!function(e){"use strict";function t(e){e=e.replace("#","");var t=v.floor(e.length/3),i=v.RADIX.HEXA,n=(i+1)/(1/(i-1)*(v.pow(i,t)-1)),s=0;this.r=v.round(v.toDeci(e.substr(s++*t,t))*n),this.g=v.round(v.toDeci(e.substr(s++*t,t))*n),this.b=v.round(v.toDeci(e.substr(s*t,t))*n),this.a=1}function i(e){this.html=i.enableHTML?this.toHTML():null,e&&this.html.classList.add.apply(this.html.classList,e.split(" ")),this.init.apply(this,Array.prototype.slice.call(arguments,1))}function n(e){this.data=E.get(e).clone();var t=Array.prototype.slice.call(arguments,1);t.unshift(null),n.prototype.super.apply(this,t)}function s(e,t){this.count=0,this.warnLack=!1,this.super(e,t)}function o(e,t,i){this.locked=!0,this.clickable=null,this.options=null,this.optionsWrapper=null,this.owner=t,this.parentAction=i||null,this.repeated=0,this.chosenOptionId=null,this.energyDrain=null,this.super(e)}function r(e){this.super(e)}function a(e,t){var i=w.getNow();w.log("Loaded in "+i+"ms"),console.log("Starting v0.5.2"),this.assets=t,this.resources=new Map,this.buildings=new Map,this.incidents=new Map,this.people=new Map,this.initialActions=[],this.knownLocations=[],this.buildingsInProgress=[],this.flags={paused:!1,win:!1,gameOver:!1,settled:0,incidents:[]},this.lastTick=i,a.holder=e,this.super(null,t),w.log("Started in "+(w.getNow()-i)+"ms")}function c(e){this.timer=null,this.nameNode=null,this.progressBar=null,this.tooltip=null,this.super(e)}function l(e,t){this.id=w.pickUniqueID(),this.name=e,this.gender=t||"other",this.actions=new Map,this.busy=!1,this.energyDrain=.7,this.energy=100,this.life=100,this.stats={idle:0,age:0},this.perk=null,this.super()}function u(e,t){if(u.usedId.includes(e))throw new RangeError("This perk is already used ["+e+"]");u.usedId.push(e),this.owner=t,this.super(e)}function h(e,t,i){this.value=null,this.threshold=i||0,this.super(e),this.setColor(t)}function d(e,t,i){this.text=t,this.timeout=null,this.super(e),this.setAction(i)}function m(e,t,i){e instanceof m?(this.html=e.html.cloneNode(),this.distance=e.distance):this.super("icon icon-small-"+e,t,i)}function f(e,t){this.data=e,this.super(t),this.show.defer(this)}function p(e,t){this.container=e,this.nodes={},this.resourcesMapper={},this.super(null,t)}var g={prepareCanvas:function(e,t){var i=document.createElement("canvas");return i.width=e,i.height=t,{cnv:i,ctx:i.getContext("2d")}}};CanvasRenderingContext2D.prototype.clear=function(){this.clearRect(0,0,this.canvas.width,this.canvas.height)},t.prototype={fade:function(e){return this.a=v.constrain(e,0,1),this},grey:function(){return this.r=this.g=this.b=v.average(this.r,this.g,this.b),this},toHexa:function(){var e=v.toHexa,t=String.prototype.padStart,i=[2,"0"];return"#"+t.apply(e(this.r),i)+t.apply(e(this.g),i)+t.apply(e(this.b),i)},toRGB:function(){return"rgb("+[this.r,this.g,this.b].join(", ")+")"},toRGBA:function(){return"rgba("+[this.r,this.g,this.b,this.a].join(", ")+")"},toString:function(){return this.a<1?this.toRGBA():this.toHexa()}};var b={fade:function(e,i){return new t(e).fade(i).toString()},grey:function(e){return new t(e).grey().toString()}},v={RADIX:{BINARY:2,DECIMAL:10,HEXA:16,ALPHA:36},toNumber:function(e,t){return Number(e)||t||0},floor:function(e){return e<<0},round:function(e){return v.floor(e+v.sign(e)/2)},ceil:function(e){return v.floor(e+v.sign(e))},abs:Math.abs,sign:function(e){return e<0?-1:1},pow:Math.pow,sq:function(e){return e*e},sqrt:function(e){return v.pow(e,.5)},PI2:2*Math.PI,cos:Math.cos,sin:Math.sin,diff:function(e,t){return v.abs(e-t)},average:function(){var e=arguments.length;if(!e)throw new RangeError("Can't get mean from no value");for(var t=0,i=0;i<e;++i)t+=arguments[i];return t/e},constrain:function(e,t,i){return e<t?t:e>i?i:e},random:function(){var e=Math.random;return function(t,i){return w.isUndefined(i)?(i=!t||w.isUndefined(t)?1:v.toNumber(t,1),t=0):(t=v.toNumber(t),i=v.toNumber(i,1)),e()*(i-t)+t}}(),toHexa:function(e){return v.round(e).toString(v.RADIX.HEXA).toUpperCase()},toDeci:function(e){return parseInt(e,v.RADIX.HEXA)}};Number.prototype.equals=function(e){return w.isNumber(e)&&v.diff(this,e)<=Number.EPSILON},Array.prototype.last=function(){return this[this.length-1]},Array.prototype.random=function(){return this[v.floor(v.random(0,this.length))]},Array.prototype.out=function(e){var t=this.indexOf(e);return t>=0&&this.splice(t,1),this.length},Array.prototype.insert=function(e){return this.push.apply(this,e)},Map.prototype.push=function(e,t){return w.isUndefined(t)&&(e=(t=e).id||t instanceof n&&t.getId()||w.pickUniqueID()),this.set(e,t),e},Map.prototype.getValues=function(){var e=[];return this.forEach(function(t){e.push(t)}),e},Map.prototype.getKeys=function(){var e=[];return this.forEach(function(t,i){e.push(i)}),e},Object.prototype.browse=function(e,t){Object.keys(this).forEach(function(i){e.call(t,this[i],i,this)},this)},Object.prototype.values=function(){return Object.values(this)},Object.prototype.flatten=function(){var e=[];return this.deepBrowse(function(t){e.push(t)}),e},Object.prototype.deepBrowse=function(e,t){["Object","Array"].includes(this.constructor.name)?this.browse(function(i){i.deepBrowse(e,t)}):e.call(t,this)},Object.prototype.swap=function(){var e={};return this.browse(function(t,i){e[t]=i}),e},Object.prototype.clone=function(){var e;if([Boolean,Number,String].includes(this.constructor))e=this;else if(this instanceof Array)e=this.slice();else{if(!(this instanceof Object))throw new TypeError("Improbable source type");e=Object.assign({},this)}return e},HTMLElement.prototype.show=function(){this.removeAttribute("aria-hidden")},HTMLElement.prototype.hide=function(){this.setAttribute("aria-hidden","true")},HTMLElement.prototype.getStyle=function(e){return window.getComputedStyle(this).getPropertyValue(e)},Function.prototype.extends=function(e,t,i){if(e&&(this.prototype=Object.create(e.prototype),this.prototype.super=e,this.prototype.constructor=this,this.prototype.modelName=t),i){var n=this;i.browse(function(e,t){n.prototype[t]&&(n.prototype["_"+t]=n.prototype[t]),n.prototype[t]=e})}},Function.prototype.static=function(e){var t=this;e.browse(function(e,i){t[i]&&(t["_"+i]=t[i]),t[i]=e})},Function.prototype.defer=function(e){var t=this,i=Array.prototype.slice.call(arguments,1);requestAnimationFrame(function(){t.apply(e,i)})};var w={noop:new Function,wrap:function(e,t,i){var n=document.createElement("div");return e&&(n.className=e),t&&(n.innerHTML=t),i&&i.appendChild(n),n},formatJoin:function(e,t){return e.length>1?e.slice(0,e.length-1).join(", ")+" "+(t||"and")+" "+e.last():e.length?String(e[0]):""},formatArray:function(e){i.enableHTML=!1;var t=w.formatJoin(e.map(function(e){return s.toString(E.get(e[1]),e[0])}));return i.enableHTML=!0,t},formatTime:function(e){if(!e)return"0 hour";var t=["year","month","day","hour","minute"],i=[],n=E.time;return t.forEach(function(t){if(e>=n[t]){var s=v.floor(e/n[t]);e%=n[t],i.push(s+" "+w.pluralize(t,s))}}),w.formatJoin(i)},pluralize:function(e,t){return e+(t>1&&"s"!==e[e.length-1]?"s":"")},capitalize:function(e){return e?(e=e.replace(/([.!?])\s([a-z])/g,function(e,t,i){return t+" "+i.toUpperCase()}))[0].toUpperCase()+e.slice(1):""},randomize:function(e,t){if(!e||!e.values().length)throw new TypeError("Can't pick from empty list");var i={},n=[],s=0;e.deepBrowse(function(e){var t=E.get(e);t&&t.dropRate&&(s+=t.dropRate,n.push(s),i[s]=e)});var o=v.floor(v.random(s));n.sort(function(e,t){return e-t});for(var r=0,a=n.length;r<a;++r)if(n[r]>o){o=n[r];break}return t?(w.isArray(t)||(t=w.isString(t)?t.split("-"):[t]),[v.round(v.random.apply(null,t)),i[o]]):i[o]},randomizeMultiple:function(e,t){if(!t)throw new TypeError("Need an amount");var i=[];w.isArray(t)||(t=w.isString(t)?t.split("-"):[t]);for(var n=v.round(v.random.apply(null,t)),s=0;s++<n;)i.push([1,w.randomize(e)]);return w.compactResources(i)},log:function(){},randomStr:function(e){return e=e||6,new Array(e).fill("-").join("").replace(/-/g,function(){return v.floor(v.random(v.RADIX.ALPHA)).toString(v.RADIX.ALPHA)})},pickUniqueID:function(){return new String("")},isFunction:function(e){return e instanceof Function},isArray:function(e){return Array.isArray(e)},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isUndefined:function(e){return void 0===e},sanitize:function(e){return e.replace(/^\W+|\W+$/g,"").replace(/\W+/g,"_").toLowerCase()},camelize:function(e){return e.replace(/^\W+/,"").toLowerCase().replace(/\W+(\w?)/g,function(e,t){return t&&t[0].toUpperCase()+t.slice(1)})},an:function(e){return e.length?("aeiou".split("").includes(e[0])?"an":"a")+" "+e:""},compactResources:function(e){return e.reduce(function(e,t){var i=e.find(function(e){return e[1]===t[1]});return i?i[0]+=t[0]:t[0]>0&&e.push(t),e},[]).sort(function(e,t){return t[0]-e[0]})},getNow:function(){return v.floor(performance.now())},loadAsync:function(e,t){var i={},n=0,s=Object.keys(e),o=s.length;return Promise.all(s.map(function(s){var r=e[s],a=fetch(r).then(function(e){if(e.ok)return e;throw new URIError("["+e.status+"] "+r+" "+e.statusText)}),c=r.substr(r.lastIndexOf(".")+1);switch(c){case"png":a=a.then(function(e){var t=new Image;return e.blob().then(function(e){return t.src=URL.createObjectURL(e),t})});break;case"json":a=a.then(function(e){return e.json()});break;case"woff":case"woff2":case"ttf":a=a.then(function(){var e=document.createElement("style");return e.innerHTML="@font-face {\n    font-family: "+s+";\n    src: url("+r+") format('"+c+"');\n}",e})}return a.then(function(e){i[s]=e,t(++n/o*100,s)})})).then(function(){return i})}};i.extends(null,"View",{init:w.noop,toHTML:function(){return w.wrap(this.modelName)},show:function(e){if(e){var t=this,i=function(){e.call(t),t.html.removeEventListener("transitionend",i)};this.html.getStyle("transition")?this.html.addEventListener("transitionend",i):i.defer()}this.html.show()},hide:function(e){if(e){var t=this,i=function(){e.call(t),t.html.removeEventListener("transitionend",i)};this.html.getStyle("transition")?this.html.addEventListener("transitionend",i):i.defer()}this.html.hide()},remove:function(){this.html.remove()}}),i.static({enableHTML:!0}),n.extends(i,"Model",{getId:function(){return this.data.id},toJSON:function(){return{id:this.getId()}}}),s.extends(n,"Resource",{init:function(e){e&&this.update(e),this.tooltip=new p(this.html,this.data)},toHTML:function(){var e=this._toHTML();return this.counter=w.wrap("counter","1",e),w.wrap("icon icon-"+this.data.icon,null,e),e.style.order=this.data.order,e},refresh:function(e){this.counter.textContent=this.get(),w.isArray(this.data.consume)&&e&&this.tooltip.refresh(e,this.data)},update:function(e){var t=this.count;this.set(this.count+v.toNumber(e,0)),v.floor(t)!==v.floor(this.count)&&e<0&&this.animate("less")},animate:function(e){if(!this.html.classList.contains(e)){this.html.classList.add(e);setTimeout(this.html.classList.remove.bind(this.html.classList,e),700)}},get:function(){return v.floor(this.count)},set:function(e){if(this.count=e,this.count<0)throw new RangeError("Resources count can't be negative");this.refresh()},has:function(e){return this.count>e||this.count.equals(e)},toJSON:function(){return[this.count,this.getId()]},toString:function(){return s.toString(this.data,this.count)}}),s.static({LST_ID:"resourceList",toString:function(e,t){var i="";return w.isUndefined(t)||(i+=t+" "),e.icon&&(i+=s.iconAsString(e.icon)+" "),i+=w.pluralize(e.name,t).bold()},iconAsString:function(e){return w.wrap("icon icon-small-"+e).outerHTML}});var y=function(){var e={};return function(e,t){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=Date.now();var i=document.createElement("script"),n=document.getElementsByTagName("script")[0];i.async=1,i.src="https://www.google-analytics.com/analytics.js",n.parentNode.insertBefore(i,n)}(e,"ga"),e.ga("create","UA-99773946-1","auto"),e.ga("send","pageview"),function(t,i,n){e.ga("send","event","Game",t,i,n)}}();e.starter=function(e){var t=document.body;t.classList.add("loading"),console.groupCollapsed("Loading");var i=w.getNow();w.loadAsync({Dosis:"https://fonts.gstatic.com/s/dosis/v7/xIAtSaglM8LZOYdGmG1JqQ.woff",icons:"dist/img/icons.png",assets:"dist/img/assets.png",assetsData:"dist/json/assets.json",buildingsData:"dist/json/buildingsData.json"},function(e,t){w.log(t+" : "+e.toFixed(1)+"% - "+(w.getNow()-i)+"ms")}).then(function(e){console.groupEnd(),t.classList.remove("loading"),document.head.appendChild(e.Dosis),t.innerHTML="",new a(t,e)}).catch(function(e){console.warn("Fail to load game : "+e.message,e.stack)})};var E=function(){function e(e){var t=btoa(e.id);return e.id=t,c[t]=e,t}function t(e,t){return s.toString(c[e],t)}function i(e){return"<i class='quote'>"+e+"</i>"}var n={minute:1/60,hour:1,day:24,week:168,month:720,year:8760},o=["north","south","east","west","north-east","north-west","south-east","south-west"],r={resources:{gatherables:{common:{},uncommon:{},rare:{}},craftables:{basic:{},complex:{},advanced:{}},special:{}},buildings:{small:{},medium:{},big:{},special:{}},actions:{},locations:{near:{},far:{},epic:{}},incidents:{easy:{},medium:{},hard:{}},perks:{}},c={};r.option="opt",r.resources.room=e({id:"rom",name:"room",desc:"A place for someone in the camp.",icon:"person",order:0}),r.resources.gatherables.common.water=e({id:"wtr",name:"water",desc:"Water is definitely important to survive in this harsh environment.",icon:"water-bottle",dropRate:100,order:10}),r.resources.gatherables.common.food=e({id:"fod",name:"food",desc:"Everyone need food to keep his strength.",icon:"foodcan",dropRate:90,order:20}),r.resources.gatherables.common.rock=e({id:"rck",name:"rock",desc:i("There's rocks everywhere ! Why would you bring this back ?"),icon:"rock",dropRate:100,order:30}),r.resources.gatherables.common.scrap=e({id:"scp",name:"scrap metal",desc:"An old rusty piece of metal.",icon:"metal-scraps",dropRate:60,order:40}),r.people=e({id:"plp",name:"people",desc:"The workforce and the bane of the camp.",needs:[[1/n.day,r.resources.gatherables.common.water,"thirsty"],[1/n.day,r.resources.gatherables.common.food,"starving"]],dropRate:.001}),r.resources.gatherables.uncommon.bolts=e({id:"blt",name:"nuts and bolts",desc:"Little metal nuts and bolts to fasten anything in place.",icon:"nuts-and-bolts",dropRate:65,order:50}),r.resources.gatherables.uncommon.sand=e({id:"snd",name:"sand",desc:"Just pure fine sand.",icon:"sand-pile",dropRate:50,order:55}),r.resources.gatherables.uncommon.oil=e({id:"oil",name:"fuel",desc:"About a liter of gas-oil.",icon:"jerrycan",dropRate:20,order:60}),r.resources.gatherables.rare.medication=e({id:"mct",name:"medication",desc:"An unlabeled medication, hope it's still good.",icon:"medications",dropRate:7,order:70}),r.resources.gatherables.rare.electronic=e({id:"elc",name:"electronics",desc:"Some basic micro-electronics components.",icon:"electronic-parts",dropRate:10,order:75}),r.resources.special.ruins=e({id:"run",name:"location",desc:"Directions to a point of interest found earlier.",icon:"map",order:80,dropRate:.6}),r.resources.special.quartz=e({id:"qtz",name:"quartz cristal",desc:"A rough uncut gem of quartz. Quite valuable.",icon:"gem",dropRate:10,order:77}),r.resources.craftables.basic.component=e({id:"cmp",name:"component",desc:"Some mechanical parts for others craftables.",icon:"pipes-large",consume:[[2,r.resources.gatherables.common.scrap],[2,r.resources.gatherables.uncommon.bolts]],dropRate:120,order:110}),r.buildings.special.wreckage=e({id:"wrk",name:"wreckage",desc:"Remainings of a car.",asset:"wreckage",order:0}),r.actions.launch=e({id:"lnc",name:"start engine",desc:"Finally start the engine of the new vehicle.",time:3,isOut:1,unique:!0,consume:[[10,r.resources.gatherables.uncommon.oil]],effect:function(){A.notify(A.MSG_TYPES.WIN)},log:function(){return"After "+this.getSurvivalDuration()+", it's finally possible to leave this damned crash-site.<br/>Everyone shove itself into the car and dream of the better life waiting at the end of the road."},order:15}),r.actions.exchange=e({id:"exc",name:"exchange",desc:"Caravan passing by carry lots of useful stuff, let's see what's possible to trade.",time:7,energy:20,consume:[[2,r.resources.craftables.complex.jewelry]],giveSpan:[2,3],giveList:[r.resources.craftables.basic,r.resources.craftables.complex],log:"@people.name manage to trade a couple of jewelries for @give.",order:10}),r.actions.nurse=e({id:"nrs",name:"nurse",desc:"Look after the health of the most needed one.",time:2,energy:1,consume:[[2,r.resources.gatherables.rare.medication]],effect:function(e,t,i){var n=null;this.people.forEach(function(e){(!n||e.life<n.life)&&(n=e)}),n.updateLife(99),i.cured=n},log:"Thanks to @people.name, @cured.name feel better.",order:7}),r.actions.heal=e({id:"hel",name:"heal",desc:'"I really hope those pills are still good."',time:2,energy:1,consume:[[2,r.resources.gatherables.rare.medication]],effect:function(e,t,i){var n=99,s=this.buildings.has(r.buildings.small.pharmacy),o=e.owner.hasPerk(r.perks.healer);!s&&!o&&v.random()<.4&&(n=-10,i.wasBad=!0),e.owner.updateLife(n)},log:function(e){return e.wasBad?"After feeling not so well, @people.name realise taking these pills took a hit on his health.":"This time, it actually improve @people.name's health."},order:6}),r.actions.sleep=e({id:"slp",name:"sleep",desc:"Get some rest to restore energy.",time:7,energy:0,effect:function(e){e.owner.setEnergy(this.incidents.has(r.incidents.medium.fever)?40:100)},unlock:[r.actions.heal],log:"@people.name feels well rested now.",order:5}),r.actions.harvestPlot=e({id:"hrp",name:"harvest crops",desc:"It's not the biggest vegetables, but it'll fill our stomachs.",time:4,consume:[[1,r.resources.gatherables.common.water]],giveSpan:[1.5,2],giveList:[r.resources.gatherables.common.food],log:"Our crops produce @give.",order:70}),r.actions.harvestField=e({id:"hrf",name:"harvest crops",desc:"It's not the biggest vegetables, but it'll fill our stomachs.",time:6,consume:[[2,r.resources.gatherables.common.water]],giveSpan:[4,5],giveList:[r.resources.gatherables.common.food],log:"Our crops produce @give.",order:70}),r.actions.drawFromRiver=e({id:"dfr",name:"draw water",desc:"Get some "+t(r.resources.gatherables.common.water)+" from the river.",time:8,energy:50,isOut:1,condition:function(e){return!e.owner.actions.has(r.actions.drawFromWell)},giveSpan:[2,6],giveList:[r.resources.gatherables.common.water],log:"Coming back from the river, @people.name brings @give with @people.accusative.",order:60}),r.actions.drawFromWell=e({id:"dfw",name:"draw water",desc:"Get some "+t(r.resources.gatherables.common.water)+" from our well.",time:2,energy:15,giveSpan:[1,3],giveList:[r.resources.gatherables.common.water],log:"Using our well, @people.name draw @give.",order:60}),r.actions.drawFromPump=e({id:"dfp",name:"draw water",desc:"Get some "+t(r.resources.gatherables.common.water)+" at the pump.",time:2,giveSpan:[3,3],giveList:[r.resources.gatherables.common.water],log:"Using our pump, @people.name draw @give.",order:60}),r.actions.build=e({id:"bui",name:"build",desc:"Put together some materials to come up with what looks like a building.",build:r.option,options:function(){return this.possibleBuildings()},order:50}),r.actions.craft=e({id:"crf",name:"craft",desc:"Use some resources to tinker something useful.",time:4,energy:10,options:function(){return this.unlockedCraftables()},give:[[1,r.option]],unlock:[r.actions.build],log:"@people.name succeeds to craft @give.",order:30}),r.actions.explore=e({id:"xpl",name:"explore",desc:"Remember that "+t(r.resources.special.ruins)+" found the other day ? Let's see what can be gather there.",time:n.day,energy:100,isOut:1,consume:[[2,r.resources.gatherables.common.water],[1,r.resources.gatherables.common.food],[1,r.resources.special.ruins]],options:function(){return this.knownLocations},giveSpan:[8,10],giveList:[r.resources.special.quartz],log:"All locations should have own log",order:20});var l=c[r.resources.special.ruins].dropRate;return r.actions.scour=e({id:"scr",name:"scour",desc:"Knowledge of the area allows for better findings.",time:4,isOut:1,consume:[[1,r.resources.gatherables.common.water]],giveSpan:[1.5*l/2,(1.5*l+1)/2],giveList:[r.resources.special.ruins],log:function(e){var t;if(e.give){var i=w.randomize(r.locations);this.knownLocations.includes(i)||this.knownLocations.push(i),e.location=w.an(E.get(i).name),t="@people.name knew @people.nominative could find @location towards @direction."}else t="No special location towards @direction.";return e.direction=o.random(),t},order:10}),r.actions.roam=e({id:"ram",name:"roam",desc:"Explore the surroundings hoping to find a "+t(r.resources.special.ruins)+".",time:5,isOut:1,consume:[[1,r.resources.gatherables.common.water]],condition:function(e){return!e.owner.actions.has(r.actions.scour)},unlock:[r.actions.explore],unlockAfter:[[9,r.actions.scour]],giveSpan:[l/2,(l+1)/2],giveList:[r.resources.special.ruins],log:function(e){var t;if(e.give){var i=w.randomize({near:r.locations.near,far:r.locations.far});this.knownLocations.includes(i)||this.knownLocations.push(i),e.location=w.an(E.get(i).name),t="Heading to the @direction, @people.name spots @location"}else t="@people.name found nothing special towards the @direction.";return e.direction=w.capitalize(o.random()),t},order:10}),r.actions.gather=e({id:"gtr",name:"gather resources",desc:"Go out to bring back resources, that's the best way to survive.",time:3,isOut:1,unlock:[r.actions.roam,r.actions.craft],giveSpan:[3,6],giveList:r.resources.gatherables.flatten(),log:"@people.name comes back with @give.",order:1}),r.buildings.special.firePit=e({id:"fp1",name:"fire pit",asset:"fire",shadow:!0}),r.buildings.special.firePit2=e({id:"fp2",name:"fire pit",upgrade:r.buildings.special.firePit,asset:"fire2",shadow:!0}),r.buildings.special.forum=e({id:"fr0",name:"forum",desc:"The center and start of our settlement.",unlockForAll:[r.actions.sleep],upgrade:r.buildings.special.wreckage,give:[[1,r.resources.room]],build:r.buildings.special.firePit,asset:"forum"}),r.actions.settle=e({id:"stl",name:"settle here",desc:"Ok, let's settle right there !",time:2,energy:0,effect:function(){this.flags.settled=1},unlock:[r.actions.gather],build:r.buildings.special.forum,log:"Since the global war, the environment is rotten with radiations. It won't be easy to survive in the middle of these wastelands, but there's no other choice now.",order:0,unique:!0}),r.actions.look=e({id:"lok",name:"look around",desc:i("What am I doing here ?"),time:1,energy:0,effect:function(){T.timeout(function(){S.log("I'll need a shelter.",A.MSG_TYPES.LOGS.QUOTE)},a.TICK_LENGTH/2)},give:[[8,r.resources.gatherables.common.water],[6,r.resources.gatherables.common.food],[2,r.resources.craftables.basic.component]],unlock:[r.actions.settle],log:"After some reflexion, @people.name remembers the crash. @people.nominative grabs @give from @people.possessive car trunk.",order:0,unique:!0}),r.actions.wakeUp=e({id:"wku",name:"wake up",unlock:[r.actions.look],effect:function(e){e.owner.updateEnergy(100),e.owner.updateLife(100)},log:"@people.name gets up painfully.",order:0,unique:!0}),r.resources.craftables.basic.stone=e({id:"stn",name:"smooth stone",desc:"A round and well polish stone.",icon:"stone",consume:[[3,r.resources.gatherables.common.rock]],dropRate:100,order:90}),r.resources.craftables.basic.tool=e({id:"tol",name:"tool",desc:"The base for any tinkerer.",icon:"tools",consume:[[1,r.resources.craftables.basic.component],[2,r.resources.gatherables.common.rock]],dropRate:90,order:111}),r.buildings.small.furnace=e({id:"frn",name:"furnace",desc:"Survival require to craft as much as to gather things.",time:7,consume:[[8,r.resources.gatherables.common.rock],[2,r.resources.gatherables.uncommon.oil]],asset:"",order:15,log:"A simple furnace that can smelt small things like "+t(r.resources.gatherables.uncommon.sand)+" or "+t(r.resources.gatherables.rare.electronic)+"."}),r.resources.craftables.basic.glass=e({id:"gls",name:"glass pane",desc:"A see-through building component.",icon:"glass-pane",ifHas:r.buildings.small.furnace,consume:[[4,r.resources.gatherables.uncommon.sand]],dropRate:60,order:100}),r.buildings.small.forum1=e({id:"fr1",name:"forum+1",desc:"Add "+t(r.resources.room,1)+" to the forum.",time:2,upgrade:r.buildings.special.forum,consume:[[6,r.resources.gatherables.uncommon.bolts],[4,r.resources.gatherables.common.scrap]],give:[[1,r.resources.room]],asset:"forum1",order:10,log:"More space to sleep means more people joining and helping."}),r.buildings.small.plot=e({id:"plt",name:"farm plot",desc:"A little arranged plot of soil to grow some "+t(r.resources.gatherables.common.food)+".",time:9,consume:[[5,r.resources.gatherables.common.food],[10,r.resources.gatherables.uncommon.sand]],unlockForAll:[r.actions.harvestPlot],asset:"plot",order:12,log:"Crops required care but that's going to help keeping a constant stock of "+t(r.resources.gatherables.common.food)+"."}),r.buildings.small.pharmacy=e({id:"phr",name:"pharmacy",desc:i("Maybe we should avoid letting "+t(r.resources.gatherables.rare.medication)+"s rot in plain sunlight !"),time:6,consume:[[5,r.resources.gatherables.rare.medication],[4,r.resources.craftables.basic.component]],asset:"pharmacy",order:16,log:"Sorting the "+t(r.resources.gatherables.rare.medication)+"s should prevent further mistakes and bad reaction."}),r.buildings.small.well=e({id:"wel",name:"well",desc:"Just a large hole into the ground.",time:16,consume:[[10,r.resources.gatherables.common.rock],[4,r.resources.craftables.basic.tool]],give:[[5,r.resources.gatherables.common.water]],unlockForAll:[r.actions.drawFromWell],lock:[r.actions.drawFromRiver],asset:"",order:13,log:"Drawing "+t(r.resources.gatherables.common.water)+" from the ground should allow to further polish "+t(r.resources.gatherables.common.rock)+"."}),r.buildings.medium.forum2=e({id:"fr2",name:"forum+2",desc:"Add "+t(r.resources.room,1)+" to the camp.",time:5,consume:[[10,r.resources.gatherables.uncommon.sand],[2,r.resources.craftables.basic.stone],[3,r.resources.craftables.basic.glass]],upgrade:r.buildings.small.forum1,give:[[1,r.resources.room]],asset:"forum2",order:20,log:"Another room for someone to join. So far, so good."}),r.buildings.medium.plot1=e({id:"fil",name:"field",desc:"A larger crop field to produce more "+t(r.resources.gatherables.common.food)+".",time:10,lockForAll:[r.actions.harvestPlot],unlockForAll:[r.actions.harvestField],consume:[[20,r.resources.gatherables.common.food],[5,r.resources.craftables.basic.tool],[3,r.resources.gatherables.rare.medication]],upgrade:r.buildings.small.plot,asset:"plot+1",order:25,log:"This should be enough to provide "+t(r.resources.gatherables.common.food)+" for our small encampment."}),r.buildings.medium.forge=e({id:"frg",name:"forge",desc:"A good upgrade to the furnace.",time:10,consume:[[10,r.resources.craftables.basic.stone],[6,r.resources.gatherables.uncommon.oil],[2,r.resources.craftables.basic.tool]],upgrade:r.buildings.small.furnace,asset:"furnace+1",order:27,log:"A big fire is now roaring in the forge. It should now be possible to forge more complex parts."}),r.resources.craftables.complex.brick=e({id:"brk",name:"brick",desc:"Will give walls for larger constructions.",icon:"brick",ifHas:r.buildings.small.well,consume:[[1,r.resources.craftables.basic.stone],[1,r.resources.craftables.basic.tool]],dropRate:80,order:112}),r.resources.craftables.complex.circuit=e({id:"cir",name:"circuit",desc:"That's a little rough, but it's actually a functioning circuit board.",icon:"electronic-circuit-board",consume:[[2,r.resources.gatherables.common.scrap],[2,r.resources.craftables.basic.component],[3,r.resources.gatherables.rare.electronic]],dropRate:60,order:114}),r.resources.craftables.complex.metalPipe=e({id:"mtp",name:"metal pipe",desc:"Forged from junk metal.",icon:"pipes-small",ifHas:r.buildings.medium.forge,consume:[[4,r.resources.gatherables.common.scrap],[1,r.resources.craftables.basic.tool]],dropRate:80,order:115}),r.resources.craftables.advanced.jewelry=e({id:"jwl",name:"jewelry",desc:"A really beautiful ornament useful for trading.",icon:"jewelry",ifHas:r.buildings.small.furnace,consume:[[4,r.resources.gatherables.rare.electronic],[2,r.resources.special.quartz]],dropRate:40,order:117}),r.buildings.big.workshop=e({id:"wrs",name:"workshop",desc:"Having a dedicated place for the crafting work would allow to make more complex crafts.",time:3*n.day,energy:90,ifHas:r.buildings.medium.forge,consume:[[6,r.resources.gatherables.common.scrap],[5,r.resources.craftables.basic.glass],[10,r.resources.craftables.basic.tool],[15,r.resources.craftables.complex.brick]],asset:"",order:35,log:"Good organisation enable to put together new work."}),r.resources.craftables.complex.furniture=e({id:"fnt",name:"furniture",desc:"A proper settlement needs better than pile of trash for table and seats.",icon:"glass-table",ifHas:r.buildings.big.workshop,consume:[[2,r.resources.craftables.basic.glass],[2,r.resources.craftables.complex.metalPipe]],dropRate:40,order:116}),r.buildings.big.forum3=e({id:"fr3",name:"forum+3",desc:"Add "+t(r.resources.room,2)+" to the camp.",time:6,consume:[[10,r.resources.craftables.complex.brick],[2,r.resources.craftables.complex.furniture],[6,r.resources.craftables.basic.glass]],upgrade:r.buildings.medium.forum2,give:[[2,r.resources.room]],asset:"forum+3",order:30,log:"All the forum space is now used for sleeping place."}),r.resources.craftables.advanced.engine=e({id:"egn",name:"engine",desc:"Amazing what can be done with all those scraps !",icon:"engine",ifHas:r.buildings.big.workshop,consume:[[10,r.resources.gatherables.uncommon.oil],[5,r.resources.craftables.basic.tool],[5,r.resources.craftables.complex.metalPipe]],dropRate:30,order:120}),r.resources.craftables.advanced.computer=e({id:"cmt",name:"computer",desc:"Well, Internet is down since 2024 but it can still be useful.",icon:"computer",ifHas:r.buildings.big.workshop,consume:[[10,r.resources.craftables.basic.component],[7,r.resources.craftables.basic.tool],[3,r.resources.craftables.complex.circuit]],dropRate:20,order:130}),r.buildings.big.radio=e({id:"rdo",name:"radio-station",desc:"Putting together a radio could allow to contact other people around the camp.",time:6,ifHas:r.buildings.big.workshop,consume:[[4,r.resources.craftables.complex.circuit],[1,r.resources.craftables.advanced.computer]],effect:function(){E.get(r.people).dropRate=1},asset:"",order:37,log:"Having a way to make contact should attract more people to the camp, either they want to join or trade."}),r.buildings.big.pump=e({id:"pmp",name:"water pump",desc:"A buried contraption that collect "+t(r.resources.gatherables.common.water)+" from the earth moisture.",time:3*n.day,energy:120,consume:[[20,r.resources.craftables.basic.stone],[5,r.resources.craftables.complex.metalPipe],[1,r.resources.craftables.advanced.engine]],upgrade:r.buildings.small.well,unlockForAll:[r.actions.drawFromPump],lockForAll:[r.actions.drawFromRiver,r.actions.drawFromWell],asset:"",order:36,log:"A big upgrade to the well ! Now there's a continuous flow of "+t(r.resources.gatherables.common.water)+" coming up."}),r.buildings.big.trading=e({id:"trd",name:"trading post",desc:"Since the radio station bring a handful of merchant, better take advantage of it.",time:n.day,energy:70,ifHas:r.buildings.big.radio,consume:[[2,r.resources.craftables.basic.glass],[10,r.resources.craftables.complex.brick],[2,r.resources.craftables.complex.furniture]],unlockForAll:[r.actions.exchange],asset:"",order:38,log:"Arranging some space allow to trade with merchant caravan passing by."}),r.buildings.big.module=e({id:"mdl",name:"vehicle",desc:"This should be enough to hit the road and head towards a better place.",time:n.week,energy:100,ifHas:r.buildings.big.workshop,consume:[[15,r.resources.gatherables.uncommon.oil],[5,r.resources.craftables.complex.furniture],[1,r.resources.craftables.advanced.computer],[2,r.resources.craftables.advanced.engine]],unlockForAll:[r.actions.launch],asset:"",order:40,log:"It don't looks so well, but sure thing it should runs good."}),r.locations.near.mountain=e({id:"mnt",name:"mountain",desc:"A nearby mountain that may contains some basic building resources",giveList:[r.resources.gatherables.common.rock,r.resources.gatherables.common.scrap,r.resources.craftables.basic.component],log:"That was hard to climb those mountains, but at least @people.name find @give.",dropRate:90}),r.locations.near.desert=e({id:"dst",name:"desert",desc:"Not much to find in a desert, but that's for sure the best place to get "+t(r.resources.gatherables.uncommon.sand)+".",giveList:[r.resources.gatherables.common.scrap,r.resources.gatherables.uncommon.oil,r.resources.gatherables.uncommon.sand],log:"Dunes everywhere give a felling of hopelessness. Here's @give for the stock.",dropRate:100}),r.locations.near.supermarket=e({id:"hng",name:"hangar",desc:"A huge hangar. It was certainly raided before by others, but there may be something to grab.",giveList:[r.resources.gatherables.common.food,r.resources.gatherables.rare.medication,r.resources.craftables.basic.glass],log:"Quite easy to loot, @people.name returns with @give.",dropRate:80}),r.locations.far.river=e({id:"rvr",name:"river",desc:"Quite rare to find "+t(r.resources.gatherables.common.water)+" on those wastelands. This is a valuable location to find.",unlockForAll:[r.actions.drawFromRiver],giveList:[r.resources.gatherables.common.water,r.resources.gatherables.uncommon.bolts,r.resources.craftables.basic.stone],log:"It's nice by the river, @people.name found @give.",dropRate:30}),r.locations.far.ruin=e({id:"orn",name:"old ruin",desc:"This is a huge underground network of rooms linked by narrow hallways. This should have provided shelter a long time ago.",giveList:[r.resources.gatherables.rare.electronic,r.resources.craftables.basic.component,r.resources.craftables.basic.tool],log:"Amazing no-one get lost in those caves to get @give.",dropRate:50}),r.locations.epic.building=e({id:"bld",name:"buried building",desc:"Digging up this building, uncover stuff preserved from looting and environment.",giveList:[r.resources.gatherables.rare.medication,r.resources.craftables.basic.glass,r.resources.craftables.complex.circuit],log:"Impossible to guess what that building was, but it sure was interesting. @people.name find @give.",dropRate:10}),r.locations.epic.spaceship=e({id:"swr",name:"old wreckage",desc:"This rusty vehicle remains was in good enough shape in order to allow to find useful parts inside.",giveList:[r.resources.gatherables.rare.electronic,r.resources.craftables.basic.tool,r.resources.craftables.complex.furniture],log:"Tearing apart this wreckage allow to salvage @give.",dropRate:5}),r.incidents.easy.chest=e({id:"chs",name:"Strange old chest",desc:"While exploring, a rusty container was found in the middle of rubbles. It might contains rare resources, but there's risks to fiddle with it ?",yes:"Open it up",no:"Leave it",onStart:function(e,t){if(v.random()<.7){var i=w.randomize(r.resources.craftables);this.earn(1,i),t.give=w.formatArray([[1,i]])}else{var n=this.people.getValues().random(),s=v.constrain(v.random(10,30),0,n.life-1);n.updateLife(-s),t.person=n,t.lost=s}},dropRate:30,log:function(e){var t;if(e.give)t=S.personify("nothing to fear, @give was found inside the chest.",e);else if(e.person){var i="a loud explosion blast @name away as soon as @nominative try to open the chest. ";e.lost<20?i+="thankfully, more scared than hurt, @name get out with some scratches.":i+="@name is badly hurt in the process.",t=S.personify(i,e.person)}return t}}),r.incidents.easy.fortune=e({id:"frt",name:"an old woman approach",desc:"Someone point out to a silhouette in the distance. What seams to be a very old woman is coming toward the camp.<br/>As she get closer, she's visibly pointing her finger in a menacing manner and mumble incomprehensible chatter. Her skin looks really badly burnt by radiation.",yes:"Listen to her",no:"Fend her away",onStart:function(){new f({name:"Fortune teller",desc:"After being calmly sit down, try to get what she's trying to say.<br/>"+i("Long path ahead, full of danger ... may do it ... but at what cost ?")+"<br/>"+i("If mercy is shown, success will follow !"),yes:"Humm ... ok"},"incident")},unique:!0,dropRate:70,log:"Listening to the fate that await can give chills. Does knowing the future is really helpful ?"}),r.incidents.easy.sandstorm=e({id:"ssm",name:"sandstorm",desc:"The wind is blowing hard, carrying sand and dust. It will be impossible to go out until it end.",time:16,timeDelta:4,color:"#f7ed33",dropRate:90,log:"A sandstorm has started and prevent anyone from leaving the camp."}),r.incidents.medium.acidRain=e({id:"acr",name:"acid rain",desc:"A big dark cloud is coming from the North, which means that it's going to rain acid droplet, like stingers from the sky.<br/>Going out now will be dangerous.",time:n.day,timeDelta:n.day/2,color:"#d351e8",dropRate:50,lifeLose:3,log:"Rain is pouring and it burn the skin pretty badly. A pretty good reason to stay inside for now."}),r.incidents.medium.beggar=e({id:"bgr",name:"strange beggar",desc:"A lone traveler has a deal to propose: Invest "+t(r.resources.special.quartz,3)+" now and "+i("for sure")+", he'll return with more worth of goods.",condition:function(){return this.resources.has(r.resources.special.quartz)&&this.resources.get(r.resources.special.quartz).has(4)},yes:"Acquiesce",no:"No way",consume:[[2,r.resources.special.quartz]],giveList:[r.resources.gatherables,r.resources.craftables.basic],giveSpan:[7,8],onEnd:function(e,t){v.random()<.2?(t.give=null,t.log="Looks like the beggar is not coming back this time."):t.log="As promised, the beggar came back. He gratefully give back @give."},time:8*n.day,dropRate:20,log:"Trusting a random stranger might just cost you some resources, but who knows ..."}),r.incidents.medium.fever=e({id:"fvr",name:"fever rash",desc:"In few hours, everyone develop a very bad rash and extreme fever. With cotton leg and heads about to explode, no one is willing to do much.",time:2*n.day,timeDelta:6*n.hour,color:"#9def39",dropRate:50,log:"Illness spread out in no time and weaken everyone."}),r.incidents.medium.harmonica=e({id:"hrm",name:"a song into the wild",desc:"At night everyone gather around the camp-fire to alleviate the day's burden.Someone draw out a harmonica and a melody wander slowly into the night.",unique:!0,yes:"Take some time to appreciate",dropRate:40,log:"It's good to remember to relax from time to time."}),r.incidents.medium.strayDog=e({id:"std",name:"stray dog",desc:"Looks like a wild dog is lurking around the food stash.<br/>He seams really weakened by his hunger and thirst. Giving him "+w.formatJoin([t(r.resources.gatherables.common.water,3),t(r.resources.gatherables.common.food,3)])+" should make him stay.<br/>Does there's enough resources to have another mouth to feed ?",unique:!0,yes:"Give him some water and food",no:"Ignore him",consume:[[3,r.resources.gatherables.common.water],[3,r.resources.gatherables.common.food]],log:"With caution, he accept this offering. He then proceed to hide in the forum's shadow and quickly falls asleep."}),r.incidents.hard.drought=e({id:"drg",name:"drought",desc:"The climate is so hot, everyone needs more "+t(r.resources.gatherables.common.water)+".",condition:function(){return this.hasEnough(r.resources.gatherables.common.water,5)&&this.isBuildingDone(r.buildings.small.well)},time:3*n.day,timeDelta:10,color:"#f73a18",dropRate:10,multiplier:3,log:"A harsh drought has fallen, "+t(r.resources.gatherables.common.water)+" will be consumed faster as a result."}),r.incidents.hard.lookBack=e({id:"lkb",name:"look back",desc:"It's been so long since this settlement start that it feel like a new life now.",unique:!0,yes:"Remember",onStart:function(e,t){t.duration=this.getSurvivalDuration()},dropRate:30,log:"The camp hold well for @duration in this harsh environment. Amazing !"}),r.incidents.hard.attack=e({id:"atk",name:"attack on bandits",desc:"While exploring the surroundings, a bandits camp was found a few hours of walk away.<br/>Setting a surprise attack can lead to loot their belongings.<br/>They seams to be quite well fortified though.",condition:function(){var e=!0;return this.people.forEach(function(t){e=e&&!t.busy}),e},unique:!0,time:6,timeDelta:1,color:"#7a848c",yes:"Let's do this",no:"Leave them be",onStart:function(){this.people.forEach(function(e){e.busy||e.setBusy(r.incidents.hard.attack,6)})},giveList:[r.resources.gatherables,r.resources.craftables.basic,r.resources.craftables.complex],giveSpan:[8,11],onEnd:function(){this.people.forEach(function(e){var t=v.random(10,20);e.updateLife(t),e.setBusy()})},dropRate:200,log:"They put up quite a fight and everyone got hurt in the process. At least @give were stolen."}),r.perks.first=e({id:"fso",name:"first-one",desc:"The very first one to install the settlement.",actions:[r.actions.settle],iteration:0}),r.perks.rookie=e({id:"rki",name:"rookie",desc:"All group has a rookie, all @people.nominative want is to prove @people.nominative's efficient.",condition:function(){return this.people.length>2}}),r.perks.explorer=e({id:"xpr",name:"gadabout",desc:"The veteran of the camp and leader of the exploration. @people.nominative knows the best spot of resources.",actions:[r.actions.roam,r.actions.scour,r.actions.explore],iteration:30}),r.perks.tinkerer=e({id:"tnr",name:"tinkerer",desc:"Everyone is amazed by how quickly @people.nominative can put together any contraption.",actions:[r.actions.craft,r.actions.build],iteration:30}),r.perks.healer=e({id:"hlr",name:"doctor",desc:"Knowing enough about medicine make @people.accusative confident to heal others.",actions:[r.actions.heal],condition:function(){this.buildings.has(r.buildings.small.pharmacy)},iteration:5}),r.perks.harvester=e({id:"hvt",name:"harvester",desc:"A real eagle eye that can spot goods twice as fast as anyone.",actions:[r.actions.gather,r.actions.harvestField,r.actions.harvestPlot,r.actions.drawFromRiver,r.actions.drawFromWell],iteration:40}),r.perks.lounger=e({id:"lng",name:"lounger",desc:"Doing nothing all day's not gonna make things done.",actions:[r.actions.sleep],condition:function(e){return e.stats.idle>3*n.day}}),r.perks.merchant=e({id:"mrc",name:"merchant",desc:"The ancient art of trading is a boon if used well.",action:[r.actions.exchange],iteration:10}),{time:n,ids:r,get:function(e){return e?c[e]:null},bindAll:function(e){c.browse(function(t){t.browse(function(i,n){w.isFunction(i)&&(t[n]=i.bind(e))})})}}}(),k=function(){function e(t,i){if(!i)throw new TypeError("Can't draw asset without destination");this.animationState=0,this.animationSteps=i.steps||1,this.animationSpeed=(i.speed||0)/e.FPS,this.source={},this.destination={},this.source={x:v.toNumber(t.x),y:v.toNumber(t.y),width:v.floor(t.width/this.animationSteps),height:t.height},this.destination.width=this.source.width*e.ENLARGE,this.destination.height=this.source.height*e.ENLARGE,this.destination.x=v.floor(i.x*e.ENLARGE),this.destination.y=v.floor(i.y*e.ENLARGE)}var t,i,n,s,o;return e.ENLARGE=4,e.FPS=60,e.prototype={render:function(e,t){this.animationState=(this.animationState+this.animationSpeed)%this.animationSteps;var i=v.floor(this.animationState)*this.source.width,n=this.destination.x,s=this.destination.y;t.drawImage(e,this.source.x+i,this.source.y,this.source.width,this.source.height,n,s,this.destination.width,this.destination.height)},getDepth:function(){return this.destination.y+this.destination.height},compare:function(e){return this.getDepth()-e.getDepth()},setPosition:function(t,i){this.destination.x=v.floor(t*e.ENLARGE),this.destination.y=v.floor(i*e.ENLARGE)}},{start:function(r,a,c){t=a,i=c.assets,n=c.positions;var l=g.prepareCanvas(800,300);(s=l.ctx).imageSmoothingEnabled=0,l.cnv.classList.add("layer","buildings"),r.appendChild(l.cnv),o=new Map,A.observe(A.MSG_TYPES.BUILD,function(t){var s=E.get(t);if(s&&s.asset&&i[s.asset]){var r=new e(i[s.asset],n[s.asset]);s.upgrade&&o.delete(s.upgrade),o.push(s.id,r)}}).observe(A.MSG_TYPES.UNBUILD,function(e){E.get(e)&&o.has(e)&&o.delete(e)}),this.render()},render:function(){requestAnimationFrame(this.render.bind(this)),o.size&&(s.clear(),o.getValues().sort(function(e,t){return e.compare(t)}).forEach(function(e){e.render(t,s)}))}}}(),S=function(){var e={0:"info",1:"warning",2:"quote",3:"event"},t=null,i={LOG_TYPES:{INFO:0,WARN:1,QUOTE:2,EVENT:3},maxLog:30,start:function(e){t=e,A.observe(A.MSG_TYPES.ACTION_END,function(e){i.log(e)}).observe(A.MSG_TYPES.ARRIVAL,function(e){i.log(i.personify("A new person arrive. @nominative present @reflexive as @name.",e),A.MSG_TYPES.LOGS.EVENT)}).observe(A.MSG_TYPES.LOOSE,function(e){y("Death","survival duration",e);var t="After holding up for "+w.formatTime(e)+", everyone die and the camp is left to rot under the sun.";i.log(t,i.LOG_TYPES.EVENT)}).observe(A.MSG_TYPES.RUNS_OUT,function(e){var t="There's no more "+s.toString(E.get(e))+" available, something needs to be done quickly.";i.log(t,i.LOG_TYPES.WARN)}).observe(A.MSG_TYPES.GAIN_PERK,function(e){var t=e.name+' is now known as the "'+w.capitalize(e.perk.data.name)+'".';i.log(t,i.LOG_TYPES.EVENT)})},log:function(n,s){if(n.length){s=s||i.LOG_TYPES.INFO;var o=w.wrap("log "+e[s],n);o.hide(),t.insertBefore(o,t.firstChild);var r=Array.prototype.slice.call(t.children);r.length>S.maxLog&&r.last().remove(),o.show.defer(o)}},personify:function(e,t){return w.capitalize(e.replace(/@([\w.]+)\b/gi,function(e,i){var n=t;return i.split(".").forEach(function(e){n=n[e]}),n||""}))}};return i}(),A=function(){var e=[],t={observe:function(t,i){return w.isArray(t)||(t=[t]),t.forEach(function(t){e[t]||(e[t]=[]),e[t].push(i)}),this},notify:function(t,i,n){return e[t]&&e[t].forEach(function(e){e(i,t)}),this},MSG_TYPES:{LOGS:S.LOG_TYPES,CLICK:10,ACTION_END:12,REFRESH:20,GIVE:30,FIND_LOCATION:31,ARRIVAL:33,USE:35,RUNS_OUT:36,LOOSE_RESOURCE:38,LOOSE_SOMEONE:39,UNLOCK:40,GAIN_PERK:45,LOCK:50,START_BUILD:59,BUILD:60,UNBUILD:61,INCIDENT_START:70,INCIDENT_END:72,LOOSE:90,WIN:95,KEYS:{BACK:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,UP:38,RIGHT:39,DOWN:40,LEFT:37,CTRL:17,SHIFT:16,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,ZERO:48,F5:116,F8:119,F12:123}}};t.MSG_TYPES.KEYS.browse(function(e,t,i){i[t]=e+1e3});var i=[t.MSG_TYPES.KEYS.F5,t.MSG_TYPES.KEYS.F12,t.MSG_TYPES.KEYS.TAB,t.MSG_TYPES.KEYS.ENTER,t.MSG_TYPES.KEYS.SPACE];return window.addEventListener("keydown",function(e){var n=1e3+e.keyCode;i.includes(n)||(e.preventDefault(),e.stopPropagation()),t.notify(n,"down",!0)},!0),window.addEventListener("keyup",function(e){e.preventDefault(),e.stopPropagation();var i=1e3+e.keyCode;i===t.MSG_TYPES.KEYS.ENTER&&e.target.dispatchEvent(new Event("click")),t.notify(i,"up")},!0),t}(),L=function(){function e(e){return btoa(s+btoa(e))}function t(e){return atob(atob(e).substr(s.length))}var i=localStorage,n=i.getItem("k");n||(n=w.randomStr(),i.setItem("k",n));var s=w.randomStr();return{persist:function(t){i.setItem(n,e(JSON.stringify(t)))},hasData:function(){return Object.keys(i).includes(n)},load:function(){return JSON.parse(t(i.getItem(n)))},clear:function(){i.removeItem(n)}}}(),T=function(){function e(e,t){this.startTime=w.getNow(),this.action=e,this.time=t,this.isRunning=!0,this.timeout=this.setTimeout()}function t(e){var t=i.get(e);if(!t)throw new RangeError("Unknown timer ID ["+e+"]");return t}e.prototype={setTimeout:function(){return setTimeout(this.action,this.time)},getElapsed:function(){return w.getNow()-this.startTime},getRemaining:function(){return this.time-this.getElapsed()},stop:function(){return!!this.isRunning&&(this.isRunning=!1,this.time=this.getRemaining(),clearTimeout(this.timeout),this.time)},restart:function(e){return this.isRunning||(this.isRunning=!0,this.startTime=e,this.timeout=this.setTimeout()),!this.isRunning&&this.time}};var i=new Map;return{timeout:function(t,n){var s;return s=i.push(new e(function(){t(),i.delete(s)},n))},stop:function(e){return t(e).stop()},stopAll:function(){i.forEach(function(e){e.stop()})},restart:function(e){return t(e).restart(w.getNow())},restartAll:function(){var e=w.getNow();i.forEach(function(t){t.restart(e)})},clear:function(e){var n=t(e);i.delete(e),n.stop()},clearAll:function(){i.forEach(function(e){e.clear()})},getElapsed:function(e){return t(e).getElapsed()},getRemaining:function(e){return t(e).getRemaining()}}}();o.RUNNING_CLASS="running",o.extends(n,"Action",{toHTML:function(){var e=this._toHTML();return this.clickable=new d("name disabled animated",w.capitalize(this.data.name)),e.appendChild(this.clickable.html),w.isFunction(this.data.options)?(this.clickable.setAsDropdown(!0),this.optionsWrapper=w.wrap("options",null,e),this.optionsWrapper.hide(),e.addEventListener("mouseover",this.showOptions.bind(this)),e.addEventListener("mouseout",this.hideOptions.bind(this))):this.clickable.setAction(this.click.bind(this,null)),this.data.order&&(e.style.order=this.data.order),e},showOptions:function(){this.optionsWrapper.show();var e=this.html.getBoundingClientRect();this.optionsWrapper.style.top=e.top+e.height+"px",this.optionsWrapper.style.left=e.left+"px"},hideOptions:function(){this.optionsWrapper.hide(),this.optionsWrapper.style.left=""},init:function(){o.timeAndEnergyFallback(this.data),this.tooltip=new p(this.clickable.html,this.data),this.manageOptions()},manageOptions:function(){if(w.isFunction(this.data.options)){this.options||(this.options=new Map);var e=this.data.options(this);this.options.forEach(function(t){e.includes(t.getId())||t.lock()});for(var t,i,n=0,s=e.length;n<s;++n)i=e[n],this.options.has(i)||(t=new o(i,this.owner,this),this.options.push(t),this.optionsWrapper.appendChild(t.html))}},refresh:function(e,t){this.locked=this.owner.isTired()&&this.data.energy>0||this.data.isOut&&t.incidents.includes(E.ids.incidents.easy.sandstorm)||this.parentAction&&this.parentAction.locked,this.tooltip.refresh(e,this.data),w.isArray(this.data.consume)&&!this.locked&&this.data.consume.forEach(function(t){var i=t[1];e.has(i)&&e.get(i).has(t[0])||(this.locked=!0)},this),this.manageOptions(),this.options&&this.options.forEach(function(i){i.refresh(e,t)}),this.clickable.toggle(!this.locked)},click:function(e){if(!this.owner.busy&&!this.locked)if(this.parentAction)this.parentAction.click(this.getId());else if(e||!this.options){A.notify(A.MSG_TYPES.CLICK,this.data),this.chosenOptionId=e;var t=this.mergeWithOption(e);w.isArray(t.consume)&&A.notify(A.MSG_TYPES.USE,t.consume),t.build&&A.notify(A.MSG_TYPES.START_BUILD,t.build),++this.repeated;var i=this.defineDuration(t);this.energyDrain=t.energy/i,this.start(i*a.TICK_LENGTH)}},defineDuration:function(e){var t=e.time||0;return e.timeDelta&&(t+=v.random(-e.timeDelta,e.timeDelta)),e.timeBonus&&(t-=t*e.timeBonus),t},start:function(e,t){var i=e+(t=t||0);this.owner.setBusy(this.getId(),this.energyDrain),this.clickable.startCoolDown(i,t,this.end.bind(this)),this.html.classList.add(o.RUNNING_CLASS)},mergeWithOption:function(e){var t={},i=this.data,n=e?E.get(e):{},s={},r=n.build||i.build;r&&(r===E.ids.option?r=e:s=E.get(r)),t.build=r,t.optionId=e;var a=["consume","give","giveList","unlock","lock","unlockForAll","lockForAll"],c=[];return["name","desc","log","time","timeDelta","timeBonus","energy","giveSpan"].forEach(function(e){t[e]=s[e]||n[e]||i[e]}),a.forEach(function(e){(i[e]||n[e]||s[e])&&(t[e]=(i[e]||[]).concat(n[e]||[]).concat(s[e]||[]))}),c.forEach(function(e){(s[e]||i[e]||n[e])&&(t[e]=Object.assign({},i[e]||{},n[e]||{},s[e]||{}))}),o.timeAndEnergyFallback(t),t},end:function(){this.html.classList.remove(o.RUNNING_CLASS);var e={action:this.data,people:this.owner},t=this.mergeWithOption(this.chosenOptionId);this.chosenOptionId=null,this.owner.finishAction(),w.isFunction(this.data.effect)&&this.data.effect(this,t,e);var i=this.resolveAction(e,t);i.give.length&&A.notify(A.MSG_TYPES.GIVE,{give:i.give,initiator:this}),i.unlock.forAll.length&&A.notify(A.MSG_TYPES.UNLOCK,i.unlock.forAll),this.owner.addAction(i.unlock.forOne),i.lock.forAll.length&&A.notify(A.MSG_TYPES.LOCK,i.lock.forAll),this.owner.lockAction(i.lock.forOne),i.build&&A.notify(A.MSG_TYPES.BUILD,i.build),A.notify(A.MSG_TYPES.ACTION_END,i.log)},resolveAction:function(e,t){var i={give:[],unlock:{forAll:[],forOne:[]},lock:{forAll:[],forOne:[]},log:""};if(this.getId()===E.ids.actions.gather&&1===this.repeated&&this.owner.hasPerk(E.ids.perks.first)){var n=E.ids.resources.gatherables;i.give=[[2,n.common.rock],[1,n.uncommon.bolts],[1,n.rare.medication]]}else w.isArray(t.give)?i.give=t.give:t.giveSpan&&t.giveList&&(i.give=w.randomizeMultiple(t.giveList,t.giveSpan));if(i.give.forEach(function(e,i,n){e[1]===E.ids.option&&(n[i]=[e[0],t.optionId])}),w.isArray(this.data.unlockAfter)&&this.data.unlockAfter.forEach(function(e){this.repeated>e[0]&&(i.unlock.forOne.push(e[1]),i.lock.forOne.push(this.getId()))},this),w.isArray(t.unlock)){var s=t.unlock.filter(function(e){var t=E.get(e);return!t.condition||t.condition(this)},this);this.data.unique?i.unlock.forAll.insert(s):i.unlock.forOne.insert(s)}w.isArray(t.unlockForAll)&&i.unlock.forAll.insert(t.unlockForAll.filter(function(e){var t=E.get(e);return!t.condition||t.condition(this)},this)),w.isArray(this.data.lockAfter)&&this.data.lockAfter.forEach(function(e){this.repeated>e[0]&&i.lock.forOne.push(e[1])},this),w.isArray(t.lock)&&(this.data.unique?i.lock.forAll.insert(t.lock):i.lock.forOne.insert(t.lock)),w.isArray(t.lockForAll)&&i.lock.forAll.insert(t.lockForAll),this.data.unique&&i.lock.forAll.push(this.getId()),t.build&&(i.build=t.build,e.build=w.an(E.get(t.build).name)),e.give=w.formatArray(i.give);var o=w.isFunction(t.log)?t.log(e,this):t.log||"";return i.log=S.personify(o,e),i},lock:function(){this.cancel(),this.tooltip.remove(),this.options?this.options.forEach(function(e){e.lock()}):this.parentAction&&this.parentAction.options.delete(this.getId()),this.remove()},cancel:function(){this.clickable.isRunning()&&(this.owner.setBusy(),this.html.classList.remove(o.RUNNING_CLASS),this.clickable.endCoolDown())},toJSON:function(){var e=this._toJSON();return e.rpt=this.repeated,this.clickable.isRunning()&&(e.elp=this.clickable.getElapsed(),e.rmn=this.clickable.getRemaining(),e.egd=this.energyDrain,e.opi=this.chosenOptionId),e}}),o.static({timeAndEnergyFallback:function(e){if(w.isUndefined(e.energy)&&!w.isUndefined(e.time)){e.energy=5*e.time}e.time=e.time||0}}),r.extends(n,"Building",{toHTML:w.noop,init:function(){this.data.lock&&A.notify(A.MSG_TYPES.LOCK,this.data.lock),this.data.unlock&&A.notify(A.MSG_TYPES.UNLOCK,this.data.unlock),w.isFunction(this.data.effect)&&this.data.effect(this,this.data),this.data.build&&A.notify(A.MSG_TYPES.BUILD,this.data.build)}}),a.static({TICK_LENGTH:2e3,REFRESH_RATE:200,holder:null}),a.extends(i,"GameController",{toHTML:function(){var e=this._toHTML();e.hide(),this.resourcesList=w.wrap(s.LST_ID,null,e);var t=w.wrap("topPart",null,e);this.peopleList=w.wrap(l.LST_ID,null,t),this.logsList=w.wrap("logs",null,t),this.visualPane=w.wrap("visualPane",null,e),this.incidentsList=w.wrap(c.LST_ID,null,e);var i=this,n=w.wrap("bottomOptions",null,e),o=new d("wipe","Clear save",function(){new f({name:"Clear save",desc:"Completely wipe the saved game. Careful, this is irreversible.",yes:{name:"Restart anew",action:i.wipeSave.bind(i,!0)},no:"Cancel"},"wipeIt")});n.appendChild(o.html);var r=new d("credits","Credits",function(){var e="<ul>";[{task:"Design and code",name:"Guillaume Martigny",url:"https://www.guillaume-martigny.fr/#en"},{task:"Graphics",name:"if you want your name here, send me an email",url:"mailto:https://www.guillaume-martigny.fr"}].forEach(function(t){e+="<li>"+t.task+": "+t.name.link(t.url)+"</li>"}),new f({name:"Settlement v0.5.2",desc:e+="</ul>"})});return n.appendChild(r.html),e},init:function(e){E.bindAll(this),a.holder.innerHTML="",a.holder.appendChild(this.html),k.start(this.visualPane,e.assets,{assets:e.assetsData,positions:e.buildingsData}),S.start(this.logsList),this.registerObservers(),L.hasData()?this.loadGame():(A.notify(A.MSG_TYPES.BUILD,E.ids.buildings.special.wreckage),this.initialActions.push(E.ids.actions.wakeUp),this.prepareNewcomer.defer(this)),localStorage.getItem("known")&&new f({name:"Early access [v0.5.2]",desc:"You'll see a very early stage of the game. It may be broken, it may not be balanced ...<br/>If you want to report a bug or anything to improve the game, go to <a href='https://github.com/GMartigny/settlement'>the project's page</a>.<br/><br/>Thanks for playing !",yes:{name:"Got it !",action:function(){localStorage.setItem("known","1")}}}),this.refresh(),this.show()},registerObservers:function(){var e=this,t=A.MSG_TYPES;A.observe(t.CLICK,function(t){e.saveGame(),y("Action","start",t.name)}).observe(t.ACTION_END,function(){e.saveGame()}).observe(t.GIVE,function(t){var i=null;if(t.initiator&&(i=t.initiator,t=t.give),w.isArray(t)){var n=[],s=document.createDocumentFragment();t.forEach(function(t){if(e.earn.apply(e,t),i){var o=t[1],r=E.get(o);if(r.icon)for(var a=e.resources.get(o),c=0;c<t[0];++c){var l=new m(r.icon,i,a);s.appendChild(l.html),n.push(l)}}}),n.length&&(a.holder.appendChild(s),m.batch.defer(null,n))}}).observe(t.USE,function(t){w.isArray(t)&&w.compactResources(t).forEach(function(t){e.consume.apply(e,t)})}).observe(t.START_BUILD,function(t){e.buildingsInProgress.push(t)}).observe(t.BUILD,this.build.bind(this)).observe(t.ARRIVAL,function(){y("People","arrive",e.getSettledTime())}).observe(t.LOOSE_SOMEONE,function(i){y("People","die",i.stats.age);var n=e.people.size<=0,s=n?"The last @common standing passed away. The last hope fades out in silence.":"@name just died, @possessive body is dragged outside and buried.";S.log(S.personify(s,i),S.LOG_TYPES.WARN),n&&A.notify(t.LOOSE)}).observe(t.LOOSE,function(){e.flags.gameOver=!0,y("Game","loose",e.getSettledTime())}).observe(t.INCIDENT_START,function(t){e.incidentsList.appendChild(t.html),e.incidents.push(t),e.saveGame()}).observe(t.INCIDENT_END,function(t){e.incidents.delete(t.getId()),t.data.unique||e.flags.incidents.out(t.getId()),e.saveGame()}).observe(t.LOCK,this.removeFromInitialActions.bind(this)).observe(t.UNLOCK,this.addToInitialActions.bind(this)).observe(t.WIN,function(){e.flags.win=!0,y("Game","win",e.getSettledTime())}).observe(t.KEYS.SPACE,function(t){"up"===t&&e.togglePause()})},addToInitialActions:function(e){w.isArray(e)||(e=[e]),e.forEach(function(e){this.initialActions.includes(e)||this.initialActions.push(e)},this),this.people.forEach(function(t){t.addAction(e)})},removeFromInitialActions:function(e){w.isArray(e)||(e=[e]),e.forEach(function(e){this.initialActions.out(e)},this),this.people.forEach(function(t){t.lockAction(e)})},getSettledTime:function(){return v.floor(this.flags.settled?this.flags.settled/a.TICK_LENGTH:0)},getSurvivalDuration:function(){return w.formatTime(this.getSettledTime())},togglePause:function(){this.flags.paused=!this.flags.paused,this.html.classList.toggle("paused",this.flags.paused),this.html.classList.toggle("backdrop",this.flags.paused),this.flags.paused?T.stopAll():(T.restartAll(),this.lastTick=w.getNow())},refresh:function(){var e=v.floor((w.getNow()-this.lastTick)/a.TICK_LENGTH);if(this.lastTick+=e*a.TICK_LENGTH,requestAnimationFrame(this.refresh.bind(this)),this.flags.win){if(!f.OPENED&&this.people.size){var t=this;new f({name:"The road ahead",desc:"From the rumors, much of the east coast have not been destroy by bombs. Some survivors have set new community from scratch.<br/>From what can be heard, those groups accept anyone willing to live peacefully. Let's find them !",yes:{name:"Let the journey begin ...",action:function(){t.people.forEach(function(e,t,i){e.hide(),i.delete(t)}),A.notify(A.MSG_TYPES.UNBUILD,E.ids.buildings.big.module),t.saveGame()}}})}}else if(this.flags.gameOver)f.OPENED||new f({name:"Lost",desc:"",yes:{name:"Try again",action:this.wipeSave.bind(this,!0)}});else if(!this.flags.paused){if(this.flags.settled){this.flags.settled+=e*a.TICK_LENGTH,this.tickConsumption(e);var i=E.get(E.ids.people).dropRate;this.canSomeoneArrive()&&v.random()<i&&this.prepareNewcomer(),!f.OPENED&&v.random()<c.DROP_RATE&&this.startIncident(this.getRandomIncident())}this.resources.forEach(function(e,t,i){e.refresh(i)}),this.people.forEach(function(t,i,n){t.isDead()?(n.delete(i),t.die()):t.refresh(this.resources,e,this.flags)},this),e&&this.saveGame()}},tickConsumption:function(e){E.get(E.ids.people).needs.forEach(function(t){var i=t[1];this.flags[t[2]]=0;var n=this.incidents.get(E.ids.incidents.hard.drought);i===E.ids.resources.gatherables.common.water&&n&&(t[0]*=n.data.multiplier);var s=this.people.size+this.flags.incidents.includes(E.ids.incidents.medium.strayDog),o=this.consume(t[0]*s*e,i,function(e){this.flags[t[2]]=e}),r=E.get(i);r.initialDropRate||(r.initialDropRate=r.dropRate);r.dropRate=o?r.initialDropRate:r.dropRate*v.pow(.98,e)},this)},hasEnough:function(e,t){return this.resources.has(e)&&this.resources.get(e).has(t)},consume:function(e,t,i){var n=!1;if(e){this.resources.has(t)||this.earn(0,t);var s=this.resources.get(t);if(s.has(e))s.update(-e),s.warnLack=!1;else{if(n=!0,w.isFunction(i)){var o=e-(s?s.count:0);i.call(this,o,t)}s.set(0),s.warnLack||(s.warnLack=!0,A.notify(A.MSG_TYPES.RUNS_OUT,t))}}return n},earn:function(e,t){if(this.resources.has(t))this.resources.get(t).update(e);else{var i=new s(t,e);this.resources.push(i),this.resourcesList.appendChild(i.html)}},prepareNewcomer:function(e){var t=this;l.peopleFactory(e||1).then(function(e){e.forEach(function(e){e.addAction(t.initialActions),t.people.size||(e.life=0,e.energy=0,e.updateLife(0),e.updateEnergy(0))}),t.arrive(e)})},arrive:function(e){w.isArray(e)||(e=[e]),e.forEach(function(e){if(this.people.size&&(A.notify(A.MSG_TYPES.ARRIVAL,e),1===this.people.size)){var t=S.personify("attracted by the crash a @common approach. @nominative accept to team up.",e);S.log(t,A.MSG_TYPES.LOGS.EVENT),T.timeout(function(){S.log("There's other wanderers ready to join if there's room for them.",A.MSG_TYPES.LOGS.QUOTE)},3*a.TICK_LENGTH)}this.addPeople(e),e.show.defer(e)},this)},addPeople:function(e){this.people.push(e),this.peopleList.appendChild(e.html);var t=this.people.size;this.people.forEach(function(e){e.html.style.zIndex=String(t--)})},build:function(e){if(this.buildingsInProgress.out(e),!this.buildings.has(e)){var t=new r(e);this.buildings.push(t),t.data.upgrade&&this.buildings.delete(t.data.upgrade),y("Building","built",t.data.name)}},unlockedCraftables:function(){var e=[];return E.ids.resources.craftables.deepBrowse(function(t){var i=E.get(t);i.ifHas&&!this.buildings.has(i.ifHas)||!(!i.condition||w.isFunction(i.condition)&&i.condition())||e.push(t)},this),e},possibleCraftables:function(){var e=this;return this.unlockedCraftables().filter(function(t){var i=E.get(t),n=!0;return w.isFunction(i.consume)&&i.consume(i).forEach(function(t){n=n&&e.hasEnough(t[1],t[0])}),n})},possibleBuildings:function(){var e=[];return E.ids.buildings.deepBrowse(function(t){var i=E.get(t);i.shadow||this.isBuildingInProgress(t)||this.isBuildingDone(t)||i.upgrade&&!this.buildings.has(i.upgrade)||i.ifHas&&!this.isBuildingDone(i.ifHas)||e.push(t)},this),e},isBuildingInProgress:function(e){return this.buildingsInProgress.includes(e)},isBuildingDone:function(e){var t=!1;return this.buildings.forEach(function(i){if(!t){var n=i.getId(),s=i.data.upgrade;for(t=t||n===e;s&&!t;)n=s,s=E.get(n).upgrade,t=t||n===e}},this),t},canSomeoneArrive:function(){return this.hasEnough(E.ids.resources.room,this.people.size+1)},getRandomIncident:function(){var e=[],t=this.getSettledTime()/E.time.week;return{1:E.ids.incidents.easy,2:E.ids.incidents.medium,5:E.ids.incidents.hard}.browse(function(i,n){t>n&&e.insert(i)}),(e=e.filter(function(e){var t=E.get(e);return!this.incidents.has(e)&&(!t.condition||w.isFunction(t.condition)&&t.condition())},this)).length?w.randomize(e):null},startIncident:function(e){if(e&&!this.flags.incidents.includes(e)){var t=new c(e);this.flags.incidents.push(t.getId()),t.start(),this.saveGame(),y("Incident","start",t.data.name)}},saveGame:function(){this.flags.gameOver||L.persist(this)},toJSON:function(){var e={flg:this.flags,res:this.resources.getValues(),plp:this.people.getValues(),iac:this.initialActions,bld:this.buildings.getValues(),inc:this.incidents.getValues(),lct:this.knownLocations,bip:this.buildingsInProgress,upk:u.usedId,vrn:"v0.5.2"};return delete e.flg.paused,delete e.flg.popup,e},loadGame:function(){y("Game","reload");var e=L.load(),t=this;(e.vrn&&e.vrn.substr(0,e.vrn.lastIndexOf(".")))!=="v0.5.2".substr(0,"v0.5.2".lastIndexOf("."))&&new f({name:"New version",desc:"Since the last time you played, a new version of the game has been released.<br/>You may want to restart to experience all the cool new features. ;)<br/><a href='https://github.com/GMartigny/settlement#changelog'>Changelog</a>"}),A.notify(A.MSG_TYPES.GIVE,e.res),e.bld.forEach(function(e){A.notify(A.MSG_TYPES.BUILD,e.id)}),e.inc.forEach(function(e){var t=new c(e.id);e.rmn&&t.run(e.rmn)}),e.plp.forEach(function(e){var i=new l(e.nam,e.gnd);i.setLife(e.lif),i.setEnergy(e.ene),i.stats=e.sts,e.prk&&i.gainPerk(e.prk),e.act.forEach(function(e){i.addAction(e.id);var t=i.actions.get(e.id);t.repeated=e.rpt,e.rmn&&(t.choosenOptionId=e.opi,t.energyDrain=e.egd,t.start(e.rmn,e.elp))}),t.addPeople(i),i.show()}),u.usedId=e.upk,this.addToInitialActions(e.iac),this.knownLocations=e.lct,this.buildingsInProgress=e.bip,this.flags=e.flg},wipeSave:function(e){y("Game","wipe"),L.clear(),e&&location.reload()}}),c.DROP_RATE=.01,c.DEFAULT_COLOR="#164b80",c.extends(n,"Incident",{init:function(){this.tooltip=new p(this.html,this.data);var e=this.data.yes;this.data.yes={name:e,action:this.run.bind(this)};var t=this.data.no;this.data.no={name:t,action:this.end.bind(this)}},toHTML:function(){var e=this._toHTML();return this.data.time&&(this.nameNode=w.wrap("name",w.capitalize(this.data.name),e),this.progressBar=new h("timer animated",this.data.color||c.DEFAULT_COLOR),e.appendChild(this.progressBar.html),e.hide()),e},run:function(e){var t={incident:this.data};w.isArray(this.data.consume)&&(t.consume=this.data.consume),w.isFunction(this.data.onStart)&&this.data.onStart(this,t),w.isArray(t.consume)&&A.notify(A.MSG_TYPES.USE,t.consume);var i=0;this.data.time&&(A.notify(A.MSG_TYPES.INCIDENT_START,this),this.show(),i=e||this.defineDuration(),this.progressBar.run(i)),this.timer=T.timeout(this.end.bind(this),i);var n=w.isFunction(this.data.log)?this.data.log(t,this):this.data.log||"";S.log(S.personify(n,t))},defineDuration:function(){var e=this.data.time;return this.data.timeDelta&&(e+=v.random(-this.data.timeDelta,this.data.timeDelta)),e*a.TICK_LENGTH},start:function(){w.isFunction(this.data.effect)&&this.data.effect(this),new f(this.data,"incident")},cancel:function(){this.timer&&(T.stop(this.timer),this.end())},end:function(){this.timer=null,A.notify(A.MSG_TYPES.INCIDENT_END,this);var e={incident:this.data};if(w.isArray(this.data.give)?e.give=this.data.give:this.data.giveList&&this.data.giveSpan&&(e.give=w.randomizeMultiple(this.data.giveList,this.data.giveSpan)),w.isFunction(this.data.onEnd)&&this.data.onEnd(this,e),w.isArray(e.give)&&(A.notify(A.MSG_TYPES.GIVE,{initiator:this.nameNode,give:e.give}),e.give=w.formatArray(e.give)),e.log){var t=S.personify(e.log,e);S.log(t,S.LOG_TYPES.EVENT)}this.remove(),this.tooltip.remove()},toJSON:function(){var e=this._toJSON();return this.timer&&(e.rmn=T.getRemaining(this.timer)),e}}),c.LST_ID="incidentList",l.extends(i,"People",{init:function(){this.setPronouns(),new p(this.lifeBar.html,{name:"Health",desc:"The first thing anyone want is a good health."}),new p(this.energyBar.html,{name:"Energy",desc:"Drained faster when busy or hungry."})},toHTML:function(){var e=this._toHTML();this.nameNode=w.wrap("name",w.capitalize(this.name),e);return this.lifeBar=new h("life","#f52158",25),e.appendChild(this.lifeBar.html),this.energyBar=new h("energy","#19f5ba"),e.appendChild(this.energyBar.html),this.actionList=w.wrap("actionList",null,e),e.hide(),e},refresh:function(e,t,i){if(this.actions.forEach(function(t){t.refresh(e,i)}),i.settled){this.stats.age+=t,this.stats.idle+=t;var n=this.energyDrain+30*i.starving;this.updateEnergy(-t*n);var s=0;i.thirsty&&(s+=30*i.thirsty);var o=E.get(this.busy);i.incidents.includes(E.ids.incidents.medium.acidRain)&&o&&o.isOut&&(s+=E.get(E.ids.incidents.medium.acidRain).lifeLose),this.updateLife(-t*s)}},setPronouns:function(){switch(this.gender){case"female":this.common="woman",this.nominative="she",this.accusative="her",this.possessive="her",this.reflexive="herself";break;case"male":this.common="man",this.nominative="he",this.accusative="him",this.possessive="his",this.reflexive="himself";break;default:this.common="robot",this.nominative="it",this.accusative="it",this.possessive="its",this.reflexive="itself"}},setBusy:function(e,t){this.busy=e||!1,e?(e!==E.ids.actions.sleep&&(this.stats.idle=0),this.energyDrain=t):this.energyDrain=1,this.html.classList.toggle("busy",this.busy)},finishAction:function(){this.rollForPerk(this.busy),this.setBusy()},updateEnergy:function(e){var t=this.energy+=e;return t>l.MAX_BAR_VALUE?t=l.MAX_BAR_VALUE:t<0&&(this.updateLife(t),t=0),this.setEnergy(t),this.energy},setEnergy:function(e){this.energy=e,this.energyBar.set(e)},isTired:function(){return this.energy.equals(0)||this.energy<0},updateLife:function(e){var t=this.life+e;return t>l.MAX_BAR_VALUE&&(t=l.MAX_BAR_VALUE),this.setLife(t),t},setLife:function(e){this.life=e,this.lifeBar.set(e)},addAction:function(e){w.isArray(e)||(e=[e]),e.forEach(function(e){if(!this.actions.has(e)){var t=new o(e,this);this.actions.push(t),this.actionList.appendChild(t.html)}},this)},lockAction:function(e){w.isArray(e)||(e=[e]),e.forEach(function(e){var t=this.actions.get(e);t&&(t.lock(),this.actions.delete(e))},this)},rollForPerk:function(e){var t=!1;if(!this.perk){var i=this;E.ids.perks.deepBrowse(function(n){if(!u.isUsed(n)){var s=E.get(n),o=s.actions;if((!o||o.includes(e))&&(!w.isFunction(s.condition)||s.condition(i))){var r=0;(r=(r=o?o.reduce(function(e,t){var n=i.actions.get(t);return e+(n?n.repeated:0)},0)/(s.iteration||0):1/(s.iteration||0))<1?0:r)&&v.random()<r&&(i.gainPerk(n),A.notify(A.MSG_TYPES.GAIN_PERK,i),t=!0)}}})}return t},gainPerk:function(e){this.perk=new u(e,this),this.nameNode.appendChild(this.perk.html)},hasPerk:function(e){return this.perk&&this.perk.getId()===e},isDead:function(){return this.life<0},die:function(){A.notify(A.MSG_TYPES.LOOSE_SOMEONE,this),this.actions.forEach(function(e){e.cancel(),e.tooltip.remove()}),this.hide(this.remove)},toJSON:function(){var e={nam:this.name,gnd:this.gender,lif:this.life,ene:this.energy,sts:this.stats,act:this.actions.getValues()};return this.perk&&(e.prk=this.perk.getId()),e}}),l.static({LST_ID:"peopleList",MAX_BAR_VALUE:100,peopleFactory:function(e){e=e||1;return this.randomName(e).then(function(e){var t=[];return e.results.forEach(function(e){var i=new l(w.capitalize(e.name.first),e.gender);t.push(i)}),t})},randomName:function(e){return new Promise(function(t,i){var n="https://randomuser.me/api?inc=gender,name&nat="+["AU","BR","CA","CH","DE","DK","ES","FI","FR","GB","IE","NL","NZ","TR","US"].join(",")+"&noinfo&results="+(e||1);fetch(n).then(function(e){e.ok?e.json().then(t):i(new URIError("["+e.status+"] "+n+" "+e.statusText))})})}}),u.extends(n,"Perk",{init:function(){this.data.desc=S.personify(this.data.desc,{people:this.owner}),new p(this.html,this.data),w.isArray(this.data.unlock)&&this.owner.addAction(this.data.unlock),w.isArray(this.data.lock)&&this.owner.lockAction(this.data.lock)},toHTML:function(){var e=this._toHTML();return e.textContent='the "'+w.capitalize(this.data.name)+'"',e}}),u.static({usedId:[],isUsed:function(e){return this.usedId.includes(e)}}),h.extends(i,"Bar",{toHTML:function(){var e=this._toHTML();return this.valueBar=w.wrap("value",null,e),e},setColor:function(e){this.html.style.backgroundColor=b.fade(e,.2),this.valueBar.style.backgroundColor=e},set:function(e){e.equals(this.value)||(this.value=e,this.valueBar.style.width=e+"%",this.html.classList[e<this.threshold?"add":"remove"]("warning"))},run:function(e){this.valueBar.style.animationDuration=v.toNumber(e,0)+"ms",this.html.classList.add("ongoing")}}),d.extends(i,"Clickable",{toHTML:function(){var e=this._toHTML();return e.textContent=this.text,e.tabIndex=0,e},startCoolDown:function(e,t,i){var n=this;this.html.style.animationDuration=e+"ms",this.html.style.animationDelay=-t+"ms",this.html.classList.add("cooldown"),this.timeout=T.timeout(function(){n.endCoolDown(),i()},e-t)},setAction:function(e){w.isFunction(e)&&this.html.addEventListener("click",e,!0)},isRunning:function(){return Boolean(this.timeout)},endCoolDown:function(){this.isRunning()&&(T.clear(this.timeout),this.timeout=null,this.html.style.animationDuration="",this.html.style.animationDelay="",this.html.classList.remove("cooldown"))},toggle:function(e){this.html.classList.toggle("disabled",!e);this.html.tabIndex=e?0:-1},setText:function(e){this.text=e,this.html.textContent=e},getElapsed:function(){return T.getElapsed(this.timeout)},getRemaining:function(){return T.getRemaining(this.timeout)},setAsDropdown:function(e){this.html.classList.toggle("dropdown",e)}}),m.extends(i,"Particle",{distance:null,toHTML:function(){var e=this._toHTML();return e.style.transitionDuration=m.transitionDuration+"ms",e},init:function(e,t){this.hide();var i=e.html.getBoundingClientRect(),n={left:i.left+i.width/2,top:i.top+i.height/2};this.html.style.left=n.left+"px",this.html.style.top=n.top+"px";var s=t.html.getBoundingClientRect(),o={left:s.left+s.width/2,top:s.top+s.height/2};setTimeout(function(){t.animate("more")},2*m.transitionDuration),this.distance={left:o.left-n.left,top:o.top-n.top}},animate:function(e,t){this.html.style.transform="translate3d("+e.left+"px, "+e.top+"px, 0)",this.html.style.transitionTimingFunction=t||""}}),m.static({transitionDuration:600,transitionWait:150,flyingDistance:40,batch:function(e){e.forEach(function(e){e.show();var t=v.random(v.PI2);e.animate({left:v.cos(t)*m.flyingDistance,top:v.sin(t)*m.flyingDistance},"cubic-bezier(.2,.5,.5,1)")}),setTimeout(function(){e.forEach(function(e){e.animate(e.distance,"cubic-bezier(.5,0,.8,.5)")}),setTimeout(function(){e.forEach(function(e){e.remove()})},m.transitionDuration)},m.transitionDuration+m.transitionWait)}}),f.extends(i,"Popup",{toHTML:function(){var e=this._toHTML();w.wrap("title",w.capitalize(this.data.name),e),w.wrap("description",this.data.desc,e);var t=this.data.yes&&this.data.yes.action||w.noop,i=new d("yes",this.data.yes&&this.data.yes.name||w.isString(this.data.yes)&&this.data.yes||"Ok",this.hide.bind(this,t));if(e.appendChild(i.html),this.data.no){var n=this.data.no.action||w.noop,s=new d("no",this.data.no.name||w.isString(this.data.no)&&this.data.no||"Cancel",this.hide.bind(this,n));e.appendChild(s.html)}return e.hide(),e},show:function(e){f.OPENED=!0,f.HOLDER.classList.add("backdrop"),f.HOLDER.appendChild(this.html),this.html.style.top=v.floor((f.HOLDER.offsetHeight-this.html.offsetHeight)/2)+"px",this._show(e)},hide:function(e){f.OPENED=!1,this.remove(),this._hide(e)},remove:function(){this._remove(),f.HOLDER.classList.remove("backdrop")}}),f.static({HOLDER:document.body,OPENED:!1}),p.extends(i,"Tooltip",{init:function(e){this.refresh(new Map,e),this._mouseOver();var t=this.html.getBoundingClientRect();this.width=t.width,this.height=t.height,this._mouseOut(),this._addEvents()},_setPosition:function(e,t){var i=p.getWrapperSize(),n=v.constrain(e+10,0,i.width-this.width),s=v.constrain(t+10,0,i.height-this.height);this.html.style.left=n+"px",this.html.style.top=s+"px"},_mouseOver:function(){a.holder.appendChild(this.html)},_mouseOut:function(){this.remove()},_mouseMove:function(e){this._setPosition(e.clientX,e.clientY)},_addEvents:function(){this.container.classList.add("tooltiped"),this.container.addEventListener("mouseover",this._mouseOver.bind(this)),this.container.addEventListener("mousemove",this._mouseMove.bind(this)),this.container.addEventListener("mouseout",this._mouseOut.bind(this))},_removeEvents:function(){this.container.classList.remove("tooltiped"),this.container.removeEventListener("mouseover",this._mouseOver),this.container.removeEventListener("mousemove",this._mouseMove),this.container.removeEventListener("mouseout",this._mouseOut)},toHTML:function(){var e=this._toHTML();return this.nodes.name=w.wrap("title",null,e),this.nodes.desc=w.wrap("description",null,e),this.nodes.time=w.wrap("time",null,e),this.nodes.resourcesContainer=w.wrap("consumption",null,e),e},refresh:function(e,t){this.nodes.name.textContent=w.capitalize(t.name),t.desc?this.nodes.desc.innerHTML=t.desc:this.nodes.desc.remove(),t.time?this.nodes.time.textContent=w.formatTime(t.time):this.nodes.time.remove(),w.isArray(t.consume)?t.consume.forEach(function(t){var i=t[1],n=this.resourcesMapper[i];if(!n){var o=E.get(i),r=w.wrap("resource not-enough",null,this.nodes.resourcesContainer);r.style.order=o.order;var a=w.wrap("counter",null,r);w.wrap(null,s.toString(o,t[0]),r),n={node:r,counter:a},this.resourcesMapper[i]=n}var c=(e.has(i)||0)&&e.get(i).get(),l=c<t[0];n.counter.textContent=l?c+"/":"",n.node.classList.toggle("not-enough",l)},this):this.nodes.resourcesContainer.remove()}}),p.static({wrapperSizeCache:null,getWrapperSize:function(){if(!this.wrapperSizeCache){var e=a.holder.getBoundingClientRect();this.wrapperSizeCache={width:e.width,height:e.height}}return this.wrapperSizeCache}}),window.addEventListener("resize",function(){p.wrapperSizeCache=null})}("undefined"==typeof window?window={}:window);