window.VERSION='v0.1.3';!function(){"use strict";function a(a,b){this.holder=a,this.media=b,this.resources=new i,this.buildings=new i,this.events=new i,this.collects=[],this.people=[],this.initialActions=new i,this.knownLocations=new i,this.flags={ready:!1,paused:!1,settled:!1,survived:0,popup:!1,productivity:1},this.lastTick=performance.now(),this._init(),this.refresh()}function b(){if(b.instance)throw"An instance already exists.";this.observers={}}function c(a,b){this.locked=!0,this.running=!1,this.owner=a,this.repeated=0,this.data={},this.location=!1,this.html=this.toHTML(b),this._init(b)}function d(a){this.number=0,this._init(a),this.add(1)}function e(a){this.data={},this.timer=null,this.html=this.toHTML(),this._init(a)}function f(a){return a=a||1,new Promise(function(b,c){window.isDev?b(new Array(a).fill(new g("John Doe","male"))):g.randomName(a).then(function(a){try{var d=JSON.parse(a.target.response).results,e=[];d.forEach(function(a){var b=t(a.name.first)+" "+t(a.name.last),c=new g(b,a.gender);e.push(c)}),b(e)}catch(a){c(a)}})})}function g(a,b){this.name=a,this.gender=b,this.actions=new i,this.busy=!1,this.energy=100,this.starving=!1,this.life=100,this.thirsty=!1,this.plan=null,this.html=this.toHTML()}function h(a,b){this.data={},this.html=this.toHTML(a),this._init(a),this.count=0,b&&this.update(+b)}function i(){this.items={},this.length=0}function j(a){return a<<0}function k(a){return j(a+.5)}function l(a,b){return a=+a||0,void 0===b?(b=0===a?1:a,a=0):b=+b,L()*(b-a)+a}function m(a,b,c){if(!B(b))throw"Popup need a confirm function";var d=document.getElementById("main");c="popup"+(c?" "+c:"");var e=o(c);e.appendChild(o("title",t(a.name))),e.appendChild(o("description",a.desc));var f={remove:function(){e.remove(),d.classList.remove("backdrop")}},g=o("yes clickable",a.yes||"Ok");if(g.addEventListener("click",function(){b(),f.remove()}),e.appendChild(g),a.no){var h=o("no clickable",a.no);h.addEventListener("click",f.remove),e.appendChild(h)}return d.appendChild(e),d.classList.add("backdrop"),e.style.top=j((d.offsetHeight-e.offsetHeight)/2)+"px",f}function n(a,b){function c(a,b){document.body.appendChild(d);var c=a+10;c+255>e&&(c=e-255),d.style.left=c+"px",d.style.top=b+10+"px"}var d=null,e=document.body.offsetWidth;a.classList.add("tooltiped"),a.addEventListener("mouseover",function(a){c(a.clientX,a.clientY)}),a.addEventListener("mousemove",function(a){c(a.clientX,a.clientY)}),a.addEventListener("mouseout",function(){d.remove()});var f={},g={update:function(a){if(d=o("tooltip"),d.appendChild(o("title",t(a.name))),a.desc&&d.appendChild(o("description",a.desc)),a.time&&d.appendChild(o("time",p(a.time))),a.consume){var b,c=o("consumption");a.consume.forEach(function(a){b=o("resource not-enough",a[0]+" "+a[1].name),f[a[1].id]=b,c.appendChild(b)}),d.appendChild(c)}return g},refresh:function(a,c){if(b.consume){var d;c.forEach(function(b){d=b[1].id,a.has(d)&&a.get(d).has(b[0])?f[d].classList.remove("not-enough"):f[d].classList.add("not-enough")})}return g},remove:function(){return d.remove(),g}};return g.update(b),g}function o(a,b){var c=document.createElement("div");return a&&c.classList.add.apply(c.classList,a.split(" ")),b&&(c.innerHTML=b),c}function p(a){var b=["year","month","day","hour","minute"],c=[],d=I.time;return b.forEach(function(b){if(a>=d[b]){var e=j(a/d[b]);a%=d[b],c.push(e+" "+s(b,e))}}),r(c)}function q(a){var b=[];return a.forEach(function(a){var c=s(a[1].name,a[0]);a[1].icon&&(c+=" "+o("icon icon-"+a[1].icon).outerHTML),b.push(a[0]+" "+c)}),r(b)}function r(a,b){return b=b||"and",a.length>1?(a[a.length-2]+=" "+b+" "+a.pop(),a.join(", ")):a.length?a[0]:""}function s(a,b){return a+(b>1?"s":"")}function t(a){return a=a.replace(/([\.!\?]) ([a-z])/g,function(a,b,c){return b+" "+c.toUpperCase()}),a[0].toUpperCase()+a.slice(1)}function u(a,b){if(!a.values().length)throw"Can't pick from empty list";var c={},d=[],e=0;x(a,function(a){a.dropRate&&(e+=a.dropRate,d.push(e),c[e]=a)});var f=k(l(e));d.sort();for(var g=0,h=d.length;g<h;++g)if(d[g]>f){f=d[g];break}return b?[k(l.apply(null,b.split("-"))),c[f]]:c[f]}function v(a,b){for(var c=[],d=b.split("-"),e=d[0],f=d[1],g=0,h=k(l(1,e));g<h;++g)c.push([j(l(e/h,f/h)),u(a)]);return c}function w(a){window.isDev&&console.log(a)}function x(a,b){for(var c in a)a.hasOwnProperty(c)&&(a[c].name?b(a[c]):x(a[c],b));return a}function y(a){return Object.assign({},a)}function z(a,b,c){c=c||Object.keys(b);var d=y(b);return c.forEach(function(b){d[b]&&B(d[b])&&(d[b]=d[b](a))}),d}function A(){var a="------".replace(/-/g,function(){return k(l(36)).toString(36)});return A.IDS.includes(a)?A():(A.IDS.push(a),a)}function B(a){return a instanceof Function}function C(a){return Array.isArray(a)}function D(a){return void 0===a}function E(a){var b="aeiou".split("");return(b.includes(a[0])?"an":"a")+" "+a}function F(a){return a.reduce(function(a,b){var c=a.find(function(a){return a[1].id===b[1].id});return c?c[0]+=b[0]:b[0]>0&&a.push(b),a},[])}function G(a,b){var c=0;return Promise.all(a.map(function(d){return new Promise(function(a,b){var c=new Image;c.onload=a.bind(null,c),c.onerror=b,c.src=d}).then(function(e){return b(++c/a.length*100,d),e}).catch(function(){console.log("Can't load "+d)})}))}console.groupCollapsed("Loading");var H;G(["dist/img/icons.png"],function(a,b){console.log(b+" : "+a+"%")}).then(function(b){console.groupEnd();try{H=new a(document.getElementById("main"),b)}catch(a){console.warn("Fail to load game : "+a.message)}}),a.tickLength=2e3,a.prototype={_init:function(){w("Starting "+window.VERSION);var a=this;x(I.data,function(b){b.id=A();for(var c in b)b.hasOwnProperty(c)&&B(b[c])&&(b[c]=b[c].bind(a))}),this.initialActions.push(I.data.actions.wakeUp),window.onkeypress=function(a){switch(a.keyCode){case 32:this.togglePause()}}.bind(this),this.resourcesList=o(),this.resourcesList.id=h.LST_ID,this.holder.appendChild(this.resourcesList),this.peopleList=o(),this.peopleList.id=g.LST_ID,this.holder.appendChild(this.peopleList),this.buildingsList=o(),this.buildingsList.id=d.LST_ID,this.holder.appendChild(this.buildingsList),this.eventsList=o(),this.eventsList.id=e.LST_ID,this.holder.appendChild(this.eventsList),this.logsList=o(),this.logsList.id="logs",this.holder.appendChild(this.logsList),K.timeout(this.welcome.bind(this,1,!0),500),b.getInstance().observe(b.MSG_TYPES.GIVE,function(a){C(a)&&a.forEach(function(a){this.earn.apply(this,a)}.bind(this))}.bind(this)),b.getInstance().observe(b.MSG_TYPES.COLLECT,function(a){C(a)&&F(this.collects.concat(a))}.bind(this)),b.getInstance().observe(b.MSG_TYPES.USE,function(a){C(a)&&F(a).forEach(function(a){this.consume.apply(this,a)}.bind(this))}.bind(this)),b.getInstance().observe(b.MSG_TYPES.BUILD,function(a){a&&this.build(a)}.bind(this)),b.getInstance().observe(b.MSG_TYPES.LOOSE_SOMEONE,function(a){this.log("We loose "+a.name,b.MSG_TYPES.LOGS.WARN),this.people.out(a),this.people.length<=0&&(this.log("We held up for "+this.getSurvivalDuration()),this.flags.paused=!0)}.bind(this)),b.getInstance().observe(b.MSG_TYPES.EVENT_START,function(a){this.events.push(a.data.id,a),this.flags.popup=!1}.bind(this)),b.getInstance().observe(b.MSG_TYPES.EVENT_END,function(a){this.events.pop(a.data.id)}.bind(this)),b.getInstance().observe(b.MSG_TYPES.LOCK,function(a){this.removeFromInitialActions(a)}.bind(this)),b.getInstance().observe(b.MSG_TYPES.UNLOCK,function(a){this.addToInitialActions(a)}.bind(this));var c=b.MSG_TYPES.LOGS.values();b.getInstance().observe(c,function(a,b){this.log(a,b)}.bind(this)),this.flags.ready=!0},addToInitialActions:function(a){C(a)||(a=[a]),a.forEach(function(a){this.initialActions.push(a)}.bind(this)),this.people.forEach(function(b){b.addAction(a)})},removeFromInitialActions:function(a){C(a)||(a=[a]),a.forEach(function(a){this.initialActions.pop(a.id)}.bind(this)),this.people.forEach(function(b){b.lockAction(a)})},getSettledTime:function(){return this.flags.settled?this.flags.survived/a.tickLength:0},getSurvivalDuration:function(){return p(this.getSettledTime())},log:function(a,b){if(a.length){b=b||0;var c={0:"info",1:"warning",2:"flavor",3:"event"};this.logsList.insertBefore(o("log "+c[b],a),this.logsList.firstChild);var d=Array.prototype.slice.call(this.logsList.children);d.length>J.maxLog&&d.last().remove()}},togglePause:function(){this.flags.paused=!this.flags.paused,this.holder.classList.toggle("paused",this.flags.paused),this.flags.paused?K.stopAll():K.restartAll()},refresh:function(){var b=performance.now(),c=j((b-this.lastTick)/a.tickLength);if(this.lastTick+=c*a.tickLength,this.flags.paused&&(c=0),setTimeout(this.refresh.bind(this),a.tickLength/3),c>0){if(this.flags.settled){this.flags.survived+=c*a.tickLength;var d=I.data.people.need();if(d.forEach(function(a){var b=I.data.resources.gatherable.common.water.id,c=a[1].id===b?"thirsty":"starving";this.consume(a[0]*this.people.length,a[1],function(a){this.people.forEach(function(b,d,e){b[c]=a/e.length})})}.bind(this)),this.canSomeoneArrive()&&this.welcome(),!this.flags.popup&&l()<I.data.events.dropRate){var f=this.getRandomEvent();if(f){var g=new e(f);g.start(function(a){a.data.time&&this.eventsList.appendChild(a.html),this.flags.popup=!1}.bind(this)),this.flags.popup=!0}}}this.resources.forEach(function(a,b,c){a.refresh(c)}),this.people.forEach(function(a){a.refresh(this.resources,c,this.flags)}.bind(this)),this.save()}},getState:function(){function a(a){return a.values().map(function(a){return a.getState()})}return{flags:this.flags,people:a(this.people),resources:a(this.resources),buildings:a(this.buildings),events:a(this.events),collects:a(this.collects),initialAction:this.initialActions.values(),knownLocations:this.knownLocations.values()}},save:function(){},hasEnough:function(a,b){return this.resources.get(a).has(b)},consume:function(a,c,d){if(a){var e=this.resources.get(c.id);if(e&&e.has(a))e.update(-a),e.warnLack=!1;else if(B(d)){var f=a-e.get();if(e.set(0),d.call(this,f,c),!e.warnLack){e.warnLack=!0;var g="We run out of "+c.name+", we need to do something.";this.log(b.MSG_TYPES.LOGS.WARN,g)}}}},earn:function(a,b){var c=b.id;if(this.resources.has(c))this.resources.get(c).update(a);else{var d=new h(b,a);this.resources.push(c,d),this.resourcesList.appendChild(d.html)}},welcome:function(a,c){f(a).then(function(a){a.forEach(function(a){a.addAction(this.initialActions.values()),this.people.push(a),this.peopleList.appendChild(a.html),c?(a.life=0,a.energy=0,a.updateLife(0),a.updateEnergy(0)):(a.html.offsetHeight,this.log(a.name+" arrives.",b.MSG_TYPES.LOGS.EVENT)),a.html.classList.add("arrived")}.bind(this))}.bind(this))},build:function(a){var b=a.id;if(this.buildings.has(b))this.buildings.get(b).add(1);else{var c=new d(a);this.buildings.push(b,c),this.buildingsList.appendChild(c.html),B(a.lock)&&this.removeFromInitialActions(a.lock(c)),B(a.unlock)&&this.addToInitialActions(a.unlock(c))}},possibleCraftables:function(){var a=[],b=this.resources.items,c=I.data.resources.craftable.basic;return x(c,function(c){var d=!0;c.consume&&B(c.consume)&&c.consume(c).forEach(function(a){d=d&&b[a[1].id]&&b[a[1].id].has(a[0])}),d&&a.push(c)}),a},possibleBuildings:function(){var a=[],b=this.buildings;return x(I.data.buildings,function(c){(!c.unique||c.unique&&!b.has(c.id))&&a.push(c)}),a},canSomeoneArrive:function(){return this.hasEnough(I.data.resources.room.id,this.people.length+1)&&l()<I.data.people.dropRate&&this.getSettledTime()/I.time.day>2},getRandomEvent:function(){var a=[],b=this.getSettledTime()/I.time.week;return b>1&&(a.push.apply(a,I.data.events.easy.values()),b>2&&(a.push.apply(a,I.data.events.medium.values()),b>5&&a.push.apply(a,I.data.events.hard.values()))),a=a.filter(function(a){return!this.events.has(a.id)&&(!a.condition||B(a.condition)&&a.condition(a))}.bind(this)),!!a.length&&u(a)},debug:{oneOfEach:function(){return x(I.data.resources,function(a){this.earn(1,a)}.bind(this)),this}}};var I=function(){var a={minute:1/60,hour:1,day:24,week:168,month:720,year:8640},c=["north","south","east","west","north-east","north-west","south-east","south-west"],d={resources:{gatherable:{common:{water:{name:"water",desc:"Water is definitely important to survive in this harsh environment.",icon:"water-bottle",dropRate:130,order:10},food:{name:"food",desc:"Everyone need food to keep his strength.",icon:"foodcan",dropRate:120,order:20},rock:{name:"rock",desc:'"There\'s rocks everywhere ! Why would you bring this back ?"',icon:"rock",dropRate:100,order:30},scrap:{name:"scrap metal",desc:"An old rusty piece of metal.",icon:"scrap-metal",dropRate:80,order:40}},uncommon:{plastic:{name:"plastic",desc:"A sturdy piece of plastic.",icon:"jerrican",dropRate:60,order:50},sand:{name:"sand",desc:"It's pure fine sand.",icon:"sand-pile",dropRate:30,order:55},oil:{name:"oil",desc:"About a liter of gas-oil.",icon:"oil-bucket",dropRate:20,order:60}},rare:{medication:{name:"medication",desc:"An unmark medication, hope it'll help.",icon:"medication",dropRate:10,order:70},electronic:{name:"electronic",desc:"Basic micro-electronics components.",icon:"electronic-parts",dropRate:15,order:75}}},craftable:{basic:{stone:{name:"smooth stone",desc:"A well polish stone.",icon:"stone",consume:function(){return[[6,d.resources.gatherable.common.rock]]},dropRate:100,order:90},glass:{name:"glass pane",desc:"",icon:"glass-pane",consume:function(){return[[4,d.resources.gatherable.uncommon.sand]]},dropRate:100,order:100},component:{name:"component",desc:"A mechanical part for others craftables.",icon:"pipe-large",consume:function(){return[[2,d.resources.gatherable.common.scrap],[2,d.resources.gatherable.uncommon.plastic]]},dropRate:100,order:110},tool:{name:"tool",desc:"The base of any tinkerer.",icon:"tool",consume:function(){return[[2,d.resources.craftable.basic.component],[3,d.resources.gatherable.common.rock]]},dropRate:90,order:111}},complex:{brick:{name:"brick",desc:"Bricks will give wall to larger constructions.",icon:"brick",consume:function(){return[[3,d.resources.craftable.basic.stone],[1,d.resources.craftable.basic.tool]]},dropRate:80,order:112},circuit:{name:"circuit",desc:"That's a little rough, but it's actually a functioning circuit board.",icon:"circuit-board",consume:function(){return[[2,d.resources.gatherable.common.scrap],[1,d.resources.craftable.basic.component],[1,d.resources.gatherable.rare.electronic]]},dropRate:70,order:114},metalPipe:{name:"metal pipe",desc:"Simple pipes that you smith from junk metal.",icon:"pipe-small",consume:function(){return[[5,d.resources.gatherable.common.scrap],[1,d.resources.craftable.basic.tool]]},condition:function(){return this.buildings.has(d.buildings.medium.forge.id)},dropRate:70,order:115}},advanced:{engine:{name:"engine",desc:"Amazing what you manage to do with all those scraps !",icon:"engine",consume:function(){return[[15,d.resources.gatherable.uncommon.oil],[5,d.resources.craftable.basic.tool],[5,d.resources.craftable.complex.metalPipe]]},condition:function(){return this.buildings.has(d.buildings.big.workshop.id)},dropRate:30,order:120},computer:{name:"computer",desc:"Well, Internet is down since 2136 but it can still be useful.",icon:"computer",consume:function(){return[[10,d.resources.craftable.basic.component],[7,d.resources.craftable.basic.tool],[3,d.resources.craftable.complex.circuit]]},condition:function(){return this.buildings.has(d.buildings.big.workshop.id)},dropRate:20,order:130},beacon:{name:"beacon",desc:"",icon:"radio-station",consume:function(){return[[6,d.resources.craftable.basic.glass],[4,d.resources.craftable.complex.circuit],[1,d.resources.craftable.advanced.computer]]},give:function(){return d.people.dropRate=.9,[]},dropRate:10,order:140}}},ruins:{name:"location",desc:"Directions to a point of interest we found earlier.",icon:"map",order:80,dropRate:.6},room:{name:"room",desc:"A place for someone in the camp.",icon:"person",order:0}},people:{name:"people",desc:"The workforce and the bane of you camp.",need:function(){return[[1.5/a.day,d.resources.gatherable.common.food],[1/a.day,d.resources.gatherable.common.water]]},dropRate:.01},buildings:{small:{tent:{name:"tent",desc:"Allow someone to rejoin your colony.",time:4,consume:function(){return[[6,d.resources.gatherable.common.scrap],[3,d.resources.craftable.basic.stone]]},give:function(){return[[1,d.resources.room]]},dropRate:100},plot:{name:"farm plot",desc:"",time:12,consume:function(){return[[5,d.resources.gatherable.common.food],[10,d.resources.gatherable.uncommon.sand]]},unlock:function(){return[d.actions.harvest]}},well:{name:"well",desc:"Just a large hole into the ground.",time:16,energy:80,condition:function(){return!this.buildings.has(d.buildings.big.pump.id)},consume:function(){return[[10,d.resources.craftable.basic.stone],[3,d.resources.craftable.basic.tool]]},give:function(){return[[5,d.resources.gatherable.common.water]]},unlock:function(){return[d.actions.drawFrom.well]},dropRate:80}},medium:{forge:{name:"forge",desc:"",time:10,consume:function(){return[[5,d.resources.gatherable.uncommon.oil],[10,d.resources.craftable.basic.stone],[3,d.resources.craftable.basic.tool]]},dropRate:60}},big:{barrack:{name:"barrack",desc:"Some place to sleep for a few people.",time:2*a.day,energy:110,consume:function(){return[[5,d.resources.gatherable.uncommon.sand],[5,d.resources.gatherable.uncommon.plastic],[10,d.resources.craftable.complex.brick],[2,d.resources.craftable.basic.glass]]},give:function(){return[k(l(3,4)),d.resources.room]},dropRate:20},workshop:{name:"workshop",desc:"Organizing your workforce make them more efficient at crafting.",time:3*a.day,energy:90,unique:!0,consume:function(){return[[6,d.resources.gatherable.common.scrap],[5,d.resources.craftable.basic.glass],[10,d.resources.craftable.basic.tool],[15,d.resources.craftable.complex.brick]]},give:function(){return[]},dropRate:20},pump:{name:"water pump",desc:"A buried contraption that collect water from the earth moisture.",time:3*a.day,energy:120,unique:!0,consume:function(){return[[30,d.resources.craftable.basic.stone],[7,d.resources.craftable.complex.metalPipe],[1,d.resources.craftable.advanced.engine]]},give:function(){return[[10,d.resources.gatherable.common.water]]},unlock:function(){return[d.actions.drawFrom.well]},collect:function(){return[[2/a.day,d.resources.gatherable.common.water]]},dropRate:10}},special:{forum:{name:"forum",desc:"The center and start of our settlement.",unlock:function(){return[d.actions.sleep]},give:function(){return[[2,d.resources.room]]},unique:!0}}},actions:{wakeUp:{name:"wake up",energy:0,unlock:function(a){return a.owner.updateEnergy(100),a.owner.updateLife(100),[d.actions.look]},log:"@people gets up painfully.",order:0,unique:!0},look:{name:"look around",desc:"What am I doing here ?",time:2,energy:0,give:function(){var a=b.MSG_TYPES.LOGS.FLAVOR;return K.timeout(this.log.bind(this,"We need a shelter.",a),1e3),[,[10,d.resources.gatherable.common.water],[5,d.resources.gatherable.common.food],[2,d.resources.craftable.basic.component]]},unlock:function(){return[d.actions.settle]},log:"After some thinking, @people remembers the attack. @pronoun grabs @give laying around.",order:0,unique:!0},settle:{name:"settle here",desc:"Ok, let's settle right there !",time:3,energy:0,unlock:function(){return this.flags.settled=!0,[d.actions.gather]},build:function(){return d.buildings.special.forum},give:function(){return[]},log:"@people installs @build inside a ship-wreck with @give to sleep in.",order:0,unique:!0},gather:{name:"gather resources",desc:"Go out to bring back resources, that's the best you can do.",time:3,isOut:1,unlock:function(){return[d.actions.roam]},give:function(){return v(d.resources.gatherable,"3-6")},log:"@people comes back with @give.",order:0},roam:{name:"roam",desc:"Explore the surroundings hoping to find something interesting.",time:7,isOut:1,consume:function(){return[[2,d.resources.gatherable.common.water]]},condition:function(a){return!a.owner.actions.has(d.actions.scour.id)},unlock:function(a){var b=[d.actions.explore,d.actions.craft];return a.repeated>10&&b.push(d.actions.scour),b},lock:function(a){return a.repeated>10?[a.data]:[]},give:function(a,b){var c=[u(d.resources.gatherable,"1-3")];if(l()<d.resources.ruins.dropRate){c.push([1,d.resources.ruins]);var e=u(d.locations.near);this.knownLocations.push(e),b.location=E(e.name)}return c},log:function(a){var b;return b=a.location?"Heading @direction, @people spots @location so @pronoun brings back @give.":"Despite nothing special found towards @direction, @people brings back @give.",a.direction=c.random(),a.give.filter(function(a){return a.id!==d.resources.ruins}),b},order:10},scour:{name:"scour",desc:"Knowledge of ",time:6,isOut:1,consume:function(){return[[2,d.resources.gatherable.common.water]]},give:function(a,b){var c=[u(d.resources.gatherable,"2-4")],e=d.resources.ruins.dropRate+.5*(1-d.resources.ruins.dropRate);if(l()<e){c.push([1,d.resources.ruins]);var f=u(d.locations.near);this.knownLocations.push(f),b.location=E(f.name)}return c},log:function(a){var b;return b=a.location?"Heading @direction, @people spots @location. @pronoun also brings back @give.":"Despite nothing special found towards @direction, @people brings back @give."},order:10},explore:{name:"explore a ruin",desc:"Remember that location we saw the other day ? Let's see what we can find.",time:2*a.day,energy:110,isOut:1,consume:function(){return[[4,d.resources.gatherable.common.water],[1,d.resources.gatherable.common.food],[1,d.resources.ruins]]},give:function(a){var b=this.knownLocations.random();return a.location=b,v(b.give(),"5-9")},log:function(a,b){var c=b.location.log;return B(c)?c(a,b):c?c:void 0},order:20},craft:{name:"craft something",desc:"Use some resources to tinker something useful.",time:function(){return this.buildings.has(d.buildings.big.workshop.id)?4:5},unlock:function(){return[d.actions.plan]},consume:function(){return[]},give:function(){var a=u(this.possibleCraftables());return a?(B(a.consume)&&b.getInstance().notify(b.MSG_TYPES.USE,a.consume(this)),[[1,a]]):[]},log:function(a){return a.give?"@people succeeds to craft @give.":"Nothing could be made with what you have right now."},order:30},plan:{name:"plan a building",desc:"Prepare blueprint and space for a new building.",time:8,energy:20,unlock:function(){return[d.actions.build]},give:function(a){return a.owner.planBuilding(u(this.possibleBuildings())),[]},consume:function(){return[[1,d.resources.gatherable.common.water],[1,d.resources.gatherable.common.food],[1,d.resources.craftable.basic.tool]]},log:"Everything's ready to build @plan",order:40},build:{name:function(a){return"build "+E(a.owner.plan.name)},desc:function(a){return a.owner.plan.desc},time:function(a){return a.owner.plan.time},energy:function(a){return a.owner.plan.energy},consume:function(a){var b=[[2,d.resources.gatherable.common.water],[1,d.resources.gatherable.common.food]];return B(a.owner.plan.consume)&&b.push.apply(b,a.owner.plan.consume(a)),b},lock:function(a){var b=[a.data];return B(a.owner.plan.lock)&&b.push.apply(b,a.owner.plan.lock(a)),b},unlock:function(a){var b=[];return B(a.owner.plan.unlock)&&b.push.apply(b,a.owner.plan.unlock(a)),b},build:function(a){return a.owner.plan},log:"Building @build gives @give",order:50},drawFrom:{river:{name:"draw water",desc:"Get some water from the river.",time:8,energy:50,condition:function(a){return!a.owner.actions.has(d.actions.drawFrom.well.id)},give:function(){return[[k(l(2,5)),d.resources.gatherable.common.water]]},log:"Coming back from the river, @people brings back @give.",order:60},well:{name:"draw water",desc:"Get some water from our well.",time:2,energy:15,give:function(){var a;return this.buildings.has(d.buildings.big.pump.id)?a=l(5,9):this.buildings.has(d.buildings.small.well.id)&&(a=l(1,3)),[[k(a),d.resources.gatherable.common.water]]},lock:function(){return[d.actions.drawFrom.river]},log:"Using our well, @people get @give.",order:60}},harvest:{name:"harvest crops",desc:"It's not the biggest vegetables, but it'll fill our stomachs.",time:5,consume:function(){return[[1,d.resources.gatherable.common.water]]},give:function(){return[[k(l(1,3)),d.resources.gatherable.common.food]]},order:70},sleep:{name:"sleep",desc:"Get some rest.",time:10,energy:0,give:function(a){return a.owner.updateEnergy(100),[]},unlock:function(){return[d.actions.heal]},log:"@people feels well rested now.",order:5},heal:{name:"heal",desc:'"I really hope those pills are still good."',time:2,energy:0,consume:function(){return[[2,d.resources.gatherable.rare.medication]]},give:function(a){return a.owner.updateLife(l()>.05?100:-10),[]},order:6}},locations:{near:{mountain:{name:"mountain",give:function(){return[d.resources.gatherable.common.rock,d.resources.gatherable.common.scrap,d.resources.craftable.basic.component]},dropRate:80},desert:{name:"desert",give:function(){return[d.resources.gatherable.common.scrap,d.resources.gatherable.uncommon.oil,d.resources.gatherable.uncommon.sand]},dropRate:120},supermarket:{name:"supermarket",give:function(){return[d.resources.gatherable.common.food,d.resources.gatherable.rare.medication,d.resources.craftable.basic.glass]}}},far:{river:{name:"river",unlock:function(){return[d.actions.drawFrom.river]},give:function(){return[d.resources.gatherable.common.water,d.resources.gatherable.uncommon.plastic,d.resources.craftable.basic.stone]},dropRate:20},ruin:{name:"old ruin",give:function(){return[d.resources.gatherable.rare.electronic,d.resources.craftable.basic.component,d.resources.craftable.basic.tool]},dropRate:100}},epic:{building:{name:"abandoned building",give:function(){return[d.resources.gatherable.rare.medication,d.resources.craftable.basic.glass,d.resources.craftable.complex.circuit]},dropRate:100}}},events:{dropRate:.01,easy:{sandstorm:{name:"sandstorm",desc:"The wind is blowing hard, impossible to go out for now.",time:20,deltaTime:4,effect:function(a){this.flags.cantGoOut=a},dropRate:100,log:"A sandstorm has started and prevent anyone from leaving the camp."},crate:{name:"you find an old crate",desc:"Would you want to open it ?",yes:"Yes",no:"Leave it there",effect:function(a){a&&b.getInstance().notify(b.MSG_TYPES.GIVE,d.actions.gather.give())},dropRate:50,log:"Upon opening, you find @give in it."}},medium:{death:{name:"the grim Reaper",desc:"Sometimes death strike unexpectedly.",condition:function(){return this.people.length>1},effect:function(a){a&&this.people.random().die()},dropRate:10},party:{name:"party",desc:"Someone propose to throw a party to change our mind.",time:a.day,yes:"Great idea !",no:"We can't afford it.",effect:function(a){this.flags.productivity*=a?2:.5,a&&b.getInstance().notify(b.MSG_TYPES.USE,[[1*this.people.length,d.resources.gatherable.common.water],[3*this.people.length,d.resources.gatherable.common.food]])},dropRate:25,log:"We make a little party to try forget our situation."}},hard:{drought:{name:"drought",desc:"The climate is so hot, we consume more water.",time:3*a.day,timeDelta:10,effect:function(a){this.flags.drought=a},dropRate:6,log:"A harsh drought fall on us, water will be more important than ever."}}}};return{time:a,data:d}}(),J=function(){return{maxLog:100}}();b.prototype={observe:function(a,b){C(a)||(a=[a]);for(var c=0,d=a.length;c<d;++c)this.observers[a[c]]||(this.observers[a[c]]=[]),this.observers[a[c]].push(b);return this},notify:function(a,b){if(this.observers[a])for(var c=0,d=this.observers[a].length;c<d;++c)this.observers[a][c](b,a);return this}},b.instance=!1,b.getInstance=function(){return b.instance||(b.instance=new b),b.instance},b.MSG_TYPES={LOGS:{INFO:0,WARN:1,FLAVOR:2,EVENT:3},CLICK:10,REFRESH:20,GIVE:30,FIND_LOCATION:31,COLLECT:32,USE:35,RUNS_OUT:36,LOOSE:38,LOOSE_SOMEONE:39,UNLOCK:40,LOCK:50,BUILD:60,EVENT_START:70,EVENT_CANCEL:71,EVENT_END:72};var K=(function(){function a(a,b){return btoa(a+b)+b}function b(a,b){return atob(a.slice(0,-b.length)).slice(0,-b.length)}function c(){return d||(d=g?g.slice(-h):l().toString(36).slice(-h)),d}var d,e=localStorage,f="_s",g=e.getItem(f),h=6;return{store:function(b){try{var d=a(JSON.stringify(b),c());return g=d,e.setItem(f,d),!0}catch(a){return console.warn(a),!1}},load:function(){try{return JSON.parse(b(g,c()))}catch(a){return console.warn(a),!1}},erase:function(){e.removeItem(f)}}}(),function(){function a(a,b){this.startTime=performance.now(),this.action=a,this.time=b,this.isRunning=!0,this.timeout=this.setTimeout()}function b(){return c||(c=new i),c}a.prototype={setTimeout:function(){return setTimeout(this.action,this.time)},getElapsed:function(){return performance.now()-this.startTime},getRemaining:function(){return this.time-this.getElapsed()},stop:function(){return!!this.isRunning&&(this.isRunning=!1,this.time=this.getRemaining(),clearTimeout(this.timeout),this.time)},restart:function(a){return!this.isRunning&&(this.isRunning=!0,this.startTime=a,this.timeout=this.setTimeout(),this.time)}};var c=null;return{timeout:function(c,d){var e,f=function(){b().pop(e),c()};return e=b().push(new a(f,d))},stop:function(a){return b().get(a).stop()},stopAll:function(){return b().forEach(function(a){a.stop()}),this},restart:function(a){return b().get(a).restart(performance.now())},restartAll:function(){var a=performance.now();return b().forEach(function(b){b.restart(a)}),this},clear:function(a){return b().pop(a).stop()},clearAll:function(){return b().forEach(function(a){a.clear()}),this},getRemaining:function(a){return getTimers().get(a).getRemaining()}}}());c.prototype={_init:function(a){return this.data=z(this,a,["name","desc","time","energy","consume"]),D(this.data.energy)&&(this.data.energy=5*this.data.time),this.html.textContent=t(this.data.name),this.tooltip?this.tooltip.remove().update(this.data):this.tooltip=n(this.html,this.data),this},toHTML:function(a){var b=o("action clickable disabled animated");return b.addEventListener("click",function(){this.locked||this.running||this.owner.busy||this.click.call(this)}.bind(this)),b.style.order=a.order,b},refresh:function(a,b){return this.locked=this.owner.isTired()&&this.data.energy>0||this.data.isOut&&b.cantGoOut,C(this.data.consume)&&(this.tooltip.refresh(a,this.data.consume),this.locked||this.data.consume.forEach(function(b){var c=b[1].id;a.has(c)&&a.get(c).has(b[0])||(this.locked=!0)}.bind(this))),this.locked?this.html.classList.add("disabled"):this.html.classList.remove("disabled"),this},click:function(){if(this.owner.busy||this.locked)return!1;C(this.data.consume)&&b.getInstance().notify(b.MSG_TYPES.USE,this.data.consume),++this.repeated,this.owner.setBusy(this.data);var c=(this.data.time||0)*a.tickLength;return this.data.deltaTime&&(c+=l(-this.data.deltaTime,this.data.deltaTime)),this.html.style.animationDuration=c+"ms",this.html.classList.add("cooldown"),this.timeout=K.timeout(function(){this.timeout=0,this.owner.setBusy(!1),this.html.classList.remove("cooldown");var a={name:this.data.name,people:this.owner.name,pronoun:this.owner.getPronoun()};if(B(this.data.build)){var c=this.data.build(this);a.build=E(c.name)}var d=[];B(this.data.give)&&(d=this.data.give(this,a)),c&&B(c.give)&&(d=d.concat(c.give(this))),d=F(d),d.length&&(b.getInstance().notify(b.MSG_TYPES.GIVE,d),a.give=q(d));var e=[];if(B(this.data.collect)&&(e=this.data.collect(this)),c&&B(c.collect)&&(e=e.concat(c.collect(this))),e=F(e),e.length&&(b.getInstance().notify(b.MSG_TYPES.COLLECT,e),a.collect=q(e)),B(this.data.unlock)){var f=this.data.unlock(this).filter(function(a){return!a.condition||a.condition&&a.condition(this)}.bind(this));this.data.unique?b.getInstance().notify(b.MSG_TYPES.UNLOCK,f):this.owner.addAction(f)}if(B(this.data.lock)){var g=this.data.lock(this);this.owner.lockAction(g)}this.data.unique&&b.getInstance().notify(b.MSG_TYPES.LOCK,this.data),c&&b.getInstance().notify(b.MSG_TYPES.BUILD,c);var h;B(this.data.log)?h=this.data.log(a,this):this.data.log&&(h=this.data.log),h=h.replace(/@(\w+)/gi,function(b,c){return a[c]||""}),b.getInstance().notify(b.MSG_TYPES.LOGS.INFO,t(h))}.bind(this),c),!0},lock:function(){return this.cancel(),this.html.remove(),this.tooltip.remove(),this},cancel:function(){return this.timeout&&(K.clear(this.timeout),this.owner.setBusy(!1),
this.html.classList.remove("cooldown")),this},getState:function(){return{data:this.data,location:this.location}}},d.prototype={_init:function(a){return this.data=z(this,a,["name","desc","time","consume"]),this.html=this.toHTML(),this.tooltip&&this.tooltip.remove(),n(this.html,this.data),this},toHTML:function(){this.counter=o("counter");var a=o("building",t(this.data.name));return a.appendChild(this.counter),a},add:function(a){return this.number+=a,this.counter.textContent=this.number,this},getState:function(){return{number:this.number,data:this.data}}},d.LST_ID="buildingsList",e.prototype={_init:function(a){return this.data=z(this,a,["name","desc","time","consume"]),this.nameNode.textContent=this.data.name,this.tooltip&&this.tooltip.remove(),this.tooltip=n(this.html,this.data),this},toHTML:function(){var a=o("event");return this.nameNode=o("name"),a.appendChild(this.nameNode),this.progressBar=o("animated bar"),a.appendChild(this.progressBar),a},start:function(c){return m(this.data,function(){if(this.data.effect(!0),this.data.time){b.getInstance().notify(b.MSG_TYPES.EVENT_START,this).notify(b.MSG_TYPES.LOGS.EVENT,t(E(this.data.name)+" has started."));var d=this.data.time*a.tickLength;this.data.deltaTime&&(d+=l(-this.data.deltaTime,this.data.deltaTime)),this.progressBar.style.animationDuration=d+"ms",this.html.classList.add("ongoing"),this.timer=K.timeout(this.end.bind(this),d)}c&&c(this)}.bind(this),"event"),!!this.data.time},end:function(){this.data.effect(!1),this.timer=null,b.getInstance().notify(b.MSG_TYPES.EVENT_END,this),this.html.remove()},getState:function(){return{data:this.data,remaining:this.timer?K.getRemaining(this.timer):0}}},e.LST_ID="eventList",g.prototype={toHTML:function(){var a=o("people");return a.appendChild(o("name",this.name)),this.lifeBar=o("bar life"),n(this.lifeBar,{name:"Health",desc:"The first thing you want is a good health."}),a.appendChild(this.lifeBar),this.energyBar=o("bar energy"),n(this.energyBar,{name:"Energy",desc:"Drained faster when busy or hungry."}),a.appendChild(this.energyBar),this.actionList=o("actionList"),a.appendChild(this.actionList),a},refresh:function(a,b,c){if(this.actions.forEach(function(b){b.refresh(a,c)}),c.settled){var d=1;this.busy&&(d=(this.busy.energy||0)/this.busy.time),this.updateEnergy(-b*d-30*this.starving),this.thirsty?this.updateLife(-b*this.thirsty*30):this.energy>80&&!this.starving&&!this.thirsty&&this.updateLife(.5*b)}return this.starving=0,this.thirsty=0,this},getPronoun:function(){return"male"===this.gender?"he":"she"},setBusy:function(a){return this.busy=!!a&&a,this.html.classList.toggle("busy",!!a),this},updateEnergy:function(a){return this.energy+=a,this.energy>100?this.energy=100:this.energy<0&&(this.updateLife(this.energy),this.energy=0),this.energyBar.style.width=this.energy+"%",this.energy},isTired:function(){return this.energy<=0},updateLife:function(a){return this.life+=a,this.life>100?this.life=100:this.life<0&&this.die(),this.lifeBar.style.width=this.life+"%",this.lifeBar.classList[this.life<25?"add":"remove"]("warning"),this.life},planBuilding:function(a){return b.getInstance().notify(b.MSG_TYPES.LOGS.FLAVOR,"Reay to build "+E(a.name)),this.plan=a,this},addAction:function(a){if(C(a))for(var b=0,d=a.length;b<d;++b)this.addAction(a[b]);else if(this.actions.has(a.id))this.actions.get(a.id)._init(a);else{var e=new c(this,a);this.actions.push(a.id,e),this.actionList.appendChild(e.html)}return this},lockAction:function(a){if(C(a))for(var b=0,c=a.length;b<c;++b)this.lockAction(a[b]);else this.actions.pop(a.id).lock();return this},die:function(){return this.html.classList.contains("arrived")&&(b.getInstance().notify(b.MSG_TYPES.LOOSE_SOMEONE,this),this.html.classList.remove("arrived"),this.actions.forEach(function(a){a.cancel()}),K.timeout(function(){this.html.remove()}.bind(this),400)),this},getState:function(){return{name:this.name,gender:this.gender,energy:this.energy,life:this.life,plan:this.plan?this.plan.getState():null,actions:this.actions.values().map(function(a){return a.getState()})}}},g.LST_ID="peopleList",g.randomName=function(a){return new Promise(function(b,c){var d="https://randomuser.me/api?inc=gender,name",e=["AU","BR","CA","CH","DE","DK","ES","FI","FR","GB","IE","NL","NZ","TR","US"],f=d+"&nat="+e.join(",")+"&noinfo&results="+a,g=new XMLHttpRequest;g.open("get",f),g.onload=b,g.onerror=c,g.send()})},h.prototype={_init:function(a){return this.data=z(this,a,["name","desc","consume"]),this.tooltip&&this.tooltip.remove(),this.tooltip=n(this.html,this.data),this},toHTML:function(a){var b=o("resource get-more");this.counter=o("counter",1),b.appendChild(this.counter);var c=o("icon icon-"+a.icon);return b.appendChild(c),b.style.order=a.order,b},refresh:function(a){return this.counter.textContent=j(this.count),a&&C(this.data.consume)&&this.tooltip.refresh(a,this.data.consume),this},update:function(a){this.set(this.count+a);var b=!1;return a>0&&!this.html.classList.contains("more")?(this.html.classList.add("more"),b=function(){this.html.classList.remove("more")}.bind(this)):a<0&&!this.html.classList.contains("less")&&(this.html.classList.add("less"),b=function(){this.html.classList.remove("less")}.bind(this)),B(b)&&K.timeout(b,700),this},get:function(){return 0|this.count},set:function(a){if(this.count=a,this.count<0)throw"Resources count can't be negative";return this.refresh()},has:function(a){return this.count>=a},getState:function(){return{count:this.count,data:this.data}}},h.LST_ID="resourceList",i.prototype={push:function(a,b){return D(b)&&(b=a,a=b.id||this.length+1),!this.has(a)&&(this.items[a]=b,++this.length)},pop:function(a){var b=this.items[a];return!!b&&(delete this.items[a],--this.length,b)},has:function(a){return!!this.items[a]},get:function(a){if(!this.has(a))throw"Unknown ID ("+a+") in Collection ("+this+")";return this.items[a]},set:function(a,b){if(!this.has(a))throw"Unknown ID ("+a+") in Collection ("+this+")";return this.items[a]=b},forEach:function(a){if(this.length>0)for(var b in this.items)this.items.hasOwnProperty(b)&&a(this.items[b],b,this);return this},filter:function(a){var b=new i;return this.forEach(function(c,d,e){a(c,d,e)&&b.push(d,c)}),b},values:function(){return this.items.values()},keys:function(){return Object.keys(this.items)},random:function(){return this.values().random()},clear:function(){return this.items={},this.length=0,this},toString:function(){return"["+this.keys().join(", ")+"]"}};var L=(Math.PI,Math.random);new Function;A.IDS=[],Array.prototype.last=function(){return this[this.length-1]},Array.prototype.random=function(){return this[j(l(0,this.length))]},Array.prototype.out=function(a){return this.splice(this.indexOf(a),1),this.length},Object.prototype.values=function(){var a=[];for(var b in this)this.hasOwnProperty(b)&&a.push(this[b]);return a}}();