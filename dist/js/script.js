!function(t){"use strict";function i(e){this.data=b.get(e),this.html=this.toHTML(),this.init.apply(this,Array.prototype.splice.call(arguments,1))}function s(e,t,i){p.isFunction(ga)&&ga("send","event","Game",e,t,i)}function o(e,t,i){this.locked=!0,this.nameNode=null,this.options=null,this.optionsWrapper=null,this.owner=t,this.parentAction=i||null,this.repeated=0,this.choosenOptionId=null,this.super(e)}function n(e){this.super(e)}function r(e){this.timer=null,this.nameNode=null,this.progressBar=null,this.tooltip=null,this.super(e)}function a(e,t){var i=p.getNow();console.log("Loaded in "+i+"ms"),console.log("Starting v0.4.0"),this.assets=t,this.resources=new Map,this.buildings=new Map,this.events=new Map,this.people=[],this.initialActions=[],this.knownLocations=[],this.buildingsInProgress=[],this.flags={ready:!1,paused:!1,settled:!1,survived:0,popup:!1,productivity:1},this.lastTick=i,this.super(null,e),console.log("Started in "+(p.getNow()-i)+"ms")}function c(e){e=e||1;return l.randomName(e).then(function(e){var t=[];return e.results.forEach(function(e){var i=new l(p.capitalize(e.name.first+""),e.gender);t.push(i)}),t})}function l(e,t){this.name=e,this.gender=t||"other",this.actions=new Map,this.busy=!1,this.energyDrain=.7,this.energy=100,this.life=100,this.stats={idle:0,age:0},this.perk=null,this.super()}function u(e,t){this.owner=t,u.usedId.push(e),this.super(e)}function h(e,t){this.count=0,this.warnLack=!1,this.super(e,t)}function d(e,t){this.value=null,this.threshold=t||0,this.super(),this.html.classList.add.apply(this.html.classList,e.split(" "))}function f(e,t,i){var s=document.body;i="popup"+(i?" "+i:"");var o=p.wrap(i);o.appendChild(p.wrap("title",p.capitalize(e.name))),o.appendChild(p.wrap("description",e.desc));var n={remove:function(){o.remove(),s.classList.remove("backdrop")}};t=t||{};var r=p.wrap("yes clickable",t.yes&&t.yes.name||"Ok"),a=t.yes&&t.yes.action||p.noop;if(r.addEventListener("click",function(){a(),n.remove()},!0),o.appendChild(r),t.no){var c=p.wrap("no clickable",t.no.name||"Cancel"),l=t.no.action||p.noop;c.addEventListener("click",function(){l(),n.remove()},!0),o.appendChild(c)}return s.classList.add("backdrop"),s.appendChild(o),o.style.top=v.floor((s.offsetHeight-o.offsetHeight)/2)+"px",n}function m(e,t){this.container=e,this.nodes={},this.resourcesMapper={},this.box=this.toHTML(t),this._mouseOver(),this.width=this.box.offsetWidth,this.height=this.box.offsetHeight,this._mouseOut(),this._addEvents()}var p={noop:new Function,wrap:function(e,t){var i=document.createElement("div");return e&&(i.className=e),t&&(i.innerHTML=t),i},formatJoin:function(e,t){return e.length>1?e.slice(0,e.length-1).join(", ")+" "+(t||"and")+" "+e.last():e.length?""+e[0]:""},formatArray:function(e){var t=[];return e.forEach(function(e){var i=b.get(e[1]),s=p.pluralize(i.name,e[0]);i.icon&&(s+=" "+h.iconAsString(i.icon)),t.push(e[0]+" "+s)}),p.formatJoin(t)},formatTime:function(e){if(!e)return"0 hour";var t=["year","month","day","hour","minute"],i=[],s=b.time;return t.forEach(function(t){if(e>s[t]){var o=v.floor(e/s[t]);e%=s[t],i.push(o+" "+p.pluralize(t,o))}}),p.formatJoin(i)},pluralize:function(e,t){return e+(t>1&&"s"!==e[e.length-1]?"s":"")},capitalize:function(e){return e?(e=e.replace(/([.!?]) ([a-z])/g,function(e,t,i){return t+" "+i.toUpperCase()}))[0].toUpperCase()+e.slice(1):""},randomize:function(e,t){if(!e.values().length)throw new TypeError("Can't pick from empty list");var i={},s=[],o=0;e.deepBrowse(function(e){var t=b.get(e);t.dropRate&&(o+=t.dropRate,s.push(o),i[o]=e)});var n=v.floor(v.random(o));s.sort(function(e,t){return e-t});for(var r=0,a=s.length;r<a;++r)if(s[r]>n){n=s[r];break}return t?(p.isArray(t)||(t=p.isString(t)?t.split("-"):[+t]),[v.round(v.random.apply(null,t)),i[n]]):i[n]},randomizeMultiple:function(e,t){if(!t)throw new TypeError("Need an amount");var i=[];p.isArray(t)||(t=p.isString(t)?t.split("-"):[+t]);for(var s=v.round(v.random.apply(null,t)),o=0;o++<s;)i.push([1,p.randomize(e)]);return p.compactResources(i)},log:function(){},randomStr:function(e){return e=e||6,new Array(e).fill("-").join("").replace(/-/g,function(){return v.floor(v.random(36)).toString(36)})},pickUniqueID:function(){var e=[];return function(){var t=p.randomStr();return e.includes(t)?p.pickUniqueID():(e.push(t),t)}}(),isFunction:function(e){return e instanceof Function},isArray:function(e){return Array.isArray(e)},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isUndefined:function(e){return void 0===e},sanitize:function(e){return e.replace(/^\W+|\W+$/g,"").replace(/\W+/g,"_").toLowerCase()},camelize:function(e){return e.replace(/^\W+/,"").toLowerCase().replace(/\W+(\w?)/g,function(e,t){return t&&t[0].toUpperCase()+t.slice(1)})},an:function(e){return e.length?("aeiou".split("").includes(e[0])?"an":"a")+" "+e:""},compactResources:function(e){return e.reduce(function(e,t){var i=e.find(function(e){return e[1]===t[1]});return i?i[0]+=t[0]:t[0]>0&&e.push(t),e},[])},getNow:function(){return v.floor(performance.now())},loadAsync:function(e,t){var i={},s=0,o=e.length;return Promise.all(e.map(function(e){var n,r=fetch(e).then(function(t){if(t.ok)return t;throw new URIError("["+t.status+"] "+e+" "+t.statusText)});switch(e.substr(e.lastIndexOf(".")+1)){case"png":case"jpg":case"gif":n=r.then(function(e){var t=new Image;return e.blob().then(function(e){return t.src=URL.createObjectURL(e),t})});break;case"json":n=r.then(function(e){return e.json()});break;default:n=Promise.resolve()}return n.then(function(n){i[p.sanitize(e)]=n,t(++s/o*100,e)})})).then(function(){return i})}},g={prepareCanvas:function(e,t){var i=document.createElement("canvas");return i.width=e,i.height=t,{cnv:i,ctx:i.getContext("2d")}}};CanvasRenderingContext2D.prototype.clear=function(){this.clearRect(0,0,this.canvas.width,this.canvas.height)};var v={floor:function(e){return e<<0},round:function(e){return v.floor(e+.5)},ceil:function(e){return v.floor(e+1)},abs:Math.abs,diff:function(e,t){return v.abs(e-t)},constrain:function(e,t,i){return e<t?t:e>i?i:e},random:function(){var e=Math.random;return function(t,i){return p.isUndefined(i)?(i=p.isUndefined(t)?1:+t||1,t=0):(t=+t||0,i=+i||1),e()*(i-t)+t}}()};i.prototype={init:p.noop,toHTML:function(){return p.wrap(this.modelName)},getStraight:function(){return{id:this.data.id}}},Number.prototype.equals=function(e){return p.isNumber(e)&&v.diff(this,e)<=Number.EPSILON},Array.prototype.last=function(){return this[this.length-1]},Array.prototype.random=function(){return this[v.floor(v.random(0,this.length))]},Array.prototype.out=function(e){var t=this.indexOf(e);return t>=0&&this.splice(t,1),this.length},Array.prototype.insert=function(e){return this.push.apply(this,e)},Map.prototype.push=function(e,t){return p.isUndefined(t)&&(e=(t=e).id||Symbol(p.randomStr(3))),this.set(e,t),e},Map.prototype.getValues=function(){for(var e=this.values(),t=[],i=e.next();!i.done;)t.push(i.value),i=e.next();return t},Object.prototype.browse=function(e,t){Object.keys(this).forEach(function(i){e.call(t,this[i],i,this)},this)},Object.prototype.values=function(){return Object.values(this)},Object.prototype.deepBrowse=function(e,t){"Object"!==this.constructor.name?e.call(t,this):this.browse(function(i){i.deepBrowse(e,t)})},Object.prototype.swap=function(){var e={};return this.browse(function(t,i){e[t]=i}),e},Object.prototype.clone=function(){var e;if([Boolean,Number,String].includes(this.constructor))e=this;else if(this instanceof Array)e=this.slice();else{if(!(this instanceof Object))throw new TypeError("Improbable source type");e=Object.assign({},this)}return e},Function.prototype.extends=function(e,t,i){if(e&&(this.prototype=Object.create(e.prototype),this.prototype.super=e,this.prototype.constructor=this,this.prototype.modelName=t),i){var s=this;i.browse(function(e,t){s.prototype[t]&&(s.prototype["_"+t]=s.prototype[t]),s.prototype[t]=e})}},window.ga=!1,function(e,t,i,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=+new Date,i=document.createElement("script"),s=document.getElementsByTagName("script")[0],i.async=1,i.src="https://www.google-analytics.com/analytics.js",s.parentNode.insertBefore(i,s)}(window,"ga"),ga("create","UA-99773946-1","auto"),ga("send","pageview"),function(){console.groupCollapsed("Loading");var t=p.getNow();p.loadAsync(["dist/img/icons.png","dist/img/assets.png","dist/js/assets.json","dist/js/buildingsData.json"],function(e,i){console.log(i+" : "+e.toFixed(1)+"% - "+(p.getNow()-t))}).then(function(e){console.groupEnd();try{new a(document.body,{images:e[p.sanitize("dist/img/assets.png")],data:{assets:e[p.sanitize("dist/js/assets.json")],positions:e[p.sanitize("dist/js/buildingsData.json")]}})}catch(e){console.warn("Fail to load game : "+e.message,e.stack)}}).catch(function(t){console.warn(t.message,e.stack)})}();var b=function(){function e(e){var t=btoa(e.id);return e.id=t,o[t]=e,t}var t={minute:1/60,hour:1,day:24,week:168,month:720,year:8760},i=["north","south","east","west","north-east","north-west","south-east","south-west"],s={resources:{gatherables:{common:{},uncommon:{},rare:{}},craftables:{basic:{},complex:{},advanced:{}},special:{}},buildings:{small:{},medium:{},big:{},special:{}},actions:{},locations:{near:{},far:{},epic:{}},events:{easy:{},medium:{},hard:{}},perks:{}},o={};s.option="opt",s.resources.room=e({id:"rom",name:"room",desc:"A place for someone in the camp.",icon:"person",order:0}),s.resources.gatherables.common.water=e({id:"wtr",name:"water",desc:"Water is definitely important to survive in this harsh environment.",icon:"water-bottle",dropRate:100,order:10}),s.resources.gatherables.common.food=e({id:"fod",name:"food",desc:"Everyone need food to keep his strength.",icon:"foodcan",dropRate:90,order:20}),s.resources.gatherables.common.rock=e({id:"rck",name:"rock",desc:'"There\'s rocks everywhere ! Why would you bring this back ?"',icon:"rock",dropRate:100,order:30}),s.resources.gatherables.common.scrap=e({id:"scp",name:"scrap metal",desc:"An old rusty piece of metal.",icon:"metal-scraps",dropRate:80,order:40}),s.people=e({id:"plp",name:"people",desc:"The workforce and the bane of you camp.",needs:[[1.2/t.day,s.resources.gatherables.common.water,"thirsty"],[1/t.day,s.resources.gatherables.common.food,"starving"]],dropRate:.1}),s.resources.gatherables.uncommon.bolts=e({id:"blt",name:"nuts and bolts",desc:"Little metal nuts and bolts to fasten anything in place.",icon:"nuts-and-bolts",dropRate:70,order:50}),s.resources.gatherables.uncommon.sand=e({id:"snd",name:"sand",desc:"Just pure fine sand.",icon:"sand-pile",dropRate:40,order:55}),s.resources.gatherables.uncommon.oil=e({id:"oil",name:"fuel",desc:"About a liter of gas-oil.",icon:"jerrycan",dropRate:10,order:60}),s.resources.gatherables.rare.medication=e({id:"mct",name:"medication",desc:"An unlabeled medication, hope it's still good.",icon:"medications",dropRate:7,order:70}),s.resources.gatherables.rare.electronic=e({id:"elc",name:"electronics",desc:"Some basic micro-electronics components.",icon:"electronic-parts",dropRate:10,order:75}),s.resources.special.ruins=e({id:"run",name:"location",desc:"Directions to a point of interest we found earlier.",icon:"map",order:80,dropRate:.6}),s.resources.special.quartz=e({id:"qtz",name:"quartz cristal",desc:"A rough uncut gem of quartz. Quite valuable.",icon:"gem",dropRate:.1,order:77}),s.resources.craftables.basic.component=e({id:"cmp",name:"component",desc:"Some mechanical parts for others craftables.",icon:"pipes-large",consume:[[2,s.resources.gatherables.common.scrap],[2,s.resources.gatherables.uncommon.bolts]],dropRate:120,order:110}),s.buildings.special.wreckage=e({id:"wrk",name:"wreckage",desc:"Remainings of space-ships.",asset:"wreckage",order:0}),s.actions.launch=e({id:"lnc",name:"launch",desc:"Finally set off this module to get out of that damn wasteland.",time:12,energy:30,isOut:1,unique:!0,consume:[[10,s.resources.gatherables.uncommon.oil]],effect:function(){k.notify(k.MSG_TYPES.WIN,this.getSettledTime())},log:function(){return"After "+this.getSurvivalDuration()+", you finally leave this damn crash-site.<br/>You have to leave everyone behind. You make a promise to yourself to come back as soon as you can."},order:15}),s.actions.exchange=e({id:"exc",name:"exchange",desc:"Caravan passing by carry lots of useful stuff, let's see what's possible to trade.",time:7,energy:20,consume:[[2,s.resources.craftables.complex.jewelry]],giveSpan:[2,3],giveList:[s.resources.craftables.basic,s.resources.craftables.complex],log:"@people.name manage to trade a couple of jewelries for @give.",order:10}),s.actions.nurse=e({id:"nrs",name:"nurse",desc:"Look after the health of the most needed one.",time:2,energy:1,consume:[[2,s.resources.gatherables.rare.medication]],effect:function(e,t,i){var s=null;this.people.forEach(function(e){(!s||e.life<s.life)&&(s=e)}),s.updateLife(99),i.cured=s},log:"Thanks to @people.name, @cured.name feel better.",order:7}),s.actions.heal=e({id:"hel",name:"heal",desc:'"I really hope those pills are still good."',time:2,energy:1,consume:[[2,s.resources.gatherables.rare.medication]],effect:function(e,t,i){var o=99,n=this.buildings.has(s.buildings.small.pharmacy),r=e.owner.hasPerk(s.perks.healer);!n&&!r&&v.random()<.4&&(o=-10,i.wasBad=!0),e.owner.updateLife(o)},log:function(e){return e.wasBad?"After feeling not so well, @people.name realise taking these pillstook a hit on his health.":"This time, it actually improve @people.name's health."},order:6}),s.actions.sleep=e({id:"slp",name:"sleep",desc:"Get some rest to restore energy.",time:7,energy:0,effect:function(e){e.owner.updateEnergy(99)},unlock:[s.actions.heal],log:"@people.name feels well rested now.",order:5}),s.actions.harvestPlot=e({id:"hrp",name:"harvest crops",desc:"It's not the biggest vegetables, but it'll fill our stomachs.",time:4,consume:[[2,s.resources.gatherables.common.water]],giveSpan:[1.5,2],giveList:[s.resources.gatherables.common.food],log:"Our crops produce @give.",order:70}),s.actions.harvestField=e({id:"hrf",name:"harvest crops",desc:"It's not the biggest vegetables, but it'll fill our stomachs.",time:6,lock:[s.actions.harvestPlot],consume:[[3,s.resources.gatherables.common.water]],giveSpan:[3,4],giveList:[s.resources.gatherables.common.food],log:"Our crops produce @give.",order:70}),s.actions.drawFromWell=e({id:"dfw",name:"draw water",desc:"Get some water from our well.",time:2,energy:15,giveSpan:[1,3],giveList:[s.resources.gatherables.common.water],log:"Using our well, @people.name get @give.",order:60}),s.actions.drawFromRiver=e({id:"dfr",name:"draw water",desc:"Get some water from the river.",time:8,energy:50,isOut:1,condition:function(e){return!e.owner.actions.has(s.actions.drawFromWell)},giveSpan:[2,6],giveList:[s.resources.gatherables.common.water],log:"Coming back from the river, @people.name brings @give with @people.accusative.",order:60}),s.actions.build=e({id:"bui",name:"build",desc:"Put together some materials to come up with what looks like a building.",build:s.option,options:function(){return this.possibleBuildings()},order:50}),s.actions.craft=e({id:"crf",name:"craft",desc:"Use some resources to tinker something useful.",time:5,energy:15,options:function(){return this.unlockedCraftables()},give:[[1,s.option]],unlock:[s.actions.build],log:"@people.name succeeds to craft @give.",order:30}),s.actions.explore=e({id:"xpl",name:"explore",desc:"Remember that location we saw the other day ? Let's see what we can find there.",time:t.day,energy:100,isOut:1,consume:[[2,s.resources.gatherables.common.water],[1,s.resources.gatherables.common.food],[1,s.resources.special.ruins]],options:function(){return this.knownLocations},giveSpan:[7,10],log:"All locations should have own log",order:20});var n=o[s.resources.special.ruins].dropRate;return s.actions.scour=e({id:"scr",name:"scour",desc:"Knowledge of the area allows for better findings.",time:5,isOut:1,consume:[[1,s.resources.gatherables.common.water]],giveSpan:[1.5*n/2,(1.5*n+1)/2],giveList:[s.resources.special.ruins],log:function(e){var t;if(e.give){var o=p.randomize(s.locations.far);this.knownLocations.includes(o)||this.knownLocations.push(o),e.location=p.an(b.get(o).name),t="@people.name knew @people.nominative could find @location towards @direction."}else t="No special location towards @direction.";return e.direction=i.random(),t},order:10}),s.actions.roam=e({id:"ram",name:"roam",desc:"Explore the surroundings hoping to find something interesting.",time:6,isOut:1,consume:[[1,s.resources.gatherables.common.water]],condition:function(e){return!e.owner.actions.has(s.actions.scour)},unlock:[s.actions.explore],unlockAfter:[[9,s.actions.scour]],giveSpan:[n/2,(n+1)/2],giveList:[s.resources.special.ruins],log:function(e){var t;if(e.give){var o=p.randomize(s.locations.near);this.knownLocations.includes(o)||this.knownLocations.push(o),e.location=p.an(b.get(o).name),t="Heading @direction, @people.name spots @location"}else t="@people.name found nothing special towards @direction.";return e.direction=i.random(),t},order:10}),s.actions.gather=e({id:"gtr",name:"gather resources",desc:"Go out to bring back resources, that's the best you can do.",time:3,isOut:1,unlock:[s.actions.roam,s.actions.craft],giveSpan:[3,6],giveList:s.resources.gatherables,log:"@people.name comes back with @give.",order:1}),s.buildings.special.forum=e({id:"fr0",name:"forum",desc:"The center and start of our settlement.",unlockForAll:[s.actions.sleep],upgrade:s.buildings.special.wreckage,give:[[1,s.resources.room]],asset:"forum",order:1}),s.actions.settle=e({id:"stl",name:"settle here",desc:"Ok, let's settle right there !",time:2,energy:0,effect:function(){this.flags.settled=!0},unlock:[s.actions.gather],build:s.buildings.special.forum,log:"@people.name installs @build inside a ship-wreck with @give to sleep in.",order:0,unique:!0}),s.actions.look=e({id:"lok",name:"look around",desc:"What am I doing here ?",time:1,energy:0,effect:function(){S.timeout(function(){k.notify(k.MSG_TYPES.LOGS.FLAVOR,"We need a shelter.")},1500)},give:[[10,s.resources.gatherables.common.water],[8,s.resources.gatherables.common.food],[2,s.resources.craftables.basic.component]],unlock:[s.actions.settle],log:"After some thinking, @people.name remembers the attack. @people.nominative grabs @give laying around.",order:0,unique:!0}),s.actions.wakeUp=e({id:"wku",name:"wake up",unlock:[s.actions.look],effect:function(e){e.owner.updateEnergy(100),e.owner.updateLife(100)},log:"@people.name gets up painfully.",order:0,unique:!0}),s.resources.craftables.basic.stone=e({id:"stn",name:"smooth stone",desc:"A round and well polish stone.",icon:"stone",consume:[[3,s.resources.gatherables.common.rock]],dropRate:100,order:90}),s.resources.craftables.basic.tool=e({id:"tol",name:"tool",desc:"The base for any tinkerer.",icon:"tools",consume:[[1,s.resources.craftables.basic.component],[2,s.resources.gatherables.common.rock]],dropRate:90,order:111}),s.buildings.small.furnace=e({id:"frn",name:"furnace",desc:"Survival require to craft as much as to gather things.",time:7,consume:[[8,s.resources.gatherables.common.rock],[2,s.resources.gatherables.uncommon.oil]],asset:"furnace",order:15,log:"A simple furnace that can smelt small things like sand or little electronics."}),s.resources.craftables.basic.glass=e({id:"gls",name:"glass pane",desc:"A see-through building component.",icon:"glass-pane",ifHas:s.buildings.small.furnace,consume:[[4,s.resources.gatherables.uncommon.sand]],dropRate:60,order:100}),s.buildings.small.forum1=e({id:"fr1",name:"forum+1",desc:"Add one room.",time:2,upgrade:s.buildings.special.forum,consume:[[6,s.resources.gatherables.uncommon.bolts],[4,s.resources.gatherables.common.scrap]],give:[[1,s.resources.room]],asset:"forum+1",order:10,log:"It'll be nice to have someone else helping."}),s.buildings.small.plot=e({id:"plt",name:"farm plot",desc:"A little arranged plot of soil to grow some food.",time:9,consume:[[5,s.resources.gatherables.common.food],[10,s.resources.gatherables.uncommon.sand]],unlockForAll:[s.actions.harvestPlot],asset:"plot",order:12,log:"More crops required more care but that's going to help us keeping a constant stock of food."}),s.buildings.small.pharmacy=e({id:"phr",name:"pharmacy",desc:'"Maybe we should avoid letting medications rot in plain sunlight ?!"',time:6,consume:[[5,s.resources.gatherables.rare.medication],[4,s.resources.craftables.basic.component]],asset:"pharmacy",order:16,log:"Sorting our medications should prevent further mistakes and bad reaction."}),s.buildings.small.well=e({id:"wel",name:"well",desc:"Just a large hole into the ground.",time:16,condition:function(){return!this.buildings.has(s.buildings.big.pump)},consume:[[10,s.resources.craftables.basic.stone],[3,s.resources.craftables.basic.tool]],give:[[5,s.resources.gatherables.common.water]],unlockForAll:[s.actions.drawFromWell],lock:[s.actions.drawFromRiver],asset:"well",order:13,log:"Drawing water from the ground should allow to further polish stone into bricks."}),s.buildings.medium.forum2=e({id:"fr2",name:"forum+2",desc:"Add one room.",time:5,consume:[[10,s.resources.gatherables.uncommon.sand],[2,s.resources.craftables.basic.stone],[3,s.resources.craftables.basic.glass]],upgrade:s.buildings.small.forum1,give:[[1,s.resources.room]],asset:"forum+2",order:20,log:"Another room for someone to join. So far, so good."}),s.buildings.medium.plot1=e({id:"fil",name:"field",desc:"A larger crop field to produce more food.",time:10,unlockForAll:[s.actions.harvestField],consume:[[20,s.resources.gatherables.common.food],[5,s.resources.gatherables.uncommon.sand],[3,s.resources.gatherables.rare.medication]],upgrade:s.buildings.small.plot,asset:"plot+1",order:25,log:"This should be enough to provide food for our small encampment."}),s.buildings.medium.forge=e({id:"frg",name:"forge",desc:"A good upgrade to the furnace.",time:10,consume:[[10,s.resources.craftables.basic.stone],[6,s.resources.gatherables.uncommon.oil],[2,s.resources.craftables.basic.tool]],upgrade:s.buildings.small.furnace,asset:"furnace+1",order:27,log:"We can now work metal better and make more complex part."}),s.resources.craftables.complex.brick=e({id:"brk",name:"brick",desc:"Bricks will give walls for larger constructions.",icon:"brick",ifHas:s.buildings.small.well,consume:[[1,s.resources.craftables.basic.stone],[1,s.resources.craftables.basic.tool]],dropRate:80,order:112}),s.resources.craftables.complex.circuit=e({id:"cir",name:"circuit",desc:"That's a little rough, but it's actually a functioning circuit board.",icon:"electronic-circuit-board",consume:[[1,s.resources.gatherables.common.scrap],[2,s.resources.craftables.basic.component],[3,s.resources.gatherables.rare.electronic]],dropRate:60,order:114}),s.resources.craftables.complex.metalPipe=e({id:"mtp",name:"metal pipe",desc:"Pipes that you forge from junk metal.",icon:"pipes-small",ifHas:s.buildings.medium.forge,consume:[[4,s.resources.gatherables.common.scrap],[1,s.resources.craftables.basic.tool]],dropRate:80,order:115}),s.resources.craftables.advanced.jewelry=e({id:"jwl",name:"jewelry",desc:"A really beautiful ornament you could use for trading.",icon:"jewelry",ifHas:s.buildings.small.furnace,consume:[[4,s.resources.gatherables.rare.electronic],[3,s.resources.special.quartz]],dropRate:40,order:117}),s.buildings.big.workshop=e({id:"wrs",name:"workshop",desc:"Organizing your workforce make them more efficient at crafting.",time:3*t.day,energy:90,ifHas:s.buildings.medium.forge,consume:[[6,s.resources.gatherables.common.scrap],[5,s.resources.craftables.basic.glass],[10,s.resources.craftables.basic.tool],[15,s.resources.craftables.complex.brick]],asset:"workshop",order:35,log:"Good organisation allow you to prepare project and do much more complex crafting."}),s.resources.craftables.complex.furniture=e({id:"fnt",name:"furniture",desc:"A proper settlement needs better than pile of trash for table and seats.",icon:"glass-table",ifHas:s.buildings.big.workshop,consume:[[2,s.resources.craftables.basic.glass],[2,s.resources.craftables.complex.metalPipe]],dropRate:40,order:116}),s.buildings.big.forum3=e({id:"fr3",name:"forum+3",desc:"Add two rooms.",time:6,consume:[[10,s.resources.craftables.complex.brick],[2,s.resources.craftables.complex.furniture],[6,s.resources.craftables.basic.glass]],upgrade:s.buildings.medium.forum2,give:[[2,s.resources.room]],asset:"forum+3",order:30,log:"All the forum space is now used for sleeping place."}),s.resources.craftables.advanced.engine=e({id:"egn",name:"engine",desc:"Amazing what you manage to do with all those scraps !",icon:"engine",ifHas:s.buildings.big.workshop,consume:[[10,s.resources.gatherables.uncommon.oil],[5,s.resources.craftables.basic.tool],[5,s.resources.craftables.complex.metalPipe]],dropRate:30,order:120}),s.resources.craftables.advanced.computer=e({id:"cmt",name:"computer",desc:"Well, Internet is down since 2136 but it can still be useful.",icon:"computer",ifHas:s.buildings.big.workshop,consume:[[10,s.resources.craftables.basic.component],[7,s.resources.craftables.basic.tool],[3,s.resources.craftables.complex.circuit]],dropRate:20,order:130}),s.buildings.big.radio=e({id:"rdo",name:"radio-station",desc:"Broadcasting could finally bring us some help.",time:6,ifHas:s.buildings.big.workshop,consume:[[4,s.resources.craftables.complex.circuit],[1,s.resources.craftables.advanced.computer]],asset:"radio",order:37,log:'"Message received. We thought no one survive the crash. Glad you still have the cube.Unfortunately we can\'t risk being located, bring it to sent position. Over."'}),s.buildings.big.pump=e({id:"pmp",name:"water pump",desc:"A buried contraption that collect water from the earth moisture.",time:3*t.day,energy:120,consume:[[20,s.resources.craftables.basic.stone],[5,s.resources.craftables.complex.metalPipe],[1,s.resources.craftables.advanced.engine]],upgrade:s.buildings.small.well,unlockForAll:[s.actions.drawFromWell],asset:"pump",order:36,log:"A big upgrade to your well ! Now we have a continuous flow of water coming."}),s.buildings.big.trading=e({id:"trd",name:"trading post",desc:"Since the radio station bring a handful of merchant, better take advantage of it.",time:t.day,energy:70,ifHas:s.buildings.big.radio,consume:[[2,s.resources.craftables.basic.glass],[10,s.resources.craftables.complex.brick],[2,s.resources.craftables.complex.furniture]],unlockForAll:[s.actions.exchange],asset:"trading",order:38,log:"Arranging some space allow us to trade with merchant caravan passing by."}),s.buildings.big.module=e({id:"mdl",name:"module",desc:"With that, we can finally deliver the cube to security.",time:t.week,energy:100,ifHas:s.buildings.big.radio,consume:[[15,s.resources.gatherables.uncommon.oil],[3,s.resources.craftables.complex.furniture],[1,s.resources.craftables.advanced.computer],[2,s.resources.craftables.advanced.engine]],unlockForAll:[s.actions.launch],asset:"module",order:40,log:"What a journey, but there we are. We build so many things and explore lots of places.<br/>Now it's time to end it all !"}),s.locations.near.mountain=e({id:"mnt",name:"mountain",desc:"A nearby mountain that may contains some basic building resources",giveList:[s.resources.gatherables.common.rock,s.resources.gatherables.common.scrap,s.resources.craftables.basic.component],log:"That was hard to climb those mountains, but at least @people.name find @give.",dropRate:90}),s.locations.near.desert=e({id:"dst",name:"desert",desc:"Not much to find in a desert, but that's for sure the best place to get sand.",giveList:[s.resources.gatherables.common.scrap,s.resources.gatherables.uncommon.oil,s.resources.gatherables.uncommon.sand],log:"Dunes everywhere give a felling of hopelessness. Anyway, here's @give for the stock.",dropRate:100}),s.locations.near.supermarket=e({id:"hng",name:"hangar",desc:"A huge hangar. It was certainly raided before by others, but you may grab something.",giveList:[s.resources.gatherables.common.food,s.resources.gatherables.rare.medication,s.resources.craftables.basic.glass],log:"Quite easy to loot, but full of dangers too. Hopefully, @people.name return safely and got @give.",dropRate:80}),s.locations.far.river=e({id:"rvr",name:"river",desc:"Quite rare to find water around here. This is a valuable location to find.",unlockForAll:[s.actions.drawFromRiver],giveList:[s.resources.gatherables.common.water,s.resources.gatherables.uncommon.bolts,s.resources.craftables.basic.stone],log:"It's nice by the river, @people.name found @give.",dropRate:40}),s.locations.far.ruin=e({id:"orn",name:"old ruin",desc:"This is a huge underground network of rooms linked by narrow hallways. This should have provided shelter a long time ago.",giveList:[s.resources.gatherables.rare.electronic,s.resources.craftables.basic.component,s.resources.craftables.basic.tool],log:"Amazing no-one get lost in those caves to get @give.",dropRate:60}),s.locations.epic.building=e({id:"bld",name:"buried building",desc:"By digging up this building, you uncover stuff preserved from looting and environment.",giveList:[s.resources.gatherables.rare.medication,s.resources.craftables.basic.glass,s.resources.craftables.complex.circuit],log:"No-one could guess what that building was, but it sure was interesting. @people.name find @give.",dropRate:30}),s.locations.epic.spaceship=e({id:"swr",name:"spaceship wreck",desc:"This wreckage seems to be in a fairly good shape and allow you to find useful part inside.",giveList:[s.resources.gatherables.rare.electronic,s.resources.craftables.basic.tool,s.resources.craftables.complex.furniture],log:"What a chance to find a wreckage with not melted stuff inside. It was possible to get @give.",dropRate:20}),s.events.easy.sandstorm=e({id:"ssm",name:"sandstorm",desc:"The wind is blowing hard, impossible to go out for now.",time:20,timeDelta:4,effect:function(e){this.flags.cantGoOut=e},dropRate:100,log:"A sandstorm has started and prevent anyone from leaving the camp."}),s.events.hard.drought=e({id:"drg",name:"drought",desc:"The climate is so hot, we consume more water.",time:3*t.day,timeDelta:10,effect:function(e){this.flags.drought=e},dropRate:10,log:"A harsh drought has fall, water will be more important than ever."}),s.perks.first=e({id:"fso",name:"first-one",desc:"The very first one to install the settlement.",actions:[s.actions.settle],iteration:0}),s.perks.rookie=e({id:"rki",name:"rookie",desc:"All group has a rookie, all @people.nominative want is to prove @people.nominative's efficient.",condition:function(){return this.people.length>2},effect:function(e){e.timeBonus=.9}}),s.perks.explorer=e({id:"xpr",name:"gadabout",desc:"The veteran of the camp and leader of the exploration. @people.nominative knows the best spot of resources.",actions:[s.actions.roam,s.actions.scour,s.actions.explore],iteration:30,effect:function(e){if(e.id===s.actions.explore){e.giveSpan=e.giveSpan.map(function(e){return e+2})}}}),s.perks.tinkerer=e({id:"tnr",name:"tinkerer",desc:"Everyone is amazed by how quickly @people.nominative can put together any contraption.",actions:[s.actions.craft,s.actions.build],iteration:30,effect:function(e){e.timeBonus=.5}}),s.perks.healer=e({id:"hlr",name:"doctor",desc:"Knowing enough about medicine make @people.accusative confident to heal others.",actions:[s.actions.heal],ifHas:s.buildings.small.pharmacy,iteration:5,unlock:[s.actions.nurse]}),s.perks.harvester=e({id:"hvt",name:"harvester",desc:"A real eagle eye that can spot goods twice as fast as anyone.",actions:[s.actions.gather,s.actions.harvestField,s.actions.harvestPlot,s.actions.drawFromRiver,s.actions.drawFromWell],iteration:40,effect:function(e){e.giveSpan=e.giveSpan.map(function(e){return 1.5*e})}}),s.perks.lounger=e({id:"lng",name:"lounger",desc:"Doing nothing all day's not gonna make things done.",actions:[s.actions.sleep],condition:function(e){return e.stats.idle>3*t.day},effect:function(e){e.timeBonus=-.2}}),s.perks.merchant=e({id:"mrc",name:"merchant",desc:"The ancient art of trading have been one of the most important skill you could have.",action:[s.actions.exchange],iteration:10,effect:function(e){e.consume[0]=1}}),{time:t,ids:s,get:function(e){return o[e]},bindAll:function(e){o.browse(function(t){t.browse(function(i,s){p.isFunction(i)&&(t[s]=i.bind(e))})})}}}(),y=function(){function e(t,i){if(!i)throw new TypeError("Can't draw asset without destination");this.animationState=0,this.animationSteps=i.steps||1,this.animationSpeed=(i.speed||0)/60,this.source={},this.destination={},this.defineSource(t),this.destination.x=v.floor(+i.x*e.ENLARGE),this.destination.y=v.floor(+i.y*e.ENLARGE)}var t,i,s,o,n;return e.ENLARGE=4,e.prototype={defineSource:function(t){this.source={x:t.x,y:t.y,width:v.floor(t.width/this.animationSteps),height:t.height},this.destination.width=this.source.width*e.ENLARGE,this.destination.height=this.source.height*e.ENLARGE},render:function(e,t){this.animationState=(this.animationState+this.animationSpeed)%this.animationSteps;var i=v.floor(this.animationState)*this.source.width,s=this.destination.x,o=this.destination.y;t.drawImage(e,this.source.x+i,this.source.y,this.source.width,this.source.height,s,o,this.destination.width,this.destination.height)},getDepth:function(){return this.destination.y},compare:function(e){return e.destination.y+e.destination.height-(this.destination.y+this.destination.height)},setPosition:function(e,t){this.destination.x=+e,this.destination.y=+t}},{start:function(r,a,c){t=a,i=c.assets,s=c.positions;var l=g.prepareCanvas(800,300);(o=l.ctx).imageSmoothingEnabled=0,l.cnv.classList.add("layer","buildings"),r.appendChild(l.cnv),(l=g.prepareCanvas(r.offsetWidth,r.offsetHeight)).cnv.classList.add("layer","events"),r.appendChild(l.cnv),n=new Map,k.observe(k.MSG_TYPES.BUILD,function(t){var o=b.get(t);if(o&&o.asset){var r=new e(i[o.asset],s[o.asset]);if(o.upgrade){var a=o.upgrade;n.has(a)&&n.set(a,r)}else n.push(o.id,r)}}.bind(this)),this.render()},render:function(){requestAnimationFrame(this.render.bind(this)),n.size&&(o.clear(),n.getValues().sort(function(e,t){return e.compare(t)}).forEach(function(e){e.render(t,o)}))}}}(),w=function(){var e={0:"info",1:"warning",2:"flavor",3:"event"},t=null,i={LOG_TYPES:{INFO:0,WARN:1,FLAVOR:2,EVENT:3},maxLog:50,start:function(e){t=e,k.observe(i.LOG_TYPES.values(),function(e,t){i.log(e,t)}).observe(k.MSG_TYPES.ARRIVAL,function(e){i.log(e.name+" has arrived.",k.MSG_TYPES.LOGS.EVENT)}).observe(k.MSG_TYPES.LOOSE_SOMEONE,function(e){var t="We lost "+e.name+".";i.log(t,i.LOG_TYPES.WARN)}).observe(k.MSG_TYPES.LOOSE,function(e){s("death","survival duration",e);var t="We held up for "+p.formatTime(e)+", but all is lost now.";i.log(t,i.LOG_TYPES.EVENT)}).observe(k.MSG_TYPES.RUNS_OUT,function(e){var t=b.get(e),s=t.icon?h.iconAsString(t.icon):"",o="We run out of "+t.name+" "+s+", we need to do something.";i.log(o,i.LOG_TYPES.WARN)}).observe(k.MSG_TYPES.GAIN_PERK,function(e){var t=e.name+' is now known as the "'+p.capitalize(e.perk.data.name)+'".';i.log(t,i.LOG_TYPES.EVENT)}).observe(k.MSG_TYPES.WIN,function(e){s("win","survival duration",e);var t="It took "+p.formatTime(e)+" to escape.";i.log(t,i.LOG_TYPES.EVENT)})},log:function(i,s){if(i.length){s=s||0,t.insertBefore(p.wrap("log "+e[s],i),t.firstChild);var o=Array.prototype.slice.call(t.children);o.length>w.maxLog&&o.last().remove()}},personify:function(e,t){return e.replace(/@([\w.]+)\b/gi,function(e,i){var s=t;return i.split(".").forEach(function(e){s=s[e]}),s||""})}};return i}(),k=function(){var e=[],t={observe:function(t,i){return p.isArray(t)||(t=[t]),t.forEach(function(t){e[t]||(e[t]=[]),e[t].push(i)}),this},notify:function(t,i,s){var o=this.SWAP_MSG_TYPE[t];return s||p.log("Message ",o||t,i),e[t]&&e[t].forEach(function(e){e(i,t)}),this},MSG_TYPES:{LOGS:w.LOG_TYPES,CLICK:10,REFRESH:20,GIVE:30,FIND_LOCATION:31,ARRIVAL:33,USE:35,RUNS_OUT:36,LOOSE_RESOURCE:38,LOOSE_SOMEONE:39,UNLOCK:40,GAIN_PERK:45,LOCK:50,START_BUILD:59,BUILD:60,UNBUILD:61,EVENT_START:70,EVENT_CANCEL:71,EVENT_END:72,SAVE:80,LOOSE:90,WIN:95,KEYS:{TAB:1009,SPACE:1032,ENTER:1013,ESCAPE:1027,UP:1038,RIGHT:1039,DOWN:1040,LEFT:1037,CTRL:1017,SHIFT:1016,BACK:1008,ONE:1049,TWO:1050,THREE:1051,FOUR:1052,FIVE:1053,SIX:1054,SEVEN:1055,EIGHT:1056,NINE:1057,ZERO:1048,F5:1116,F8:1119,F12:1123}}};return window.addEventListener("keydown",function(e){var i=1e3+e.keyCode;i!==t.MSG_TYPES.KEYS.F5&&i!==t.MSG_TYPES.KEYS.F12&&i!==t.MSG_TYPES.KEYS.TAB&&(e.preventDefault(),e.stopPropagation()),t.notify(i,"down",!0)},!0),window.addEventListener("keyup",function(e){e.preventDefault(),e.stopPropagation(),t.notify(1e3+e.keyCode,"up")},!0),t.SWAP_MSG_TYPE=t.MSG_TYPES.swap(),t}(),E=function(){function e(e){var t=btoa(o+btoa(e));return p.log("Compress: "+e.length+" => "+t.length),t}function t(e){return atob(atob(e).substr(o.length))}var i=localStorage,s=i.getItem("k");s||(s=p.randomStr(),i.setItem("k",s));var o=p.randomStr();return{persist:function(t){i.setItem(s,e(JSON.stringify(t)))},hasData:function(){return Object.keys(i).includes(s)},load:function(){return JSON.parse(t(i.getItem(s)))},clear:function(){i.removeItem(s)}}}(),S=function(){function e(e,t){this.startTime=p.getNow(),this.action=e,this.time=t,this.isRunning=!0,this.timeout=this.setTimeout()}e.prototype={setTimeout:function(){return setTimeout(this.action,this.time)},getElapsed:function(){return p.getNow()-this.startTime},getRemaining:function(){return this.time-this.getElapsed()},stop:function(){return!!this.isRunning&&(this.isRunning=!1,this.time=this.getRemaining(),clearTimeout(this.timeout),this.time)},restart:function(e){return!this.isRunning&&(this.isRunning=!0,this.startTime=e,this.timeout=this.setTimeout(),this.time)}};var t=new Map;return{timeout:function(i,s){var o=p.randomStr(),n=function(){t.delete(o),i()};return o=t.push(new e(n,s))},stop:function(e){return t.get(e).stop()},stopAll:function(){t.forEach(function(e){e.stop()})},restart:function(e){return t.get(e).restart(p.getNow())},restartAll:function(){var e=p.getNow();t.forEach(function(t){t.restart(e)})},clear:function(e){return t.delete(e).stop()},clearAll:function(){t.forEach(function(e){e.clear()})},getElapsed:function(e){return t.get(e).getElapsed()},getRemaining:function(e){return t.get(e).getRemaining()}}}();o.COOLDOWN_CLASS="cooldown",o.RUNNING_CLASS="running",o.DISABLED_CLASS="disabled",o.extends(i,"Action",{toHTML:function(){var e=this._toHTML(),t=p.wrap("name clickable disabled animated",p.capitalize(this.data.name));return this.nameNode=t,e.appendChild(t),p.isFunction(this.data.options)?(e.classList.add("withOptions"),this.optionsWrapper=p.wrap("options"),e.appendChild(this.optionsWrapper)):e.addEventListener("click",function(){this.click()}.bind(this),!0),this.data.order&&(e.style.order=this.data.order),e},init:function(){this.data.time=this.data.time||0,p.isUndefined(this.data.energy)&&(this.data.energy=5*this.data.time),this.tooltip=new m(this.nameNode,this.data),this.manageOptions()},manageOptions:function(){if(p.isFunction(this.data.options)){this.options||(this.options=new Map);var e=this.data.options(this);this.options.forEach(function(t){e.includes(t.data.id)||t.lock()});for(var t,i,s=0,n=e.length;s<n;++s)i=e[s],this.options.has(i)||(t=new o(i,this.owner,this),this.options.push(i,t),this.optionsWrapper.appendChild(t.html))}},refresh:function(e,t){this.locked=this.owner.isTired()&&this.data.energy>0||this.data.isOut&&t.cantGoOut||this.parentAction&&this.parentAction.locked,this.tooltip.refresh(e,this.data),p.isArray(this.data.consume)&&!this.locked&&this.data.consume.forEach(function(t){var i=t[1];e.has(i)&&e.get(i).has(t[0])||(this.locked=!0)},this),this.manageOptions(),this.options&&this.options.forEach(function(i){i.refresh(e,t)}),this.nameNode.classList.toggle(o.DISABLED_CLASS,this.locked)},click:function(e){if(this.owner.busy||this.locked)return!1;if(this.parentAction)return this.parentAction.click(this.data.id);if(e||!this.options){this.choosenOptionId=e;var t=this.mergeWithOption(e);p.isArray(t.consume)&&k.notify(k.MSG_TYPES.USE,t.consume),t.build&&k.notify(k.MSG_TYPES.START_BUILD,t.build),this.html.classList.add(o.RUNNING_CLASS),++this.repeated;var i=this.defineDuration(t);return this.energyDrain=t.energy/i,this.start(i*a.tickLength),k.notify(k.MSG_TYPES.SAVE),!0}},defineDuration:function(e){var t=e.time||0;return e.timeDelta&&(t+=v.random(-e.timeDelta,e.timeDelta)),e.timeBonus&&(t-=t*e.timeBonus),t},start:function(e,t){var i=e+(t=t||0);this.owner.setBusy(this.data.id,this.energyDrain),this.nameNode.style.animationDuration=i+"ms",this.nameNode.style.animationDelay=-t+"ms",this.nameNode.classList.add(o.COOLDOWN_CLASS),this.timeout=S.timeout(this.end.bind(this),e)},mergeWithOption:function(e){var t={},i=this.data,s={};e&&(s=b.get(e));var o={},n=s.build||i.build;n&&(n===b.ids.option?n=e:o=b.get(n)),t.build=n,t.optionId=e;var r=["consume","give","unlock","lock","unlockForAll","lockForAll"],a=["giveList"];return["name","desc","log","time","timeDelta","timeBonus","energy","giveSpan"].forEach(function(e){t[e]=o[e]||s[e]||i[e]}),r.forEach(function(e){(i[e]||s[e]||o[e])&&(t[e]=(i[e]||[]).concat(s[e]||[]).concat(o[e]||[]))}),a.forEach(function(e){(o[e]||i[e]||s[e])&&(t[e]=Object.assign({},i[e]||{},s[e]||{},o[e]||{}))}),t},end:function(){this.timeout=null,this.html.classList.remove(o.RUNNING_CLASS),this.nameNode.classList.remove(o.COOLDOWN_CLASS);var e={name:this.data.name,people:this.owner},t=this.mergeWithOption(this.choosenOptionId);this.choosenOptionId=null,this.owner.finishAction(),p.isFunction(this.data.effect)&&this.data.effect(this,t,e);var i=this.resolveAction(e,t);i.give.length&&k.notify(k.MSG_TYPES.GIVE,i.give),i.unlock.forAll.length&&k.notify(k.MSG_TYPES.UNLOCK,i.unlock.forAll),i.unlock.forOne.length&&this.owner.addAction(i.unlock.forOne),i.lock.forAll.length&&k.notify(k.MSG_TYPES.LOCK,i.lock.forAll),i.lock.forOne.length&&this.owner.lockAction(i.lock.forOne),i.build&&k.notify(k.MSG_TYPES.BUILD,i.build),k.notify(e.logType||k.MSG_TYPES.LOGS.INFO,p.capitalize(i.log)),k.notify(k.MSG_TYPES.SAVE)},resolveAction:function(e,t){var i={give:[],unlock:{forAll:[],forOne:[]},lock:{forAll:[],forOne:[]},log:""};p.isArray(t.give)?i.give=t.give:t.giveSpan&&t.giveList&&(i.give=p.randomizeMultiple(t.giveList,t.giveSpan)),i.give.forEach(function(e,i,s){e[1]===b.ids.option&&(s[i]=[e[0],t.optionId])});var s=this.repeated;if(p.isArray(this.data.unlockAfter)&&this.data.unlockAfter.forEach(function(e){s>e[0]&&i.unlock.forOne.push(e[1])}),p.isArray(t.unlock)){var o=t.unlock.filter(function(e){var t=b.get(e);return!t.condition||t.condition(this)},this);this.data.unique?i.unlock.forAll.insert(o):i.unlock.forOne.insert(o)}if(p.isArray(t.unlockForAll)&&i.unlock.forAll.insert(t.unlockForAll.filter(function(e){var t=b.get(e);return!t.condition||t.condition(this)},this)),p.isArray(this.data.lockAfter)&&this.data.lockAfter.forEach(function(e){s>e[0]&&i.lock.forOne.push(e[1])}),p.isArray(t.lock)&&(this.data.unique?i.lock.forAll=t.lock:i.lock.forOne=t.lock),p.isArray(t.lockForAll)&&i.lock.forAll.insert(t.lockForAll),this.data.unique&&i.lock.forAll.push(this.data.id),t.build){var n=b.get(t.build);i.build=t.build,e.build=p.an(n.name)}i.give=p.compactResources(i.give),e.give=p.formatArray(i.give);var r=t.log||"",a=p.isFunction(r)?r(e,this):r;return i.log=w.personify(a,e),i},lock:function(){this.cancel(),this.tooltip.remove(),this.options?this.options.forEach(function(e){e.lock()}):this.parentAction&&this.parentAction.options.delete(this.data.id),this.html.remove()},cancel:function(){this.timeout&&(S.clear(this.timeout),this.owner.setBusy(),this.html.classList.remove(o.RUNNING_CLASS),this.nameNode.classList.remove(o.COOLDOWN_CLASS))},getStraight:function(){var e=this._getStraight();return e.repeated=this.repeated,this.timeout&&(e.elapsed=S.getElapsed(this.timeout),e.remaining=S.getRemaining(this.timeout),e.energyDrain=this.energyDrain,e.optionId=this.choosenOptionId),e}}),n.extends(i,"Building",{toHTML:p.noop,init:function(){this.data.lock&&k.notify(k.MSG_TYPES.LOCK,this.data.lock),this.data.unlock&&k.notify(k.MSG_TYPES.UNLOCK,this.data.unlock)}}),r.extends(i,"Event",{init:function(){this.tooltip&&this.tooltip.remove(),this.tooltip=new m(this.html,this.data)},toHTML:function(){var e=this._toHTML();return this.nameNode=p.wrap("name",p.capitalize(this.data.name)),e.appendChild(this.nameNode),this.progressBar=new d("timer animated"),e.appendChild(this.progressBar.html),e},start:function(e){return f(this.data,function(){var t={event:this.data};if(this.data.effect(!0,this,t),this.data.time){k.notify(k.MSG_TYPES.EVENT_START,this);var i=this.data.time*a.tickLength;this.data.deltaTime&&(i+=v.random(-this.data.deltaTime,this.data.deltaTime)),this.progressBar.run(i),this.timer=S.timeout(this.end.bind(this),i)}e&&e(this);var s;s=p.isFunction(this.data.log)?this.data.log(t,this):this.data.log||"";var o=w.personify(s,t);k.notify(t.logType||k.MSG_TYPES.LOGS.EVENT,p.capitalize(o))}.bind(this),"event"),!!this.data.time},cancel:function(){this.timer&&(S.stop(this.timer),this.end())},end:function(){this.data.effect(!1,this),this.timer=null,k.notify(k.MSG_TYPES.EVENT_END,this),this.html.remove()},getStraight:function(){var e=this._getStraight();return e.remains=S.getRemaining(this.timer),e}}),r.LST_ID="eventList",a.tickLength=2e3,a.extends(i,"GameController",{toHTML:function(){var e=this._toHTML();this.resourcesList=p.wrap(h.LST_ID),e.appendChild(this.resourcesList),this.peopleList=p.wrap(l.LST_ID),e.appendChild(this.peopleList),this.visualPane=p.wrap("visualPane"),e.appendChild(this.visualPane),this.eventsList=p.wrap(r.LST_ID),e.appendChild(this.eventsList),this.logsList=p.wrap("logs"),e.appendChild(this.logsList);var t=this,i=p.wrap("bottomOptions"),o=p.wrap("wipe clickable","Clear save");o.addEventListener("click",function(){f({name:"Clear your save",desc:"Completely wipe your saved game. Careful, this is irreversible."},{yes:{name:"Restart anew",action:function(){s("Save","wipe"),t.wipeSave(),location.reload()}},no:{name:"Cancel"}},"wipeIt")}),i.appendChild(o);var n=p.wrap("credits clickable","Credits");return n.addEventListener("click",function(){f({name:"Settlement",desc:"<ul><li>Design and code: Guillaume Martigny</li><li>Graphics: Maybe you ;)</li>"})}),i.appendChild(n),e.appendChild(i),e},init:function(e){var t=this;b.bindAll(this),e.innerHTML="",e.appendChild(this.html),y.start(this.visualPane,this.assets.images,this.assets.data),w.start(this.logsList),this.registerObservers(),E.hasData()?this.loadGame():(k.notify(k.MSG_TYPES.BUILD,b.ids.buildings.special.wreckage),this.initialActions.push(b.ids.actions.wakeUp),S.timeout(this.prepareNewcomer.bind(this,1),500)),"v0.4.0".includes("v0.")&&f({name:"Early access [v0.4.0]",desc:"You'll see a very early stage of the game. It may be broken, it may not be balanced ...<br/>If you want to report a bug or anything to improve the game, go to <a href='https://github.com/GMartigny/settlement'>the project's page</a>.<br/><br/>Thanks for playing !"},{yes:{name:"Got it !",action:function(){t.flags.ready=!0}}}),this.refresh()},registerObservers:function(){var e=this,t=k.MSG_TYPES;k.observe(t.GIVE,function(t){p.isArray(t)&&t.forEach(function(t){e.earn.apply(e,t)})}).observe(t.USE,function(t){p.isArray(t)&&p.compactResources(t).forEach(function(t){e.consume.apply(e,t)})}).observe(t.START_BUILD,function(t){e.buildingsInProgress.push(t)}).observe(t.BUILD,this.build.bind(this)).observe(t.LOOSE_SOMEONE,function(i){e.people.out(i),e.people.length<=0&&(k.notify(t.LOOSE,e.getSettledTime()),e.flags.paused=!0,e.wipeSave())}).observe(t.EVENT_START,function(t){e.events.push(t.data.id,t)}).observe(t.EVENT_END,function(t){e.events.delete(t.data.id)}).observe(t.LOCK,this.removeFromInitialActions.bind(this)).observe(t.UNLOCK,this.addToInitialActions.bind(this)).observe(t.SAVE,this.saveGame.bind(this)).observe(t.WIN,function(){this.flags.paused=!0}).observe(t.KEYS.SPACE,function(t){"up"===t&&e.togglePause()})},addToInitialActions:function(e){p.isArray(e)||(e=[e]),e.forEach(function(e){this.initialActions.includes(e)||this.initialActions.push(e)},this),this.people.forEach(function(t){t.addAction(e)})},removeFromInitialActions:function(e){p.isArray(e)||(e=[e]),e.forEach(function(e){this.initialActions.out(e)},this),this.people.forEach(function(t){t.lockAction(e)})},getSettledTime:function(){return this.flags.settled?this.flags.survived/a.tickLength:0},getSurvivalDuration:function(){return p.formatTime(this.getSettledTime())},togglePause:function(){this.flags.paused=!this.flags.paused,this.html.classList.toggle("paused",this.flags.paused),this.html.classList.toggle("backdrop",this.flags.paused),this.flags.paused?S.stopAll():S.restartAll()},refresh:function(){var e=v.floor((p.getNow()-this.lastTick)/a.tickLength);if(this.lastTick+=e*a.tickLength,this.flags.paused&&(e=0),S.timeout(this.refresh.bind(this),a.tickLength/3),e>0){if(this.flags.settled){this.flags.survived+=e*a.tickLength;var t=b.get(b.ids.people).needs;this.flags.drought&&(t[0][0]*=2),t.forEach(function(e){this.flags[e[2]]=0,this.consume(e[0],e[1],function(t){this.flags[e[2]]=t})},this);var i=b.get(b.ids.people).dropRate;this.canSomeoneArrive()&&v.random()<i&&this.prepareNewcomer();!this.flags.popup&&v.random()<.01&&this.startEvent(this.getRandomEvent())}this.resources.forEach(function(e,t,i){e.refresh(i)}),this.people.forEach(function(t){t.refresh(this.resources,e,this.flags)},this),this.saveGame()}},hasEnough:function(e,t){return this.resources.has(e)&&this.resources.get(e).has(t)},consume:function(e,t,i){if(e){var s=this.resources.get(t);if(s)if(s.has(e))s.update(-e),s.warnLack=!1;else{if(s.set(0),p.isFunction(i)){var o=e-s.count;i.call(this,o,t)}s.warnLack||(s.warnLack=!0,k.notify(k.MSG_TYPES.RUNS_OUT,t))}}},earn:function(e,t){if(this.resources.has(t))this.resources.get(t).update(e);else{var i=new h(t,e);this.resources.push(t,i),this.resourcesList.appendChild(i.html)}},prepareNewcomer:function(e){var t=this;c(e||1).then(function(e){e.forEach(function(e){e.addAction(t.initialActions),t.people.length||(e.life=0,e.energy=0,e.updateLife(0),e.updateEnergy(0))}),t.arrive(e)})},arrive:function(e){p.isArray(e)||(e=[e]),e.forEach(function(e){this.people.length&&(k.notify(k.MSG_TYPES.ARRIVAL,e),1===this.people.length&&S.timeout(function(){var t=e.name+" say that there's other desert-walkers ready to join you if there's room for them.";k.notify(k.MSG_TYPES.LOGS.FLAVOR,t)},2e3)),this.people.push(e),this.peopleList.appendChild(e.html),e.html.offsetHeight,e.html.classList.add("arrived")},this)},build:function(e){if(this.buildingsInProgress.out(e),!this.buildings.has(e)){var t=new n(e);this.buildings.push(e,t)}},unlockedCraftables:function(){var e=[];return b.ids.resources.craftables.deepBrowse(function(t){var i=b.get(t);i.ifHas&&!this.buildings.has(i.ifHas)||!(!i.condition||p.isFunction(i.condition)&&i.condition())||e.push(t)},this),e},possibleCraftables:function(){var e=this;return this.unlockedCraftables().filter(function(t){var i=b.get(t),s=!0;return p.isFunction(i.consume)&&i.consume(i).forEach(function(t){s=s&&e.hasEnough(t[1],t[0])}),s})},possibleBuildings:function(){var e=[];return b.ids.buildings.deepBrowse(function(t){var i=b.get(t);this.isBuildingInProgress(t)||this.isBuildingDone(t)||i.upgrade&&!this.buildings.has(i.upgrade)||i.ifHas&&!this.isBuildingDone(i.ifHas)||e.push(t)},this),e},isBuildingInProgress:function(e){return this.buildingsInProgress.includes(e)},isBuildingDone:function(e){var t=!1;return this.buildings.forEach(function(i){var s=i.data;if(!(t=t||s.id===e))for(;s.upgrade&&!t;)s=b.get(s.upgrade),t=t||s.id===e},this),t},canSomeoneArrive:function(){return this.hasEnough(b.ids.resources.room,this.people.length+1)},getRandomEvent:function(){var e=[],t=this.getSettledTime()/b.time.week;return t>1&&(e.push.apply(e,b.ids.events.easy),t>2&&(e.push.apply(e,b.ids.events.medium),t>5&&e.push.apply(e,b.ids.events.hard))),e=e.filter(function(e){var t=b.get(e);return!this.events.has(e)&&(!t.condition||p.isFunction(t.condition)&&t.condition(t))},this),e.length?p.randomize(e):null},startEvent:function(e){if(e){var t=new r(e);this.flags.popup=!!t.start(function(e){e.data.time&&this.eventsList.appendChild(e.html),this.flags.popup=!1}.bind(this))}},saveGame:function(){var e={stl:this.flags.settled,res:this.resources.getValues().map(function(e){return e.getStraight()}),plp:this.people.map(function(e){return e.getStraight()}),iac:this.initialActions,bld:this.buildings.getValues().map(function(e){return e.getStraight()}),evt:this.events.getValues().map(function(e){return e.getStraight()}),lct:this.knownLocations,bip:this.buildingsInProgress,settled:this.flags.settled,survived:this.flags.survived};E.persist(e)},loadGame:function(){var e=E.load();k.notify(k.MSG_TYPES.GIVE,e.res),this.arrive(e.plp.map(function(e){var t=new l(e.nam,e.gnd);return t.setLife(e.lif),t.setEnergy(e.ene),t.stats=e.sts,e.prk&&t.gainPerk(e.prk),e.act.forEach(function(e){t.addAction(e.id);var i=t.actions.get(e.id);i.repeated=e.repeated,e.remaining&&(i.choosenOptionId=e.optionId,i.energyDrain=e.energyDrain,i.start(e.remaining,e.elapsed))}),t})),this.addToInitialActions(e.iac),e.bld.forEach(function(e){k.notify(k.MSG_TYPES.BUILD,e.id)}),this.knownLocations=e.lct,this.buildingsInProgress=e.bip,this.flags.settled=e.settled,this.flags.survived=e.survived},wipeSave:function(){E.clear()}}),l.LST_ID="peopleList",l.extends(i,"People",{init:function(){this.setPronouns(),new m(this.lifeBar.html,{name:"Health",desc:"The first thing you want is a good health."}),new m(this.energyBar.html,{name:"Energy",desc:"Drained faster when busy or hungry."})},toHTML:function(){var e=this._toHTML();return this.nameNode=p.wrap("name",p.capitalize(this.name)),e.appendChild(this.nameNode),this.lifeBar=new d("life",25),e.appendChild(this.lifeBar.html),this.energyBar=new d("energy"),e.appendChild(this.energyBar.html),this.actionList=p.wrap("actionList"),e.appendChild(this.actionList),e},refresh:function(e,t,i){if(this.actions.forEach(function(t){t.refresh(e,i)}),i.settled){this.stats.age+=t,this.stats.idle+=t;var s=this.perk&&this.perk.id===b.ids.perks.lounger?0:this.energyDrain;this.updateEnergy(-t*(s+30*i.starving)),i.thirsty&&this.updateLife(-t*i.thirsty*30)}},setPronouns:function(){switch(this.gender){case"female":this.nominative="she",this.accusative="her",this.possessive="her",this.reflexive="herself";break;case"male":this.nominative="he",this.accusative="him",this.possessive="his",this.reflexive="himself";break;default:this.nominative="it",this.accusative="it",this.possessive="its",this.reflexive="itself"}},setBusy:function(e,t){this.busy=e||!1,e?(e!==b.ids.actions.sleep&&(this.stats.idle=0),this.energyDrain=t):this.energyDrain=1,this.html.classList.toggle("busy",this.busy)},finishAction:function(){this.rollForPerk(this.busy),this.setBusy()},updateEnergy:function(e){var t=this.energy+=e;return t>100?t=100:t<0&&(this.updateLife(t),t=0),this.setEnergy(t),this.energy},setEnergy:function(e){this.energy=e,this.energyBar.set(e)},isTired:function(){return this.energy.equals(0)||this.energy<0},updateLife:function(e){var t=this.life+e;return t>100&&(t=100),this.setLife(t),t},setLife:function(e){this.life=e,this.lifeBar.set(e),e<0&&this.die()},addAction:function(e){p.isArray(e)||(e=[e]),e.forEach(function(e){if(!this.actions.has(e)){var t=new o(e,this);this.actions.push(e,t),this.actionList.appendChild(t.html)}},this)},lockAction:function(e){p.isArray(e)||(e=[e]),e.forEach(function(e){var t=this.actions.get(e);t&&(t.lock(),this.actions.delete(e))},this)},rollForPerk:function(e){var t=!1;if(!this.perk){var i=this;b.ids.perks.deepBrowse(function(s){if(!u.isUsed(s)){var o=b.get(s),n=o.actions;if((!n||n.includes(e))&&(!p.isFunction(o.condition)||o.condition(i))){var r=0;(r=(r=n?n.reduce(function(e,t){var s=i.actions.get(t);return e+(s?s.repeated:0)},0)/(o.iteration||0):1/(o.iteration||0))<1?0:r)&&v.random()<r&&(i.gainPerk(s),k.notify(k.MSG_TYPES.GAIN_PERK,i),t=!0)}}})}return t},gainPerk:function(e){var t=new u(e,this);this.perk=t,this.nameNode.appendChild(t.html)},hasPerk:function(e){return this.perk&&this.perk.data.id===e},die:function(){this.html.classList.contains("arrived")&&(k.notify(k.MSG_TYPES.LOOSE_SOMEONE,this),this.html.classList.remove("arrived"),this.actions.forEach(function(e){e.cancel(),e.tooltip.remove()}),S.timeout(function(){this.html.remove()}.bind(this),400))},getStraight:function(){var e={nam:this.name,gnd:this.gender,lif:this.life,ene:this.energy,sts:this.stats,prk:this.perk&&this.perk.data.id,act:[]};return this.actions.forEach(function(t){e.act.push(t.getStraight())}),e}}),l.randomName=function(e){return new Promise(function(t,i){var s="https://randomuser.me/api?inc=gender,name&nat="+["AU","BR","CA","CH","DE","DK","ES","FI","FR","GB","IE","NL","NZ","TR","US"].join(",")+"&noinfo&results="+(e||1);fetch(s).then(function(e){if(e.ok)return e.json().then(t);i(new URIError("["+e.status+"] "+s+" "+e.statusText))})})},u.usedId=[],u.isUsed=function(e){return u.usedId.includes(e)},u.extends(i,"Perk",{init:function(){this.data.desc=w.personify(this.data.desc,{people:this.owner}),new m(this.html,this.data),p.isArray(this.data.unlock)&&this.owner.addAction(this.data.unlock),p.isArray(this.data.lock)&&this.owner.lockAction(this.data.lock)},toHTML:function(){var e=this._toHTML();return e.textContent='the "'+p.capitalize(this.data.name)+'"',e}}),h.extends(i,"Resource",{init:function(e){e&&this.update(+e),this.tooltip=new m(this.html,this.data)},toHTML:function(){var e=this._toHTML();this.counter=p.wrap("counter","1"),e.appendChild(this.counter);var t=p.wrap("icon icon-"+this.data.icon);return e.appendChild(t),e.style.order=this.data.order,e},refresh:function(e){this.counter.textContent=this.get(),p.isArray(this.data.consume)&&e&&this.tooltip.refresh(e,this.data)},update:function(e){var t=this.count;if(this.set(this.count+e),v.floor(t)!==v.floor(this.count)){var i=this.html,s=!1;if(e>0&&!i.classList.contains("more")?(i.classList.add("more"),s=!0):e<0&&!i.classList.contains("less")&&(i.classList.add("less"),s=!0),s){S.timeout(i.classList.remove.bind(i.classList,"more","less"),700)}}},get:function(){return v.floor(this.count)},set:function(e){if(this.count=e,this.count<0)throw new RangeError("Resources count can't be negative");return this.refresh()},has:function(e){return this.count>e||this.count.equals(e)},getStraight:function(){return[this.count,this.data.id]},toString:function(){var e=this.count+" "+p.pluralize(this.data.name,this.count);return this.data.icon&&(e+=" "+h.iconAsString(this.data.icon)),e}}),h.iconAsString=function(e){return p.wrap("icon icon-small-"+e).outerHTML},h.LST_ID="resourceList",d.extends(i,"Bar",{toHTML:function(){var e=this._toHTML();return this.valueBar=p.wrap("value"),e.appendChild(this.valueBar),e},set:function(e){e.equals(this.value)||(this.value=e,this.valueBar.style.width=e+"%",this.html.classList[e<this.threshold?"add":"remove"]("warning"))},run:function(e){e=+e||0,this.valueBar.style.animationDuration=e+"ms",this.html.classList.add("ongoing")}}),m.prototype={bodyWidth:document.body.offsetWidth,bodyHeight:document.body.offsetHeight,_setPosition:function(e,t){var i=v.constrain(e+10,0,this.bodyWidth-this.width),s=v.constrain(t+10,0,this.bodyHeight-this.height);this.box.style.left=i+"px",this.box.style.top=s+"px"},_mouseOver:function(){document.body.appendChild(this.box)},_mouseOut:function(){this.box.remove()},_mouseMove:function(e){this._setPosition(e.clientX,e.clientY)},_addEvents:function(){this.container.classList.add("tooltiped"),this.container.addEventListener("mouseover",this._mouseOver.bind(this)),this.container.addEventListener("mousemove",this._mouseMove.bind(this)),this.container.addEventListener("mouseout",this._mouseOut.bind(this))},_removeEvents:function(){this.container.classList.remove("tooltiped"),this.container.removeEventListener("mouseover",this._mouseOver),this.container.removeEventListener("mousemove",this._mouseMove),this.container.removeEventListener("mouseout",this._mouseOut)},toHTML:function(e){var t=p.wrap("tooltip"),i=p.wrap("title",p.capitalize(e.name));if(t.appendChild(i),this.nodes.name=i,e.desc){var s=p.wrap("description",e.desc);t.appendChild(s),this.nodes.desc=s}if(e.time){var o=p.wrap("time",p.formatTime(e.time));t.appendChild(o),this.nodes.time=o}if(p.isArray(e.consume)){var n=p.wrap("consumption");e.consume.forEach(function(e){var t=b.get(e[1]),i=p.wrap("resource not-enough",e[0]+" "+t.name);i.style.order=t.order,this.resourcesMapper[e[1]]=i,n.appendChild(i)},this),t.appendChild(n)}return t},refresh:function(e,t){this.nodes.name.textContent=p.capitalize(t.name),t.desc&&(this.nodes.desc.textContent=t.desc),t.time&&(this.nodes.time.textContent=p.formatTime(t.time)),p.isArray(t.consume)&&t.consume.forEach(function(t){var i=t[1],s=e.has(i)&&e.get(i).has(t[0]);this.resourcesMapper[i].classList.toggle("not-enough",!s)},this)},remove:function(){this.box.remove()}}}("undefined"==typeof G?G={}:G);