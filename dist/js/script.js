!function(e){const t={prepareCanvas(e,t){const s=document.createElement("canvas");return s.width=e,s.height=t,{cnv:s,ctx:s.getContext("2d")}}};function s(e){e=e.replace("#","");const t=o.floor(e.length/3),s=o.RADIX.HEXA,i=(s+1)/(1/(s-1)*(s**t-1));let n=0;this.r=o.round(o.toDeci(e.substr(n++*t,t))*i),this.g=o.round(o.toDeci(e.substr(n++*t,t))*i),this.b=o.round(o.toDeci(e.substr(n*t,t))*i),this.a=1}CanvasRenderingContext2D.prototype.clear=function(){this.clearRect(0,0,this.canvas.width,this.canvas.height)},s.prototype={fade(e){return this.a=o.constrain(e,0,1),this},grey(){const e=o.average(this.r,this.g,this.b);return this.r=e,this.g=e,this.b=e,this},toHexa(){const e=o.toHexa;return`#${e(this.r).padStart(2,"0")}${e(this.g).padStart(2,"0")}${e(this.b).padStart(2,"0")}`},toRGB(){return`rgb(${[this.r,this.g,this.b].join(", ")})`},toRGBA(){return`rgba(${[this.r,this.g,this.b,this.a].join(", ")})`},toString(){return this.a<1?this.toRGBA():this.toHexa()}};const i={fade:(e,t)=>new s(e).fade(t).toString(),grey:e=>new s(e).grey().toString()},o={RADIX:{BINARY:2,DECIMAL:10,HEXA:16,ALPHA:36},toNumber:e=>Number(e),floor:e=>e<<0,round:e=>o.floor(e+o.sign(e)/2),ceil:e=>o.floor(e+o.sign(e)),abs:Math.abs,sign:e=>e<0?-1:1,sq:e=>e*e,sqrt:e=>e**.5,PI2:2*Math.PI,cos:Math.cos,sin:Math.sin,diff:(e,t)=>o.abs(e-t),average(...e){if(!e.length)throw new RangeError("Can't get average from no value");return e.reduce((e,t)=>e+t,0)/e.length},constrain:(e,t,s)=>e<t?t:e>s?s:e,random:(n=Math.random,function(e,t){return r.isUndefined(t)?(t=!e||r.isUndefined(e)?1:o.toNumber(e,1),e=0):(e=o.toNumber(e),t=o.toNumber(t,1)),n()*(t-e)+e}),toHexa:e=>o.round(e).toString(o.RADIX.HEXA).toUpperCase(),toDeci:e=>parseInt(e,o.RADIX.HEXA)};var n;Number.prototype.equals=function(e){return r.isNumber(e)&&o.diff(this,e)<=Number.EPSILON},Array.prototype.last=function(){return this[this.length-1]},Array.prototype.random=function(){return this[o.floor(o.random(0,this.length))]},Array.prototype.out=function(e){const t=this.indexOf(e);return t>=0&&this.splice(t,1),this.length},Array.prototype.insert=function(e){return this.push(...e)},Map.prototype.push=function(e,t){return r.isUndefined(t)&&(e=(t=e).id||t instanceof l&&t.getId()||r.pickUniqueID()),this.set(e,t),e},Map.prototype.getValues=function(){const e=[];return this.forEach(t=>e.push(t)),e},Map.prototype.getKeys=function(){const e=[];return this.forEach((t,s)=>e.push(s)),e},Object.prototype.browse=function(e){Object.keys(this).forEach(t=>e(this[t],t,this))},Object.prototype.values=function(){return Object.values(this)},Object.prototype.flatten=function(){const e=[];return this.deepBrowse(t=>e.push(t)),e},Object.prototype.deepBrowse=function(e){["Object","Array"].includes(this.constructor.name)?this.browse(t=>t.deepBrowse(e)):e(this.valueOf())},Object.prototype.swap=function(){const e={};return this.browse((t,s)=>e[t]=s),e},Object.prototype.clone=function(){let e;if([Boolean,Number,String,Function].includes(this.constructor))e=this;else if(this instanceof Array)e=this.slice();else{if(!(this instanceof Object))throw new TypeError("Improbable source type");e=Object.assign({},this)}return e},HTMLElement.prototype.show=function(){this.removeAttribute("aria-hidden")},HTMLElement.prototype.hide=function(){this.setAttribute("aria-hidden","true")},Object.defineProperty(HTMLElement.prototype,"html",{cache:"",get(){return this.innerHTML},set(e){e!==this.cache&&(this.innerHTML=e,this.cache=e)}}),HTMLElement.prototype.getStyle=function(e){return window.getComputedStyle(this).getPropertyValue(e)},Function.prototype.extends=function(e,t,s){e&&(this.prototype=Object.create(e.prototype),this.prototype.super=e,this.prototype.constructor=this,this.prototype.modelName=t),s&&s.browse((e,t)=>{this.prototype[t]&&(this.prototype[`_${t}`]=this.prototype[t]),this.prototype[t]=e})},Function.prototype.static=function(e){e.browse((e,t)=>{this[t]&&(this[`_${t}`]=this[t]),this[t]=e})},Function.prototype.defer=function(e,...t){requestAnimationFrame(()=>this.apply(e,t))};const r={noop:new Function,wrap(e,t,s){const i=document.createElement("div");return e&&(i.className=e),t&&(i.html=t),s&&s.appendChild(i),i},formatJoin:(e,t="and")=>e.length>1?`${e.slice(0,-1).join(", ")} ${t} ${e.last()}`:e.length?String(e[0]):"",formatArray:e=>r.formatJoin(e.map(e=>c.toString(d.get(e[1]),e[0]))),formatTime(e){if(!e)return"0 hour";const t=[],s=d.time;let i=e;return["year","month","day","hour","minute"].forEach(e=>{if(i>=s[e]){const n=o.floor(i/s[e]);i%=s[e],t.push(`${n} ${r.pluralize(e,n)}`)}}),r.formatJoin(t)},pluralize:(e,t)=>e+(t>1&&"s"!==e[e.length-1]?"s":""),capitalize(e){if(e){const t=e.replace(/([.!?])\s([a-z])/g,(e,t,s)=>`${t} ${s.toUpperCase()}`);return t[0].toUpperCase()+t.slice(1)}return""},randomize(e,t){if(!e||!e.values().length)throw new TypeError("Can't pick from empty list");const s={},i=[];let n=0;e.deepBrowse(e=>{const t=d.get(e);t&&t.dropRate&&(n+=t.dropRate,i.push(n),s[n]=e)});let a=o.floor(o.random(n));i.sort();for(let e=0,t=i.length;e<t;++e)if(i[e]>a){a=i[e];break}return t?(r.isArray(t)||(t=r.isString(t)?t.split("-"):[t]),[o.round(o.random.apply(null,t)),s[a]]):s[a]},randomizeMultiple(e,t){if(!t)throw new TypeError("Need an amount");const s=[];r.isArray(t)||(t=r.isString(t)?t.split("-"):[t]);const i=o.round(o.random.apply(null,t));let n=0;for(;n++<i;)s.push([1,r.randomize(e)]);return r.compactResources(s)},log(...e){0},randomStr(e=6){const t=o.RADIX.ALPHA;return new Array(e).fill("-").join("").replace(/-/g,()=>o.floor(o.random(t)).toString(t))},pickUniqueID:()=>new String(""),isFunction:e=>e instanceof Function,isArray:e=>Array.isArray(e),isString:e=>"string"==typeof e,isNumber:e=>"number"==typeof e,isUndefined:e=>void 0===e,sanitize:e=>e.replace(/^\W+|\W+$/g,"").replace(/\W+/g,"_").toLowerCase(),camelize:e=>e.replace(/^\W+/,"").toLowerCase().replace(/\W+(\w?)/g,(e,t)=>t&&t[0].toUpperCase()+t.slice(1)),an(e){if(!e.length)return"";return`${"aeiou".split("").includes(e[0])?"an":"a"} ${e}`},compactResources:e=>e.reduce((e,t)=>{const s=e.find(e=>e[1]===t[1]);return s?s[0]+=t[0]:t[0]>0&&e.push(t),e},[]).sort((e,t)=>t[0]-e[0]),getNow:()=>o.floor(performance.now()),loadAsync(e,t){const s={};let i=0;const o=Object.keys(e),n=o.length;return Promise.all(o.map(o=>{const r=e[o];let a=fetch(r).then(e=>{if(e.ok)return e;throw new URIError(`[${e.status}] ${r} ${e.statusText}`)});const l=r.substr(r.lastIndexOf(".")+1);switch(l){case"png":a=a.then(e=>{const t=new Image;return e.blob().then(e=>(t.src=URL.createObjectURL(e),t))});break;case"json":a=a.then(e=>e.json());break;case"woff":case"woff2":case"ttf":a=a.then(()=>{const e=document.createElement("style");return e.html=`@font-face {\n                            font-family: ${o};\n                            src: url(${r}) format("${l}");\n                        }`,e})}return a.then(e=>{s[o]=e,t(++i/n*100,o)})})).then(()=>s)}};function a(e,...t){this.html=a.enableHTML?this.toHTML():null,e&&this.html.classList.add(...e.split(" ")),this.isShow=!0,this.init(...t)}function l(e,...t){this.data=d.get(e).clone(),l.prototype.super.call(this,null,...t)}function c(e,t){this.count=0,this.warnLack=!1,this.super(e,t)}a.extends(null,"View",{init:r.noop,toHTML(){return r.wrap(this.modelName)},show(e){if(r.isFunction(e)){const t=()=>{e.call(this),this.html.removeEventListener("transitionend",t)};this.html.getStyle("transition")?this.html.addEventListener("transitionend",t):t.defer()}this.html.show(),this.isShow=!0},hide(e){if(r.isFunction(e)){const t=()=>{e.call(this),this.html.removeEventListener("transitionend",t)};this.html.getStyle("transition")?this.html.addEventListener("transitionend",t):t.defer()}this.html.hide(),this.isShow=!1},remove(){this.html.remove()}}),a.static({enableHTML:!0}),l.extends(a,"Model",{getId(){return this.data.id},toJSON(){return{id:this.getId()}}}),c.extends(l,"Resource",{init(e){e&&this.update(e),this.tooltip=new I(this.html,this.data)},toHTML(){const e=this._toHTML();return this.counter=r.wrap("counter","1",e),r.wrap(`icon icon-${this.data.icon}`,null,e),e.style.order=this.data.order,e},refresh(e){this.counter.textContent=this.get(),r.isArray(this.data.consume)&&e&&this.tooltip.refresh(e,this.data)},update(e){const t=this.count;this.set(this.count+o.toNumber(e)),o.floor(t)!==o.floor(this.count)&&e<0&&this.animate("less")},animate(e){if(!this.html.classList.contains(e)){this.html.classList.add(e);const t=700;setTimeout(this.html.classList.remove.bind(this.html.classList,e),t)}},get(){return o.floor(this.count)},set(e){if(this.count=e,this.count<0)throw new RangeError("Resources count can't be negative");this.refresh()},has(e){return this.count>e||this.count.equals(e)},toJSON(){return[this.count,this.getId()]},toString(){return c.toString(this.data,this.count)}}),c.static({LST_ID:"resourceList",toString(e,t){let s="";return r.isUndefined(t)||(s+=`${t} `),e.icon&&(s+=`${c.iconAsString(e.icon)} `),s+=r.pluralize(e.name,t).bold()},iconAsString:e=>r.wrap(`icon icon-small-${e}`).outerHTML});const h=function(){var e={};return function(e,t){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=Date.now();const s=document.createElement("script"),i=document.getElementsByTagName("script")[0];s.async=1,s.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(s,i)}(e,"ga"),e.ga("create","UA-99773946-1","auto"),e.ga("send","pageview"),function(t,s,i){e.ga("send","event","Game",t,s,i)}}();e.starter=function(e){const t=document.body;t.classList.add("loading");const s=r.getNow();r.loadAsync({Dosis:"https://fonts.gstatic.com/s/dosis/v7/xIAtSaglM8LZOYdGmG1JqQ.woff",icons:"dist/img/icons.png",assets:"dist/img/assets.png",assetsData:"dist/json/assets.json",buildingsData:"dist/json/buildingsData.json"},(e,t)=>{r.log(`${t} : ${e.toFixed(1)}% - ${r.getNow()-s}ms`)}).then(e=>{t.classList.remove("loading"),document.head.appendChild(e.Dosis),t.innerHTML="",new y(t,e)}).catch(e=>console.warn(`Fail to load game : ${e.message}`,e.stack))};const d=function(){const e={minute:1/60,hour:1,day:24,week:168,month:720,year:8760},t=["north","south","east","west","north-east","north-west","south-east","south-west"],s={resources:{gatherables:{common:{},uncommon:{},rare:{}},craftables:{basic:{},complex:{},advanced:{}},special:{}},buildings:{small:{},medium:{},big:{},special:{}},actions:{},locations:{near:{},far:{},epic:{}},incidents:{easy:{},medium:{},hard:{}},perks:{}},i={};function n(e){const t=btoa(e.id);return e.id=t,i[t]=e,t}function a(e,t){return c.toString(i[e],t)}function l(e){return`<i class="quote">${e}</i>`}s.option="opt",s.resources.room=n({id:"rom",name:"room",desc:"A place for someone in the camp.",icon:"person",order:0}),s.resources.gatherables.common.water=n({id:"wtr",name:"water",desc:"Water is definitely important to survive in this harsh environment.",icon:"water-bottle",dropRate:100,order:10}),s.resources.gatherables.common.food=n({id:"fod",name:"food",desc:"Everyone need food to keep his strength.",icon:"foodcan",dropRate:90,order:20}),s.resources.gatherables.common.rock=n({id:"rck",name:"rock",desc:l("There's rocks everywhere ! Why would you bring this back ?"),icon:"rock",dropRate:100,order:30}),s.resources.gatherables.common.scrap=n({id:"scp",name:"scrap metal",desc:"An old rusty piece of metal.",icon:"metal-scraps",dropRate:60,order:40}),s.people=n({id:"plp",name:"people",desc:"The workforce and the bane of the camp.",needs:[[1/e.day,s.resources.gatherables.common.water,"thirsty"],[1/e.day,s.resources.gatherables.common.food,"starving"]],dropRate:.001}),s.resources.gatherables.uncommon.bolts=n({id:"blt",name:"nuts and bolts",desc:"Little metal nuts and bolts to fasten anything in place.",icon:"nuts-and-bolts",dropRate:65,order:50}),s.resources.gatherables.uncommon.sand=n({id:"snd",name:"sand",desc:"Just pure fine sand.",icon:"sand-pile",dropRate:50,order:55}),s.resources.gatherables.uncommon.oil=n({id:"oil",name:"fuel",desc:"About a liter of gas-oil.",icon:"jerrycan",dropRate:20,order:60}),s.resources.gatherables.rare.medication=n({id:"mct",name:"medication",desc:"An unlabeled medication, hope it's still good.",icon:"medications",dropRate:7,order:70}),s.resources.gatherables.rare.electronic=n({id:"elc",name:"electronics",desc:"Some basic micro-electronics components.",icon:"electronic-parts",dropRate:10,order:75}),s.resources.special.ruins=n({id:"run",name:"location",desc:"Directions to a point of interest found earlier.",icon:"map",order:80,dropRate:.6}),s.resources.special.quartz=n({id:"qtz",name:"quartz cristal",desc:"A rough uncut gem of quartz. Quite valuable.",icon:"gem",dropRate:10,order:77}),s.resources.craftables.basic.component=n({id:"cmp",name:"component",desc:"Some mechanical parts for others craftables.",icon:"pipes-large",consume:[[2,s.resources.gatherables.common.scrap],[2,s.resources.gatherables.uncommon.bolts]],dropRate:120,order:110}),s.buildings.special.wreckage=n({id:"wrk",name:"wreckage",desc:"Remainings of a car.",asset:"wreckage",order:0}),s.actions.launch=n({id:"lnc",name:"start engine",desc:"Finally start the engine of the new vehicle.",time:3,isOut:1,unique:!0,consume:[[10,s.resources.gatherables.uncommon.oil]],effect(){p.notify(p.MSG_TYPES.WIN)},log(){return`After ${this.getSurvivalDuration()}, it's finally possible to leave this damned crash-site.<br/>\n                Everyone shove itself into the car and dream of the better life waiting at the end of the road.`},order:15}),s.actions.exchange=n({id:"exc",name:"exchange",desc:"Caravan passing by carry lots of useful stuff, let's see what's possible to trade.",time:7,energy:20,consume:[[2,s.resources.craftables.complex.jewelry]],giveSpan:[2,3],giveList:[s.resources.craftables.basic,s.resources.craftables.complex],log:"@people.name manage to trade a couple of jewelries for @give.",order:10}),s.actions.nurse=n({id:"nrs",name:"nurse",desc:"Look after the health of the most needed one.",time:2,energy:1,consume:[[2,s.resources.gatherables.rare.medication]],effect(e,t,s){let i=null;this.people.forEach(e=>{(!i||e.life<i.life)&&(i=e)}),i.updateLife(99),s.cured=i},log:"Thanks to @people.name, @cured.name feel better.",order:7}),s.actions.heal=n({id:"hel",name:"heal",desc:'"I really hope those pills are still good."',time:2,energy:1,consume:[[2,s.resources.gatherables.rare.medication]],effect(e,t,i){let n=99;const r=this.buildings.has(s.buildings.small.pharmacy),a=e.owner.hasPerk(s.perks.healer);!r&&!a&&o.random()<.4&&(n=-10,i.wasBad=!0),e.owner.updateLife(n)},log:e=>e.wasBad?"After feeling not so well, @people.name realise taking these pills took a hit on his health.":"This time, it actually improve @people.name's health.",order:6}),s.actions.sleep=n({id:"slp",name:"sleep",desc:"Get some rest to restore energy.",time:7,energy:0,effect(e){e.owner.setEnergy(this.incidents.has(s.incidents.medium.fever)?40:100)},unlock:[s.actions.heal],log:"@people.name feels well rested now.",order:5}),s.actions.harvestPlot=n({id:"hrp",name:"harvest crops",desc:"It's not the biggest vegetables, but it'll fill our stomachs.",time:4,consume:[[1,s.resources.gatherables.common.water]],giveSpan:[1.5,2],giveList:[s.resources.gatherables.common.food],log:"Our crops produce @give.",order:70}),s.actions.harvestField=n({id:"hrf",name:"harvest crops",desc:"It's not the biggest vegetables, but it'll fill our stomachs.",time:6,consume:[[2,s.resources.gatherables.common.water]],giveSpan:[4,5],giveList:[s.resources.gatherables.common.food],log:"Our crops produce @give.",order:70}),s.actions.drawFromRiver=n({id:"dfr",name:"draw water",desc:`Get some ${a(s.resources.gatherables.common.water)} from the river.`,time:8,energy:50,isOut:1,condition:e=>!e.owner.actions.has(s.actions.drawFromWell),giveSpan:[2,6],giveList:[s.resources.gatherables.common.water],log:"Coming back from the river, @people.name brings @give with @people.accusative.",order:60}),s.actions.drawFromWell=n({id:"dfw",name:"draw water",desc:`Get some ${a(s.resources.gatherables.common.water)} from our well.`,time:2,energy:15,giveSpan:[1,3],giveList:[s.resources.gatherables.common.water],log:"Using our well, @people.name draw @give.",order:60}),s.actions.drawFromPump=n({id:"dfp",name:"draw water",desc:`Get some ${a(s.resources.gatherables.common.water)} at the pump.`,time:2,giveSpan:[3,3],giveList:[s.resources.gatherables.common.water],log:"Using our pump, @people.name draw @give.",order:60}),s.actions.build=n({id:"bui",name:"build",desc:"Put together some materials to come up with what looks like a building.",build:s.option,options(){return this.possibleBuildings()},order:50}),s.actions.craft=n({id:"crf",name:"craft",desc:"Use some resources to tinker something useful.",time:4,energy:10,options(){return this.unlockedCraftables()},give:[[1,s.option]],unlock:[s.actions.build],log:"@people.name succeeds to craft @give.",order:30}),s.actions.explore=n({id:"xpl",name:"explore",desc:`Remember that ${a(s.resources.special.ruins)} found the other day ?\n            Let's see what can be gather there.`,time:e.day,energy:100,isOut:1,consume:[[2,s.resources.gatherables.common.water],[1,s.resources.gatherables.common.food],[1,s.resources.special.ruins]],options(){return this.knownLocations},giveSpan:[8,10],giveList:[s.resources.special.quartz],log:"All locations should have own log",order:20});const h=i[s.resources.special.ruins].dropRate;s.actions.scour=n({id:"scr",name:"scour",desc:"Knowledge of the area allows for better findings.",time:4,isOut:1,consume:[[1,s.resources.gatherables.common.water]],giveSpan:[1.5*h/2,(1.5*h+1)/2],giveList:[s.resources.special.ruins],log(e){let i;if(e.give){const t=r.randomize(s.locations);this.knownLocations.includes(t)||this.knownLocations.push(t),e.location=r.an(d.get(t).name),i="@people.name knew @people.nominative could find @location towards @direction."}else i="No special location towards @direction.";return e.direction=t.random(),i},order:10}),s.actions.roam=n({id:"ram",name:"roam",desc:`Explore the surroundings hoping to find a ${a(s.resources.special.ruins)}.`,time:5,isOut:1,consume:[[1,s.resources.gatherables.common.water]],condition:e=>!e.owner.actions.has(s.actions.scour),unlock:[s.actions.explore],unlockAfter:[[9,s.actions.scour]],giveSpan:[h/2,(h+1)/2],giveList:[s.resources.special.ruins],log(e){let i;if(e.give){const t=r.randomize({near:s.locations.near,far:s.locations.far});this.knownLocations.includes(t)||this.knownLocations.push(t),e.location=r.an(d.get(t).name),i="Heading to the @direction, @people.name spots @location"}else i="@people.name found nothing special towards the @direction.";return e.direction=r.capitalize(t.random()),i},order:10}),s.actions.gather=n({id:"gtr",name:"gather resources",desc:"Go out to bring back resources, that's the best way to survive.",time:3,isOut:1,unlock:[s.actions.roam,s.actions.craft],giveSpan:[3,6],giveList:s.resources.gatherables.flatten(),log:"@people.name comes back with @give.",order:1}),s.buildings.special.firePit=n({id:"fp1",name:"fire pit",asset:"fire",shadow:!0}),s.buildings.special.firePit2=n({id:"fp2",name:"fire pit",upgrade:s.buildings.special.firePit,asset:"fire2",shadow:!0}),s.buildings.special.forum=n({id:"fr0",name:"forum",desc:"The center and start of our settlement.",unlockForAll:[s.actions.sleep],upgrade:s.buildings.special.wreckage,give:[[1,s.resources.room]],build:s.buildings.special.firePit,asset:"forum"}),s.actions.settle=n({id:"stl",name:"settle here",desc:"Ok, let's settle right there !",time:2,energy:0,effect(){this.flags.settled=1},unlock:[s.actions.gather],build:s.buildings.special.forum,log:"Since the global war, the environment is rotten with radiations. It won't be easy to survive in the middle of these wastelands, but there's no other choice now.",order:0,unique:!0}),s.actions.look=n({id:"lok",name:"look around",desc:l("What am I doing here ?"),time:1,energy:0,effect(){f.timeout(()=>{m.log("I'll need a shelter.",p.MSG_TYPES.LOGS.QUOTE)},y.TICK_LENGTH/2)},give:[[8,s.resources.gatherables.common.water],[6,s.resources.gatherables.common.food],[2,s.resources.craftables.basic.component]],unlock:[s.actions.settle],log:"After some reflexion, @people.name remembers the crash. @people.nominative grabs @give from @people.possessive car trunk.",order:0,unique:!0}),s.actions.wakeUp=n({id:"wku",name:"wake up",unlock:[s.actions.look],effect(e){e.owner.updateEnergy(100),e.owner.updateLife(100)},log:"@people.name gets up painfully.",order:0,unique:!0}),s.resources.craftables.basic.stone=n({id:"stn",name:"smooth stone",desc:"A round and well polish stone.",icon:"stone",consume:[[3,s.resources.gatherables.common.rock]],dropRate:100,order:90}),s.resources.craftables.basic.tool=n({id:"tol",name:"tool",desc:"The base for any tinkerer.",icon:"tools",consume:[[1,s.resources.craftables.basic.component],[2,s.resources.gatherables.common.rock]],dropRate:90,order:111}),s.buildings.small.furnace=n({id:"frn",name:"furnace",desc:"Survival require to craft as much as to gather things.",time:7,consume:[[8,s.resources.gatherables.common.rock],[2,s.resources.gatherables.uncommon.oil]],asset:"",order:15,log:`A simple furnace that can smelt small things\n            like ${a(s.resources.gatherables.uncommon.sand)} or \n            ${a(s.resources.gatherables.rare.electronic)}.`}),s.resources.craftables.basic.glass=n({id:"gls",name:"glass pane",desc:"A see-through building component.",icon:"glass-pane",ifHas:s.buildings.small.furnace,consume:[[4,s.resources.gatherables.uncommon.sand]],dropRate:60,order:100}),s.buildings.small.forum1=n({id:"fr1",name:"forum+1",desc:`Add ${a(s.resources.room,1)} to the forum.`,time:2,upgrade:s.buildings.special.forum,consume:[[6,s.resources.gatherables.uncommon.bolts],[4,s.resources.gatherables.common.scrap]],give:[[1,s.resources.room]],asset:"forum1",order:10,log:"More space to sleep means more people joining and helping."}),s.buildings.small.plot=n({id:"plt",name:"farm plot",desc:`A little arranged plot of soil to grow some ${a(s.resources.gatherables.common.food)}.`,time:9,consume:[[5,s.resources.gatherables.common.food],[10,s.resources.gatherables.uncommon.sand]],unlockForAll:[s.actions.harvestPlot],asset:"plot",order:12,log:`Crops required care but that's going to help keeping a constant stock of\n            ${a(s.resources.gatherables.common.food)}.`}),s.buildings.small.pharmacy=n({id:"phr",name:"pharmacy",desc:l(`Maybe we should avoid letting ${a(s.resources.gatherables.rare.medication)}s\n            rot in plain sunlight !`),time:6,consume:[[5,s.resources.gatherables.rare.medication],[4,s.resources.craftables.basic.component]],asset:"pharmacy",order:16,log:`Sorting the ${a(s.resources.gatherables.rare.medication)}s\n            should prevent further mistakes and bad reaction.`}),s.buildings.small.well=n({id:"wel",name:"well",desc:"Just a large hole into the ground.",time:16,consume:[[10,s.resources.gatherables.common.rock],[4,s.resources.craftables.basic.tool]],give:[[5,s.resources.gatherables.common.water]],unlockForAll:[s.actions.drawFromWell],lock:[s.actions.drawFromRiver],asset:"",order:13,log:`Drawing ${a(s.resources.gatherables.common.water)} from the ground\n            should allow to further polish ${a(s.resources.gatherables.common.rock)}.`}),s.buildings.medium.forum2=n({id:"fr2",name:"forum+2",desc:`Add ${a(s.resources.room,1)} to the camp.`,time:5,consume:[[10,s.resources.gatherables.uncommon.sand],[2,s.resources.craftables.basic.stone],[3,s.resources.craftables.basic.glass]],upgrade:s.buildings.small.forum1,give:[[1,s.resources.room]],asset:"forum2",order:20,log:"Another room for someone to join. So far, so good."}),s.buildings.medium.plot1=n({id:"fil",name:"field",desc:`A larger crop field to produce more ${a(s.resources.gatherables.common.food)}.`,time:10,lockForAll:[s.actions.harvestPlot],unlockForAll:[s.actions.harvestField],consume:[[20,s.resources.gatherables.common.food],[5,s.resources.craftables.basic.tool],[3,s.resources.gatherables.rare.medication]],upgrade:s.buildings.small.plot,asset:"plot+1",order:25,log:`This should be enough\n            to provide ${a(s.resources.gatherables.common.food)} for our small encampment.`}),s.buildings.medium.forge=n({id:"frg",name:"forge",desc:"A good upgrade to the furnace.",time:10,consume:[[10,s.resources.craftables.basic.stone],[6,s.resources.gatherables.uncommon.oil],[2,s.resources.craftables.basic.tool]],upgrade:s.buildings.small.furnace,asset:"furnace+1",order:27,log:"A big fire is now roaring in the forge. It should now be possible to forge more complex parts."}),s.resources.craftables.complex.brick=n({id:"brk",name:"brick",desc:"Will give walls for larger constructions.",icon:"brick",ifHas:s.buildings.small.well,consume:[[1,s.resources.craftables.basic.stone],[1,s.resources.craftables.basic.tool]],dropRate:80,order:112}),s.resources.craftables.complex.circuit=n({id:"cir",name:"circuit",desc:"That's a little rough, but it's actually a functioning circuit board.",icon:"electronic-circuit-board",consume:[[2,s.resources.gatherables.common.scrap],[2,s.resources.craftables.basic.component],[3,s.resources.gatherables.rare.electronic]],dropRate:60,order:114}),s.resources.craftables.complex.metalPipe=n({id:"mtp",name:"metal pipe",desc:"Forged from junk metal.",icon:"pipes-small",ifHas:s.buildings.medium.forge,consume:[[4,s.resources.gatherables.common.scrap],[1,s.resources.craftables.basic.tool]],dropRate:80,order:115}),s.resources.craftables.advanced.jewelry=n({id:"jwl",name:"jewelry",desc:"A really beautiful ornament useful for trading.",icon:"jewelry",ifHas:s.buildings.small.furnace,consume:[[4,s.resources.gatherables.rare.electronic],[2,s.resources.special.quartz]],dropRate:40,order:117}),s.buildings.big.workshop=n({id:"wrs",name:"workshop",desc:"Having a dedicated place for the crafting work would allow to make more complex crafts.",time:3*e.day,energy:90,ifHas:s.buildings.medium.forge,consume:[[6,s.resources.gatherables.common.scrap],[5,s.resources.craftables.basic.glass],[10,s.resources.craftables.basic.tool],[15,s.resources.craftables.complex.brick]],asset:"",order:35,log:"Good organisation enable to put together new work."}),s.resources.craftables.complex.furniture=n({id:"fnt",name:"furniture",desc:"A proper settlement needs better than pile of trash for table and seats.",icon:"glass-table",ifHas:s.buildings.big.workshop,consume:[[2,s.resources.craftables.basic.glass],[2,s.resources.craftables.complex.metalPipe]],dropRate:40,order:116}),s.buildings.big.forum3=n({id:"fr3",name:"forum+3",desc:`Add ${a(s.resources.room,2)} to the camp.`,time:6,consume:[[10,s.resources.craftables.complex.brick],[2,s.resources.craftables.complex.furniture],[6,s.resources.craftables.basic.glass]],upgrade:s.buildings.medium.forum2,give:[[2,s.resources.room]],asset:"forum+3",order:30,log:"All the forum space is now used for sleeping place."}),s.resources.craftables.advanced.engine=n({id:"egn",name:"engine",desc:"Amazing what can be done with all those scraps !",icon:"engine",ifHas:s.buildings.big.workshop,consume:[[10,s.resources.gatherables.uncommon.oil],[5,s.resources.craftables.basic.tool],[5,s.resources.craftables.complex.metalPipe]],dropRate:30,order:120}),s.resources.craftables.advanced.computer=n({id:"cmt",name:"computer",desc:"Well, Internet is down since 2024 but it can still be useful.",icon:"computer",ifHas:s.buildings.big.workshop,consume:[[10,s.resources.craftables.basic.component],[7,s.resources.craftables.basic.tool],[3,s.resources.craftables.complex.circuit]],dropRate:20,order:130}),s.buildings.big.radio=n({id:"rdo",name:"radio-station",desc:"Putting together a radio could allow to contact other people around the camp.",time:6,ifHas:s.buildings.big.workshop,consume:[[4,s.resources.craftables.complex.circuit],[1,s.resources.craftables.advanced.computer]],effect(){d.get(s.people).dropRate=1},asset:"",order:37,log:"Having a way to make contact should attract more people to the camp, either they want to join or trade."}),s.buildings.big.pump=n({id:"pmp",name:"water pump",desc:`A buried contraption that collect ${a(s.resources.gatherables.common.water)} from\n            the earth moisture.`,time:3*e.day,energy:120,consume:[[20,s.resources.craftables.basic.stone],[5,s.resources.craftables.complex.metalPipe],[1,s.resources.craftables.advanced.engine]],upgrade:s.buildings.small.well,unlockForAll:[s.actions.drawFromPump],lockForAll:[s.actions.drawFromRiver,s.actions.drawFromWell],asset:"",order:36,log:`A big upgrade to the well !\n            Now there's a continuous flow of ${a(s.resources.gatherables.common.water)} coming up.`}),s.buildings.big.trading=n({id:"trd",name:"trading post",desc:"Since the radio station bring a handful of merchant, better take advantage of it.",time:e.day,energy:70,ifHas:s.buildings.big.radio,consume:[[2,s.resources.craftables.basic.glass],[10,s.resources.craftables.complex.brick],[2,s.resources.craftables.complex.furniture]],unlockForAll:[s.actions.exchange],asset:"",order:38,log:"Arranging some space allow to trade with merchant caravan passing by."}),s.buildings.big.module=n({id:"mdl",name:"vehicle",desc:"This should be enough to hit the road and head towards a better place.",time:e.week,energy:90,ifHas:s.buildings.big.workshop,consume:[[15,s.resources.gatherables.uncommon.oil],[5,s.resources.craftables.complex.furniture],[1,s.resources.craftables.advanced.computer],[2,s.resources.craftables.advanced.engine]],unlockForAll:[s.actions.launch],asset:"",order:40,log:"It don't looks so good, but sure thing it should runs well enough."}),s.locations.near.mountain=n({id:"mnt",name:"mountain",desc:"A nearby mountain that may contains some basic building resources",giveList:[s.resources.gatherables.common.rock,s.resources.gatherables.common.scrap,s.resources.craftables.basic.component],log:"That was hard to climb those mountains, but at least @people.name find @give.",dropRate:90}),s.locations.near.desert=n({id:"dst",name:"desert",desc:`Not much to find in a desert,\n            but that's for sure the best place to get ${a(s.resources.gatherables.uncommon.sand)}.`,giveList:[s.resources.gatherables.common.scrap,s.resources.gatherables.uncommon.oil,s.resources.gatherables.uncommon.sand],log:"Dunes everywhere give a felling of hopelessness. Here's @give for the stock.",dropRate:100}),s.locations.near.supermarket=n({id:"hng",name:"hangar",desc:"A huge hangar. It was certainly raided before by others, but there may be something to grab.",giveList:[s.resources.gatherables.common.food,s.resources.gatherables.rare.medication,s.resources.craftables.basic.glass],log:"Quite easy to loot, @people.name returns with @give.",dropRate:80}),s.locations.far.river=n({id:"rvr",name:"river",desc:`Quite rare to find ${a(s.resources.gatherables.common.water)} on those wastelands.\n            This is a valuable location to find.`,unlockForAll:[s.actions.drawFromRiver],giveList:[s.resources.gatherables.common.water,s.resources.gatherables.uncommon.bolts,s.resources.craftables.basic.stone],log:"It's nice by the river, @people.name found @give.",dropRate:30}),s.locations.far.ruin=n({id:"orn",name:"old ruin",desc:"This is a huge underground network of rooms linked by narrow hallways. This should have provided shelter a long time ago.",giveList:[s.resources.gatherables.rare.electronic,s.resources.craftables.basic.component,s.resources.craftables.basic.tool],log:"Amazing no-one get lost in those caves to get @give.",dropRate:50}),s.locations.epic.building=n({id:"bld",name:"buried building",desc:"Digging up this building, uncover stuff preserved from looting and environment.",giveList:[s.resources.gatherables.rare.medication,s.resources.craftables.basic.glass,s.resources.craftables.complex.circuit],log:"Impossible to guess what that building was, but it sure was interesting. @people.name find @give.",dropRate:10}),s.locations.epic.spaceship=n({id:"swr",name:"old wreckage",desc:"This rusty vehicle remains was in good enough shape in order to allow to find useful parts inside.",giveList:[s.resources.gatherables.rare.electronic,s.resources.craftables.basic.tool,s.resources.craftables.complex.furniture],log:"Tearing apart this wreckage allow to salvage @give.",dropRate:5}),s.incidents.easy.chest=n({id:"chs",name:"Strange old chest",desc:"While exploring, a rusty container was found in the middle of rubbles. It might contains rare resources, but there's risks to fiddle with it ?",yes:"Open it up",no:"Leave it",onStart(e,t){if(o.random()<.7){const e=r.randomize(s.resources.craftables);this.earn(1,e),t.give=r.formatArray([[1,e]])}else{const e=this.people.getValues().random(),s=o.constrain(o.random(10,30),0,e.life-1);e.updateLife(-s),t.person=e,t.lost=s}},dropRate:30,log(e){let t;if(e.give)t=m.personify("nothing to fear, @give was found inside the chest.",e);else if(e.person){let s="a loud explosion blast @name away as soon as @nominative try to open the chest. ";e.lost<20?s+="thankfully, more scared than hurt, @name get out with some scratches.":s+="@name is badly hurt in the process.",t=m.personify(s,e.person)}return t}}),s.incidents.easy.fortune=n({id:"frt",name:"an old woman approach",desc:"Someone point out to a silhouette in the distance. What seams to be a very old woman is coming toward the camp.<br/>As she get closer, she's visibly pointing her finger in a menacing manner and mumble incomprehensible chatter. Her skin looks really badly burnt by radiation.",yes:"Listen to her",no:"Fend her away",onStart(){new T({name:"Fortune teller",desc:`After being calmly sit down, try to get what she's trying to say.<br/>\n                    ${l("Long path ahead, full of danger ... may do it ... but at what cost ?")}<br/>\n                    ${l("If mercy is shown, success will follow !")}`,yes:"Humm ... ok"},"incident")},unique:!0,dropRate:70,log:"She then proceed on her lonely journey. Listening to the fate that await can give chills. Does knowing the future is really helpful ?"}),s.incidents.easy.sandstorm=n({id:"ssm",name:"sandstorm",desc:"The wind is blowing hard, carrying sand and dust. It will be impossible to go out until it end.",time:16,timeDelta:4,color:"#f7ed33",dropRate:90,log:"A sandstorm has started and prevent anyone from leaving the camp."}),s.incidents.medium.acidRain=n({id:"acr",name:"acid rain",desc:"A big dark cloud is coming from the North, which means that it's going to rain acid droplet, like stingers from the sky.<br/>Going out now will be dangerous.",time:e.day,timeDelta:e.day/2,color:"#d351e8",dropRate:50,lifeLose:3,log:"Rain is pouring and it burn the skin pretty badly. A pretty good reason to stay inside for now."}),s.incidents.medium.beggar=n({id:"bgr",name:"strange beggar",desc:`A lone traveler has a deal to propose:\n            Invest ${a(s.resources.special.quartz,3)} now and\n            ${l("for sure")}, he'll return with more worth of goods.`,condition(){return this.resources.has(s.resources.special.quartz)&&this.resources.get(s.resources.special.quartz).has(4)},yes:"Acquiesce",no:"No way",consume:[[2,s.resources.special.quartz]],giveList:[s.resources.gatherables,s.resources.craftables.basic],giveSpan:[7,8],onEnd(e,t){o.random()<.2?(t.give=null,t.log="Looks like the beggar is not coming back this time."):t.log="As promised, the beggar came back. He gratefully give back @give."},time:8*e.day,dropRate:20,log:"Trusting a random stranger might just cost you some resources, but who knows ..."}),s.incidents.medium.fever=n({id:"fvr",name:"fever rash",desc:"In few hours, everyone develop a very bad rash and extreme fever. With cotton leg and heads about to explode, no one is willing to do much.",time:2*e.day,timeDelta:6*e.hour,color:"#9def39",dropRate:50,log:"Illness spread out in no time and weaken everyone."}),s.incidents.medium.harmonica=n({id:"hrm",name:"a song into the wild",desc:"At night everyone gather around the camp-fire to alleviate the day's burden.Someone draw out a harmonica and a melody wander slowly into the night.",unique:!0,yes:"Take some time to appreciate",dropRate:40,log:"It's good to remember to relax from time to time."});const u=[[3,s.resources.gatherables.common.water],[3,s.resources.gatherables.common.food]];return s.incidents.medium.strayDog=n({id:"std",name:"stray dog",desc:`Looks like a wild dog is lurking around the food stash.<br/>\n            He seams really weakened by his hunger and thirst.\n            Giving him ${r.formatJoin(u.map(e=>a(e[1],e[0])))} should\n            make him stay.<br/>\n            Does there's enough resources to have another mouth to feed ?`,unique:!0,yes:"Give him some water and food",no:"Ignore him",consume:u,log:"With caution, he accept this offering. He then proceed to hide in the forum's shadow and quickly falls asleep."}),s.incidents.hard.drought=n({id:"drg",name:"drought",desc:`The climate is so hot, everyone needs more ${a(s.resources.gatherables.common.water)}.`,condition(){return this.hasEnough(s.resources.gatherables.common.water,5)&&this.isBuildingDone(s.buildings.small.well)},time:3*e.day,timeDelta:10,color:"#f73a18",dropRate:10,multiplier:3,log:`A harsh drought has fallen,\n            ${a(s.resources.gatherables.common.water)} will be consumed faster as a result.`}),s.incidents.hard.lookBack=n({id:"lkb",name:"look back",desc:"It's been so long since this settlement start that it feel like a new life now.",unique:!0,yes:"Remember",onStart(e,t){t.duration=this.getSurvivalDuration()},dropRate:30,log:"The camp hold well for @duration in this harsh environment. Amazing !"}),s.incidents.hard.attack=n({id:"atk",name:"attack on bandits",desc:"While exploring the surroundings, a bandits camp was found a few hours of walk away.<br/>Setting a surprise attack can lead to loot their belongings.<br/>They seams to be quite well fortified though.",condition(){let e=!0;return this.people.forEach(t=>e=e&&!t.busy),e},unique:!0,time:6,timeDelta:1,color:"#7a848c",yes:"Let's do this",no:"Leave them be",onStart(){this.people.forEach(e=>{e.busy||e.setBusy(s.incidents.hard.attack,6)})},giveList:[s.resources.gatherables,s.resources.craftables.basic,s.resources.craftables.complex],giveSpan:[8,11],onEnd(){this.people.forEach(e=>{const t=o.random(10,20);e.updateLife(t),e.setBusy()})},dropRate:200,log:"They put up quite a fight and everyone got hurt in the process. At least @give were stolen."}),s.perks.first=n({id:"fso",name:"first-one",desc:"The very first one to install the settlement.",actions:[s.actions.settle],iteration:0}),s.perks.rookie=n({id:"rki",name:"rookie",desc:"All group has a rookie, all @people.nominative want is to prove @people.nominative's efficient.",condition(){return this.people.length>2}}),s.perks.explorer=n({id:"xpr",name:"gadabout",desc:"The veteran of the camp and leader of the exploration. @people.nominative knows the best spot of resources.",actions:[s.actions.roam,s.actions.scour,s.actions.explore],iteration:30}),s.perks.tinkerer=n({id:"tnr",name:"tinkerer",desc:"Everyone is amazed by how quickly @people.nominative can put together any contraption.",actions:[s.actions.craft,s.actions.build],iteration:30}),s.perks.healer=n({id:"hlr",name:"doctor",desc:"Knowing enough about medicine make @people.accusative confident to heal others.",actions:[s.actions.heal],condition(){this.buildings.has(s.buildings.small.pharmacy)},iteration:5}),s.perks.harvester=n({id:"hvt",name:"harvester",desc:"A real eagle eye that can spot goods twice as fast as anyone.",actions:[s.actions.gather,s.actions.harvestField,s.actions.harvestPlot,s.actions.drawFromRiver,s.actions.drawFromWell],iteration:40}),s.perks.lounger=n({id:"lng",name:"lounger",desc:"Doing nothing all day's not gonna make things done.",actions:[s.actions.sleep],condition:t=>t.stats.idle>3*e.day}),s.perks.merchant=n({id:"mrc",name:"merchant",desc:"The ancient art of trading is a boon if used well.",action:[s.actions.exchange],iteration:10}),{time:e,ids:s,get:e=>e?i[e]:null,bindAll(e){i.browse(t=>{t.browse((s,i)=>{r.isFunction(s)&&(t[i]=s.bind(e))})})}}}(),u=function(){let e,s,i,n,r;function a(e,t){if(!t)throw new TypeError(`Can't draw asset ${e.source_image} without destination`);this.animationState=0,this.animationSteps=t.steps||1,this.animationSpeed=(t.speed||0)/a.FPS,this.source={},this.destination={},this.source={x:o.toNumber(e.x),y:o.toNumber(e.y),width:o.floor(e.width/this.animationSteps),height:e.height},this.destination.width=this.source.width*a.SCALE,this.destination.height=this.source.height*a.SCALE,this.destination.x=o.floor(t.x*a.SCALE),this.destination.y=o.floor(t.y*a.SCALE),this.zIndex=1e4*(t.index||1)+this.destination.y+this.destination.height}return a.SCALE=4,a.FPS=60,a.prototype={render(e,t){this.animationState=(this.animationState+this.animationSpeed)%this.animationSteps;const s=o.floor(this.animationState)*this.source.width,i=this.destination.x,n=this.destination.y;t.drawImage(e,this.source.x+s,this.source.y,this.source.width,this.source.height,i,n,this.destination.width,this.destination.height)}},{start(o,l,c){e=l,s=c.assets,i=c.positions;const h=t.prepareCanvas(800,300);(n=h.ctx).imageSmoothingEnabled=0,h.cnv.classList.add("layer","buildings"),o.appendChild(h.cnv),r=new Map,p.observe(p.MSG_TYPES.BUILD,e=>{const t=d.get(e);if(t&&t.asset&&s[t.asset]){const e=new a(s[t.asset],i[t.asset]);t.upgrade&&r.delete(t.upgrade),r.push(t.id,e)}}).observe(p.MSG_TYPES.UNBUILD,e=>{d.get(e)&&r.has(e)&&r.delete(e)}),this.render()},render(){if(requestAnimationFrame(this.render.bind(this)),r.size){n.clear();const t=[];r.forEach(e=>{let s=e.zIndex;for(;t[s];)s++;t[s]=e}),t.forEach(t=>t.render(e,n))}}}}(),m=function(){const e={0:"info",1:"warning",2:"quote",3:"event"};let t=null;const s={LOG_TYPES:{INFO:0,WARN:1,QUOTE:2,EVENT:3},maxLog:30,start(e){t=e,p.observe(p.MSG_TYPES.ACTION_END,e=>s.log(e)).observe(p.MSG_TYPES.ARRIVAL,e=>{s.log(s.personify("A new person arrive. @nominative present @reflexive as @name.",e),p.MSG_TYPES.LOGS.EVENT)}).observe(p.MSG_TYPES.LOOSE,e=>{h("Death","survival duration",e);const t=`After holding up for ${r.formatTime(e)},\n                        everyone die and the camp is left to rot under the sun.`;s.log(t,s.LOG_TYPES.EVENT)}).observe(p.MSG_TYPES.RUNS_OUT,e=>{const t=`There's no more ${c.toString(d.get(e))} available,\n                        something needs to be done quickly.`;s.log(t,s.LOG_TYPES.WARN)}).observe(p.MSG_TYPES.GAIN_PERK,e=>{const t=`${e.name} is now known as the "${r.capitalize(e.perk.data.name)}".`;s.log(t,s.LOG_TYPES.EVENT)})},log(i,o=s.LOG_TYPES.INFO){if(i.length){const s=r.wrap(`log ${e[o]}`,i);s.hide(),t.insertBefore(s,t.firstChild);const n=Array.prototype.slice.call(t.children);n.length>m.maxLog&&n.last().remove(),s.show.defer(s)}},personify:(e,t)=>r.capitalize(e.replace(/@([\w.]+)\b/gi,(e,s)=>{let i=t;return s.split(".").forEach(e=>i=i[e]),i||""}))};return s}(),p=function(){const e=[],t={observe(t,s){return r.isArray(t)||(t=[t]),t.forEach(t=>{e[t]||(e[t]=[]),e[t].push(s)}),this},notify(t,s,i){return e[t]&&e[t].forEach(e=>e(s,t)),this},MSG_TYPES:{LOGS:m.LOG_TYPES,CLICK:10,ACTION_END:12,REFRESH:20,GIVE:30,FIND_LOCATION:31,ARRIVAL:33,USE:35,RUNS_OUT:36,LOOSE_RESOURCE:38,LOOSE_SOMEONE:39,UNLOCK:40,GAIN_PERK:45,LOCK:50,START_BUILD:59,BUILD:60,UNBUILD:61,INCIDENT_START:70,INCIDENT_END:72,LOOSE:90,WIN:95,KEYS:{BACK:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,UP:38,RIGHT:39,DOWN:40,LEFT:37,CTRL:17,SHIFT:16,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,ZERO:48,F5:116,F8:119,F12:123}}};t.MSG_TYPES.KEYS.browse((e,s)=>t.MSG_TYPES.KEYS[s]=e+1e3);const s=[t.MSG_TYPES.KEYS.F5,t.MSG_TYPES.KEYS.F12,t.MSG_TYPES.KEYS.TAB,t.MSG_TYPES.KEYS.ENTER,t.MSG_TYPES.KEYS.SPACE];return window.addEventListener("keydown",e=>{const i=1e3+e.keyCode;s.includes(i)||(e.preventDefault(),e.stopPropagation()),t.notify(i,"down",!0)},!0),window.addEventListener("keyup",e=>{e.preventDefault(),e.stopPropagation();const s=1e3+e.keyCode;s===t.MSG_TYPES.KEYS.ENTER&&e.target.dispatchEvent(new Event("click")),t.notify(s,"up")},!0),t}(),g=function(){const e=localStorage;let t=e.getItem("k");t||(t=r.randomStr(),e.setItem("k",t));const s=r.randomStr();return{persist(i){var o;e.setItem(t,(o=JSON.stringify(i),btoa(s+btoa(o))))},hasData:()=>Object.keys(e).includes(t),load(){return JSON.parse((i=e.getItem(t),atob(atob(i).substr(s.length))));var i},clear(){e.removeItem(t)}}}(),f=function(){function e(e,t){this.startTime=r.getNow(),this.action=e,this.time=t,this.isRunning=!0,this.timeout=this.setTimeout()}e.prototype={setTimeout(){return setTimeout(this.action,this.time)},getElapsed(){return r.getNow()-this.startTime},getRemaining(){return this.time-this.getElapsed()},stop(){return!!this.isRunning&&(this.isRunning=!1,this.time=this.getRemaining(),clearTimeout(this.timeout),this.time)},restart(e){return this.isRunning||(this.isRunning=!0,this.startTime=e,this.timeout=this.setTimeout()),!this.isRunning&&this.time}};const t=new Map;function s(e){const s=t.get(e);if(!s)throw new RangeError(`Unknown timer ID [${e}]`);return s}return{timeout(s,i){const o=t.push(new e(()=>{s(),t.delete(o)},i));return o},stop:e=>s(e).stop(),stopAll(){t.forEach(e=>e.stop())},restart:e=>s(e).restart(r.getNow()),restartAll(){const e=r.getNow();t.forEach(t=>t.restart(e))},clear(e){const i=s(e);t.delete(e),i.stop()},clearAll(){t.forEach(e=>e.clear())},getElapsed:e=>s(e).getElapsed(),getRemaining:e=>s(e).getRemaining()}}();function b(e,t,s){this.locked=!0,this.clickable=null,this.options=null,this.optionsWrapper=null,this.owner=t,this.parentAction=s||null,this.repeated=0,this.chosenOptionId=null,this.energyDrain=null,this.super(e)}function w(e){this.super(e)}function y(e,t){const s=r.getNow();r.log(`Loaded in ${s}ms`),console.log("Starting v0.5.3"),this.assets=t,this.resources=new Map,this.buildings=new Map,this.incidents=new Map,this.people=new Map,this.initialActions=[],this.knownLocations=[],this.buildingsInProgress=[],this.flags={paused:!1,win:!1,gameOver:!1,settled:0,incidents:[]},this.lastTick=s,y.holder=e,this.super(null,t),r.log(`Started in ${r.getNow()-s}ms`)}function v(e){this.timer=null,this.nameNode=null,this.progressBar=null,this.tooltip=null,this.super(e)}function E(e,t){this.id=r.pickUniqueID(),this.name=e,this.gender=t||"other",this.actions=new Map,this.busy=!1,this.energyDrain=.7,this.energy=100,this.life=100,this.stats={idle:0,age:0},this.perk=null,this.super()}function k(e,t){if(k.usedId.includes(e))throw new RangeError(`This perk is already used [${e}]`);k.usedId.push(e),this.owner=t,this.super(e)}function S(e,t,s=0){this.value=null,this.threshold=s,this.super(e),this.setColor(t)}function A(e,t,s){this.text=t,this.timeout=null,this.super(e),this.setAction(s)}function L(e,t,s){e instanceof L?(this.html=e.html.cloneNode(),this.distance=e.distance):this.super(`icon icon-small-${e}`,t,s)}function T(e,t){this.data=e,this.super(t),this.show.defer(this)}function I(e,t){this.container=e,this.nodes={},this.resourcesMapper={},this.super(null,t)}b.RUNNING_CLASS="running",b.extends(l,"Action",{toHTML(){const e=this._toHTML();return this.clickable=new A("name disabled animated",r.capitalize(this.data.name)),e.appendChild(this.clickable.html),r.isFunction(this.data.options)?(this.clickable.setAsDropdown(!0),this.optionsWrapper=r.wrap("options",null,e),this.optionsWrapper.hide(),e.addEventListener("mouseover",this.showOptions.bind(this)),e.addEventListener("mouseout",this.hideOptions.bind(this))):this.clickable.setAction(this.click.bind(this,null)),this.data.order&&(e.style.order=this.data.order),e},showOptions(){this.optionsWrapper.show();const e=this.html.getBoundingClientRect();this.optionsWrapper.style.top=`${e.top+e.height}px`,this.optionsWrapper.style.left=`${e.left}px`},hideOptions(){this.optionsWrapper.hide(),this.optionsWrapper.style.left=""},init(){b.timeAndEnergyFallback(this.data),this.tooltip=new I(this.clickable.html,this.data),this.manageOptions()},manageOptions(){if(r.isFunction(this.data.options)){this.options||(this.options=new Map);const e=this.data.options(this);this.options.forEach(t=>{e.includes(t.getId())||t.lock()});for(let t=0,s=e.length;t<s;++t){const s=e[t];if(!this.options.has(s)){const e=new b(s,this.owner,this);this.options.push(e),this.optionsWrapper.appendChild(e.html)}}}},refresh(e,t){this.locked=this.owner.isTired()&&this.data.energy>0||this.data.isOut&&t.incidents.includes(d.ids.incidents.easy.sandstorm)||this.parentAction&&this.parentAction.locked,this.tooltip.refresh(e,this.data),r.isArray(this.data.consume)&&!this.locked&&this.data.consume.forEach(t=>{const s=t[1];e.has(s)&&e.get(s).has(t[0])||(this.locked=!0)},this),this.manageOptions(),this.options&&this.options.forEach(s=>s.refresh(e,t)),this.clickable.toggle(!this.locked)},click(e){if(!this.owner.busy&&!this.locked)if(this.parentAction)this.parentAction.click(this.getId());else if(e||!this.options){p.notify(p.MSG_TYPES.CLICK,this.data),this.chosenOptionId=e;const t=this.mergeWithOption(e);r.isArray(t.consume)&&p.notify(p.MSG_TYPES.USE,t.consume),t.build&&p.notify(p.MSG_TYPES.START_BUILD,t.build),++this.repeated;const s=this.defineDuration(t);this.energyDrain=t.energy/s,this.start(s*y.TICK_LENGTH)}},defineDuration(e){let t=e.time||0;return e.timeDelta&&(t+=o.random(-e.timeDelta,e.timeDelta)),e.timeBonus&&(t-=t*e.timeBonus),t},start(e,t=0){const s=e+t;this.owner.setBusy(this.getId(),this.energyDrain),this.clickable.startCoolDown(s,t,this.end.bind(this)),this.html.classList.add(b.RUNNING_CLASS)},mergeWithOption(e){const t={},s=e?d.get(e):{};let i={},o=s.build||this.data.build;o&&(o===d.ids.option?o=e:i=d.get(o)),t.build=o,t.optionId=e;return["name","desc","log","time","timeDelta","timeBonus","energy","giveSpan"].forEach(e=>{t[e]=i[e]||s[e]||this.data[e]}),["consume","give","giveList","unlock","lock","unlockForAll","lockForAll"].forEach(e=>{(this.data[e]||s[e]||i[e])&&(t[e]=(this.data[e]||[]).concat(s[e]||[]).concat(i[e]||[]))}),[].forEach(e=>{(i[e]||this.data[e]||s[e])&&(t[e]=Object.assign({},this.data[e]||{},s[e]||{},i[e]||{}))}),b.timeAndEnergyFallback(t),t},end(){this.html.classList.remove(b.RUNNING_CLASS);const e={action:this.data,people:this.owner},t=this.mergeWithOption(this.chosenOptionId);this.chosenOptionId=null,this.owner.finishAction(),r.isFunction(this.data.effect)&&this.data.effect(this,t,e);const s=this.resolveAction(e,t);s.give.length&&p.notify(p.MSG_TYPES.GIVE,{give:s.give,initiator:this}),s.unlock.forAll.length&&p.notify(p.MSG_TYPES.UNLOCK,s.unlock.forAll),this.owner.addAction(s.unlock.forOne),s.lock.forAll.length&&p.notify(p.MSG_TYPES.LOCK,s.lock.forAll),this.owner.lockAction(s.lock.forOne),s.build&&p.notify(p.MSG_TYPES.BUILD,s.build),p.notify(p.MSG_TYPES.ACTION_END,s.log)},resolveAction(e,t){const s={give:[],unlock:{forAll:[],forOne:[]},lock:{forAll:[],forOne:[]},log:""};if(this.getId()===d.ids.actions.gather&&1===this.repeated&&this.owner.hasPerk(d.ids.perks.first)?s.give=[[2,d.ids.resources.gatherables.common.rock],[1,d.ids.resources.gatherables.uncommon.bolts],[1,d.ids.resources.gatherables.rare.medication]]:r.isArray(t.give)?s.give=t.give:t.giveSpan&&t.giveList&&(s.give=r.randomizeMultiple(t.giveList,t.giveSpan)),s.give.forEach((e,s,i)=>{e[1]===d.ids.option&&(i[s]=[e[0],t.optionId])}),r.isArray(this.data.unlockAfter)&&this.data.unlockAfter.forEach(e=>{this.repeated>e[0]&&(s.unlock.forOne.push(e[1]),s.lock.forOne.push(this.getId()))}),r.isArray(t.unlock)){const e=t.unlock.filter(e=>{const t=d.get(e);return!t.condition||t.condition(this)});this.data.unique?s.unlock.forAll.insert(e):s.unlock.forOne.insert(e)}r.isArray(t.unlockForAll)&&s.unlock.forAll.insert(t.unlockForAll.filter(e=>{const t=d.get(e);return!t.condition||t.condition(this)})),r.isArray(this.data.lockAfter)&&this.data.lockAfter.forEach(e=>{this.repeated>e[0]&&s.lock.forOne.push(e[1])}),r.isArray(t.lock)&&(this.data.unique?s.lock.forAll.insert(t.lock):s.lock.forOne.insert(t.lock)),r.isArray(t.lockForAll)&&s.lock.forAll.insert(t.lockForAll),this.data.unique&&s.lock.forAll.push(this.getId()),t.build&&(s.build=t.build,e.build=r.an(d.get(t.build).name)),e.give=r.formatArray(s.give);const i=r.isFunction(t.log)?t.log(e,this):t.log||"";return s.log=m.personify(i,e),s},lock(){this.cancel(),this.tooltip.remove(),this.options?this.options.forEach(e=>e.lock()):this.parentAction&&this.parentAction.options.delete(this.getId()),this.remove()},cancel(){this.clickable.isRunning()&&(this.owner.setBusy(),this.html.classList.remove(b.RUNNING_CLASS),this.clickable.endCoolDown())},toJSON(){const e=this._toJSON();return e.rpt=this.repeated,this.clickable.isRunning()&&(e.elp=this.clickable.getElapsed(),e.rmn=this.clickable.getRemaining(),e.egd=this.energyDrain,e.opi=this.chosenOptionId),e}}),b.static({timeAndEnergyFallback(e){if(r.isUndefined(e.energy)&&!r.isUndefined(e.time)){const t=5;e.energy=e.time*t}e.time=e.time||0}}),w.extends(l,"Building",{toHTML:r.noop,init(){this.data.lock&&p.notify(p.MSG_TYPES.LOCK,this.data.lock),this.data.unlock&&p.notify(p.MSG_TYPES.UNLOCK,this.data.unlock),r.isFunction(this.data.effect)&&this.data.effect(this,this.data),this.data.build&&p.notify(p.MSG_TYPES.BUILD,this.data.build)}}),y.static({TICK_LENGTH:2e3,REFRESH_RATE:200,holder:null}),y.extends(a,"GameController",{toHTML(){const e=this._toHTML();e.hide(),this.resourcesList=r.wrap(c.LST_ID,null,e);const t=r.wrap("topPart",null,e);this.peopleList=r.wrap(E.LST_ID,null,t),this.logsList=r.wrap("logs",null,t),this.visualPane=r.wrap("visualPane",null,e),this.incidentsList=r.wrap(v.LST_ID,null,e);const s=r.wrap("bottomOptions",null,e),i=new A("wipe","Clear save",()=>{new T({name:"Clear save",desc:"Completely wipe the saved game. Careful, this is irreversible.",yes:{name:"Restart anew",action:this.wipeSave.bind(this,!0)},no:"Cancel"},"wipeIt")});s.appendChild(i.html);const o=new A("credits","Credits",()=>{new T({name:"Settlement v0.5.3",desc:`<ul>\n                ${[{task:"Code",name:"Guillaume Martigny",url:"https://www.guillaume-martigny.fr/#en"},{task:"Graphics",name:"Olivier Michas",url:"https://twitter.com/OliverMichas"}].map(e=>`<li>${e.task}: ${e.name.link(e.url)}</li>`).join("")}\n            </ul>`})});return s.appendChild(o.html),e},init(e){d.bindAll(this),y.holder.html="",y.holder.appendChild(this.html),u.start(this.visualPane,e.assets,{assets:e.assetsData,positions:e.buildingsData}),m.start(this.logsList),this.registerObservers(),g.hasData()?this.loadGame():(p.notify(p.MSG_TYPES.BUILD,d.ids.buildings.special.wreckage),this.initialActions.push(d.ids.actions.wakeUp),this.prepareNewcomer.defer(this)),localStorage.getItem("known")&&new T({name:"Early access [v0.5.3]",desc:"You'll see a very early stage of the game. It may be broken, it may not be balanced ...<br/>If you want to report a bug or anything to improve the game, go to <a href='https://github.com/GMartigny/settlement'>the project's page</a>.<br/><br/>Thanks for playing !",yes:{name:"Got it !",action(){localStorage.setItem("known","1")}}}),this.refresh(),this.show()},registerObservers(){const e=p.MSG_TYPES;p.observe(e.ACTION_END,()=>this.saveGame()).observe(e.CLICK,e=>{this.saveGame(),h("Action","start",e.name)}).observe(e.GIVE,e=>{let t=null;if(e.initiator&&(t=e.initiator,e=e.give),r.isArray(e)){const s=[],i=document.createDocumentFragment();e.forEach(e=>{if(this.earn(...e),t){const o=e[1],n=d.get(o);if(n.icon){const r=this.resources.get(o);for(let o=0;o<e[0];++o){const e=new L(n.icon,t,r);i.appendChild(e.html),s.push(e)}}}}),s.length&&(y.holder.appendChild(i),L.batch.defer(null,s))}}).observe(e.USE,e=>{r.isArray(e)&&r.compactResources(e).forEach(e=>this.consume(...e))}).observe(e.START_BUILD,e=>this.buildingsInProgress.push(e)).observe(e.BUILD,e=>this.build(e)).observe(e.ARRIVAL,()=>h("People","arrive",this.getSettledTime())).observe(e.LOOSE_SOMEONE,t=>{h("People","die",t.stats.age);const s=this.people.size<=0,i=s?"The last @common standing passed away. The last hope fades out in silence.":"@name just died, @possessive body is dragged outside and buried.";m.log(m.personify(i,t),m.LOG_TYPES.WARN),s&&p.notify(e.LOOSE)}).observe(e.LOOSE,()=>{this.flags.gameOver=!0,h("Game","loose",this.getSettledTime())}).observe(e.INCIDENT_START,e=>{this.incidentsList.appendChild(e.html),this.incidents.push(e),this.saveGame()}).observe(e.INCIDENT_END,e=>{this.incidents.delete(e.getId()),e.data.unique||this.flags.incidents.out(e.getId()),this.saveGame()}).observe(e.LOCK,this.removeFromInitialActions.bind(this)).observe(e.UNLOCK,this.addToInitialActions.bind(this)).observe(e.WIN,()=>{this.flags.win=!0,h("Game","win",this.getSettledTime())}).observe(e.KEYS.SPACE,e=>{"up"===e&&this.togglePause()})},addToInitialActions(e){r.isArray(e)||(e=[e]),e.forEach(e=>{this.initialActions.includes(e)||this.initialActions.push(e)}),this.people.forEach(t=>t.addAction(e))},removeFromInitialActions(e){r.isArray(e)||(e=[e]),e.forEach(e=>this.initialActions.out(e)),this.people.forEach(t=>t.lockAction(e))},getSettledTime(){return o.floor(this.flags.settled?this.flags.settled/y.TICK_LENGTH:0)},getSurvivalDuration(){return r.formatTime(this.getSettledTime())},togglePause(){this.flags.paused=!this.flags.paused,this.html.classList.toggle("paused",this.flags.paused),this.html.classList.toggle("backdrop",this.flags.paused),this.flags.paused?f.stopAll():(f.restartAll(),this.lastTick=r.getNow())},refresh(){const e=o.floor((r.getNow()-this.lastTick)/y.TICK_LENGTH);if(this.lastTick+=e*y.TICK_LENGTH,requestAnimationFrame(this.refresh.bind(this)),this.flags.win){if(!T.OPENED&&this.people.size){const e=this;new T({name:"The road ahead",desc:"From the rumors, much of the east coast have not been destroy by bombs. Some survivors have set new community from scratch.<br/>From what can be heard, those groups accept anyone willing to live peacefully. Let's find them !",yes:{name:"Let the journey begin ...",action(){e.people.forEach((e,t,s)=>{e.hide(),s.delete(t)}),p.notify(p.MSG_TYPES.UNBUILD,d.ids.buildings.big.module),e.saveGame()}}})}}else if(this.flags.gameOver)T.OPENED||new T({name:"Lost",desc:"",yes:{name:"Try again",action:()=>this.wipeSave(!0)}});else if(!this.flags.paused){if(this.flags.settled){this.flags.settled+=e*y.TICK_LENGTH,this.tickConsumption(e);const t=d.get(d.ids.people).dropRate;this.canSomeoneArrive()&&o.random()<t&&this.prepareNewcomer(),!T.OPENED&&o.random()<v.DROP_RATE&&this.startIncident(this.getRandomIncident())}this.resources.forEach(e=>e.refresh(this.resources)),this.people.forEach((t,s)=>{t.isDead()?(this.people.delete(s),t.die()):t.refresh(this.resources,e,this.flags)}),e&&this.saveGame()}},tickConsumption(e){d.get(d.ids.people).needs.forEach(t=>{const s=t[1];this.flags[t[2]]=0;const i=this.incidents.get(d.ids.incidents.hard.drought);s===d.ids.resources.gatherables.common.water&&i&&(t[0]*=i.data.multiplier);const o=+this.flags.incidents.includes(d.ids.incidents.medium.strayDog),n=this.people.size+o,r=this.consume(t[0]*n*e,s,e=>{this.flags[t[2]]=e}),a=d.get(s);a.initialDropRate||(a.initialDropRate=a.dropRate);a.dropRate=r?a.initialDropRate:a.dropRate*.99**e})},hasEnough(e,t){return this.resources.has(e)&&this.resources.get(e).has(t)},consume(e,t,s){let i=!1;if(e){this.resources.has(t)||this.earn(0,t);const o=this.resources.get(t);if(o.has(e))o.update(-e),o.warnLack=!1;else{if(i=!0,r.isFunction(s)){const i=e-(o?o.count:0);s.call(this,i,t)}o.set(0),o.warnLack||(o.warnLack=!0,p.notify(p.MSG_TYPES.RUNS_OUT,t))}}return i},earn(e,t){if(this.resources.has(t))this.resources.get(t).update(e);else{const s=new c(t,e);this.resources.push(s),this.resourcesList.appendChild(s.html)}},prepareNewcomer(e){E.peopleFactory(e||1).then(e=>{e.forEach(e=>{e.addAction(this.initialActions),this.people.size||(e.life=0,e.energy=0,e.updateLife(0),e.updateEnergy(0))}),this.arrive(e)})},arrive(e){r.isArray(e)||(e=[e]),e.forEach(e=>{if(this.people.size&&(p.notify(p.MSG_TYPES.ARRIVAL,e),1===this.people.size)){const t=m.personify("attracted by the crash a @common approach. @nominative accept to team up.",e);m.log(t,p.MSG_TYPES.LOGS.EVENT),f.timeout(()=>{m.log("There's other wanderers ready to join if there's room for them.",p.MSG_TYPES.LOGS.QUOTE)},3*y.TICK_LENGTH)}this.addPeople(e),e.show.defer(e)})},addPeople(e){this.people.push(e),this.peopleList.appendChild(e.html);let t=this.people.size;this.people.forEach(e=>e.html.style.zIndex=String(t--))},build(e){if(this.buildingsInProgress.out(e),!this.buildings.has(e)){const t=new w(e);this.buildings.push(t),t.data.upgrade&&this.buildings.delete(t.data.upgrade),h("Building","built",t.data.name)}},unlockedCraftables(){const e=[];return d.ids.resources.craftables.deepBrowse(t=>{const s=d.get(t);s.ifHas&&!this.buildings.has(s.ifHas)||!(!s.condition||r.isFunction(s.condition)&&s.condition())||e.push(t)}),e},possibleCraftables(){return this.unlockedCraftables().filter(e=>{const t=d.get(e);let s=!0;return r.isFunction(t.consume)&&(s=t.consume(t).some(e=>this.hasEnough(e[1],e[0]))),s})},possibleBuildings(){const e=[];return d.ids.buildings.deepBrowse(t=>{const s=d.get(t);s.shadow||this.isBuildingInProgress(t)||this.isBuildingDone(t)||s.upgrade&&!this.buildings.has(s.upgrade)||s.ifHas&&!this.isBuildingDone(s.ifHas)||e.push(t)}),e},isBuildingInProgress(e){return this.buildingsInProgress.includes(e)},isBuildingDone(e){let t=!1;return this.buildings.forEach(s=>{if(!t){let i=s.getId(),o=s.data.upgrade;for(t=t||i===e;o&&!t;)i=o,o=d.get(i).upgrade,t=t||i===e}}),t},canSomeoneArrive(){return this.hasEnough(d.ids.resources.room,this.people.size+1)},getRandomIncident(){let e=[];const t=this.getSettledTime()/d.time.week;return{1:d.ids.incidents.easy,2:d.ids.incidents.medium,5:d.ids.incidents.hard}.browse((s,i)=>{t>i&&e.insert(s)}),(e=e.filter(e=>{const t=d.get(e);return!this.incidents.has(e)&&(!t.condition||r.isFunction(t.condition)&&t.condition())})).length?r.randomize(e):null},startIncident(e){if(e&&!this.flags.incidents.includes(e)){const t=new v(e);this.flags.incidents.push(t.getId()),t.start(),this.saveGame(),h("Incident","start",t.data.name)}},saveGame(){this.flags.gameOver||g.persist(this)},toJSON(){const e={flg:this.flags,res:this.resources.getValues(),plp:this.people.getValues(),iac:this.initialActions,bld:this.buildings.getValues(),inc:this.incidents.getValues(),lct:this.knownLocations,bip:this.buildingsInProgress,upk:k.usedId,vrn:"v0.5.3"};return delete e.flg.paused,delete e.flg.popup,e},loadGame(){h("Game","reload");const e=g.load();(e.vrn&&e.vrn.substr(0,e.vrn.lastIndexOf(".")))!=="v0.5.3".substr(0,"v0.5.3".lastIndexOf("."))&&new T({name:"New version",desc:"Since the last time you played, a new version of the game has been released.<br/>You may want to restart to experience all the cool new features. ;)<br/><a href='https://github.com/GMartigny/settlement#changelog'>Changelog</a>"}),p.notify(p.MSG_TYPES.GIVE,e.res),e.bld.forEach(e=>p.notify(p.MSG_TYPES.BUILD,e.id)),e.inc.forEach(e=>{const t=new v(e.id);e.rmn&&t.run(e.rmn)}),e.plp.forEach(e=>{const t=new E(e.nam,e.gnd);t.setLife(e.lif),t.setEnergy(e.ene),t.stats=e.sts,e.prk&&t.gainPerk(e.prk),e.act.forEach(e=>{t.addAction(e.id);const s=t.actions.get(e.id);s.repeated=e.rpt,e.rmn&&(s.choosenOptionId=e.opi,s.energyDrain=e.egd,s.start(e.rmn,e.elp))}),this.addPeople(t),t.show()}),k.usedId=e.upk,this.addToInitialActions(e.iac),this.knownLocations=e.lct,this.buildingsInProgress=e.bip,this.flags=e.flg},wipeSave(e){h("Game","wipe"),g.clear(),e&&location.reload()}}),v.DROP_RATE=.01,v.DEFAULT_COLOR="#164b80",v.extends(l,"Incident",{init(){this.tooltip=new I(this.html,this.data),this.data.yes={name:this.data.yes,action:this.run.bind(this)},this.data.no=this.data.no?{name:this.data.no,action:this.end.bind(this)}:null},toHTML(){const e=this._toHTML();return this.data.time&&(this.nameNode=r.wrap("name",r.capitalize(this.data.name),e),this.progressBar=new S("timer animated",this.data.color||v.DEFAULT_COLOR),e.appendChild(this.progressBar.html),e.hide()),e},run(e){if(!e){const e={incident:this.data};r.isArray(this.data.consume)&&(e.consume=this.data.consume),r.isFunction(this.data.onStart)&&this.data.onStart(this,e),r.isArray(e.consume)&&p.notify(p.MSG_TYPES.USE,e.consume);const t=r.isFunction(this.data.log)?this.data.log(e,this):this.data.log||"";m.log(m.personify(t,e),m.LOG_TYPES.EVENT)}let t=0;this.data.time&&(p.notify(p.MSG_TYPES.INCIDENT_START,this),this.show(),t=e||this.defineDuration(),this.progressBar.run(t)),this.timer=f.timeout(this.end.bind(this),t)},defineDuration(){let e=this.data.time;return this.data.timeDelta&&(e+=o.random(-this.data.timeDelta,this.data.timeDelta)),e*y.TICK_LENGTH},start(){r.isFunction(this.data.effect)&&this.data.effect(this),new T(this.data,"incident")},cancel(){this.timer&&(f.stop(this.timer),this.end())},end(){this.timer=null,p.notify(p.MSG_TYPES.INCIDENT_END,this);const e={incident:this.data};if(r.isArray(this.data.give)?e.give=this.data.give:this.data.giveList&&this.data.giveSpan&&(e.give=r.randomizeMultiple(this.data.giveList,this.data.giveSpan)),r.isFunction(this.data.onEnd)&&this.data.onEnd(this,e),r.isArray(e.give)&&(p.notify(p.MSG_TYPES.GIVE,{initiator:this.nameNode,give:e.give}),e.give=r.formatArray(e.give)),e.log){const t=m.personify(e.log,e);m.log(t,m.LOG_TYPES.EVENT)}this.remove(),this.tooltip.remove()},toJSON(){const e=this._toJSON();return this.timer&&(e.rmn=f.getRemaining(this.timer)),e}}),v.LST_ID="incidentList",E.extends(a,"People",{init(){this.setPronouns(),new I(this.lifeBar.html,{name:"Health",desc:"The first thing anyone want is a good health."}),new I(this.energyBar.html,{name:"Energy",desc:"Drained faster when busy or hungry."})},toHTML(){const e=this._toHTML();this.nameNode=r.wrap("name",r.capitalize(this.name),e);return this.lifeBar=new S("life","#f52158",25),e.appendChild(this.lifeBar.html),this.energyBar=new S("energy","#19f5ba"),e.appendChild(this.energyBar.html),this.actionList=r.wrap("actionList",null,e),e.hide(),e},refresh(e,t,s){if(this.actions.forEach(t=>t.refresh(e,s)),s.settled){this.stats.age+=t,this.stats.idle+=t;const e=30,i=this.energyDrain+s.starving*e;this.updateEnergy(-t*i);let o=0;s.thirsty&&(o+=s.thirsty*e);const n=d.get(this.busy);s.incidents.includes(d.ids.incidents.medium.acidRain)&&n&&n.isOut&&(o+=d.get(d.ids.incidents.medium.acidRain).lifeLose),this.updateLife(-t*o)}},setPronouns(){switch(this.gender){case"female":this.common="woman",this.nominative="she",this.accusative="her",this.possessive="her",this.reflexive="herself";break;case"male":this.common="man",this.nominative="he",this.accusative="him",this.possessive="his",this.reflexive="himself";break;default:this.common="robot",this.nominative="it",this.accusative="it",this.possessive="its",this.reflexive="itself"}},setBusy(e,t){this.busy=e||!1,e?(e!==d.ids.actions.sleep&&(this.stats.idle=0),this.energyDrain=t):this.energyDrain=1,this.html.classList.toggle("busy",this.busy)},finishAction(){this.rollForPerk(this.busy),this.setBusy()},updateEnergy(e){this.energy+=e;let t=this.energy;return t>E.MAX_BAR_VALUE?t=E.MAX_BAR_VALUE:t<0&&(this.updateLife(t),t=0),this.setEnergy(t),t},setEnergy(e){this.energy=e,this.energyBar.set(e)},isTired(){return this.energy.equals(0)||this.energy<0},updateLife(e){let t=this.life+e;return t>E.MAX_BAR_VALUE&&(t=E.MAX_BAR_VALUE),this.setLife(t),t},setLife(e){this.life=e,this.lifeBar.set(e)},addAction(e){r.isArray(e)||(e=[e]),e.forEach(e=>{if(!this.actions.has(e)){const t=new b(e,this);this.actions.push(t),this.actionList.appendChild(t.html)}})},lockAction(e){r.isArray(e)||(e=[e]),e.forEach(e=>{const t=this.actions.get(e);t&&(t.lock(),this.actions.delete(e))})},rollForPerk(e){let t=!1;return this.perk||d.ids.perks.deepBrowse(s=>{if(!k.isUsed(s)){const i=d.get(s),n=i.actions;if((!n||n.includes(e))&&(!r.isFunction(i.condition)||i.condition(this))){let e=0;(e=(e=n?n.reduce((e,t)=>{const s=this.actions.get(t);return e+(s?s.repeated:0)},0)/(i.iteration||0):1/(i.iteration||0))<1?0:e)&&o.random()<e&&(this.gainPerk(s),p.notify(p.MSG_TYPES.GAIN_PERK,this),t=!0)}}}),t},gainPerk(e){this.perk=new k(e,this),this.nameNode.appendChild(this.perk.html)},hasPerk(e){return this.perk&&this.perk.getId()===e},isDead(){return this.life<0},die(){p.notify(p.MSG_TYPES.LOOSE_SOMEONE,this),this.actions.forEach(e=>{e.cancel(),e.tooltip.remove()}),this.hide(this.remove)},toJSON(){const e={nam:this.name,gnd:this.gender,lif:this.life,ene:this.energy,sts:this.stats,act:this.actions.getValues()};return this.perk&&(e.prk=this.perk.getId()),e}}),E.static({LST_ID:"peopleList",MAX_BAR_VALUE:100,peopleFactory(e=1){return this.randomName(e).then(e=>{const t=[];return e.results.forEach(e=>{const s=new E(r.capitalize(e.name.first),e.gender);t.push(s)}),t})},randomName:(e=1)=>new Promise((t,s)=>{const i=`https://randomuser.me/api?inc=gender,name&nat=${["AU","BR","CA","CH","DE","DK","ES","FI","FR","GB","IE","NL","NZ","TR","US"].join(",")}&noinfo&results=${e}`;fetch(i).then(e=>{e.ok?e.json().then(t):s(new URIError(`[${e.status}] ${i} ${e.statusText}`))})})}),k.extends(l,"Perk",{init(){this.data.desc=m.personify(this.data.desc,{people:this.owner}),new I(this.html,this.data),r.isArray(this.data.unlock)&&this.owner.addAction(this.data.unlock),r.isArray(this.data.lock)&&this.owner.lockAction(this.data.lock)},toHTML(){const e=this._toHTML();return e.textContent=`the "${r.capitalize(this.data.name)}"`,e}}),k.static({usedId:[],isUsed:e=>k.usedId.includes(e)}),S.extends(a,"Bar",{toHTML(){const e=this._toHTML();return this.valueBar=r.wrap("value",null,e),e},setColor(e){this.html.style.backgroundColor=i.fade(e,.2),this.valueBar.style.backgroundColor=e},set(e){e.equals(this.value)||(this.value=e,this.valueBar.style.width=`${e}%`,this.html.classList[e<this.threshold?"add":"remove"]("warning"))},run(e=0){this.valueBar.style.animationDuration=`${o.toNumber(e)}ms`,this.html.classList.add("ongoing")}}),A.extends(a,"Clickable",{toHTML(){const e=this._toHTML();return e.textContent=this.text,e.tabIndex=0,e},startCoolDown(e,t,s){this.html.style.animationDuration=`${e}ms`,this.html.style.animationDelay=`${-t}ms`,this.html.classList.add("cooldown"),this.timeout=f.timeout(()=>{this.endCoolDown(),s()},e-t)},setAction(e){r.isFunction(e)&&this.html.addEventListener("click",e,!0)},isRunning(){return Boolean(this.timeout)},endCoolDown(){this.isRunning()&&(f.clear(this.timeout),this.timeout=null,this.html.style.animationDuration="",this.html.style.animationDelay="",this.html.classList.remove("cooldown"))},toggle(e){this.html.classList.toggle("disabled",!e);this.html.tabIndex=e?0:-1},setText(e){this.text=e,this.html.textContent=e},getElapsed(){return f.getElapsed(this.timeout)},getRemaining(){return f.getRemaining(this.timeout)},setAsDropdown(e){this.html.classList.toggle("dropdown",e)}}),function(e,t,s){this.value=null,this.threshold=s||0,this.super(e),this.setColor(t)}.extends(a,"Bar",{toHTML(){const e=this._toHTML();this._nodes=[];for(let t=0;t<2;++t){const t=r.wrap("clip",null,e);this._nodes.push({clip:t,bar:r.wrap("part",null,t)})}return this.valueNode=r.wrap("value","0%",e),e},setColor(e){this._nodes.forEach(t=>t.bar.style.backgroundColor=e)},set(e){if(!e.equals(this.value)){this.value=e;const t=3.6*e;this._nodes.forEach(e=>e.bar.style.transform=`rotate3d(0, 0, 1, ${t/2-.5})`),this.valueNode.textContent=`${o.floor(e)}%`,this.html.classList[e<this.threshold?"add":"remove"]("warning")}}}),L.extends(a,"Particle",{toHTML(){const e=this._toHTML();return e.style.transitionDuration=`${L.transitionDuration}ms`,e},init(e,t){this.hide();const s=e.html.getBoundingClientRect(),i=s.left+s.width/2,o=s.top+s.height/2;this.html.style.left=`${i}px`,this.html.style.top=`${o}px`;const n=t.html.getBoundingClientRect(),r=n.left+n.width/2,a=n.top+n.height/2;setTimeout(()=>t.animate("more"),2*L.transitionDuration),this.distance={left:r-i,top:a-o}},animate(e,t=""){this.html.style.transform=`translate3d(${e.left}px, ${e.top}px, 0)`,this.html.style.transitionTimingFunction=t}}),L.static({transitionDuration:600,transitionWait:150,flyingDistance:40,batch(e){e.forEach(e=>{e.show();const t=o.random(o.PI2);e.animate({left:o.cos(t)*L.flyingDistance,top:o.sin(t)*L.flyingDistance},"cubic-bezier(.2,.5,.5,1)")}),setTimeout(()=>{e.forEach(e=>e.animate(e.distance,"cubic-bezier(.5,0,.8,.5)")),setTimeout(()=>{e.forEach(e=>e.remove())},L.transitionDuration)},L.transitionDuration+L.transitionWait)}}),T.extends(a,"Popup",{toHTML(){const e=this._toHTML();r.wrap("title",r.capitalize(this.data.name),e),r.wrap("description",this.data.desc,e);const{yes:t,no:s}=this.data,i=t&&t.action||r.noop,o=new A("yes",t&&t.name||r.isString(t)&&t||"Ok",this.hide.bind(this,i));if(e.appendChild(o.html),s){const t=s.action||r.noop,i=new A("no",s.name||r.isString(s)&&s||"Cancel",this.hide.bind(this,t));e.appendChild(i.html)}return e.hide(),e},show(e){T.OPENED=!0,T.HOLDER.classList.add("backdrop"),T.HOLDER.appendChild(this.html);const t=o.floor((T.HOLDER.offsetHeight-this.html.offsetHeight)/2);this.html.style.top=`${t}px`,this._show(e)},hide(e){T.OPENED=!1,this.remove(),this._hide(e)},remove(){this._remove(),T.HOLDER.classList.remove("backdrop")}}),T.static({HOLDER:document.body,OPENED:!1}),I.extends(a,"Tooltip",{init(e){this.refresh(new Map,e),y.holder.appendChild(this.html);const t=this.html.getBoundingClientRect();this.width=t.width,this.height=t.height,this.hide(),this.html.remove(),this._addEvents()},_setPosition(e,t){const s=I.getWrapperSize(),i=o.constrain(e+10,0,s.width-this.width),n=o.constrain(t+10,0,s.height-this.height);this.html.style.left=`${i}px`,this.html.style.top=`${n}px`},_mouseOver(){y.holder.appendChild(this.html),this.show.defer(this)},_mouseOut(){this.hide(),this.html.remove.defer(this.html)},_mouseMove(e){this._setPosition(e.clientX,e.clientY)},_addEvents(){this.container.classList.add("tooltiped"),this.container.addEventListener("mouseenter",this._mouseOver.bind(this)),this.container.addEventListener("mousemove",this._mouseMove.bind(this)),this.container.addEventListener("mouseleave",this._mouseOut.bind(this))},_removeEvents(){this.container.classList.remove("tooltiped"),this.container.removeEventListener("mouseenter",this._mouseOver),this.container.removeEventListener("mousemove",this._mouseMove),this.container.removeEventListener("mouseleave",this._mouseOut)},toHTML(){const e=this._toHTML(),t=r.wrap("wrapper",null,e);return this.nodes.name=r.wrap("title",null,t),this.nodes.desc=r.wrap("description",null,t),this.nodes.time=r.wrap("time",null,t),this.nodes.resourcesContainer=r.wrap("consumption",null,t),e},refresh(e,t){this.isShow&&(this.nodes.name.textContent=r.capitalize(t.name),t.desc?this.nodes.desc.html=t.desc:this.nodes.desc.remove(),t.time?this.nodes.time.textContent=r.formatTime(t.time):this.nodes.time.remove(),r.isArray(t.consume)?t.consume.forEach(function(t){const s=t[1];let i=this.resourcesMapper[s];if(!i){const e=d.get(s),o=r.wrap("resource not-enough",null,this.nodes.resourcesContainer);o.style.order=e.order;const n=r.wrap("counter",null,o);r.wrap(null,c.toString(e,t[0]),o),i={node:o,counter:n},this.resourcesMapper[s]=i}const o=e.has(s)?e.get(s).get():0,n=o<t[0];i.counter.textContent=n?`${o}/`:"",i.node.classList.toggle("not-enough",n)},this):this.nodes.resourcesContainer.remove())}}),I.static({wrapperSizeCache:null,getWrapperSize(){if(!this.wrapperSizeCache){const e=y.holder.getBoundingClientRect();I.wrapperSizeCache={width:e.width,height:e.height}}return I.wrapperSizeCache},resetCache(){I.wrapperSizeCache=null}}),window.addEventListener("resize",I.resetCache)}("undefined"==typeof window?window={}:window);