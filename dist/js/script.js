!function(t){"use strict";function n(e,t){var n=document.createElement("canvas");return n.width=e,n.height=t,{cnv:n,ctx:n.getContext("2d")}}function i(){this.items={},this.length=0}function o(e){return e<<0}function s(e){return o(e+.5)}function r(e,t,n){return e<t?t:e>n?n:e}function a(e){this.data=e,this.html=this.toHTML(),this._init.apply(this,Array.prototype.splice.call(arguments,1))}function c(e,t){var n=document.createElement("div");return e&&n.classList.add.apply(n.classList,e.split(" ")),t&&(n.innerHTML=t),n}function u(e){var t=["year","month","day","hour","minute"],n=[],i=U.time;return t.forEach(function(t){if(e>=i[t]){var s=o(e/i[t]);e%=i[t],n.push(s+" "+d(t,s))}}),h(n)}function l(e){var t=[];return e.forEach(function(e){var n=d(e[1].name,e[0]);e[1].icon&&(n+=" "+C.iconAsString(e[1].icon)),t.push(e[0]+" "+n)}),h(t)}function h(e,t){return e.length>1?(e[e.length-2]+=" "+(t||"and")+" "+e.pop(),e.join(", ")):e.length?e[0]:""}function d(e,t){return e+(t>1&&"s"!==e[e.length-1]?"s":"")}function f(e){return e?(e=e.replace(/([\.!\?]) ([a-z])/g,function(e,t,n){return t+" "+n.toUpperCase()}))[0].toUpperCase()+e.slice(1):""}function m(e,t){if(!e.values().length)throw new TypeError("Can't pick from empty list");var n={},i=[],o=0;e.deepBrowse(function(e){e.dropRate&&(o+=e.dropRate,i.push(o),n[o]=e)});var r=s(B(o));i.sort();for(var a=0,c=i.length;a<c;++a)if(i[a]>r){r=i[a];break}return t?(v(t)||(t=y(t)?t.split("-"):[+t]),[s(B.apply(null,t)),n[r]]):n[r]}function p(e,t){if(!t)throw new TypeError("Need an amount");var n=[];v(t)||(t=y(t)?t.split("-"):[+t]);for(var i=s(B.apply(null,t)),o=0;o<i;){var r=s(B(1,i-o));n.push([r,m(e)]),o+=r}return n}function g(e,t,n){n=n||Object.keys(t);var i=t.clone();return n.forEach(function(t){i[t]&&b(i[t])&&(i[t]=i[t](e))}),i}function b(e){return e instanceof Function}function v(e){return Array.isArray(e)}function y(e){return"string"==typeof e}function w(e){return void 0===e}function k(e){return e.toLowerCase().replace(/(\W)+/g,"_")}function E(e){return("aeiou".split("").includes(e[0])?"an":"a")+" "+e}function S(e){return e.reduce(function(e,t){var n=e.find(function(e){return e[1].id===t[1].id});return n?n[0]+=t[0]:t[0]>0&&e.push(t),e},[])}function L(e,t){var n={},i=0,o=e.length;return Promise.all(e.map(function(e){var s,r=fetch(e).then(function(t){if(t.ok)return t;throw URIError("["+t.status+"] "+e+" "+t.statusText)});switch(e.substr(e.lastIndexOf(".")+1)){case"png":case"jpg":case"gif":s=r.then(function(e){var t=new Image;return e.blob().then(function(e){return t.src=URL.createObjectURL(e),t})});break;case"json":s=r.then(function(e){return e.json()});break;default:s=Promise.resolve()}return s.then(function(s){n[k(e)]=s,t(++i/o*100,e)})})).then(function(){return n})}function T(e,t,n){ga&&ga("send","event","Game",e,t,n)}function A(e,t){if(!t)throw new TypeError("Can't draw asset without destination");this.animationState=0,this.animationSteps=t.animationSteps||1,this.source={},this.destination={},this.defineSource(e),this.destination.x=o(+t.x*A.ENLARGE),this.destination.y=o(+t.y*A.ENLARGE)}function _(e,t,n){this.locked=!0,this.running=!1,this.nameNode=null,this.options=null,this.optionsWrapper=null,this.owner=e,this.parentAction=n||null,this.repeated=0,this.super(t)}function O(e){this.super(e)}function R(e){this.timer=null,this.nameNode=null,this.progressBar=null,this.tooltip=null,this.super(e)}function N(e,t){var n=s(performance.now());console.log("Loaded in "+n+"ms"),console.log("Starting v0.3.0"),this.assets=t,this.resources=new i,this.buildings=new i,this.events=new i,this.people=[],this.initialActions=new i,this.knownLocations=new i,this.buildingsInProgress=[],this.flags={ready:!1,paused:!1,settled:!1,survived:0,popup:!1,productivity:1},this.lastTick=n,this.super(),e.appendChild(this.html),console.log("Started in "+s(performance.now()-n)+"ms")}function P(e){return x.randomName(e).then(function(e){var t=[];return e.results.forEach(function(e){var n=new x(f(e.name.first+""),e.gender);t.push(n)}),t})}function x(e,t){this.name=e,this.gender=t||"other",this.actions=new i,this.busy=!1,this.energy=100,this.starving=!1,this.life=100,this.thirsty=!1,this.stats={actionsDone:{},idle:0,age:0},this.perk=null,this.super()}function C(e,t){this.count=0,this.warnLack=!1,this.super(e,t)}function G(e,t){this.value=null,this.threshold=t||0,this.super(),this.html.classList.add.apply(this.html.classList,e.split(" "))}function I(e,t,n){t=t||Y;var i=document.body,s=c(n="popup"+(n?" "+n:""));s.appendChild(c("title",f(e.name))),s.appendChild(c("description",e.desc));var r={remove:function(){s.remove(),i.classList.remove("backdrop")}},a=c("yes clickable",e.yes||"Ok");if(a.addEventListener("click",function(){t(),r.remove()}),s.appendChild(a),e.no){var u=c("no clickable",e.no);u.addEventListener("click",r.remove),s.appendChild(u)}return i.appendChild(s),i.classList.add("backdrop"),s.style.top=o((i.offsetHeight-s.offsetHeight)/2)+"px",r}function M(e,t){this.container=e,this.nodes={},this.resourcesMapper={},this.box=this.toHTML(t),this._mouseOver(),this.width=this.box.offsetWidth,this.height=this.box.offsetHeight,this._mouseOut(),this._addEvents()}CanvasRenderingContext2D.prototype.clear=function(){this.clearRect(0,0,this.canvas.width,this.canvas.height)},i.prototype={push:function(e,t){return w(t)&&(e=(t=e).id||this.length+1),e=e.toString(),!this.has(e)&&(this.items[e]=t,++this.length,e)},pop:function(e){var t=this.items[e];return!!t&&(delete this.items[e],--this.length,t)},has:function(e){return!!this.items[e]},get:function(e){if(!this.has(e))throw new RangeError("Unknown ID ("+e+") in Collection ("+this+")");return this.items[e]},set:function(e,t){var n=this.get(e);return this.items[e]=t,n},forEach:function(e){this.length>0&&this.items.browse(function(t,n){e(t,n,this)}.bind(this))},filter:function(e){var t=new i;return this.forEach(function(n,i,o){e(n,i,o)&&t.push(i,n)}),t},values:function(){return this.items.values()},keys:function(){return Object.keys(this.items)},random:function(){return this.values().random()},clear:function(){this.items={},this.length=0},toString:function(){return"["+this.keys().join(", ")+"]"}};var B=function(){var e=Math.random;return function(t,n){return w(n)?(n=w(t)?1:+t||1,t=0):(t=+t||0,n=+n||1),e()*(n-t)+t}}();a.prototype={_init:function(){},toHTML:function(){return c(this.modelName)}},Array.prototype.last=function(){return this[this.length-1]},Array.prototype.random=function(){return this[o(B(0,this.length))]},Array.prototype.out=function(e){return this.splice(this.indexOf(e),1),this.length},Object.prototype.values=function(){var e=[];return this.browse(function(t){e.push(t)}),e},Object.prototype.browse=function(e){var t=this;Object.keys(this).forEach(function(n){e(t[n],n,t)})},Object.prototype.deepBrowse=function(e){this.browse(function(t,n,i){t.name?e(t,n,i):t.deepBrowse(e)})},Object.prototype.swap=function(){var e={};return this.browse(function(t,n){e[t]=n}),e},Object.prototype.clone=function(){var e;if(void 0===this||null===this||[Boolean,Number,String].includes(this.constructor))e=this;else if(this instanceof Array)e=this.slice();else{if(!(this instanceof Object))throw new TypeError("Improbable source type");e=Object.assign({},this)}return e},Function.prototype.extends=function(e,t,n){if(e&&(this.prototype=Object.create(e.prototype),this.prototype.super=e,this.prototype.constructor=this,this.prototype.modelName=t),n){var i=this;n.browse(function(e,t){i.prototype[t]&&(i.prototype["_"+t]=i.prototype[t]),i.prototype[t]=e})}};var Y=new Function,D=function(){var e=[];return function(){var t="------".replace(/-/g,function(){return s(B(36)).toString(36)});return e.includes(t)?D():(e.push(t),t)}}();!function(e,t,n,i,o,s,r){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=+new Date,s=t.createElement(n),r=t.getElementsByTagName(n)[0],s.async=1,s.src="https://www.google-analytics.com/analytics.js",r.parentNode.insertBefore(s,r)}(window,document,"script",0,"ga"),ga("create","UA-99773946-1","auto"),ga("send","pageview"),function(){console.groupCollapsed("Loading");L(["dist/img/icons.png","dist/img/assets.png","dist/js/assets.json"],function(e,t){console.log(t+" : "+e.toFixed(1)+"% - "+s(performance.now()))}).then(function(e){console.groupEnd();try{new N(document.body,{images:e[k("dist/img/assets.png")],data:e[k("dist/js/assets.json")]})}catch(e){console.warn("Fail to load game : "+e.message,e.stack)}}).catch(function(t){console.warn(t.message,e.stack)})}();var U=function(){var e={minute:1/60,hour:1,day:24,week:168,month:720,year:8640},t=["north","south","east","west","north-east","north-west","south-east","south-west"],n={resources:{gatherables:{common:{water:{name:"water",desc:"Water is definitely important to survive in this harsh environment.",icon:"water-bottle",dropRate:100,order:10},food:{name:"food",desc:"Everyone need food to keep his strength.",icon:"foodcan",dropRate:90,order:20},rock:{name:"rock",desc:'"There\'s rocks everywhere ! Why would you bring this back ?"',icon:"rock",dropRate:100,order:30},scrap:{name:"scrap metal",desc:"An old rusty piece of metal.",icon:"metal-scraps",dropRate:90,order:40}},uncommon:{bolts:{name:"nuts and bolts",desc:"Little metal nuts and bolts to fasten anything in place.",icon:"nuts-and-bolts",dropRate:70,order:50},sand:{name:"sand",desc:"Just pure fine sand.",icon:"sand-pile",dropRate:40,order:55},oil:{name:"fuel",desc:"About a liter of gas-oil.",icon:"jerrycan",dropRate:10,order:60}},rare:{medication:{name:"medication",desc:"An unlabeled medication, hope it's still good.",icon:"medications",dropRate:7,order:70},electronic:{name:"electronics",desc:"Some basic micro-electronics components.",icon:"electronic-parts",dropRate:10,order:75}},special:{ruins:{name:"location",desc:"Directions to a point of interest we found earlier.",icon:"map",order:80,dropRate:.6},quartz:{name:"quartz cristal",desc:"A rough uncut gem of quartz. Quite valuable.",icon:"gem",dropRate:.1,order:77}}},craftables:{basic:{stone:{name:"smooth stone",desc:"A round and well polish stone.",icon:"stone",consume:function(){return[[3,n.resources.gatherables.common.rock]]},dropRate:100,order:90},glass:{name:"glass pane",desc:"A see-through building component.",icon:"glass-pane",condition:function(){return this.buildings.has(n.buildings.small.furnace.id)},consume:function(){return[[4,n.resources.gatherables.uncommon.sand]]},dropRate:60,order:100},component:{name:"component",desc:"Some mechanical parts for others craftables.",icon:"pipes-large",consume:function(){return[[2,n.resources.gatherables.common.scrap],[2,n.resources.gatherables.uncommon.bolts]]},dropRate:120,order:110},tool:{name:"tool",desc:"The base for any tinkerer.",icon:"tools",consume:function(){return[[1,n.resources.craftables.basic.component],[2,n.resources.gatherables.common.rock]]},dropRate:90,order:111}},complex:{brick:{name:"brick",desc:"Bricks will give walls for larger constructions.",icon:"brick",condition:function(){return this.buildings.has(n.buildings.small.well.id)},consume:function(){return[[1,n.resources.craftables.basic.stone],[1,n.resources.craftables.basic.tool]]},dropRate:80,order:112},circuit:{name:"circuit",desc:"That's a little rough, but it's actually a functioning circuit board.",icon:"electronic-circuit-board",consume:function(){return[[1,n.resources.gatherables.common.scrap],[2,n.resources.craftables.basic.component],[3,n.resources.gatherables.rare.electronic]]},dropRate:60,order:114},metalPipe:{name:"metal pipe",desc:"Pipes that you forge from junk metal.",icon:"pipes-small",condition:function(){return this.buildings.has(n.buildings.medium.forge.id)},consume:function(){return[[4,n.resources.gatherables.common.scrap],[1,n.resources.craftables.basic.tool]]},dropRate:80,order:115},furniture:{name:"furniture",desc:"A proper settlement needs better than pile of trash for table and seats.",icon:"glass-table",consume:function(){return[[2,n.resources.craftables.basic.glass],[2,n.resources.craftables.complex.metalPipe]]},dropRate:40,order:116}},advanced:{jewelry:{name:"jewelry",desc:"A really beautiful ornament you could use for trading.",icon:"jewelry",condition:function(){return this.buildings.has(n.buildings.small.furnace.id)},consume:function(){return[[4,n.resources.gatherables.rare.electronic],[3,n.resources.gatherables.special.quartz]]},dropRate:40,order:117},engine:{name:"engine",desc:"Amazing what you manage to do with all those scraps !",icon:"engine",condition:function(){return this.buildings.has(n.buildings.big.workshop.id)},consume:function(){return[[10,n.resources.gatherables.uncommon.oil],[5,n.resources.craftables.basic.tool],[5,n.resources.craftables.complex.metalPipe]]},dropRate:30,order:120},computer:{name:"computer",desc:"Well, Internet is down since 2136 but it can still be useful.",icon:"computer",condition:function(){return this.buildings.has(n.buildings.big.workshop.id)},consume:function(){return[[10,n.resources.craftables.basic.component],[7,n.resources.craftables.basic.tool],[3,n.resources.craftables.complex.circuit]]},dropRate:20,order:130}}},room:{name:"room",desc:"A place for someone in the camp.",icon:"person",order:0}},people:{name:"people",desc:"The workforce and the bane of you camp.",consumption:{water:1/e.day,food:1/e.day},needs:function(e){return[[n.people.consumption.water*(e.drought?2:1),n.resources.gatherables.common.water,"thirsty"],[n.people.consumption.food,n.resources.gatherables.common.food,"starving"]]},dropRate:.1},buildings:{small:{forum1:{name:"forum+1",desc:"Add one room.",time:2,condition:function(){var e=this.buildings;return!(e.has(n.buildings.medium.forum2)||e.has(n.buildings.medium.forum3))},consume:function(){return[[6,n.resources.gatherables.uncommon.bolts],[4,n.resources.gatherables.common.scrap]]},give:function(){return[[1,n.resources.room]]},asset:"forum+1",log:"It'll be nice to have someone else helping."},furnace:{name:"furnace",desc:"Survival require to craft as much as to gather things.",time:7,condition:function(){return!this.buildings.has(n.buildings.medium.forge)},consume:function(){return[[8,n.resources.gatherables.common.rock],[2,n.resources.gatherables.uncommon.oil]]},asset:"furnace",log:"A simple furnace that can smelt small things like sand or little electronics."},plot:{name:"farm plot",desc:"A little arranged plot of soil to grow some food.",time:9,condition:function(){return!this.buildings.has(n.buildings.medium.plot1)},consume:function(){return[[5,n.resources.gatherables.common.food],[10,n.resources.gatherables.uncommon.sand]]},unlock:function(){return[n.actions.harvest]},asset:"plot",log:"More crops required more care but that's going to help us keeping a constant stock of food."},pharmacy:{name:"pharmacy",desc:'"Maybe we should avoid letting medications rot in plain sunlight ?!"',time:6,consume:function(){return[[5,n.resources.gatherables.rare.medication],[4,n.resources.craftables.basic.component]]},asset:"pharmacy",log:"Sorting our medications should prevent further mistakes and bad reaction."},well:{name:"well",desc:"Just a large hole into the ground.",time:16,condition:function(){return!this.buildings.has(n.buildings.big.pump.id)},consume:function(){return[[10,n.resources.craftables.basic.stone],[3,n.resources.craftables.basic.tool]]},give:function(){return[[5,n.resources.gatherables.common.water]]},unlock:function(){return[n.actions.drawFrom.well]},lock:function(){return[n.actions.drawFrom.river.id]},asset:"well",log:"Drawing water from the ground should allow to further polish stone into bricks."}},medium:{forum2:{name:"forum+2",desc:"Add one room.",time:5,condition:function(){return!this.buildings.has(n.buildings.big.forum3)},consume:function(){return[[10,n.resources.gatherables.uncommon.sand],[2,n.resources.craftables.basic.stone],[3,n.resources.craftables.basic.glass]]},upgrade:function(){return n.buildings.small.forum1.id},give:function(){return[[1,n.resources.room]]},asset:"forum+2",log:"Another room for someone to join. So far, "},plot1:{name:"field",desc:"A larger crop field to produce more food.",time:10,consume:function(){return[[20,n.resources.gatherables.common.food],[5,n.resources.gatherables.uncommon.sand],[3,n.resources.gatherables.rare.medication]]},upgrade:function(){return n.buildings.small.plot.id},asset:"plot+1",log:"This should be enough to provide food for our small encampment."},forge:{name:"forge",desc:"A good upgrade to the furnace.",time:10,consume:function(){return[[6,n.resources.gatherables.uncommon.oil],[10,n.resources.craftables.basic.stone],[2,n.resources.craftables.basic.tool]]},upgrade:function(){return n.buildings.small.furnace.id},asset:"furnace+1",log:"We can now work metal better and make more complex part."}},big:{forum3:{name:"forum+3",desc:"Add two rooms.",time:6,consume:function(){return[[10,n.resources.craftables.complex.brick],[2,n.resources.craftables.complex.furniture],[6,n.resources.craftables.basic.glass]]},upgrade:function(){return n.buildings.medium.forum2.id},give:function(){return[[2,n.resources.room]]},asset:"forum+3",log:"All the forum space is now used for sleeping place."},workshop:{name:"workshop",desc:"Organizing your workforce make them more efficient at crafting.",time:3*e.day,energy:90,condition:function(){return this.buildings.has(n.buildings.small.furnace.id)},consume:function(){return[[6,n.resources.gatherables.common.scrap],[5,n.resources.craftables.basic.glass],[10,n.resources.craftables.basic.tool],[15,n.resources.craftables.complex.brick]]},give:function(){return[]},asset:"workshop",log:"Good organisation allow you to prepare project and do much more complex crafting."},radio:{name:"radio-station",desc:"Broadcasting could finally bring us some help.",time:6,condition:function(){return this.buildings.has(n.buildings.big.workshop.id)},consume:function(){return[[4,n.resources.craftables.complex.circuit],[1,n.resources.craftables.advanced.computer]]},asset:"radio",log:'"Message received. We thought no one survive the crash. Glad you still have the cube.Unfortunately we can\'t risk being located, bring it to sent position. Over."'},pump:{name:"water pump",desc:"A buried contraption that collect water from the earth moisture.",time:3*e.day,energy:120,consume:function(){return[[20,n.resources.craftables.basic.stone],[5,n.resources.craftables.complex.metalPipe],[1,n.resources.craftables.advanced.engine]]},upgrade:function(){return n.buildings.small.well.id},unlock:function(){return[n.actions.drawFrom.well]},asset:"pump",log:"A big upgrade to your well ! Now we have a continuous flow of water coming."},trading:{name:"trading post",desc:"Since the radio station bring a handful of merchant, better take advantage of it.",time:e.day,energy:70,condition:function(){return this.buildings.has(n.buildings.big.radio.id)&&this.resources.has(n.resources.craftables.complex.jewelry)},consume:function(){return[[2,n.resources.craftables.basic.glass],[10,n.resources.craftables.complex.brick],[2,n.resources.craftables.complex.furniture]]},unlock:function(){return[n.actions.exchange]},asset:"trading",log:"Arranging some space allow us to trade with merchant caravan passing by."},module:{name:"module",desc:"With that, we can finally deliver the cube to security.",time:e.week,energy:100,condition:function(){return this.buildings.has(n.buildings.big.radio.id)},consume:function(){return[[15,n.resources.gatherables.uncommon.oil],[3,n.resources.craftables.complex.furniture],[1,n.resources.craftables.advanced.computer],[2,n.resources.craftables.advanced.engine]]},unlock:function(){return[n.actions.launch]},asset:"module",log:"What a journey, but there we are. We build so many things and explore lots of places.<br/>Now it's time to end it all !"}},special:{wreckage:{name:"wreckage",desc:"Remainings of space-ships.",asset:"wreckage"},forum:{name:"forum",desc:"The center and start of our settlement.",unlock:function(){return[n.actions.sleep]},upgrade:function(){return n.buildings.special.wreckage.id},give:function(){return[[1,n.resources.room]]},asset:"forum"}}},actions:{wakeUp:{name:"wake up",unlock:function(e){return e.owner.updateEnergy(100),e.owner.updateLife(100),[n.actions.look]},log:"@people.name gets up painfully.",order:0,unique:!0},look:{name:"look around",desc:"What am I doing here ?",time:1,energy:0,give:function(){return V.timeout(function(){H.notify(H.MSG_TYPES.LOGS.FLAVOR,"We need a shelter.")},1500),[[10,n.resources.gatherables.common.water],[8,n.resources.gatherables.common.food],[2,n.resources.craftables.basic.component]]},unlock:function(){return[n.actions.settle]},log:"After some thinking, @people.name remembers the attack. @people.nominative grabs @give laying around.",order:0,unique:!0},settle:{name:"settle here",desc:"Ok, let's settle right there !",time:2,energy:0,unlock:function(){return this.flags.settled=!0,[n.actions.gather]},build:function(){return n.buildings.special.forum},log:"@people.name installs @build inside a ship-wreck with @give to sleep in.",order:0,unique:!0},gather:{name:"gather resources",desc:"Go out to bring back resources, that's the best you can do.",time:3,isOut:1,unlock:function(){return[n.actions.roam,n.actions.craft]},giveSpan:[3,6],give:function(e){return p(n.resources.gatherables,e.data.giveSpan)},log:"@people.name comes back with @give.",order:0},roam:{name:"roam",desc:"Explore the surroundings hoping to find something interesting.",time:6,isOut:1,consume:function(){return[[1,n.resources.gatherables.common.water]]},condition:function(e){return!e.owner.actions.has(n.actions.scour.id)},unlock:function(e){var t=[n.actions.explore];return e.repeated>9&&t.push(n.actions.scour),t},lock:function(e){var t=[];return e.repeated>9&&t.push(e.data.id),t},giveSpan:[1,3],give:function(e,t,i){var o=p(n.resources.gatherables,e.data.giveSpan);if(B()<n.resources.gatherables.special.ruins.dropRate){o.push([1,n.resources.gatherables.special.ruins]);var s=m(n.locations.near);this.knownLocations.push(s),i.location=E(s.name)}return o},log:function(e){var n;return n=e.location?"Heading @direction, @people.name spots @location, so @people.nominative brings back @give.":"Despite nothing special found towards @direction, @people.name brings back @give.",e.direction=t.random(),n},order:10},scour:{name:"scour",desc:"Knowledge of the area allows for better findings.",time:5,isOut:1,consume:function(){return[[1,n.resources.gatherables.common.water]]},giveSpan:[2,4],give:function(e,t,i){var o=m(n.resources.gatherables,e.data.giveSpan),s=n.resources.gatherables.special.ruins.dropRate,r=e.owner.hasPerk(n.perks.explorer.id),a=r?1:.5;if(B()<s+(1-s)*a){o.push([1,n.resources.gatherables.special.ruins]);var c=m(r?n.locations.epic:n.locations.far);this.knownLocations.push(c),i.location=E(c.name)}return o},log:function(e){var n;return n=e.location?"@people.name knew @people.nominative could find @location towards @direction, so @people.nominative comes back with @give.":"No special location towards @direction, but @people.name find @give.",e.direction=t.random(),n},order:10},explore:{name:"explore",desc:"Remember that location we saw the other day ? Let's see what we can find there.",time:e.day+4*e.hour,energy:100,isOut:1,consume:function(){return[[3,n.resources.gatherables.common.water],[1,n.resources.gatherables.common.food],[1,n.resources.gatherables.special.ruins]]},options:function(){return this.knownLocations.values()},giveSpan:[7,10],give:function(e,t,i){i.location=t;var o=p(t.give(),e.data.giveSpan),s=n.resources.gatherables.special.quartz;return B()<s.dropRate&&o.push([1,s]),o},log:function(e){var t=e.location.log||"";return b(t)?t(e,action):t},order:20},craft:{name:"craft",desc:"Use some resources to tinker something useful.",time:function(){return this.buildings.has(n.buildings.big.workshop.id)?4:5},options:function(){return this.unlockedCraftables()},give:function(e,t){return[[1,t]]},unlock:function(){return[n.actions.build]},log:function(){return"@people.name succeeds to craft @give."},order:30},build:{name:"build",desc:"Put together some materials to come up with what looks like a building.",build:function(e,t){return t},options:function(){return this.possibleBuildings()},order:50},drawFrom:{river:{name:"draw water",desc:"Get some water from the river.",time:8,energy:50,isOut:1,condition:function(e){return!e.owner.actions.has(n.actions.drawFrom.well.id)},giveSpan:[2,6],give:function(e){return[[s(B.apply(null,e.data.giveSpan)),n.resources.gatherables.common.water]]},log:"Coming back from the river, @people.name bringsÂ @give with @people.accusative.",order:60},well:{name:"draw water",desc:"Get some water from our well.",time:2,energy:15,giveSpan:[1,3],give:function(e){var t=this.buildings.has(n.buildings.big.pump.id);return[[s(B.apply(null,e.data.giveSpan)+(t?4:0)),n.resources.gatherables.common.water]]},log:"Using our well, @people.name get @give.",order:60}},harvest:{name:"harvest crops",desc:"It's not the biggest vegetables, but it'll fill our stomachs.",time:function(){return this.buildings.has(n.buildings.medium.plot1.id)?6:4},consume:function(){return[[this.buildings.has(n.buildings.medium.plot1.id)?3:2,n.resources.gatherables.common.water]]},giveSpan:[1.5,2],give:function(e){var t=this.buildings.has(n.buildings.medium.plot1.id);return[[s(B.apply(null,e.data.giveSpan)*(t?2:1)),n.resources.gatherables.common.food]]},log:"Our crops produce @give.",order:70},sleep:{name:"sleep",desc:"Get some rest to restore energy.",time:7,energy:0,give:function(e){return e.owner.updateEnergy(100),[]},unlock:function(){return[n.actions.heal]},log:"@people.name feels well rested now.",order:5},heal:{name:"heal",desc:'"I really hope those pills are still good."',time:2,energy:1,consume:function(){return[[2,n.resources.gatherables.rare.medication]]},give:function(e,t,i){var o=99,s=this.buildings.has(n.buildings.small.pharmacy.id),r=e.owner.hasPerk(n.perks.healer.id);return!s&&!r&&B()<.4&&(o=-10,i.wasBad=!0),e.owner.updateLife(o),[]},log:function(e){return e.wasBad?"After feeling not so well, @people.name realise taking these pillstook a hit on his health.":"This time, it actually improve @people's health."},order:6},nurse:{name:"nurse",desc:"Look after the health of the most needed one.",time:2,energy:1,consume:function(){return[[2,n.resources.gatherables.rare.medication]]},give:function(e,t,n){var i=null;return this.people.forEach(function(e){(!i||e.life<i.life)&&(i=e)}),i.updateLife(99),n.cured=i,[]},log:"Thanks to @people.name, @cured.name feel better.",order:7},exchange:{name:"exchange",desc:"Caravan passing by carry lots of useful stuff, let's see what's possible to trade.",time:7,energy:20,consume:function(){return[[2,n.resources.craftables.complex.jewelry]]},giveSpan:[2,3],give:function(e){return p({basic:n.resources.craftables.basic,complex:n.resources.craftables.complex},e.data.giveSpan)},log:"@people.name manage to trade a couple of jewelries for @give.",order:10},launch:{name:"launch",desc:"Finally set off this module to get out of that damn wasteland.",time:12,energy:30,isOut:1,unique:!0,consume:function(){return[[10,n.resources.gatherables.uncommon.oil]]},give:function(){return H.notify(H.MSG_TYPES.WIN,this.getSettledTime()),[]},log:function(){return"After "+this.getSurvivalDuration()+", you finally leave this damn crash-site.<br/>You have to leave everyone behind. You make a promise to yourself to come back as soon as you can."},order:15}},locations:{near:{mountain:{name:"mountain",desc:"A nearby mountain that may contains some basic building resources",give:function(){return[n.resources.gatherables.common.rock,n.resources.gatherables.common.scrap,n.resources.craftables.basic.component]},log:"That was hard to climb those mountains, but at least @people find @give.",dropRate:90},desert:{name:"desert",desc:"Not much to find in a desert, but that's for sure the best place to get sand.",give:function(){return[n.resources.gatherables.common.scrap,n.resources.gatherables.uncommon.oil,n.resources.gatherables.uncommon.sand]},log:"Dunes everywhere give a felling of hopelessness. Anyway, here's @give for the stock.",dropRate:100},supermarket:{name:"hangar",desc:"A huge hangar. It was certainly raided before by others, but you may grab something",give:function(){return[n.resources.gatherables.common.food,n.resources.gatherables.rare.medication,n.resources.craftables.basic.glass]},log:"Quite easy to loot, but full of dangers too. Hopefully, @people.name return safely and got @give.",dropRate:80}},far:{river:{name:"river",desc:"Quite rare to find water around here. This is a valuable location to find.",unlock:function(){return[n.actions.drawFrom.river]},give:function(){return[n.resources.gatherables.common.water,n.resources.gatherables.uncommon.bolts,n.resources.craftables.basic.stone]},log:"It's nice by the river, @people.name found @give.",dropRate:40},ruin:{name:"old ruin",desc:"This is a huge underground network of rooms linked by narrow hallways. This should have provided shelter a long time ago.",give:function(){return[n.resources.gatherables.rare.electronic,n.resources.craftables.basic.component,n.resources.craftables.basic.tool]},log:"Amazing no-one get lost in those caves to get @give.",dropRate:60}},epic:{building:{name:"buried building",desc:"By digging up this building, you uncover stuff preserved from looting and environment.",give:function(){return[n.resources.gatherables.rare.medication,n.resources.craftables.basic.glass,n.resources.craftables.complex.circuit]},log:"No-one could guess what that building was, but it sure was interesting. @people.name find @give.",dropRate:30},spaceship:{name:"spaceship wreck",desc:"This wreckage seems to be in a fairly good shape and allow you to find useful part inside.",give:function(){return[n.resources.gatherables.rare.electronic,n.resources.craftables.basic.tool,n.resources.craftables.complex.furniture]},log:"What a chance to find a wreckage with not melted stuff inside. It was possible to get @give.",dropRate:20}}},events:{dropRate:.01,easy:{sandstorm:{name:"sandstorm",desc:"The wind is blowing hard, impossible to go out for now.",time:20,timeDelta:4,effect:function(e){this.flags.cantGoOut=e},dropRate:100,log:"A sandstorm has started and prevent anyone from leaving the camp."}},medium:{},hard:{drought:{name:"drought",desc:"The climate is so hot, we consume more water.",time:3*e.day,timeDelta:10,effect:function(e){this.flags.drought=e},dropRate:10,log:"A harsh drought has fall, water will be more important than ever."}}},perks:{dropRate:.1,first:{name:"first-one",desc:"The very first one to install the settlement.",actions:function(){return[n.actions.settle.id]},iteration:0},rookie:{name:"rookie",desc:"All group has a rookie, all @people.nominative want is to prove @people.nominative's efficient.",condition:function(){return this.people.length>2},effect:function(e){e.timeBonus=.9}},explorer:{name:"gadabout",desc:"The veteran of the camp and leader of the exploration. @people.nominative knows the best spot of resources.",actions:function(){return[n.actions.roam.id,n.actions.scour.id,n.actions.explore.id]},iteration:30,effect:function(e){if(e.id===n.actions.explore.id){e.giveSpan=e.giveSpan.map(function(e){return e+2})}}},tinkerer:{name:"tinkerer",desc:"Everyone is amazed by how quickly @people.nominative can put together any contraption.",actions:function(){return[n.actions.craft.id,n.actions.build.id]},iteration:30,effect:function(e){e.timeBonus=.5}},healer:{name:"doctor",desc:"Knowing enough about medicine make @people.accusative confident to heal others.",actions:function(){return[n.actions.heal.id]},condition:function(){return this.buildings.has(n.buildings.small.pharmacy.id)},iteration:5,unlock:function(){return[n.actions.nurse]}},harvester:{name:"harvester",desc:"A real eagle eye that can spot goods twice as fast as anyone.",actions:function(){return[n.actions.gather.id,n.actions.harvest.id,n.actions.drawFrom.river.id,n.actions.drawFrom.well.id]},iteration:40,effect:function(e){e.giveSpan=e.giveSpan.map(function(e){return 1.5*e})}},lounger:{name:"lounger",desc:"Doing nothing all day's not gonna make things done.",actions:function(){return[n.actions.sleep]},condition:function(t){return t.stats.idle>3*e.day},effect:function(e){e.timeBonus=1.2}},merchant:{name:"merchant",desc:"The ancient art of trading have been one of the most important skill you could have.",action:function(){return[n.actions.exchange]},iteration:10,effect:function(e){e.consume=function(){return[[1,n.resources.craftables.complex.jewelry]]}}}}};return{time:e,data:n}}(),j=function(){var e,t,o,s,r,a,c={"forum+1":{x:80,y:30},"forum+2":{x:80,y:30},"forum+3":{x:80,y:30},forum:{x:80,y:30},"furnace+1":{x:63,y:6},furnace:{x:63,y:6},module:{x:172,y:28},pharmacy:{x:86,y:35},"plot+1":{x:23,y:23},plot:{x:31,y:28},pump:{x:101,y:58},radio:{x:63,y:57},trading:{x:28,y:53},well:{x:112,y:59},workshop:{x:132,y:10},wreckage:{x:80,y:30}},u=0,l=0;return{start:function(h,d,f){e=d,t=f;var m=n(800,300);(o=m.ctx).imageSmoothingEnabled=0,m.cnv.classList.add("layer","buildings"),h.appendChild(m.cnv),m=n(h.offsetWidth,h.offsetHeight),r=m.ctx,m.cnv.classList.add("layer","events"),h.appendChild(m.cnv),s=new i,H.observe(H.MSG_TYPES.BUILD,function(e){if(e&&e.asset){var n=new A(t[e.asset],c[e.asset]);if(b(e.upgrade)){var i=e.upgrade(e);s.has(i)&&s.set(i,n)}else s.push(e.id,n)}}.bind(this)),a=new i,H.observe(H.MSG_TYPES.EVENT_START,function(e){e.asset&&a.push(e.id,new A(t[e.asset],e.asset))}),H.observe(H.MSG_TYPES.EVENT_END,function(e){a.pop(e.id)}),H.observe([H.MSG_TYPES.USE,H.MSG_TYPES.GIVE],function(e){switch(e.id){case U.data.resources.gatherables.common.water:u=e.get();break;case U.data.resources.gatherables.common.food:l=e.get()}}),this.render()},render:function(){requestAnimationFrame(this.render.bind(this)),s.length&&(o.clear(),s.values().sort(function(e,t){return e.compare(t)}).forEach(function(t){t.render(e,o)})),a.length&&(r.clear(),a.forEach(function(t){t.render(e,r)}))}}}();A.ANIMATION_INC=2/60,A.ENLARGE=4,A.prototype={defineSource:function(e){this.source={x:e.x,y:e.y,width:o(e.width/this.animationSteps),height:e.height},this.destination.width=this.source.width*A.ENLARGE,this.destination.height=this.source.height*A.ENLARGE},render:function(e,t){this.animationState=(this.animationState+A.ANIMATION_INC)%this.animationSteps;var n=o(o(this.animationState)*this.source.width),i=this.destination.x,s=this.destination.y;t.drawImage(e,this.source.x+n,this.source.y,this.source.width,this.source.height,i,s,this.destination.width,this.destination.height)},getDepth:function(){return this.destination.y},compare:function(e){return e.destination.y+e.destination.height-(this.destination.y+this.destination.height)},setPosition:function(e,t){this.destination.x=+e,this.destination.y=+t}};var W=function(){var e={};return window.addEventListener("keyup",function(t){t.keyCode;var n=e[t.keyCode];b(n)&&n()}),{KEYS:{SPACE:32,ENTER:13,ESCAPE:27,UP:38,RIGHT:39,DOWN:40,LEFT:37,CTRL:17,SHIFT:16,BACK:8,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,ZERO:48},attach:function(t,n){e[t]=n},detach:function(t){e[t]=null}}}(),F=function(){var e={0:"info",1:"warning",2:"flavor",3:"event"},t=null,n={LOG_TYPES:{INFO:0,WARN:1,FLAVOR:2,EVENT:3},maxLog:50,start:function(e){t=e,H.observe(n.LOG_TYPES.values(),function(e,t){n.log(e,t)}).observe(H.MSG_TYPES.ARRIVAL,function(e){n.log(e+" has arrived.",H.MSG_TYPES.LOGS.EVENT)}).observe(H.MSG_TYPES.LOOSE_SOMEONE,function(e){var t="We lost "+e.name+".";n.log(t,n.LOG_TYPES.WARN)}).observe(H.MSG_TYPES.LOOSE,function(e){T("death","survival duration",e);var t="We held up for "+u(e)+", but all is lost now.";n.log(t,n.LOG_TYPES.FLAVOR)}).observe(H.MSG_TYPES.RUNS_OUT,function(e){var t=e.icon?C.iconAsString(e.icon):"",i="We run out of "+e.name+" "+t+", we need to do something.";n.log(i,n.LOG_TYPES.WARN)}).observe(H.MSG_TYPES.GAIN_PERK,function(e){var t=e.name+' is now known as the "'+f(e.perk.name)+'".';n.log(t,n.LOG_TYPES.EVENT)}).observe(H.MSG_TYPES.WIN,function(e){T("win","survival duration",e);var t="It took "+u(e)+" to escape.";n.log(t,n.LOG_TYPES.FLAVOR)})},log:function(n,i){if(n.length){i=i||0,t.insertBefore(c("log "+e[i],n),t.firstChild);var o=Array.prototype.slice.call(t.children);o.length>F.maxLog&&o.last().remove()}},personify:function(e,t){return e.replace(/@([\w\.]+)\b/gi,function(e,n){var i=t;return n.split(".").forEach(function(e){i=i[e]}),i||""})}};return n}(),H=function(){var e=[],t={observe:function(t,n){return v(t)||(t=[t]),t.forEach(function(t){e[t]||(e[t]=[]),e[t].push(n)}),this},notify:function(t,n,i){this.SWAP_MSG_TYPE[t];return e[t]&&e[t].forEach(function(e){e(n,t)}),this},MSG_TYPES:{LOGS:F.LOG_TYPES,CLICK:10,REFRESH:20,GIVE:30,FIND_LOCATION:31,ARRIVAL:33,USE:35,RUNS_OUT:36,LOOSE_RESOURCE:38,LOOSE_SOMEONE:39,UNLOCK:40,GAIN_PERK:45,LOCK:50,START_BUILD:59,BUILD:60,UNBUILD:61,EVENT_START:70,EVENT_CANCEL:71,EVENT_END:72,LOOSE:80,WIN:85}};return t.SWAP_MSG_TYPE=t.MSG_TYPES.swap(),t}(),V=function(){function e(e,t){this.startTime=performance.now(),this.action=e,this.time=t,this.isRunning=!0,this.timeout=this.setTimeout()}e.prototype={setTimeout:function(){return setTimeout(this.action,this.time)},getElapsed:function(){return performance.now()-this.startTime},getRemaining:function(){return this.time-this.getElapsed()},stop:function(){return!!this.isRunning&&(this.isRunning=!1,this.time=this.getRemaining(),clearTimeout(this.timeout),this.time)},restart:function(e){return!this.isRunning&&(this.isRunning=!0,this.startTime=e,this.timeout=this.setTimeout(),this.time)}};var t=new i;return{timeout:function(n,i){var o,s=function(){t.pop(o),n()};return o=t.push(new e(s,i))},stop:function(e){return t.get(e).stop()},stopAll:function(){t.forEach(function(e){e.stop()})},restart:function(e){return t.get(e).restart(performance.now())},restartAll:function(){var e=performance.now();t.forEach(function(t){t.restart(e)})},clear:function(e){return t.pop(e).stop()},clearAll:function(){t.forEach(function(e){e.clear()})},getRemaining:function(e){return t.get(e).getRemaining()}}}();_.COOLDOWN_CLASS="cooldown",_.RUNNING_CLASS="running",_.DISABLED_CLASS="disabled",_.extends(a,"Action",{_init:function(){var e=g(this,this.data,["time","energy","consume"]);w(this.data.energy)&&e.time&&(this.data.energy=5*e.time),this.tooltip=new M(this.nameNode,e),this.manageOptions()},toHTML:function(){var e=this._toHTML(),t=c("name clickable disabled animated",f(this.data.name));return this.nameNode=t,e.appendChild(t),b(this.data.options)?(e.classList.add("withOptions"),this.optionsWrapper=c("options"),e.appendChild(this.optionsWrapper)):e.addEventListener("click",this.click.bind(this)),e.style.order=this.data.order,e},manageOptions:function(){if(b(this.data.options)){this.options||(this.options=new i);var e=this.data.options(this);this.options.forEach(function(t){e.find(function(e){return e.id===t.data.id})||t.lock()});for(var t,n,o=0,s=e.length;o<s;++o)n=e[o],this.options.has(n.id)||(t=new _(this.owner,n,this),this.options.push(n.id,t),this.optionsWrapper.appendChild(t.html))}},refresh:function(e,t){var n=g(this,this.data,["time","energy","consume"]);this.locked=this.owner.isTired()&&n.energy>0||this.data.isOut&&t.cantGoOut||this.parentAction&&this.parentAction.locked,this.tooltip.refresh(e,n),v(n.consume)&&(this.locked||n.consume.forEach(function(t){var n=t[1].id;e.has(n)&&e.get(n).has(t[0])||(this.locked=!0)}.bind(this))),this.manageOptions(),this.options&&this.options.forEach(function(n){n.refresh(e,t)}),this.locked?this.nameNode.classList.add(_.DISABLED_CLASS):this.nameNode.classList.remove(_.DISABLED_CLASS)},click:function(e){if(this.running||this.owner.busy||this.locked)return!1;if(this.parentAction)return this.parentAction.click(this.data);var t=g(this,Object.assign({},e,this.data),["time","timeDelta","timeBonus","consume"]);if(v(t.consume)&&H.notify(H.MSG_TYPES.USE,t.consume),b(t.build)){var n=t.build(this,e);H.notify(H.MSG_TYPES.START_BUILD,n.id)}this.html.classList.add(_.RUNNING_CLASS),++this.repeated,this.owner.setBusy(t);var i=(t.time||0)*N.tickLength;return t.timeDelta&&(i+=B(-t.timeDelta,t.timeDelta)*N.tickLength),t.timeBonus&&(i=t.timeBonus),this.nameNode.style.animationDuration=i+"ms",this.nameNode.classList.add(_.COOLDOWN_CLASS),this.timeout=V.timeout(this.end.bind(this,e),i),!0},end:function(e){this.timeout=0,this.html.classList.remove(_.RUNNING_CLASS),this.nameNode.classList.remove(_.COOLDOWN_CLASS);var t={name:this.data.name,people:this.owner},n=this.resolveAction(t,e);n.give.length&&H.notify(H.MSG_TYPES.GIVE,n.give),n.unlock.forAll.length&&H.notify(H.MSG_TYPES.UNLOCK,n.unlock.forAll),n.unlock.forOne.length&&this.owner.addAction(n.unlock.forOne),n.lock.forAll.length&&H.notify(H.MSG_TYPES.LOCK,n.lock.forAll),n.lock.forOne.length&&this.owner.lockAction(n.lock.forOne),n.build&&H.notify(H.MSG_TYPES.BUILD,n.build);var i,o=e&&e.log||this.data.log||"";i=b(o)?o(t,this):o;var s=F.personify(i,t);H.notify(t.logType||H.MSG_TYPES.LOGS.INFO,f(s)),this.owner.finishAction()},resolveAction:function(e,t){var n={give:[],unlock:{forAll:[],forOne:[]},lock:{forAll:[],forOne:[]}},i=this.data;if(b(i.give)&&(n.give=i.give(this,t,e)||[]),b(i.unlock)){var o=i.unlock(this,t,e).filter(function(e){return!e.condition||e.condition&&e.condition(this)}.bind(this));i.unique?n.unlock.forAll=o:n.unlock.forOne=o}if(b(i.lock)){var s=i.lock(this,t,e);i.unique?n.lock.forAll=s:n.lock.forOne=s}return i.unique&&n.lock.forAll.push(i.id),b(i.build)&&(n.build=i.build(this,t,e),n.build&&(e.build=E(n.build.name),b(n.build.give)&&(n.give=n.give.concat(n.build.give(this,t,e))),b(n.build.unlock)&&(n.unlock.forAll=n.unlock.forAll.concat(n.build.unlock(this,t,e))),b(n.build.lock)&&(n.lock.forAll=n.lock.forAll.concat(n.build.lock(this,t,e))))),n.give=S(n.give),e.give=l(n.give),n},applyEffect:function(e){b(e)&&e(this.data)},lock:function(){this.cancel(),this.tooltip.remove(),this.options?this.options.forEach(function(e){e.lock()}):this.parentAction&&this.parentAction.options.pop(this.data.id),this.html.remove()},cancel:function(){this.timeout&&(V.clear(this.timeout),this.owner.setBusy(!1),this.html.classList.remove(_.RUNNING_CLASS),this.nameNode.classList.remove(_.COOLDOWN_CLASS))}}),O.extends(a,"Building",{}),R.extends(a,"Event",{_init:function(){var e=g(this,this.data,["time","consume"]);this.tooltip&&this.tooltip.remove(),this.tooltip=new M(this.html,e)},toHTML:function(){var e=this._toHTML();return this.nameNode=c("name",f(this.data.name)),e.appendChild(this.nameNode),this.progressBar=new G("timer animated"),e.appendChild(this.progressBar.html),e},start:function(e){return I(this.data,function(){var t={event:this.data};if(this.data.effect(!0,this,t),this.data.time){H.notify(H.MSG_TYPES.EVENT_START,this);var n=this.data.time*N.tickLength;this.data.deltaTime&&(n+=B(-this.data.deltaTime,this.data.deltaTime)),this.progressBar.run(n),this.timer=V.timeout(this.end.bind(this),n)}e&&e(this);var i;i=b(this.data.log)?this.data.log(t,this):this.data.log||"";var o=F.personify(i,t);H.notify(t.logType||H.MSG_TYPES.LOGS.EVENT,f(o))}.bind(this),"event"),!!this.data.time},cancel:function(){this.timer&&(V.stop(this.timer),this.end())},end:function(){this.data.effect(!1,this),this.timer=null,H.notify(H.MSG_TYPES.EVENT_END,this),this.html.remove()}}),R.LST_ID="eventList",N.tickLength=2e3,N.extends(a,"GameController",{toHTML:function(){var e=this._toHTML();return this.resourcesList=c(C.LST_ID),e.appendChild(this.resourcesList),this.peopleList=c(x.LST_ID),e.appendChild(this.peopleList),this.visualPane=c("visualPane"),e.appendChild(this.visualPane),this.eventsList=c(R.LST_ID),e.appendChild(this.eventsList),this.logsList=c("logs"),e.appendChild(this.logsList),e},_init:function(){var e=this;U.data.deepBrowse(function(t){t.id=D(),t.browse(function(n,i){b(n)&&(t[i]=n.bind(e))})}),this.initialActions.push(U.data.actions.wakeUp),W.attach(W.KEYS.SPACE,this.togglePause.bind(this)),j.start(this.visualPane,this.assets.images,this.assets.data),F.start(this.logsList),V.timeout(this.welcome.bind(this,1,!0),500),H.observe(H.MSG_TYPES.GIVE,function(t){v(t)&&t.forEach(function(t){e.earn.apply(e,t)})}).observe(H.MSG_TYPES.USE,function(t){v(t)&&S(t).forEach(function(t){e.consume.apply(e,t)})}).observe(H.MSG_TYPES.START_BUILD,function(t){t&&e.buildingsInProgress.push(t)}).observe(H.MSG_TYPES.BUILD,function(t){t&&e.build(t)}).notify(H.MSG_TYPES.BUILD,U.data.buildings.special.wreckage).observe(H.MSG_TYPES.LOOSE_SOMEONE,function(t){e.people.out(t),e.people.length<=0&&(H.notify(H.MSG_TYPES.LOOSE,e.getSettledTime()),e.flags.paused=!0)}).observe(H.MSG_TYPES.EVENT_START,function(t){e.events.push(t.data.id,t)}).observe(H.MSG_TYPES.EVENT_END,function(t){e.events.pop(t.data.id)}).observe(H.MSG_TYPES.LOCK,function(t){e.removeFromInitialActions(t)}).observe(H.MSG_TYPES.UNLOCK,function(t){e.addToInitialActions(t)}).observe(H.MSG_TYPES.WIN,function(){this.flags.paused=!0}),I({name:"Early access",desc:"You'll see a very early stage of the game. It may be broken, it may not be balanced ...<br/>If you want to report a bug or anything to improve the game, go to <a href='https://github.com/GMartigny/settlement'>the project's page</a>.<br/><br/>Thanks for playing !"},function(){this.flags.ready=!0}.bind(this)),this.refresh()},addToInitialActions:function(e){v(e)||(e=[e]),e.forEach(function(e){this.initialActions.push(e)}.bind(this)),this.people.forEach(function(t){t.addAction(e)})},removeFromInitialActions:function(e){v(e)||(e=[e]),e.forEach(function(e){this.initialActions.pop(e)}.bind(this)),this.people.forEach(function(t){t.lockAction(e)})},getSettledTime:function(){return this.flags.settled?this.flags.survived/N.tickLength:0},getSurvivalDuration:function(){return u(this.getSettledTime())},togglePause:function(){this.flags.paused=!this.flags.paused,this.html.classList.toggle("paused",this.flags.paused),this.html.classList.toggle("backdrop",this.flags.paused),this.flags.paused?V.stopAll():V.restartAll()},refresh:function(){var e=o((performance.now()-this.lastTick)/N.tickLength);if(this.lastTick+=e*N.tickLength,this.flags.paused&&(e=0),setTimeout(this.refresh.bind(this),N.tickLength/3),e>0){if(this.flags.settled){this.flags.survived+=e*N.tickLength;var t=U.data.people.needs(this.flags);H.notify(H.MSG_TYPES.USE,t,!0),t.forEach(function(e){var t=e[0],n=e[1],i=e[2],o=this.resources.has(n.id)&&this.resources.get(n.id);o||(o=new C(n),this.resources.push(o)),o.count<t?(o.warnLack||(H.notify(H.MSG_TYPES.RUNS_OUT,n),o.warnLack=!0),this.flags[i]+=t-o.count):(o.warnLack=!1,this.flags[i]=0)}.bind(this)),this.canSomeoneArrive()&&B()<U.data.people.dropRate&&this.welcome(),!this.flags.popup&&B()<U.data.events.dropRate&&this.startEvent(this.getRandomEvent())}this.resources.forEach(function(e,t,n){e.refresh(n)}),this.people.forEach(function(t){t.refresh(this.resources,e,this.flags)}.bind(this))}},hasEnough:function(e,t){return this.resources.has(e)&&this.resources.get(e).has(t)},consume:function(e,t,n){if(e){var i=this.resources.get(t.id);if(i&&i.has(e))i.update(-e),i.warnLack=!1;else if(b(n)){var o=e-i.get();i.set(0),n.call(this,o,t),i.warnLack||(i.warnLack=!0,H.notify(H.MSG_TYPES.RUNS_OUT,t.name))}}},earn:function(e,t){var n=t.id;if(this.resources.has(n))this.resources.get(n).update(e);else{var i=new C(t,e);this.resources.push(n,i),this.resourcesList.appendChild(i.html)}},welcome:function(e,t){var n=this;P(e).then(function(e){e.forEach(function(e){e.addAction(n.initialActions.values()),n.people.push(e),n.peopleList.appendChild(e.html),t?(e.life=0,e.energy=0,e.updateLife(0),e.updateEnergy(0)):(e.html.offsetHeight,H.notify(H.MSG_TYPES.ARRIVAL,e.name),2===n.people.length&&V.timeout(function(){var t=e.name+" say that there's other desert-walkers ready to join you if there's room for them.";H.notify(H.MSG_TYPES.LOGS.FLAVOR,t)},2e3)),e.html.classList.add("arrived")})})},build:function(e){var t=e.id;if(this.buildingsInProgress.out(t),!this.buildings.has(t)){var n=new O(e);this.buildings.push(t,n),b(e.lock)&&this.removeFromInitialActions(e.lock(n)),b(e.unlock)&&this.addToInitialActions(e.unlock(n))}},unlockedCraftables:function(){var e=[];return U.data.resources.craftables.deepBrowse(function(t){(!t.condition||b(t.condition)&&t.condition())&&e.push(t)}),e},possibleCraftables:function(){this.resources.items;var e=this;return this.unlockedCraftables().filter(function(t){var n=!0;return b(t.consume)&&t.consume(t).forEach(function(t){n=n&&e.hasEnough(t[1].id,t[0])}),n})},possibleBuildings:function(){var e=[],t=this.buildings,n=this.buildingsInProgress;return U.data.buildings.deepBrowse(function(i){t.has(i.id)||n.includes(i.id)||b(i.condition)&&!i.condition(i)||b(i.upgrade)&&!t.has(i.upgrade())||e.push(i)}),e},canSomeoneArrive:function(){return this.hasEnough(U.data.resources.room.id,this.people.length+1)},getRandomEvent:function(){var e=[],t=this.getSettledTime()/U.time.week;return t>1&&(e.push.apply(e,U.data.events.easy.values()),t>2&&(e.push.apply(e,U.data.events.medium.values()),t>5&&e.push.apply(e,U.data.events.hard.values()))),e=e.filter(function(e){return!this.events.has(e.id)&&(!e.condition||b(e.condition)&&e.condition(e))}.bind(this)),e.length?m(e):null},startEvent:function(e){if(e){var t=new R(e);this.flags.popup=t.start(function(e){e.data.time&&this.eventsList.appendChild(e.html),this.flags.popup=!1}.bind(this))}}}),x.LST_ID="peopleList",x.usedPerks=[],x.extends(a,"People",{_init:function(){this.setPronouns(),new M(this.lifeBar.html,{name:"Health",desc:"The first thing you want is a good health."}),new M(this.energyBar.html,{name:"Energy",desc:"Drained faster when busy or hungry."})},toHTML:function(){var e=this._toHTML(),t=c("name",f(this.name));return this.perkNode=c("perk"),t.appendChild(this.perkNode),e.appendChild(t),this.lifeBar=new G("life",25),e.appendChild(this.lifeBar.html),this.energyBar=new G("energy"),e.appendChild(this.energyBar.html),this.actionList=c("actionList"),e.appendChild(this.actionList),e},refresh:function(e,t,n){if(this.actions.forEach(function(t){t.refresh(e,n)}),n.settled){this.stats.age+=t,this.stats.idle+=t;var i=.7;this.busy?i=(this.busy.energy||0)/this.busy.time:this.perk&&this.perk.id===U.data.perks.lounger.id&&(i=0),this.updateEnergy(-t*i-30*this.starving),this.thirsty&&this.updateLife(-t*this.thirsty*30)}this.starving=0,this.thirsty=0},setPronouns:function(){switch(this.gender){case"female":this.nominative="she",this.accusative="her",this.possessive="her",this.reflexive="herself";break;case"male":this.nominative="he",this.accusative="him",this.possessive="his",this.reflexive="himself";break;default:this.nominative="it",this.accusative="it",this.possessive="it",this.reflexive="itself"}},setBusy:function(e){e&&e.id!==U.data.actions.sleep.id&&(this.stats.idle=0),this.busy=e||!1,this.html.classList.toggle("busy",this.busy)},finishAction:function(){this.stats.actionsDone[this.busy.id]?++this.stats.actionsDone[this.busy.id]:this.stats.actionsDone[this.busy.id]=1,this.rollForPerk(this.busy),this.setBusy(null)},updateEnergy:function(e){return this.energy+=e,this.energy>100?this.energy=100:this.energy<0&&(this.updateLife(this.energy),this.energy=0),this.energyBar.set(this.energy),this.energy},isTired:function(){return this.energy<=0},updateLife:function(e){return this.life+=e,this.life>100?this.life=100:this.life<0&&this.die(),this.lifeBar.set(this.life),this.life},addAction:function(e){if(v(e))for(var t=0,n=e.length;t<n;++t)this.addAction(e[t]);else if(!this.actions.has(e.id)){var i=new _(this,e);this.perk&&b(this.perk.effect)&&(this.perk.actions&&!this.perk.actions().includes(e.id)||i.applyEffect(this.perk.effect)),this.actions.push(e.id,i),this.actionList.appendChild(i.html)}},lockAction:function(e){if(v(e))for(var t=0,n=e.length;t<n;++t)this.lockAction(e[t]);else this.actions.has(e)&&this.actions.pop(e).lock()},rollForPerk:function(e){var t=!1;if(!this.perk){var n=this,i=U.data.perks;i.deepBrowse(function(o){if(!x.usedPerks.includes(o.id)){var s=b(o.actions)&&o.actions();if((!s||s.includes(e.id))&&(!b(o.condition)||o.condition(e))){var r=0;(r=(r=s?s.reduce(function(e,t){return e+(n.stats.actionsDone[t]||0)},0)/(o.iteration||0):1/(o.iteration||0))<1?0:r)&&B()<i.dropRate*r&&(n.gainPerk(o),t=!0)}}})}return t},gainPerk:function(e){e.desc=F.personify(e.desc,{people:this}),this.perk=e,this.perkNode.textContent='the "'+f(e.name)+'"',new M(this.perkNode,e),H.notify(H.MSG_TYPES.GAIN_PERK,this),b(e.unlock)&&this.addAction(e.unlock()),b(e.lock)&&this.lockAction(e.lock()),x.usedPerks.push(e.id)},hasPerk:function(e){return this.perk&&this.perk.id===e},die:function(){this.html.classList.contains("arrived")&&(H.notify(H.MSG_TYPES.LOOSE_SOMEONE,this),this.html.classList.remove("arrived"),this.perk&&x.usedPerks.out(this.perk.id),this.actions.forEach(function(e){e.cancel(),e.tooltip.remove()}),V.timeout(function(){this.html.remove()}.bind(this),400))}}),x.randomName=function(e){return new Promise(function(t,n){var i="https://randomuser.me/api?inc=gender,name&nat="+["AU","BR","CA","CH","DE","DK","ES","FI","FR","GB","IE","NL","NZ","TR","US"].join(",")+"&noinfo&results="+(e||1);fetch(i).then(function(e){if(e.ok)return e.json().then(t);n(URIError("["+e.status+"] "+i+" "+e.statusText))})})},C.extends(a,"Resource",{_init:function(e){e&&this.update(+e);var t=g(this,this.data,["consume"]);this.tooltip=new M(this.html,t)},toHTML:function(){var e=this._toHTML();this.counter=c("counter","1"),e.appendChild(this.counter);var t=c("icon icon-"+this.data.icon);return e.appendChild(t),e.style.order=this.data.order,e},refresh:function(e){this.counter.textContent=o(this.count),e&&v(this.data.consume)&&this.tooltip.refresh(e,this.data.consume)},update:function(e){var t=this.count;if(this.set(this.count+e),o(t)!==o(this.count)){var n;e>0&&!this.html.classList.contains("more")?(this.html.classList.add("more"),n=function(){this.html.classList.remove("more")}.bind(this)):e<0&&!this.html.classList.contains("less")&&(this.html.classList.add("less"),n=function(){this.html.classList.remove("less")}.bind(this)),b(n)&&V.timeout(n,700)}},get:function(){return s(this.count)},set:function(e){if(this.count=e,this.count<0)throw new RangeError("Resources count can't be negative");return this.refresh()},has:function(e){return this.count>=e},toString:function(){var e=this.count+" "+d(this.data.name,this.count);return this.data.icon&&(e+=" "+C.iconAsString(this.data.icon)),e}}),C.iconAsString=function(e){return c("icon icon-small-"+e).outerHTML},C.LST_ID="resourceList",G.extends(a,"Bar",{toHTML:function(){var e=this._toHTML();return this.valueBar=c("value"),e.appendChild(this.valueBar),e},set:function(e){e!==this.value&&(this.value=e,this.valueBar.style.width=e+"%",this.valueBar.classList[e<this.threshold?"add":"remove"]("warning"))},run:function(e){e=+e||0,this.valueBar.style.animationDuration=e+"ms",this.html.classList.add("ongoing")}}),M.prototype={bodyWidth:document.body.offsetWidth,bodyHeight:document.body.offsetHeight,_setPosition:function(e,t){var n=r(e+10,0,this.bodyWidth-this.width),i=r(t+10,0,this.bodyHeight-this.height);this.box.style.left=n+"px",this.box.style.top=i+"px"},_mouseOver:function(){document.body.appendChild(this.box)},_mouseOut:function(){this.box.remove()},_mouseMove:function(e){this._setPosition(e.clientX,e.clientY)},_addEvents:function(){this.container.classList.add("tooltiped"),this.container.addEventListener("mouseover",this._mouseOver.bind(this)),this.container.addEventListener("mousemove",this._mouseMove.bind(this)),this.container.addEventListener("mouseout",this._mouseOut.bind(this))},_removeEvents:function(){this.container.classList.remove("tooltiped"),this.container.removeEventListener("mouseover",this._mouseOver),this.container.removeEventListener("mousemove",this._mouseMove),this.container.removeEventListener("mouseout",this._mouseOut)},toHTML:function(e){var t=c("tooltip"),n=c("title",f(e.name));if(t.appendChild(n),this.nodes.name=n,e.desc){var i=c("description",e.desc);t.appendChild(i),this.nodes.desc=i}if(e.time){var o=c("time",u(e.time));t.appendChild(o),this.nodes.time=o}if(v(e.consume)){var s=c("consumption");e.consume.forEach(function(e){var t=c("resource not-enough",e[0]+" "+e[1].name);this.resourcesMapper[e[1].id]=t,s.appendChild(t)}.bind(this)),t.appendChild(s)}return t},refresh:function(e,t){this.nodes.name=t.name,t.desc&&(this.nodes.desc.textContent=t.desc),t.time&&(this.nodes.time.textContent=u(t.time)),v(t.consume)&&t.consume.forEach(function(t){var n=t[1].id,i=e.has(n)&&e.get(n).has(t[0]);this.resourcesMapper[n].classList.toggle("not-enough",!i)}.bind(this))},remove:function(){this.box.remove()}}}("undefined"==typeof G?G={}:G);