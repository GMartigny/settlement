!function(){"use strict";function a(a,b){this.holder=a,this.assets=b,this.resources=new k,this.buildings=new k,this.events=new k,this.collects=[],this.people=[],this.initialActions=new k,this.knownLocations=new k,this.flags={ready:!1,paused:!1,settled:!1,survived:0,popup:!1,productivity:1},this.lastTick=performance.now(),this._init(),this.refresh()}function b(a,c){this.animationState=0,this.animationSteps=c.animationSteps||1,this.size={width:a.width/this.animationSteps,height:a.height},this.origin={x:a.x,y:a.y,width:a.width/this.animationSteps,height:a.height},this.destination={width:this.origin.width*b.ENLARGE,height:this.origin.height*b.ENLARGE},c.position?(c.position.x.includes("-")?this.destination.x=O.apply(null,(c.position.x+"").split("-")):this.destination.x=+c.position.x,c.position.y.includes("-")?this.destination.y=O.apply(null,(c.position.y+"").split("-")):this.destination.y=+c.position.y):(this.destination.x=50,this.destination.y=50)}function c(){if(c.instance)throw new ReferenceError("An instance already exists.");this.observers={}}function d(a,b){this.locked=!0,this.running=!1,this.owner=a,this.repeated=0,this.data={},this.location=!1,this.html=this.toHTML(b),this._init(b)}function e(a){this.number=0,this._init(a),this.add(1)}function f(a){this.data={},this.timer=null,this.html=this.toHTML(),this._init(a)}function g(a){return h.randomName(a).then(function(a){var b=[];return a.results.forEach(function(a){var c=u(a.name.first+""),d=new h(c,a.gender);b.push(d)}),b})}function h(a,b){this.name=a,this.gender=b||"other",this.setPronouns(),this.actions=new k,this.busy=!1,this.energy=100,this.starving=!1,this.life=100,this.thirsty=!1,this.stats={actionsDone:{},idle:0,age:0},this.perk=null,this.plan=null,this.project=null,this.html=this.toHTML()}function i(a,b){this.data={},this.html=this.toHTML(a),this._init(a),this.count=0,b&&this.update(+b),this.warnLack=!1}function j(a,b){var c=document.createElement("canvas");return c.width=a,c.height=b,{cnv:c,ctx:c.getContext("2d")}}function k(){this.items={},this.length=0}function l(a){return a<<0}function m(a){return l(a+.5)}function n(a,b,c){if(!B(b))throw new TypeError("Popup need a confirm function");var d=document.getElementById("main");c="popup"+(c?" "+c:"");var e=p(c);e.appendChild(p("title",u(a.name))),e.appendChild(p("description",a.desc));var f={remove:function(){e.remove(),d.classList.remove("backdrop")}},g=p("yes clickable",a.yes||"Ok");if(g.addEventListener("click",function(){b(),f.remove()}),e.appendChild(g),a.no){var h=p("no clickable",a.no);h.addEventListener("click",f.remove),e.appendChild(h)}return d.appendChild(e),d.classList.add("backdrop"),e.style.top=l((d.offsetHeight-e.offsetHeight)/2)+"px",f}function o(a,b){function c(a,b){var c=a+10;c+f>e&&(c=e-f),d.style.left=c+"px",d.style.top=b+10+"px"}var d=null,e=document.body.offsetWidth,f=305;a.classList.add("tooltiped"),a.addEventListener("mouseover",function(){document.body.appendChild(d)}),a.addEventListener("mouenter",function(){document.body.appendChild(d)}),a.addEventListener("mousemove",function(a){c(a.clientX,a.clientY)}),a.addEventListener("mouseout",function(){d.remove()});var g={},h={update:function(a){if(d=p("tooltip"),d.appendChild(p("title",u(a.name))),a.desc&&d.appendChild(p("description",a.desc)),a.time&&d.appendChild(p("time",q(a.time))),C(a.consume)){var b,c=p("consumption");a.consume.forEach(function(a){b=p("resource not-enough",a[0]+" "+a[1].name),g[a[1].id]=b,c.appendChild(b)}),d.appendChild(c)}return h},refresh:function(a,c){if(b.consume){var d;c.forEach(function(b){d=b[1].id,a.has(d)&&a.get(d).has(b[0])?g[d].classList.remove("not-enough"):g[d].classList.add("not-enough")})}return h},remove:function(){return d.remove(),h}};return h.update(b),h}function p(a,b){var c=document.createElement("div");return a&&c.classList.add.apply(c.classList,a.split(" ")),b&&(c.innerHTML=b),c}function q(a){var b=["year","month","day","hour","minute"],c=[],d=J.time;return b.forEach(function(b){if(a>=d[b]){var e=l(a/d[b]);a%=d[b],c.push(e+" "+t(b,e))}}),s(c)}function r(a){var b=[];return a.forEach(function(a){var c=t(a[1].name,a[0]);a[1].icon&&(c+=" "+p("icon icon-small-"+a[1].icon).outerHTML),b.push(a[0]+" "+c)}),s(b)}function s(a,b){return b=b||"and",a.length>1?(a[a.length-2]+=" "+b+" "+a.pop(),a.join(", ")):a.length?a[0]:""}function t(a,b){return a+(b>1&&"s"!==a[a.length-1]?"s":"")}function u(a){return a?(a=a.replace(/([\.!\?]) ([a-z])/g,function(a,b,c){return b+" "+c.toUpperCase()}),a[0].toUpperCase()+a.slice(1)):""}function v(a,b){if(!a.values().length)throw new TypeError("Can't pick from empty list");var c={},d=[],e=0;y(a,function(a){a.dropRate&&(e+=a.dropRate,d.push(e),c[e]=a)});var f=m(O(e));d.sort();for(var g=0,h=d.length;g<h;++g)if(d[g]>f){f=d[g];break}return b?(D(b)&&(b=b.split("-")),[m(O.apply(null,b)),c[f]]):c[f]}function w(a,b){if(!b)throw new TypeError("Need an amount");var c=[];D(b)&&(b=b.split("-"));for(var d=m(O.apply(null,b)),e=0;e+1<=d;){var f=m(O(1,d-e));c.push([f,v(a)]),e+=f}return c}function x(a){}function y(a,b){for(var c in a)a.hasOwnProperty(c)&&(a[c].name?b(a[c],a):y(a[c],b));return a}function z(a){return Object.assign({},a)}function A(a,b,c){c=c||Object.keys(b);var d=z(b);return c.forEach(function(b){d[b]&&B(d[b])&&(d[b]=d[b](a))}),d}function B(a){return a instanceof Function}function C(a){return Array.isArray(a)}function D(a){return"string"==typeof a}function E(a){return void 0===a}function F(a){return a.toLowerCase().replace(/(\W)+/g,"_")}function G(a){var b="aeiou".split("");return(b.includes(a[0])?"an":"a")+" "+a}function H(a){return a.reduce(function(a,b){var c=a.find(function(a){return a[1].id===b[1].id});return c?c[0]+=b[0]:b[0]>0&&a.push(b),a},[])}function I(a,b){var c={},d=0,e=a.length;return Promise.all(a.map(function(a){var f,g=fetch(a).then(function(b){if(b.ok)return b;throw URIError("["+b.status+"] "+a+" "+b.statusText)});switch(a.substr(a.lastIndexOf(".")+1)){case"png":case"jpg":case"gif":f=g.then(function(a){var b=new Image;return a.blob().then(function(a){return b.src=URL.createObjectURL(a),b})});break;case"json":f=g.then(function(a){return a.json()});break;default:f=Promise.resolve()}return f.then(function(f){c[F(a)]=f,b(++d/e*100,a)})})).then(function(){return c})}!function(){console.groupCollapsed("Loading");var b="dist/img/assets.png",c="dist/js/assets.json";I(["dist/img/icons.png",b,c],function(a,b){console.log(b+" : "+a.toFixed(2)+"%")}).then(function(d){console.groupEnd();try{new a(document.getElementById("main"),{images:d[F(b)],data:d[F(c)]})}catch(a){console.warn("Fail to load game : "+a.message,a.stack)}}).catch(function(a){console.warn(a.message)})}(),a.tickLength=2e3,a.prototype={_init:function(){console.log("Starting v0.1.7"),console.log("Stated in "+m(performance.now())+"ms");var a=this;y(J.data,function(b){b.id=P();for(var c in b)b.hasOwnProperty(c)&&B(b[c])&&(b[c]=b[c].bind(a))}),this.initialActions.push(J.data.actions.wakeUp),L.attach(L.KEYS.SPACE,this.togglePause.bind(this)),this.resourcesList=p(),this.resourcesList.id=i.LST_ID,this.holder.appendChild(this.resourcesList),this.peopleList=p(),this.peopleList.id=h.LST_ID,this.holder.appendChild(this.peopleList),this.visualPane=p(),this.visualPane.id="visualPane",this.holder.appendChild(this.visualPane),this.eventsList=p(),this.eventsList.id=f.LST_ID,this.holder.appendChild(this.eventsList),this.logsList=p(),this.logsList.id="logs",this.holder.appendChild(this.logsList),K.start(this.visualPane,this.assets.images,this.assets.data),M.start(this.logsList),N.start(),N.timeout(this.welcome.bind(this,1,!0),500);var b=c.getInstance();b.observe(c.MSG_TYPES.GIVE,function(b){C(b)&&b.forEach(function(b){a.earn.apply(a,b)})}),b.observe(c.MSG_TYPES.COLLECT,function(b){C(b)&&H(a.collects.concat(b))}),b.observe(c.MSG_TYPES.USE,function(b){C(b)&&H(b).forEach(function(b){a.consume.apply(a,b)})}),b.observe(c.MSG_TYPES.BUILD,function(b){b&&a.build(b)}),b.observe(c.MSG_TYPES.LOOSE_SOMEONE,function(b){a.people.out(b),a.people.length<=0&&(c.getInstance().notify(c.MSG_TYPES.LOOSE,a.getSurvivalDuration()),a.flags.paused=!0)}),b.observe(c.MSG_TYPES.EVENT_START,function(b){a.events.push(b.data.id,b)}),b.observe(c.MSG_TYPES.EVENT_END,function(b){a.events.pop(b.data.id)}),b.observe(c.MSG_TYPES.LOCK,function(b){a.removeFromInitialActions(b)}),b.observe(c.MSG_TYPES.UNLOCK,function(b){a.addToInitialActions(b)}),b.observe(c.MSG_TYPES.WIN,function(){this.flags.paused=!0}),n({name:"Early access",desc:"You'll see a very early stage of the game. It may be broken, it may not be balanced ...<br/>If you want to report a bug or anything to improve the game, go to <a href='https://github.com/GMartigny/settlement'>the project's page</a>.<br/><br/>Thanks for playing !"},function(){this.flags.ready=!0}.bind(this))},addToInitialActions:function(a){C(a)||(a=[a]),a.forEach(function(a){this.initialActions.push(a)}.bind(this)),this.people.forEach(function(b){b.addAction(a)})},removeFromInitialActions:function(a){C(a)||(a=[a]),a.forEach(function(a){this.initialActions.pop(a.id)}.bind(this)),this.people.forEach(function(b){b.lockAction(a)})},getSettledTime:function(){return this.flags.settled?this.flags.survived/a.tickLength:0},getSurvivalDuration:function(){return q(this.getSettledTime())},togglePause:function(){this.flags.paused=!this.flags.paused,this.holder.classList.toggle("paused",this.flags.paused),this.flags.paused?N.stopAll():N.restartAll()},refresh:function(){var b=performance.now(),c=l((b-this.lastTick)/a.tickLength);if(this.lastTick+=c*a.tickLength,this.flags.paused&&(c=0),setTimeout(this.refresh.bind(this),a.tickLength/3),c>0){if(this.flags.settled&&(this.flags.survived+=c*a.tickLength,J.data.people.need().forEach(function(a){var b=J.data.resources.gatherable.common.water.id,c=a[1].id===b?"thirsty":"starving";this.consume(a[0]*this.people.length,a[1],function(a){this.people.forEach(function(b,d,e){b[c]=a/e.length})})}.bind(this)),this.canSomeoneArrive()&&this.welcome(),!this.flags.popup&&O()<J.data.events.dropRate)){var d=this.getRandomEvent();if(d){var e=new f(d);this.flags.popup=e.start(function(a){a.data.time&&this.eventsList.appendChild(a.html),this.flags.popup=!1}.bind(this))}}this.resources.forEach(function(a,b,c){a.refresh(c)}),this.people.forEach(function(a){a.refresh(this.resources,c,this.flags)}.bind(this))}},hasEnough:function(a,b){return this.resources.get(a).has(b)},consume:function(a,b,d){if(a){var e=this.resources.get(b.id);if(e&&e.has(a))e.update(-a),e.warnLack=!1;else if(B(d)){var f=a-e.get();e.set(0),d.call(this,f,b),e.warnLack||(e.warnLack=!0,c.getInstance().notify(c.MSG_TYPES.RUNS_OUT,b.name))}}},earn:function(a,b){var c=b.id;if(this.resources.has(c))this.resources.get(c).update(a);else{var d=new i(b,a);this.resources.push(c,d),this.resourcesList.appendChild(d.html)}},welcome:function(a,b){g(a).then(function(a){a.forEach(function(a){a.addAction(this.initialActions.values()),this.people.push(a),this.peopleList.appendChild(a.html),b?(a.life=0,a.energy=0,a.updateLife(0),a.updateEnergy(0)):(a.html.offsetHeight,c.getInstance().notify(c.MSG_TYPES.ARRIVAL,a.name),2===this.people.length&&N.timeout(function(){c.getInstance().notify(c.MSG_TYPES.LOGS.FLAVOR,a.name+" say that there's other desert-walkers ready to join you if there's room for them.")}.bind(this),2e3)),a.html.classList.add("arrived")}.bind(this))}.bind(this))},build:function(a){var b=a.id;if(this.buildings.has(b))this.buildings.get(b).add(1);else{var c=new e(a);this.buildings.push(b,c),B(a.lock)&&this.removeFromInitialActions(a.lock(c)),B(a.unlock)&&this.addToInitialActions(a.unlock(c))}},unlockedCraftables:function(){var a=[];return y(J.data.resources.craftable,function(b){(!b.condition||B(b.condition)&&b.condition())&&a.push(b)}),a},possibleCraftables:function(){var a=this.resources.items;return this.unlockedCraftables().filter(function(b){var c=!0;return B(b.consume)&&b.consume(b).forEach(function(b){c=c&&a[b[1].id]&&a[b[1].id].has(b[0])}),c})},possibleBuildings:function(){var a=[],b=this.buildings;return y(J.data.buildings,function(c){(!c.unique||c.unique&&!b.has(c.id))&&(B(c.condition)&&!c.condition()||a.push(c))}),a},canSomeoneArrive:function(){return this.hasEnough(J.data.resources.room.id,this.people.length+1)&&O()<J.data.people.dropRate&&this.getSettledTime()/J.time.day>5},getRandomEvent:function(){var a=[],b=this.getSettledTime()/J.time.week;return b>1&&(a.push.apply(a,J.data.events.easy.values()),b>2&&(a.push.apply(a,J.data.events.medium.values()),b>5&&a.push.apply(a,J.data.events.hard.values()))),a=a.filter(function(a){return!this.events.has(a.id)&&(!a.condition||B(a.condition)&&a.condition(a))}.bind(this)),!!a.length&&v(a)}};var J=function(){var a={minute:1/60,hour:1,day:24,week:168,month:720,year:8640},b=["north","south","east","west","north-east","north-west","south-east","south-west"],d={resources:{gatherable:{common:{water:{name:"water",desc:"Water is definitely important to survive in this harsh environment.",icon:"water-bottle",dropRate:140,order:10},food:{name:"food",desc:"Everyone need food to keep his strength.",icon:"foodcan",dropRate:140,order:20},rock:{name:"rock",desc:'"There\'s rocks everywhere ! Why would you bring this back ?"',icon:"rock",dropRate:100,order:30},scrap:{name:"scrap metal",desc:"An old rusty piece of metal.",icon:"metal-scraps",dropRate:100,order:40}},uncommon:{plastic:{name:"nuts and bolts",desc:"Little metal nuts and bolts to fasten anything in place.",icon:"nuts-and-bolts",dropRate:70,order:50},sand:{name:"sand",desc:"Just pure fine sand.",icon:"sand-pile",dropRate:30,order:55},oil:{name:"fuel",desc:"About a liter of gas-oil.",icon:"jerrycan",dropRate:20,order:60}},rare:{medication:{name:"medication",desc:"An unlabeled medication, hope it's still good.",icon:"medications",dropRate:5,order:70},electronic:{name:"electronics",desc:"Some basic micro-electronics components.",icon:"electronic-parts",dropRate:10,order:75}},special:{ruins:{name:"location",desc:"Directions to a point of interest we found earlier.",icon:"map",order:80,dropRate:.6},quartz:{name:"quartz cristal",desc:"A rough uncut gem of quartz. Quite valuable.",icon:"gem",dropRate:.1,order:77}}},craftable:{basic:{stone:{name:"smooth stone",desc:"A round and well polish stone.",icon:"stone",consume:function(){return[[3,d.resources.gatherable.common.rock]]},dropRate:100,order:90},glass:{name:"glass pane",desc:"A see-through building component.",icon:"glass-pane",condition:function(){return this.buildings.has(d.buildings.small.furnace.id)},consume:function(){return[[4,d.resources.gatherable.uncommon.sand]]},dropRate:60,order:100},component:{name:"component",desc:"Some mechanical parts for others craftables.",icon:"pipes-large",consume:function(){return[[2,d.resources.gatherable.common.scrap],[2,d.resources.gatherable.uncommon.plastic]]},dropRate:120,order:110},tool:{name:"tool",desc:"The base for any tinkerer.",icon:"tools",consume:function(){return[[1,d.resources.craftable.basic.component],[2,d.resources.gatherable.common.rock]]},dropRate:90,order:111}},complex:{brick:{name:"brick",desc:"Bricks will give walls for larger constructions.",icon:"brick",condition:function(){return this.buildings.has(d.buildings.small.well.id)},consume:function(){return[[1,d.resources.craftable.basic.stone],[1,d.resources.craftable.basic.tool]]},dropRate:80,order:112},circuit:{name:"circuit",desc:"That's a little rough, but it's actually a functioning circuit board.",icon:"electronic-circuit-board",consume:function(){return[[1,d.resources.gatherable.common.scrap],[2,d.resources.craftable.basic.component],[3,d.resources.gatherable.rare.electronic]]},dropRate:60,order:114},metalPipe:{name:"metal pipe",desc:"Pipes that you forge from junk metal.",icon:"pipes-small",condition:function(){return this.buildings.has(d.buildings.medium.forge.id)},consume:function(){return[[4,d.resources.gatherable.common.scrap],[1,d.resources.craftable.basic.tool]]},dropRate:80,order:115},furniture:{name:"furniture",desc:"A proper settlement needs better than pile of trash for table and seats.",icon:"glass-table",consume:function(){return[[2,d.resources.craftable.basic.glass],[2,d.resources.craftable.complex.metalPipe]]},dropRate:40,order:116},jewelry:{name:"jewelry",desc:"A really beautiful ornament you could use for trading.",icon:"jewelry",condition:function(){return this.buildings.has(d.buildings.small.furnace.id)},consume:function(){return[[4,d.resources.gatherable.rare.electronic],[3,d.resources.gatherable.special.quartz]]},dropRate:40,order:117}},advanced:{engine:{name:"engine",desc:"Amazing what you manage to do with all those scraps !",icon:"engine",condition:function(){return this.buildings.has(d.buildings.big.workshop.id)},consume:function(){return[[10,d.resources.gatherable.uncommon.oil],[5,d.resources.craftable.basic.tool],[5,d.resources.craftable.complex.metalPipe]]},dropRate:30,order:120},computer:{name:"computer",desc:"Well, Internet is down since 2136 but it can still be useful.",icon:"computer",condition:function(){return this.buildings.has(d.buildings.big.workshop.id)},consume:function(){return[[10,d.resources.craftable.basic.component],[7,d.resources.craftable.basic.tool],[3,d.resources.craftable.complex.circuit]]},dropRate:20,order:130}}},room:{name:"room",desc:"A place for someone in the camp.",icon:"person",order:0}},people:{name:"people",desc:"The workforce and the bane of you camp.",need:function(){return[[1/a.day,d.resources.gatherable.common.food],[1/a.day,d.resources.gatherable.common.water]]},dropRate:.005},buildings:{small:{tent:{name:"tent",desc:"Allow someone to rejoin the colony.",time:4,consume:function(){return[[7,d.resources.gatherable.common.scrap],[5,d.resources.gatherable.common.rock]]},give:function(){return[[1,d.resources.room]]},log:"That's small and ugly, but give @give for someone to sleep safely.",dropRate:100},furnace:{name:"furnace",desc:"Survival require to make as much as gathering things.",time:7,consume:function(){return[[8,d.resources.gatherable.common.rock],[3,d.resources.gatherable.uncommon.oil]]},log:"A small furnace can smelt small things like sand or little electronic.",unique:!0,dropRate:90},plot:{name:"farm plot",desc:"A little arranged plot of soil to grow some food.",time:12,consume:function(){return[[5,d.resources.gatherable.common.food],[10,d.resources.gatherable.uncommon.sand]]},unlock:function(){return[d.actions.harvest]},log:"More crops required more care but that's going to help us keeping a constant stock of food.",dropRate:80},pharmacy:{name:"pharmacy",desc:'"Maybe we should avoid letting medications rot in plain sunlight ?!"',time:6,consume:function(){return[[5,d.resources.gatherable.rare.medication],[4,d.resources.craftable.basic.component]]},log:"Sorting our medications should prevent further mistakes and bad reaction.",unique:!0,dropRate:70},well:{name:"well",desc:"Just a large hole into the ground.",time:16,energy:80,condition:function(){return!this.buildings.has(d.buildings.big.pump.id)},consume:function(){return[[10,d.resources.craftable.basic.stone],[3,d.resources.craftable.basic.tool]]},give:function(){return[[5,d.resources.gatherable.common.water]]},unlock:function(){return[d.actions.drawFrom.well]},lock:function(){return[d.actions.drawFrom.river]},log:"Drawing water from the ground should allow to further polish stone into bricks.",unique:!0,dropRate:80}},medium:{forge:{name:"forge",desc:"A good upgrade to the furnace.",time:10,condition:function(){this.buildings.has(d.buildings.small.furnace.id)},consume:function(){return[[5,d.resources.gatherable.uncommon.oil],[10,d.resources.craftable.basic.stone],[2,d.resources.craftable.basic.tool]]},unlock:function(){return c.getInstance().notify(c.MSG_TYPES.UNBUILD,d.buildings.small.well.furnace),[]},log:"We can now work metal better and make more complex part.",unique:!0,dropRate:60},house:{name:"house",desc:"Turn a tent into what looks like a house.",time:13,condition:function(){this.buildings.has(d.buildings.small.tent.id)},consume:function(){return[[7,d.resources.gatherable.common.rock],[1,d.resources.craftable.complex.furniture]]},give:function(){return c.getInstance().notify(c.MSG_TYPES.UNBUILD,d.buildings.small.tent),[m(O(2,3)),d.resources.room]},log:"Better than a simple tent, it provide @give.",dropRate:50}},big:{barrack:{name:"barrack",desc:"Some place to sleep for a few people.",time:2*a.day,energy:110,condition:function(){return this.buildings.has(d.buildings.medium.house.id)&&!1},consume:function(){return[[5,d.resources.gatherable.uncommon.sand],[8,d.resources.craftable.complex.brick],[1,d.resources.craftable.complex.furniture]]},give:function(){return[m(O(3,4)),d.resources.room]},log:"That's a lots of space to welcome wanderers.",dropRate:0},workshop:{name:"workshop",desc:"Organizing your workforce make them more efficient at crafting.",time:3*a.day,energy:90,unique:!0,condition:function(){return this.buildings.has(d.buildings.small.furnace.id)},consume:function(){return[[6,d.resources.gatherable.common.scrap],[5,d.resources.craftable.basic.glass],[10,d.resources.craftable.basic.tool],[15,d.resources.craftable.complex.brick]]},give:function(){return[]},unlock:function(){return[d.actions.project]},log:"Good organisation allow you to prepare project and do much more complex crafting.",dropRate:30},radio:{name:"radio-station",desc:"Broadcasting could finally bring us some help.",time:6,energy:60,unique:!0,condition:function(){return this.buildings.has(d.buildings.big.workshop.id)},consume:function(){return[[4,d.resources.craftable.complex.circuit],[1,d.resources.craftable.advanced.computer]]},log:'"Message received. We thought no one survive the crash. Glad you still have the cube.Unfortunately we can\'t risk being located, bring it to sent position. Over."',dropRate:20},pump:{name:"water pump",desc:"A buried contraption that collect water from the earth moisture.",time:3*a.day,energy:120,unique:!0,condition:function(){return this.buildings.has(d.buildings.small.well.id)},consume:function(){return[[20,d.resources.craftable.basic.stone],[5,d.resources.craftable.complex.metalPipe],[1,d.resources.craftable.advanced.engine]]},unlock:function(){return c.getInstance().notify(c.MSG_TYPES.UNBUILD,d.buildings.small.well.id),[d.actions.drawFrom.well]},collect:function(){return[[2/a.day,d.resources.gatherable.common.water]]},log:"A big upgrade to your well ! Now we have a continuous flow of water coming.",dropRate:10},trading:{name:"trading post",desc:"Since the radio station bring a handful of merchant, better take advantage of it.",time:a.day,energy:70,unique:!0,condition:function(){return this.buildings.has(d.buildings.big.radio.id)&&this.resources.has(d.resources.craftable.complex.jewelry)},consume:function(){return[[2,d.resources.craftable.basic.glass],[10,d.resources.craftable.complex.brick],[2,d.resources.craftable.complex.furniture]]},unlock:function(){return[d.actions.exchange]},log:"Arranging some space allow us to trade with merchant caravan passing by.",dropRate:10},module:{name:"module",desc:"With that, we can finally deliver the cube to security.",time:a.week,energy:100,unique:!0,condition:function(){return this.buildings.has(d.buildings.big.radio.id)},consume:function(){return[[15,d.resources.gatherable.uncommon.oil],[3,d.resources.craftable.complex.furniture],[1,d.resources.craftable.advanced.computer],[2,d.resources.craftable.advanced.engine]]},unlock:function(){return[d.actions.launch]},log:"What a journey, but there we are. We build so many things and explore lots of places.<br/>Now we end this all !",dropRate:5}},special:{forum:{name:"forum",desc:"The center and start of our settlement.",unlock:function(){return[d.actions.sleep]},give:function(){return[[2,d.resources.room]]},unique:!0}}},actions:{wakeUp:{name:"wake up",energy:0,unlock:function(a){return a.owner.updateEnergy(100),a.owner.updateLife(100),[d.actions.look]},log:"@people.name gets up painfully.",order:0,unique:!0},look:{name:"look around",desc:"What am I doing here ?",time:2,energy:0,give:function(){return N.timeout(function(){c.getInstance().notify(c.MSG_TYPES.LOGS.FLAVOR,"We need a shelter.")},1e3),[,[10,d.resources.gatherable.common.water],[8,d.resources.gatherable.common.food],[2,d.resources.craftable.basic.component]]},unlock:function(){return[d.actions.settle]},log:"After some thinking, @people.name remembers the attack. @people.nominative grabs @give laying around.",order:0,unique:!0},settle:{name:"settle here",desc:"Ok, let's settle right there !",time:3,energy:0,unlock:function(){return this.flags.settled=!0,[d.actions.gather]},build:function(){return d.buildings.special.forum},log:"@people.name installs @build inside a ship-wreck with @give to sleep in.",order:0,unique:!0},gather:{name:"gather resources",desc:"Go out to bring back resources, that's the best you can do.",time:3,isOut:1,unlock:function(){return[d.actions.roam]},giveSpan:[3,6],give:function(a){return w(d.resources.gatherable,a.data.giveSpan)},log:"@people.name comes back with @give.",order:0},roam:{name:"roam",desc:"Explore the surroundings hoping to find something interesting.",time:7,isOut:1,consume:function(){return[[2,d.resources.gatherable.common.water]]},condition:function(a){return!a.owner.actions.has(d.actions.scour.id)},unlock:function(a){var b=[d.actions.explore,d.actions.craft];return a.repeated>10&&b.push(d.actions.scour),b},lock:function(a){return a.repeated>10?[a.data]:[]},giveSpan:[1,3],give:function(a,b){var c=w(d.resources.gatherable,a.data.giveSpan);if(O()<d.resources.gatherable.special.ruins.dropRate){c.push([1,d.resources.gatherable.special.ruins]);var e=v(d.locations.near);this.knownLocations.push(e),b.location=G(e.name)}return c},log:function(a){var c;return c=a.location?"Heading @direction, @people.name spots @location, so @people.nominative brings back @give.":"Despite nothing special found towards @direction, @people.name brings back @give.",a.direction=b.random(),c},order:10},scour:{name:"scour",desc:"Knowledge of the area allows for better findings.",time:6,isOut:1,consume:function(){return[[2,d.resources.gatherable.common.water]]},giveSpan:[2,4],give:function(a,b){var c=v(d.resources.gatherable,a.data.giveSpan),e=d.resources.gatherable.special.ruins.dropRate,f=a.owner.perk&&a.owner.perk.id===d.perks.explorer,g=f?1:.5;if(O()<e+(1-e)*g){c.push([1,d.resources.gatherable.special.ruins]);var h=v(f?d.locations.epic:d.locations.far);this.knownLocations.push(h),b.location=G(h.name)}return c},log:function(a){var b;return b=a.location?"@people.name knew @people.nominative could find @location towards @direction, so @people.nominative comes back with @give.":"No special location towards @direction, but @people.name find @give."},order:10},explore:{name:"explore a ruin",desc:"Remember that location we saw the other day ? Let's see what we can find there.",time:2*a.day,energy:110,isOut:1,consume:function(){return[[4,d.resources.gatherable.common.water],[1,d.resources.gatherable.common.food],[1,d.resources.gatherable.special.ruins]]},giveSpan:[5,9],give:function(a){var b=this.knownLocations.random();return a.location=b,w(b.give(),a.data.giveSpan)},log:function(a,b){var c=b.location.log||"";return B(c)?c(a,b):c},order:20},craft:{name:"craft something",desc:"Use some resources to tinker something useful.",time:function(){return this.buildings.has(d.buildings.big.workshop.id)?4:5},unlock:function(){return[d.actions.plan]},give:function(){var a=this.possibleCraftables();if(a.length){var b=v(a);return B(b.consume)&&c.getInstance().notify(c.MSG_TYPES.USE,b.consume(this)),[[1,b]]}return[]},log:function(a){return a.give?"@people.name succeeds to craft @give.":(a.logType=c.MSG_TYPES.LOGS.WARN,"Nothing could be made with what you have right now.")},order:30},plan:{name:"plan a building",desc:"Prepare blueprint and space for a new building.",time:8,energy:20,consume:function(){return[[1,d.resources.gatherable.common.water],[1,d.resources.gatherable.common.food],[1,d.resources.craftable.basic.tool]]},give:function(a,b){var c=v(this.possibleBuildings());return b.plan=G(c.name),a.owner.planBuilding(c),[]},unlock:function(){return[d.actions.build]},log:"Everything's ready to build @plan.",order:40},build:{name:function(a){return"build "+G(a.owner.plan.name)},desc:function(a){return a.owner.plan.desc},time:function(a){return a.owner.plan.time},energy:function(a){return a.owner.plan.energy},consume:function(a){var b=[[2,d.resources.gatherable.common.water],[1,d.resources.gatherable.common.food]];return B(a.owner.plan.consume)&&b.push.apply(b,a.owner.plan.consume(a)),H(b)},lock:function(a){var b=[a.data];return B(a.owner.plan.lock)&&b.push.apply(b,a.owner.plan.lock(a)),b},unlock:function(a){var b=[];return B(a.owner.plan.unlock)&&b.push.apply(b,a.owner.plan.unlock(a)),b},build:function(a){return a.owner.plan},log:function(a,b){var c=b.owner.plan.log;return B(c)?c(a,b):c},order:50},drawFrom:{river:{name:"draw water",desc:"Get some water from the river.",time:8,energy:50,isOut:1,condition:function(a){return!a.owner.actions.has(d.actions.drawFrom.well.id)},giveSpan:[2,6],give:function(a){return[[m(O.apply(null,a.data.giveSpan)),d.resources.gatherable.common.water]]},log:"Coming back from the river, @people.name bringsÂ @give with @people.accusative.",order:60},well:{name:"draw water",desc:"Get some water from our well.",time:2,energy:15,giveSpan:[1,3],give:function(a){var b=0;return this.buildings.has(d.buildings.small.well.id)?b=O.apply(null,a.data.giveSpan):this.buildings.has(d.buildings.big.pump.id)&&(b=O.apply(null,a.data.giveSpan)+4),[[m(b),d.resources.gatherable.common.water]]},log:"Using our well, @people.name get @give.",order:60}},harvest:{name:"harvest crops",desc:"It's not the biggest vegetables, but it'll fill our stomachs.",time:function(){var a=0;return this.buildings.has(d.buildings.small.plot.id)&&(a=this.buildings.get(d.buildings.small.plot.id).number),4+a},consume:function(){return[[1,d.resources.gatherable.common.water]]},giveSpan:[1.5,2],give:function(a){var b=this.buildings.get(d.buildings.small.plot.id).number,c=m(O.apply(null,a.data.giveSpan)*b);return[[c,d.resources.gatherable.common.food]]},log:"Our crops produce @give.",order:70},sleep:{name:"sleep",desc:"Get some rest to restore energy.",time:9,energy:0,give:function(a){return a.owner.updateEnergy(100),[]},unlock:function(){return[d.actions.heal]},log:"@people.name feels well rested now.",order:5},heal:{name:"heal",desc:'"I really hope those pills are still good."',time:2,energy:1,consume:function(){return[[2,d.resources.gatherable.rare.medication]]},give:function(a,b){var c=99;return!this.buildings.has(d.buildings.small.pharmacy.id)&&O()<.4&&(c=-15,b.wasBad=!0),a.owner.updateLife(c),[]},log:function(a){return a.wasBad?"After feeling not so well, @people.name realise taking these pillstook a hit on his health.":"This time, it actually improve @people's health."},order:6},project:{name:"project",desc:"Prepare in order to craft an object.",time:2,energy:20,give:function(a){return a.owner.prepareProject(v(this.unlockedCraftables())),[]},unlock:function(){return[d.actions.make]},log:"Looking at the resources, @people.name could make @project."},make:{name:function(a){return"make "+G(a.owner.project.name)},desc:"Now that all is ready, craft what we need.",time:function(){var a=d.actions.craft.time;return B(a)?a():a},consume:function(a){var b=[];return B(a.owner.project.consume)&&b.push.apply(b,a.owner.project.consume(a)),b},lock:function(a){var b=[a.data];return B(a.owner.project.lock)&&b.push.apply(b,a.owner.project.lock(a)),b},unlock:function(a){var b=[];return B(a.owner.project.unlock)&&b.push.apply(b,a.owner.project.unlock(a)),b},log:"@people.name successfully made @give."},exchange:{name:"exchange",desc:"Caravan passing by carry lots of useful stuff, let's see what's possible to trade.",time:7,energy:20,consume:function(){return[[2,d.resources.craftable.complex.jewelry]]},giveSpan:[2,3],give:function(a){var b=Object.assign({},d.resources.craftable.basic,d.resources.craftable.complex);return delete b.jewelry,w(b,a.data.giveSpan)},log:"@people.name manage to trade a couple of jewelries for @give."
},launch:{name:"launch",desc:"",time:12,energy:30,isOut:1,consume:function(){return[[10,d.resources.gatherable.uncommon.oil]]},give:function(){return c.getInstance().notify(c.MSG_TYPES.WIN),[]},log:function(){return"After "+this.getSurvivalDuration()+", you finally leave this damn crash-site.<br/>You have to leave everyone behind. You make a promise to yourself to come back as soon as you can."}}},locations:{near:{mountain:{name:"mountain",give:function(){return[d.resources.gatherable.common.rock,d.resources.gatherable.common.scrap,d.resources.craftable.basic.component]},log:"That was hard to climb those mountains, but at least @people find @give.",dropRate:90},desert:{name:"desert",give:function(){return[d.resources.gatherable.common.scrap,d.resources.gatherable.uncommon.oil,d.resources.gatherable.uncommon.sand]},log:"Dunes everywhere give a felling of hopelessness. Anyway, here's @give for the stock.",dropRate:100},supermarket:{name:"hangar",give:function(){return[d.resources.gatherable.common.food,d.resources.gatherable.rare.medication,d.resources.craftable.basic.glass]},log:"Quite easy to loot, but full of dangers too. Hopefully, @people.name return safely and got @give.",dropRate:80}},far:{river:{name:"river",unlock:function(){return[d.actions.drawFrom.river]},give:function(){return[d.resources.gatherable.common.water,d.resources.gatherable.uncommon.plastic,d.resources.craftable.basic.stone]},log:"It's nice by the river, @people.name found @give.",dropRate:40},ruin:{name:"old ruin",give:function(){return[d.resources.gatherable.rare.electronic,d.resources.craftable.basic.component,d.resources.craftable.basic.tool]},log:"Amazing noone get lost in those caves to get @give.",dropRate:60}},epic:{building:{name:"abandoned building",give:function(){return[d.resources.gatherable.rare.medication,d.resources.craftable.basic.glass,d.resources.craftable.complex.circuit]},log:"Noone could guess what that building was, but it sure was interesting. @people.name find @give.",dropRate:30},spaceship:{name:"spaceship wreck",give:function(){return[d.resources.gatherable.rare.electronic,d.resources.craftable.basic.tool,d.resources.craftable.complex.furniture]},log:"What a chance to find a wreckage with not melted stuff inside. It was possible to get @give.",dropRate:20}}},events:{dropRate:.01,easy:{sandstorm:{name:"sandstorm",desc:"The wind is blowing hard, impossible to go out for now.",time:20,deltaTime:4,effect:function(a){this.flags.cantGoOut=a},dropRate:100,log:"A sandstorm has started and prevent anyone from leaving the camp."}},medium:{},hard:{drought:{name:"drought",desc:"The climate is so hot, we consume more water.",time:3*a.day,timeDelta:10,effect:function(a){this.flags.drought=a},dropRate:6,log:"A harsh drought has fall, water will be more important than ever."}}},perks:{dropRate:.1,first:{name:"first-one",desc:"The very first one to install the settlement.",actions:function(){return[d.actions.settle.id]},iteration:0},rookie:{name:"rookie",desc:"All group has a rookie, all @people.nominative want is to prove @people.nominative's efficient.",condition:function(){return this.people.length>2},effect:function(a){a.time=.95*(B(a.time)?a.time():a.time)}},explorer:{name:"gadabout",desc:"The veteran of the camp and leader of the exploration. @people.nominative knows the best spot of resources.",actions:function(){return[d.actions.roam.id,d.actions.scour.id,d.actions.explore.id]},iteration:30,effect:function(a){a.id===d.actions.explore.id&&(a.giveSpan+=2)}},tinkerer:{name:"tinkerer",desc:"",actions:function(){return[d.actions.craft.id,d.actions.build.id,d.actions.make.id]},iteration:50,effect:function(a){a.time=.6*(B(a.time)?a.time():a.time)}},healer:{name:"doctor",desc:"Knowing enough about medecine make @people.accusative confident to heal others.",actions:function(){return[d.actions.heal.id]},condition:function(){return this.buildings.has(d.buildings.small.pharmacy.id)},iteration:5,effect:function(a){var b=this.people;a.give=function(){var a=null;return b.forEach(function(b){(!a||b.life<a.life)&&(a=b)}),a.updateLife(99),[]}}},harvester:{name:"harvester",desc:"",actions:function(){return[d.actions.gather.id,d.actions.harvest.id,d.actions.drawFrom.river.id,d.actions.drawFrom.well.id]},iteration:70,effect:function(a){var b=1.5;a.giveSpan=a.giveSpan.map(function(a){return a*b})}},lounger:{name:"lounger",desc:"Doing nothing all day's not gonna make things done.",actions:function(){return[d.actions.sleep]},condition:function(b){return b.stats.idle/(3*a.day)},effect:function(a){a.time=1.2*(B(a.time)?a.time():a.time)}},merchant:{name:"merchant",desc:"The ancient art of trading have been one of the most important skill you could have.",action:function(){return[d.actions.exchange]},iteration:10,effect:function(a){a.consume=function(){return[[1,d.resources.craftable.complex.jewelry]]}}}}};return{time:a,data:d}}(),K=function(){var a,d,e,f,g,h=[];return{start:function(i,l,m){a=l,d=m;var n=j(Math.min(i.offsetWidth,800),Math.min(i.offsetHeight,200));e=n.ctx,e.imageSmoothingEnabled=0,n.cnv.classList.add("layer"),i.appendChild(n.cnv),n=j(i.offsetWidth,i.offsetHeight),f=n.ctx,n.cnv.classList.add("layer"),i.appendChild(n.cnv);var o=c.getInstance();o.observe(c.MSG_TYPES.BUILD,function(a){a.asset&&(h.push(new b(d[a.asset.image],a.asset)),h.sort(function(a,b){return a.compare(b)}))}.bind(this)),g=new k,o.observe(c.MSG_TYPES.EVENT_START,function(a){a.asset&&g.push(a.id,new b(d[a.asset.image],a.asset))}),o.observe(c.MSG_TYPES.EVENT_END,function(a){g.has(a.id)&&g.pop(a.id)}),o.observe([c.MSG_TYPES.USE,c.MSG_TYPES.REFRESH],function(a){switch(a.id){case J.data.resources.gatherable.common.water:break;case J.data.resources.gatherable.common.food:}}),this.render()},render:function(){requestAnimationFrame(this.render.bind(this)),h.length&&(e.clear(),h.forEach(function(b){b.render(a,e)})),g.length&&(f.clear(),g.forEach(function(b){b.render(a,f)}))}}}();b.ANIMATION_INC=2/60,b.ENLARGE=4,b.prototype={render:function(a,c){this.animationState=(this.animationState+b.ANIMATION_INC)%this.animationSteps;var d=l(l(this.animationState)*this.size.width),e=l(c.canvas.width*(this.destination.x/100)-this.destination.width/2),f=l(c.canvas.height*(this.destination.y/100)-this.destination.height/2);c.drawImage(a,this.origin.x+d,this.origin.y,this.origin.width,this.origin.height,e,f,this.destination.width,this.destination.height)},getDepth:function(){return this.destination.y},compare:function(a){return this.getDepth()-a.getDepth()}};var L=function(){var a={};return window.addEventListener("keyup",function(b){x(b.keyCode);var c=a[b.keyCode];B(c)&&c()}),{KEYS:{SPACE:32,ENTER:13,ESCAPE:27,UP:38,RIGHT:39,DOWN:40,LEFT:37,CTRL:17,SHIFT:16,BACK:8,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,ZERO:48},attach:function(b,c){a[b]=c},detach:function(b){a[b]=null}}}(),M=function(){var a={0:"info",1:"warning",2:"flavor",3:"event"},b=null,d={LOG_TYPES:{INFO:0,WARN:1,FLAVOR:2,EVENT:3},maxLog:50,start:function(a){b=a;var e=c.getInstance();e.observe(d.LOG_TYPES.values(),function(a,b){d.log(a,b)}),e.observe(c.MSG_TYPES.ARRIVAL,function(a){d.log(a+" has arrived.",c.MSG_TYPES.LOGS.EVENT)}),e.observe(c.MSG_TYPES.LOOSE_SOMEONE,function(a){var b="We lost "+a.name+".";d.log(b,d.LOG_TYPES.WARN)}),e.observe(c.MSG_TYPES.LOOSE,function(a){var b="We held up for "+a+", but all is lost now.";d.log(b,d.LOG_TYPES.FLAVOR)}),e.observe(c.MSG_TYPES.RUNS_OUT,function(a){var b="We run out of "+a+", we need to do something.";d.log(b,d.LOG_TYPES.WARN)}),e.observe(c.MSG_TYPES.GAIN_PERK,function(a){var b=a.name+' is now known as the "'+u(a.perk.name)+'".';d.log(b,d.LOG_TYPES.EVENT)})},log:function(c,d){if(c.length){d=d||0,b.insertBefore(p("log "+a[d],c),b.firstChild);var e=Array.prototype.slice.call(b.children);e.length>M.maxLog&&e.last().remove()}},personify:function(a,b){return a.replace(/@([\w\.]+)\b/gi,function(a,c){var d=b;return c.split(".").forEach(function(a){d=d[a]}),d||""})}};return d}();c.prototype={observe:function(a,b){C(a)||(a=[a]);for(var c=0,d=a.length;c<d;++c)this.observers[a[c]]||(this.observers[a[c]]=[]),this.observers[a[c]].push(b);return this},notify:function(a,b){if(this.observers[a])for(var c=0,d=this.observers[a].length;c<d;++c)this.observers[a][c](b,a);return this}},c.instance=!1,c.getInstance=function(){return c.instance||(c.instance=new c),c.instance},c.MSG_TYPES={LOGS:M.LOG_TYPES,CLICK:10,REFRESH:20,GIVE:30,FIND_LOCATION:31,COLLECT:32,ARRIVAL:33,USE:35,RUNS_OUT:36,LOOSE_RESOURCE:38,LOOSE_SOMEONE:39,UNLOCK:40,GAIN_PERK:45,LOCK:50,BUILD:60,UNBUILD:61,EVENT_START:70,EVENT_CANCEL:71,EVENT_END:72,LOOSE:80,WIN:85};var N=function(){function a(a,b){this.startTime=performance.now(),this.action=a,this.time=b,this.isRunning=!0,this.timeout=this.setTimeout()}a.prototype={setTimeout:function(){return setTimeout(this.action,this.time)},getElapsed:function(){return performance.now()-this.startTime},getRemaining:function(){return this.time-this.getElapsed()},stop:function(){return!!this.isRunning&&(this.isRunning=!1,this.time=this.getRemaining(),clearTimeout(this.timeout),this.time)},restart:function(a){return!this.isRunning&&(this.isRunning=!0,this.startTime=a,this.timeout=this.setTimeout(),this.time)}};var b=null;return{start:function(){b=new k},timeout:function(c,d){var e,f=function(){b.pop(e),c()};return e=b.push(new a(f,d))},stop:function(a){return b.get(a).stop()},stopAll:function(){return b.forEach(function(a){a.stop()}),this},restart:function(a){return b.get(a).restart(performance.now())},restartAll:function(){var a=performance.now();return b.forEach(function(b){b.restart(a)}),this},clear:function(a){return b.pop(a).stop()},clearAll:function(){return b.forEach(function(a){a.clear()}),this},getRemaining:function(a){return getTimers().get(a).getRemaining()}}}();d.prototype={_init:function(a){return this.data=A(this,a,["name","desc","time","energy","consume"]),E(this.data.energy)&&(this.data.energy=5*this.data.time),this.html.textContent=u(this.data.name),this.tooltip?this.tooltip.remove().update(this.data):this.tooltip=o(this.html,this.data),this},toHTML:function(a){var b=p("action clickable disabled animated");return b.addEventListener("click",function(){this.locked||this.running||this.owner.busy||this.click.call(this)}.bind(this)),b.style.order=a.order,b},refresh:function(a,b){return this.locked=this.owner.isTired()&&this.data.energy>0||this.data.isOut&&b.cantGoOut,C(this.data.consume)&&(this.tooltip.refresh(a,this.data.consume),this.locked||this.data.consume.forEach(function(b){var c=b[1].id;a.has(c)&&a.get(c).has(b[0])||(this.locked=!0)}.bind(this))),this.locked?this.html.classList.add("disabled"):this.html.classList.remove("disabled"),this},click:function(){if(this.owner.busy||this.locked)return!1;C(this.data.consume)&&c.getInstance().notify(c.MSG_TYPES.USE,this.data.consume),++this.repeated,this.owner.setBusy(this.data);var b=(this.data.time||0)*a.tickLength;return this.data.deltaTime&&(b+=O(-this.data.deltaTime,this.data.deltaTime)),this.html.style.animationDuration=b+"ms",this.html.classList.add("cooldown"),this.timeout=N.timeout(this.end.bind(this),b),!0},end:function(){this.timeout=0,this.html.classList.remove("cooldown");var a={name:this.data.name,people:this.owner};if(B(this.data.build)){var b=this.data.build(this);a.build=G(b.name)}var d=[];B(this.data.give)&&(d=this.data.give(this,a)),b&&B(b.give)&&(d=d.concat(b.give(this))),d=H(d),d.length&&(c.getInstance().notify(c.MSG_TYPES.GIVE,d),a.give=r(d));var e=[];if(B(this.data.collect)&&(e=this.data.collect(this)),b&&B(b.collect)&&(e=e.concat(b.collect(this))),e=H(e),e.length&&(c.getInstance().notify(c.MSG_TYPES.COLLECT,e),a.collect=r(e)),B(this.data.unlock)){var f=this.data.unlock(this).filter(function(a){return!a.condition||a.condition&&a.condition(this)}.bind(this));this.data.unique?c.getInstance().notify(c.MSG_TYPES.UNLOCK,f):this.owner.addAction(f)}if(B(this.data.lock)){var g=this.data.lock(this);this.owner.lockAction(g)}this.data.unique&&c.getInstance().notify(c.MSG_TYPES.LOCK,this.data),b&&c.getInstance().notify(c.MSG_TYPES.BUILD,b),this.owner.plan&&(a.plan=G(this.owner.plan.name)),this.owner.project&&(a.project=G(this.owner.project.name));var h="";B(this.data.log)?h=this.data.log(a,this):this.data.log&&(h=this.data.log);var i=M.personify(h,a);c.getInstance().notify(a.logType||c.MSG_TYPES.LOGS.INFO,u(i)),this.owner.finishAction()},applyEffect:function(a){return B(a)&&(a(this.data),this._init(this.data)),this},lock:function(){return this.cancel(),this.html.remove(),this.tooltip.remove(),this},cancel:function(){return this.timeout&&(N.clear(this.timeout),this.owner.setBusy(!1),this.html.classList.remove("cooldown")),this}},e.prototype={_init:function(a){return this.data=A(this,a,["name","desc","time","consume"]),this.html=this.toHTML(),this.tooltip&&this.tooltip.remove(),o(this.html,this.data),this},toHTML:function(){this.counter=p("counter");var a=p("building",u(this.data.name));return a.appendChild(this.counter),a},add:function(a){return this.number+=a,this.counter.textContent=this.number,this}},f.prototype={_init:function(a){return this.data=A(this,a,["name","desc","time","consume"]),this.nameNode.textContent=this.data.name,this.tooltip&&this.tooltip.remove(),this.tooltip=o(this.html,this.data),this},toHTML:function(){var a=p("event");return this.nameNode=p("name"),a.appendChild(this.nameNode),this.progressBar=p("animated bar"),a.appendChild(this.progressBar),a},start:function(b){return n(this.data,function(){if(this.data.effect(!0),this.data.time){c.getInstance().notify(c.MSG_TYPES.EVENT_START,this);var d=this.data.time*a.tickLength;this.data.deltaTime&&(d+=O(-this.data.deltaTime,this.data.deltaTime)),this.progressBar.style.animationDuration=d+"ms",this.html.classList.add("ongoing"),this.timer=N.timeout(this.end.bind(this),d)}b&&b(this)}.bind(this),"event"),!!this.data.time},end:function(){this.data.effect(!1),this.timer=null,c.getInstance().notify(c.MSG_TYPES.EVENT_END,this),this.html.remove()}},f.LST_ID="eventList",h.prototype={toHTML:function(){var a=p("people"),b=p("name",this.name);return this.perkNode=p("perk"),b.appendChild(this.perkNode),a.appendChild(b),this.lifeBar=p("bar life"),o(this.lifeBar,{name:"Health",desc:"The first thing you want is a good health."}),a.appendChild(this.lifeBar),this.energyBar=p("bar energy"),o(this.energyBar,{name:"Energy",desc:"Drained faster when busy or hungry."}),a.appendChild(this.energyBar),this.actionList=p("actionList"),a.appendChild(this.actionList),a},refresh:function(a,b,c){if(this.actions.forEach(function(b){b.refresh(a,c)}),c.settled){this.stats.age+=b,this.stats.idle+=b;var d=.7;this.busy?d=(this.busy.energy||0)/this.busy.time:this.perk&&this.perk.id===J.data.perks.lounger.id&&(d=0),this.updateEnergy(-b*d-30*this.starving),this.thirsty?this.updateLife(-b*this.thirsty*30):this.energy>80&&!this.starving&&!this.thirsty&&this.updateLife(.5*b)}return this.starving=0,this.thirsty=0,this},setPronouns:function(){switch(this.gender){case"female":this.nominative="she",this.accusative="her",this.possessive="her",this.reflexive="herself";break;case"male":this.nominative="he",this.accusative="him",this.possessive="his",this.reflexive="himself";break;default:this.nominative="it",this.accusative="it",this.possessive="it",this.reflexive="itself"}},setBusy:function(a){return a&&a.id!==J.data.actions.sleep.id&&(this.stats.idle=0),this.busy=!!a&&a,this.html.classList.toggle("busy",!!a),this},finishAction:function(){this.stats.actionsDone[this.busy.id]?++this.stats.actionsDone[this.busy.id]:this.stats.actionsDone[this.busy.id]=1,this.rollForPerk(this.busy),this.setBusy(null)},updateEnergy:function(a){return this.energy+=a,this.energy>100?this.energy=100:this.energy<0&&(this.updateLife(this.energy),this.energy=0),this.energyBar.style.width=this.energy+"%",this.energy},isTired:function(){return this.energy<=0},updateLife:function(a){return this.life+=a,this.life>100?this.life=100:this.life<0&&this.die(),this.lifeBar.style.width=this.life+"%",this.lifeBar.classList[this.life<25?"add":"remove"]("warning"),this.life},planBuilding:function(a){return this.plan=a,this},prepareProject:function(a){return this.project=a,this},addAction:function(a){if(C(a))for(var b=0,c=a.length;b<c;++b)this.addAction(a[b]);else if(this.actions.has(a.id))this.actions.get(a.id)._init(a);else{var e=new d(this,a);this.perk&&B(this.perk.effect)&&(this.perk.actions&&!this.perk.actions().includes(a.id)||e.applyEffect(this.perk.effect)),this.actions.push(a.id,e),this.actionList.appendChild(e.html)}return this},lockAction:function(a){if(C(a))for(var b=0,c=a.length;b<c;++b)this.lockAction(a[b]);else this.actions.has(a.id)&&this.actions.pop(a.id).lock();return this},rollForPerk:function(a){var b=!1;if(!this.perk){var c=this,d=J.data.perks;y(d,function(e){if(!h.usedPerks.includes(e.id)){var f=B(e.actions)&&e.actions();if((!f||f.includes(a.id))&&(!B(e.condition)||e.condition(a))){var g=0;g=f?f.reduce(function(a,b){return a+(c.stats.actionsDone[b]||0)},0)/(e.iteration||0):1/(e.iteration||0),g=g<1?0:g,g&&O()<d.dropRate*g&&(c.gainPerk.call(c,e),b=!0)}}})}return b},gainPerk:function(a){if(a.desc=M.personify(a.desc,this),this.perk=a,this.perkNode.textContent='the "'+u(a.name)+'"',o(this.perkNode,a),c.getInstance().notify(c.MSG_TYPES.GAIN_PERK,this),B(a.effect)){var b=B(a.actions)&&a.actions();this.actions.filter(function(a){return!b||b.includes(a.data.id)}).forEach(function(b){b.applyEffect(a.effect)})}return B(a.unlock)&&this.addAction(a.unlock()),B(a.lock)&&this.lockAction(a.lock()),h.usedPerks.push(a.id),this},die:function(){return this.html.classList.contains("arrived")&&(c.getInstance().notify(c.MSG_TYPES.LOOSE_SOMEONE,this),this.html.classList.remove("arrived"),this.actions.forEach(function(a){a.cancel(),a.tooltip.remove()}),N.timeout(function(){this.html.remove()}.bind(this),400)),this}},h.LST_ID="peopleList",h.usedPerks=[],h.randomName=function(a){return new Promise(function(b,c){var d="https://randomuser.me/api?inc=gender,name",e=["AU","BR","CA","CH","DE","DK","ES","FI","FR","GB","IE","NL","NZ","TR","US"],f=d+"&nat="+e.join(",")+"&noinfo&results="+(a||1);fetch(f).then(function(a){return a.ok?a.json().then(b):void c(URIError("["+a.status+"] "+f+" "+a.statusText))})})},i.prototype={_init:function(a){return this.data=A(this,a,["name","desc","consume"]),this.tooltip&&this.tooltip.remove(),this.tooltip=o(this.html,this.data),this},toHTML:function(a){var b=p("resource get-more");this.counter=p("counter","1"),b.appendChild(this.counter);var c=p("icon icon-"+a.icon);return b.appendChild(c),b.style.order=a.order,b},refresh:function(a){return this.counter.textContent=l(this.count),a&&C(this.data.consume)&&this.tooltip.refresh(a,this.data.consume),this},update:function(a){var b=this.count;if(this.set(this.count+a),l(b)!==l(this.count)){var c;a>0&&!this.html.classList.contains("more")?(this.html.classList.add("more"),c=function(){this.html.classList.remove("more")}.bind(this)):a<0&&!this.html.classList.contains("less")&&(this.html.classList.add("less"),c=function(){this.html.classList.remove("less")}.bind(this)),B(c)&&N.timeout(c,700)}return this},get:function(){return 0|this.count},set:function(a){if(this.count=a,this.count<0)throw new RangeError("Resources count can't be negative");return this.refresh()},has:function(a){return this.count>=a}},i.LST_ID="resourceList",CanvasRenderingContext2D.prototype.clear=function(){this.clearRect(0,0,this.canvas.width,this.canvas.height)},k.prototype={push:function(a,b){return E(b)&&(b=a,a=b.id||this.length+1),!this.has(a)&&(this.items[a]=b,++this.length)},pop:function(a){var b=this.items[a];return!!b&&(delete this.items[a],--this.length,b)},has:function(a){return!!this.items[a]},get:function(a){if(!this.has(a))throw new RangeError("Unknown ID ("+a+") in Collection ("+this+")");return this.items[a]},set:function(a,b){if(!this.has(a))throw new RangeError("Unknown ID ("+a+") in Collection ("+this+")");return this.items[a]=b},forEach:function(a){if(this.length>0)for(var b in this.items)this.items.hasOwnProperty(b)&&a(this.items[b],b,this);return this},filter:function(a){var b=new k;return this.forEach(function(c,d,e){a(c,d,e)&&b.push(d,c)}),b},values:function(){return this.items.values()},keys:function(){return Object.keys(this.items)},random:function(){return this.values().random()},clear:function(){return this.items={},this.length=0,this},toString:function(){return"["+this.keys().join(", ")+"]"}};var O=function(){var a=Math.random;return function(b,c){return b=+b||0,void 0===c?(c=0===b?1:b,b=0):c=+c,a()*(c-b)+b}}(),P=(new Function,function(){var a=[];return function(){var b="------".replace(/-/g,function(){return m(O(36)).toString(36)});return a.includes(b)?P():(a.push(b),b)}}());Array.prototype.last=function(){return this[this.length-1]},Array.prototype.random=function(){return this[l(O(0,this.length))]},Array.prototype.out=function(a){return this.splice(this.indexOf(a),1),this.length},Object.prototype.values=function(){var a=[];for(var b in this)this.hasOwnProperty(b)&&a.push(this[b]);return a}}();