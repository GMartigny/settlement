window.VERSION = 'v0.1.1';!function(){"use strict";function a(a,b){this.locked=!0,this.running=!1,this.owner=a,this.data={},this.html=this.toHTML(b),this._init(b)}function b(a){this.number=0,this._init(a),this.add(1)}function c(){this.items={},this.length=0}function d(a){this.data={},this.html=this.toHTML(),this._init(a)}function e(a,b){this.holder=a,this.resources=new c,this.buildings=new c,this.events=new c,this.collects=[],this.people=[],this.initialActions=new c,this.knownLocations=new c,this.flags={ready:!1,paused:!1,settled:!1,popup:!1,productivity:1},this.lastTick=performance.now(),this._init(),this.refresh()}function f(){if(f.instance)throw"An instance already exists.";this.observers={}}function g(a){return a=a||1,new Promise(function(b,c){e.isDev?b(new Array(a).fill(new h("John Doe","male"))):h.randomName(a).then(function(a){try{var d=JSON.parse(a.target.response).results,e=[];d.forEach(function(a){var b=new h(q(a.name.first)+" "+q(a.name.last),a.gender);b.push(b)}),b(e)}catch(a){c(a)}})})}function h(a,b){this.name=a,this.gender=b,this.actions=new c,this.busy=!1,this.energy=100,this.starving=!1,this.life=100,this.thirsty=!1,this.plan=!1,this.html=this.toHTML()}function i(a,b){this.data={},this.html=this.toHTML(a),this._init(a),this.count=0,b&&this.update(+b)}function j(a,b){function c(a,b){var c=a+10;c+255>document.body.offsetWidth&&(c=document.body.offsetWidth-255),d.style.left=c+"px",d.style.top=b+10+"px"}var d=l("tooltip");if(d.appendChild(l("title",q(b.name))),b.desc&&d.appendChild(l("description",b.desc)),b.time&&d.appendChild(l("time",m(b.time))),b.consume){var e,f=l("consumption"),g={};b.consume.forEach(function(a){e=l("resource not-enough",a[0]+" "+a[1].name),g[a[1].id]=e,f.appendChild(e)}),d.appendChild(f)}return a.classList.add("tooltiped"),a.addEvent("mouseover",function(a){document.body.appendChild(d),c(a.clientX,a.clientY)}),a.addEvent("mousemove",function(a){c(a.clientX,a.clientY)}),a.addEvent("mouseout",function(){d.remove()}),{refresh:function(a,b){if(f){var c;b.forEach(function(b){c=b[1].id,a[c]&&a[c].has(b[0])?g[c].classList.remove("not-enough"):g[c].classList.add("not-enough")})}},remove:function(){d.remove()}}}function k(a,b,c){if(!y(b))throw"Popup need a confirm function";var d=document.getElementById("main");c="popup"+(c?" "+c:"");var e=l(c);e.appendChild(l("title",q(a.name))),e.appendChild(l("description",a.desc));var f={remove:function(){e.remove(),d.classList.remove("backdrop")}},g=l("yes clickable",a.yes||"Ok");if(g.addEvent("click",function(){b(),f.remove()}),e.appendChild(g),a.no){var h=l("no clickable",a.no);h.addEvent("click",f.remove),e.appendChild(h)}return d.appendChild(e),d.classList.add("backdrop"),e.style.top=floor((d.offsetHeight-e.offsetHeight)/2)+"px",f}function l(a,b){var c=document.createElement("div");return a&&c.classList.add.apply(c.classList,a.split(" ")),b&&(c.innerHTML=b),c}function m(a){var b=["year","month","day","hour","minute"],c=[],d=D.time;return b.forEach(function(b){if(a>=d[b]){var e=floor(a/d[b]);a%=d[b],c.push(e+" "+p(b,e))}}),o(c)}function n(a){var b=[];return a.forEach(function(a){var c=p(a[1].name,a[0]);a[1].icon&&(c+=" "+l("icon icon-"+a[1].icon).outerHTML),b.push(a[0]+" "+c)}),o(b)}function o(a,b){return b=b||"and",a.length>1?(a[a.length-2]+=" "+b+" "+a.pop(),a.join(", ")):a.length?a[0]:""}function p(a,b){return a+(b>1?"s":"")}function q(a){return a=a.replace(/([\.!\?]) ([a-z])/g,function(a,b,c){return b+" "+c.toUpperCase()}),a[0].toUpperCase()+a.slice(1)}function r(a,b){if(!a.values().length)throw"Can't pick from empty list";var c={},d=[],e=0;u(a,function(a){a.dropRate&&(e+=a.dropRate,d.push(e),c[e]=a)});var f=round(random(e));d.sort();for(var g=0,h=d.length;g<h;++g)if(d[g]>f){f=d[g];break}return b?[round(random.apply(null,b.split("-"))),c[f]]:c[f]}function s(a,b){for(var c=[],d=b.split("-"),e=d[0],f=d[1],g=0,h=round(random(1,e));g<h;++g)c.push([floor(random(e/h,f/h)),r(a)]);return c}function t(a){e.isDev&&console.log(a)}function u(a,b){for(var c in a)a.hasOwnProperty(c)&&(a[c].name?b(a[c]):u(a[c],b));return a}function v(a){return Object.assign({},a)}function w(a,b,c){c=c||Object.keys(b);var d=v(b);return c.forEach(function(b){d[b]&&y(d[b])&&(d[b]=d[b](a))}),d}function x(){var a="------".replace(/-/g,function(){return round(random(36)).toString(36)});return x.IDS.includes(a)?x():(x.IDS.push(a),a)}function y(a){return a instanceof Function}function z(a){return Array.isArray(a)}function A(a){return a===I}function B(a){var b="aeiou".split("");return(b.includes(a[0])?"an":"a")+" "+a}function C(a){return a.reduce(function(a,b){var c=a.find(function(a){return a[1].id===b[1].id});return c?c[0]+=b[0]:b[0]>0&&a.push(b),a},[])}a.prototype={_init:function(a){return this.data=w(this,a,["name","desc","time","consume"]),this.html.textContent=q(this.data.name),this.tooltip&&this.tooltip.remove(),this.tooltip=j(this.html,this.data),this},toHTML:function(a){var b=l("action clickable disabled animated");return b.addEvent("click",function(){this.locked||this.running||this.owner.busy||this.click.call(this)}.bind(this)),b.style.order=a.order,b},refresh:function(a,b){return this.locked=1!==this.data.relaxing&&this.owner.isTired()||this.data.isOut&&b.cantGoOut,z(this.data.consume)&&(this.tooltip.refresh(a,this.data.consume),this.locked||this.data.consume.forEach(function(b){var c=a[b[1].id];c&&c.has(b[0])||(this.locked=!0)}.bind(this))),this.locked?this.html.classList.add("disabled"):this.html.classList.remove("disabled"),this},click:function(){if(this.owner.busy||this.owner.isTired()&&!(this.data.relaxing>0)||this.locked)return!1;z(this.data.consume)&&f.getInstance().notify(f.MSG_TYPES.USE,this.data.consume),this.owner.setBusy(this.data);var a=(this.data.time||0)*e.hourToMs;return this.html.style.animationDuration=a+"ms",this.html.classList.add("cooldown"),this.timeout=H.timeout(function(){this.timeout=0,this.owner.setBusy(!1),this.html.classList.remove("cooldown");var a={name:this.data.name,people:this.owner.name,pronoun:this.owner.getPronoun()};if(y(this.data.build)){var b=this.data.build(this);a.build=B(b.name)}var c=[];if(y(this.data.give)&&(c=this.data.give(this),this.data.id===D.data.actions.roam.id)){var d=r(D.data.locations);a.location=B(d.name),d.hasRuin&&c.push([d.hasRuin,D.data.resources.ruins])}b&&y(b.give)&&(c=c.concat(b.give(this))),c=C(c),c.length&&(f.getInstance().notify(f.MSG_TYPES.GIVE,c),a.give=n(c));var e=[];if(y(this.data.collect)&&(e=this.data.collect(this)),b&&y(b.collect)&&(e=e.concat(b.collect(this))),e=C(e),e.length&&(f.getInstance().notify(f.MSG_TYPES.COLLECT,e),a.collect=n(e)),y(this.data.unlock)){var g=this.data.unlock(this);this.owner.addAction(g),this.data.unique&&f.getInstance().notify(f.MSG_TYPES.UNLOCK,g)}if(y(this.data.lock)){var h=this.data.lock(this);this.owner.lockAction(h)}this.data.unique&&f.getInstance().notify(f.MSG_TYPES.LOCK,this.data),b&&f.getInstance().notify(f.MSG_TYPES.BUILD,b);var i;y(this.data.log)?i=this.data.log(a,this):this.data.log&&(i=this.data.log.replace(/@(\w+)/gi,function(b,c){return a[c]||""})),f.getInstance().notify(f.MSG_TYPES.LOGS.INFO,q(i))}.bind(this),a),!0},lock:function(){return this.cancel(),this.html.remove(),this.tooltip.remove(),this},cancel:function(){return this.timeout&&(H.clear(this.timeout),this.owner.setBusy(!1),this.html.classList.remove("cooldown")),this}},b.prototype={_init:function(a){return this.data=w(this,a,["name","desc","time","consume"]),this.html=this.toHTML(),this.tooltip&&this.tooltip.remove(),j(this.html,this.data),this},toHTML:function(){this.counter=l("counter");var a=l("building",q(this.data.name));return a.appendChild(this.counter),a},add:function(a){return this.number+=a,this.counter.textContent=this.number,this}},b.LST_ID="buildingsList",c.prototype={push:function(a,b){return A(b)&&(b=a,a=b.id||this.length+1),!this.keys().includes(a)&&(this.items[a]=b,++this.length)},pop:function(a){var b=this.items[a];return delete this.items[a],--this.length,b},has:function(a){return!!this.items[a]},get:function(a){if(!this.has(a))throw"Unknown ID ("+a+") in Collection ("+this+")";return this.items[a]},set:function(a,b){if(!this.has(a))throw"Unknown ID ("+a+") in Collection ("+this+")";return this.items[a]=b},forEach:function(a){if(this.length>0)for(var b in this.items)this.items.hasOwnProperty(b)&&a(this.items[b],b,this);return this},filter:function(a){var b=new c;return this.forEach(function(c,d,e){a(c,d,e)&&b.push(d,c)}),b},values:function(){return this.items.values()},keys:function(){return Object.keys(this.items)},clear:function(){return this.items={},this.length=0,this},toString:function(){return"["+this.keys().join(", ")+"]"}};var D=function(){var a={minute:1/60,hour:1,day:24,week:168,month:720,year:8640},b={resources:{gatherable:{common:{water:{name:"water",desc:"Water is definitely important to survive in this harsh environment.",icon:"water",dropRate:130,order:10},food:{name:"food",desc:"Everyone need food to keep his strength.",icon:"food",dropRate:120,order:20},rock:{name:"rock",desc:'"There\'s rocks everywhere ! Why would you bring this back ?"',icon:"rock",dropRate:100,order:30},scrap:{name:"scrap metal",desc:"An old rusty piece of metal.",icon:"scrap",dropRate:80,order:40}},uncommon:{oil:{name:"oil",desc:"About a liter of gas-oil.",icon:"oil",dropRate:30,order:50},plastic:{name:"plastic",desc:"A sturdy piece of plastic.",icon:"plastic",dropRate:50,order:60}},rare:{medication:{name:"medication",desc:"An unmark medication, hope it'll help.",icon:"medication",dropRate:10,order:70}}},ruins:{name:"ruin",desc:"The location of an ancient building.",icon:"ruin",order:80},craftable:{component:{name:"component",desc:"A mechanical part for others craftables.",icon:"component",consume:function(){return[[2,b.resources.gatherable.common.scrap],[2,b.resources.gatherable.uncommon.plastic]]},dropRate:100,order:90},tool:{name:"tool",desc:"The base of any tinkerer.",icon:"tool",consume:function(){return[[2,b.resources.gatherable.common.scrap],[2,b.resources.craftable.component],[1,b.resources.gatherable.common.rock]]},dropRate:90,order:100},stone:{name:"smooth stone",desc:"A well polish stone.",icon:"stone",consume:function(){return[[6,b.resources.gatherable.common.rock]]},dropRate:110,order:110},engine:{name:"engine",desc:"Amazing what you manage to do with all those scraps !",icon:"engine",consume:function(){return[[10,b.resources.gatherable.common.scrap],[20,b.resources.craftable.component],[5,b.resources.craftable.tool],[10,b.resources.gatherable.uncommon.oil]]},dropRate:70,order:120},computer:{name:"computer",desc:"Well, Internet is down since 2136 but it can be useful.",icon:"computer",consume:function(){return[[5,b.resources.craftable.component],[3,b.resources.craftable.tool],[10,b.resources.gatherable.common.scrap],[2,b.resources.gatherable.uncommon.plastic]]},dropRate:15,order:130}},room:{name:"room",desc:"A place for someone in the camp.",icon:"room",order:0}},people:{name:"people",desc:"The workforce and the bane of you camp.",need:function(){return[[1.5/a.day,b.resources.gatherable.common.food],[1/a.day,b.resources.gatherable.common.water]]},dropRate:.05},buildings:{small:{tent:{name:"tent",desc:"Allow someone to rejoin your colony.",time:3,consume:function(){return[[3,b.resources.gatherable.common.rock],[5,b.resources.gatherable.common.scrap],[2,b.resources.craftable.component]]},give:function(){return[[1,b.resources.room]]},dropRate:100},well:{name:"well",desc:"Just a large hole into the ground.",time:12,unlock:function(){return[b.actions.drawFrom.well]},consume:function(){return[[8,b.resources.gatherable.common.rock],[4,b.resources.gatherable.common.scrap],[1,b.resources.gatherable.uncommon.plastic]]},give:function(){return[[8,b.resources.gatherable.common.water]]},dropRate:80},farm:{name:"farm",desc:"A plotted land with some seeds has always provided food.",time:a.day,unlock:function(){return[b.actions.harvest]},consume:function(){return[[6,b.resources.gatherable.common.rock],[6,b.resources.gatherable.uncommon.plastic],[1,b.resources.craftable.tool]]}},dropRate:70},big:{pump:{name:"water pump",desc:"A buried contraption that collect water from the earth moisture.",time:3*a.day,unlock:function(){return[b.actions.drawFrom.well]},consume:function(){return[[100,b.resources.craftable.stone],[10,b.resources.gatherable.uncommon.plastic],[10,b.resources.craftable.component],[1,b.resources.craftable.engine],[3,b.resources.craftable.tool],[15,b.resources.gatherable.common.water]]},give:function(){return[[40,b.resources.gatherable.common.water]]},collect:function(){return[[2/a.day,b.resources.gatherable.common.water]]},dropRate:15},workshop:{name:"workshop",desc:"Organizing your workforce make them more efficient at crafting.",time:3*a.day,unique:!0,consume:function(){return[[20,b.resources.craftable.stone],[20,b.resources.gatherable.common.scrap],[15,b.resources.craftable.component],[8,b.resources.craftable.tool]]},give:function(){return[]},dropRate:10},barrak:{name:"barrack",desc:"Some place to sleep for a few people.",time:2*a.day+5*a.hour,consume:function(){return[[5,b.resources.craftable.tool],[10,b.resources.gatherable.common.scrap],[7,b.resources.gatherable.common.rock]]},give:function(){return[round(random(2,4)),b.resources.room]},dropRate:10}},special:{forum:{name:"forum",desc:"The center and start of our settlement.",unlock:function(){return[b.actions.sleep]},give:function(){return[[2,b.resources.room]]},unique:!0}}},actions:{wakeUp:{name:"wake up",unlock:function(){return[b.actions.look]},log:"@people gets up painfully.",order:0,unique:!0},look:{name:"look around",desc:"What am I doing here ?",time:2,give:function(){return H.timeout(function(){this.log("We need a shelter.",f.MSG_TYPES.LOGS.FLAVOR)}.bind(this),1e3),[,[10,b.resources.gatherable.common.water],[5,b.resources.gatherable.common.food],[2,b.resources.craftable.component]]},unlock:function(){return[b.actions.settle]},log:"After some thinking, @people remembers the attack. @pronoun grabs @give laying around.",order:0,unique:!0},settle:{name:"settle here",desc:"Ok, let's settle right there !",time:3,unlock:function(){return this.flags.settled=performance.now(),[b.actions.gather]},build:function(){return b.buildings.special.forum},give:function(){return[]},log:"@people installs @build with @give to sleep in.",order:0,unique:!0},gather:{name:"gather resources",desc:"Go out to bring back resources, that's the best you can do.",time:3,isOut:1,unlock:function(){return[b.actions.roam]},give:function(){return s(b.resources.gatherable,"3-6")},log:"@people comes back with @give.",order:0},roam:{name:"roam",desc:"Explore the surroundings hoping to find something interesting.",time:7,isOut:1,consume:function(){return[[2,b.resources.gatherable.common.water]]},unlock:function(){return[b.actions.explore,b.actions.craft]},give:function(){return[r(b.resources.gatherable,"1-3")]},log:"Not far from here, @people finds @location. @pronoun also brings back @give.",order:10},explore:{name:"explore a ruin",desc:"Remember that location we saw the other day ? Let's see what we can find.",time:a.day,isOut:1,relaxing:.17,consume:function(){return[[4,b.resources.gatherable.common.water],[1,b.resources.gatherable.common.food],[1,b.resources.ruins]]},give:function(a){var b=this.knownLocations.random();return a.location=b,s(b.give(),"5-9")},log:function(a,b){var c=b.location.log;return y(c)?c(a,b):c?c.replace(/@(\w+)/gi,function(b,c){return a[c]||""}):void 0},order:20},craft:{name:"craft something",desc:"Use some resources to tinker something useful.",time:6,unlock:function(){return[b.actions.plan]},consume:function(){return[]},give:function(){var a=r(this.possibleCraftables());return a?(y(a.consume)&&f.getInstance().notify(f.MSG_TYPES.USE,a.consume(this)),[[1,a]]):[]},log:"@people succeeds to craft @give.",order:30},plan:{name:"plan a building",desc:"Prepare blueprint and space for a new building.",time:8,relaxing:.5,unlock:function(){return[b.actions.build]},give:function(a){return a.owner.planBuilding(r(this.possibleBuildings())),[]},consume:function(){return[[1,b.resources.gatherable.common.water],[1,b.resources.gatherable.common.food],[1,b.resources.craftable.tool]]},log:"Everything's ready to build @plan",order:40},build:{name:function(a){return"build "+B(a.owner.plan.name)},desc:function(a){return a.owner.plan.desc},time:function(a){return a.owner.plan.time},consume:function(a){var c=[[2,b.resources.gatherable.common.water],[1,b.resources.gatherable.common.food]];return y(a.owner.plan.consume)&&c.push.apply(c,a.owner.plan.consume(a)),c},lock:function(a){var c=[b.actions.build];return y(a.owner.plan.lock)&&c.push.apply(c,a.owner.plan.lock(a)),c},unlock:function(a){var b=[];return y(a.owner.plan.unlock)&&b.push.apply(b,a.owner.plan.unlock(a)),b},build:function(a){return a.owner.plan},log:"Building @building gives @give",order:50},drawFrom:{river:{name:"draw water",desc:"Get some water from the river.",time:8,give:function(){return[[round(random(2,5)),b.resources.gatherable.common.water]]},log:"Coming back from the river, @people brings back @give.",order:60},well:{name:"draw water",desc:"Get some water from our well.",time:2,give:function(){return[[round(random(1,2)),b.resources.gatherable.common.water]]},log:"Using our well, @people get @give.",order:60}},harvest:{name:"harvest crops",desc:"It's not the biggest vegetables, but it'll fill our stomachs.",time:4,consume:function(){return[[2,b.resources.gatherable.common.water]]},give:function(){return[[round(random(1,3)),b.resources.gatherable.common.food]]},order:70},sleep:{name:"sleep",desc:"Get some rest.",time:10,relaxing:1,give:function(a){return a.owner.updateEnergy(100),[]},unlock:function(){return[b.actions.heal]},log:"@people feels well rested now.",order:5},heal:{name:"heal",desc:'"I really hope those pills are still good."',time:2,relaxing:.8,consume:function(){return[[2,b.resources.gatherable.rare.medication]]},give:function(a){return a.owner.updateLife(random()>.05?100:-10),[]},order:6}},locations:{river:{name:"river",unlock:function(){return[b.actions.drawFrom.river]},give:function(){return[b.resources.gatherable.common.water,b.resources.gatherable.common.rock,b.resources.gatherable.uncommon.plastic,b.resources.craftable.stone]},dropRate:20},mountain:{name:"mountain",give:function(){return[b.resources.gatherable.common.rock,b.resources.gatherable.common.food,b.resources.craftable.component,b.resources.craftable.tool]},dropRate:80},desert:{name:"desert",give:function(){return[b.resources.gatherable.common.rock,b.resources.gatherable.common.scrap,b.resources.gatherable.uncommon.oil,b.resources.craftable.engine]},dropRate:120},building:{name:"abandoned building",dropRate:100,hasRuin:1,give:function(){return[b.resources.gatherable.common.scrap,b.resources.gatherable.uncommon.plastic,b.resources.craftable.tool,b.resources.craftable.computer,b.resources.gatherable.rare.medication]}},ruin:{name:"old ruin",dropRate:100,hasRuin:1,give:function(){return[b.resources.gatherable.common.rock,b.resources.gatherable.common.food,b.resources.craftable.stone,b.resources.craftable.component]}}},events:{dropRate:.01,easy:{sandstorm:{name:"sandstorm",desc:"The wind is blowing hard, impossible to go out for now.",time:function(){var b=a.day/3;return a.day+round(random(-b,b))},effect:function(a){this.flags.cantGoOut=a},dropRate:100},crate:{name:"you find an old crate",desc:"Would you want to open it ?",yes:"Yes",no:"Leave it there",effect:function(a){a&&f.getInstance().notify(f.MSG_TYPES.GIVE,b.actions.gather.give())},dropRate:50}},medium:{death:{name:"the grim Reaper",desc:"Sometimes death strike unexpectedly.",condition:function(){return this.people.length>1},effect:function(a){a&&this.people.random().die()},dropRate:10},party:{name:"party",desc:"Someone propose to throw a party to change our mind.",time:a.day,yes:"Great idea !",no:"We can't afford it.",effect:function(a){this.flags.productivity*=a?2:.5,a&&f.getInstance().notify(f.MSG_TYPES.USE,[[1*this.people.length,b.resources.gatherable.common.water],[3*this.people.length,b.resources.gatherable.common.food]])},dropRate:25}},hard:{drought:{name:"drought",desc:"The climate is so hot, we consume more water.",time:function(){var b=a.day;return 3*a.day+round(random(-b,b))},effect:function(a){this.flags.drought=a},dropRate:6}}}};return{time:a,data:b}}();d.prototype={_init:function(a){return this.data=w(this,a,["name","desc","time","consume"]),this.nameNode.textContent=this.data.name,this.tooltip&&this.tooltip.remove(),this.tooltip=j(this.html,this.data),this},toHTML:function(){var a=l("event");return this.nameNode=l("name"),a.appendChild(this.nameNode),this.progressBar=l("animated bar"),a.appendChild(this.progressBar),a},start:function(a){return k(this.data,function(){if(this.data.effect(!0),this.data.time){f.getInstance().notify(f.MSG_TYPES.EVENT_START,this).notify(f.MSG_TYPES.LOGS.EVENT,q(B(this.data.name)+" has started."));var b=this.data.time*e.hourToMs;this.progressBar.style.animationDuration=b+"ms",this.html.classList.add("ongoing"),H.timeout(this.end.bind(this),b)}a&&a(this)}.bind(this),"event"),!!this.data.time},end:function(){this.data.effect(!1),f.getInstance().notify(f.MSG_TYPES.EVENT_END,this),this.html.remove()}},d.LST_ID="eventList",console.groupCollapsed("Loading");var E,F=loadMedia([{src:"dist/img/icons.png",type:"image"}],function(a,b){if(t(b+" : "+a+"%"),a>=100){console.groupEnd();try{E=new e(document.getElementById("main"),F)}catch(a){t("Fail to load game : "+a.message)}}});e.isDev=1,e.hourToMs=2e3,e.tickLength=e.hourToMs,e.prototype={_init:function(){t("Starting "+window.VERSION);var a=this;u(D.data,function(b){b.id=x();for(var c in b)b.hasOwnProperty(c)&&y(b[c])&&(b[c]=b[c].bind(a))}),this.initialActions.push(D.data.actions.wakeUp),window.onkeypress=function(a){switch(a.keyCode){case 32:this.togglePause()}}.bind(this),this.resourcesList=l(),this.resourcesList.id=i.LST_ID,this.holder.appendChild(this.resourcesList),this.peopleList=l(),this.peopleList.id=h.LST_ID,this.holder.appendChild(this.peopleList),this.buildingsList=l(),this.buildingsList.id=b.LST_ID,this.holder.appendChild(this.buildingsList),this.eventsList=l(),this.eventsList.id=d.LST_ID,this.holder.appendChild(this.eventsList),this.logsList=l(),this.logsList.id="logs",this.holder.appendChild(this.logsList),H.timeout(this.welcome.bind(this,1,!0),500),f.getInstance().observe(f.MSG_TYPES.GIVE,function(a){z(a)&&a.forEach(function(a){this.earn.apply(this,a)}.bind(this))}.bind(this)),f.getInstance().observe(f.MSG_TYPES.COLLECT,function(a){z(a)&&C(this.collects.concat(a))}.bind(this)),f.getInstance().observe(f.MSG_TYPES.USE,function(a){z(a)&&C(a).forEach(function(a){this.consume.apply(this,a)}.bind(this))}.bind(this)),f.getInstance().observe(f.MSG_TYPES.BUILD,function(a){a&&this.build(a)}.bind(this)),f.getInstance().observe(f.MSG_TYPES.LOOSE_SOMEONE,function(a){this.log("We loose "+a.name,f.MSG_TYPES.LOGS.WARN),this.people.out(a),this.people.length<=0&&(this.log("We held up for "+this.getSurvivalDuration()),this.flags.paused=!0)}.bind(this)),f.getInstance().observe(f.MSG_TYPES.EVENT_START,function(a){this.events.push(a.data.id,a),this.flags.popup=!1}.bind(this)),f.getInstance().observe(f.MSG_TYPES.EVENT_END,function(a){this.events.pop(a.data.id)}.bind(this)),f.getInstance().observe(f.MSG_TYPES.LOCK,function(a){this.removeFromInitialActions(a)}.bind(this)),f.getInstance().observe(f.MSG_TYPES.UNLOCK,function(a){this.addToInitialActions(a)}.bind(this));var c=f.MSG_TYPES.LOGS.values();f.getInstance().observe(c,function(a,b){this.log(a,b)}.bind(this)),this.flags.ready=1},addToInitialActions:function(a){z(a)||(a=[a]),a.forEach(function(a){this.initialActions.push(a)}.bind(this)),this.people.forEach(function(b){b.addAction(a)})},removeFromInitialActions:function(a){z(a)||(a=[a]),a.forEach(function(a){this.initialActions.pop(a.id)}.bind(this)),this.people.forEach(function(b){b.lockAction(a)})},getSettledTime:function(){return this.flags.settled?(performance.now()-this.flags.settled)/e.hourToMs:0},getSurvivalDuration:function(){return m(this.getSettledTime())},log:function(a,b){if(a.length){b=b||0;var c={0:"info",1:"warning",2:"flavor",3:"event"};this.logsList.insertBefore(l("log "+c[b],a),this.logsList.firstChild);var d=Array.prototype.slice.call(this.logsList.children);d.length>G.maxLog&&d.last().remove()}},togglePause:function(){this.flags.paused=!this.flags.paused,this.holder.classList.toggle("paused",this.flags.paused),this.flags.paused?H.stopAll():H.restartAll()},refresh:function(){var a=performance.now(),b=floor((a-this.lastTick)/e.tickLength);if(this.lastTick+=b*e.tickLength,this.flags.paused&&(this.flags.settled&&(this.flags.settled+=b*e.tickLength),b=0),raf(this.refresh.bind(this)),b>0){if(this.flags.settled){var c=D.data.people.need();if(c.forEach(function(a){var b=D.data.resources.gatherable.common.water.id,c=a[1].id===b?"thirsty":"starving";this.consume(a[0]*this.people.length,a[1],function(a){this.people.forEach(function(b,d,e){b[c]=a/e.length})})}.bind(this)),this.canSomeoneArrive()&&this.welcome(),!this.flags.popup&&random()<D.data.events.dropRate){var f=this.getRandomEvent();if(f){var g=new d(f);g.start(function(a){a.data.time&&this.eventsList.appendChild(a.html),this.flags.popup=!1}.bind(this)),this.flags.popup=!0}}}this.resources.forEach(function(a,b,c){a.refresh(c)}),this.people.forEach(function(a){a.refresh(this.resources.items,b,this.flags)}.bind(this))}},hasEnough:function(a,b){return this.resources.get(a).has(b)},consume:function(a,b,c){if(a){var d=this.resources.get(b.id);if(d&&d.has(a))d.update(-a),d.warnLack=!1;else if(y(c)){var e=a-d.get();if(d.set(0),c.call(this,e,b),!d.warnLack){d.warnLack=!0;var g="We run out of "+b.name+", we need to do something.";this.log(f.MSG_TYPES.LOGS.WARN,g)}}}},earn:function(a,b){var c=b.id;if(this.resources.has(c))this.resources.get(c).update(a);else{var d=new i(b,a);this.resources.push(c,d),this.resourcesList.appendChild(d.html)}},welcome:function(a,b){g(a).then(function(a){a.forEach(function(a){a.addAction(this.initialActions.values()),this.people.push(a),this.peopleList.appendChild(a.html).offsetHeight,a.html.classList.add("arrived"),b||this.log(a.name+" arrives.",f.MSG_TYPES.LOGS.EVENT)}.bind(this))}.bind(this))},build:function(a){var c=a.id;if(this.buildings.has(c))this.buildings.get(c).add(1);else{var d=new b(a);this.buildings.push(c,d),this.buildingsList.appendChild(d.html),y(a.lock)&&this.removeFromInitialActions(a.lock(d)),y(a.unlock)&&this.addToInitialActions(a.unlock(d))}},possibleCraftables:function(){var a=[],b=this.resources.items;return u(D.data.resources.craftable,function(c){var d=!0;c.consume&&y(c.consume)&&c.consume(c).forEach(function(a){d=d&&b[a[1].id]&&b[a[1].id].has(a[0])}),d&&a.push(c)}),a},possibleBuildings:function(){var a=[],b=this.buildings;return u(D.data.buildings,function(c){(!c.unique||c.unique&&!b.has(c.id))&&a.push(c)}),a},canSomeoneArrive:function(){return this.hasEnough(D.data.resources.room.id,this.people.length+1)&&random()<D.data.people.dropRate&&this.getSettledTime()/D.time.day>2},getRandomEvent:function(){var a=[],b=this.getSettledTime()/D.time.week;return b>1&&(a.push.apply(a,D.data.events.easy.values()),b>2&&(a.push.apply(a,D.data.events.medium.values()),b>5&&a.push.apply(a,D.data.events.hard.values()))),a=a.filter(function(a){return!this.events.has(a.id)&&(!a.condition||y(a.condition)&&a.condition(a))}.bind(this)),!!a.length&&r(a)}};var G=function(){return{maxLog:100}}();f.prototype={observe:function(a,b){z(a)||(a=[a]);for(var c=0,d=a.length;c<d;++c)this.observers[a[c]]||(this.observers[a[c]]=[]),this.observers[a[c]].push(b)},notify:function(a,b){if(this.observers[a])for(var c=0,d=this.observers[a].length;c<d;++c)this.observers[a][c](b,a)}},f.instance=!1,f.getInstance=function(){return f.instance||(f.instance=new f),f.instance},f.MSG_TYPES={LOGS:{INFO:0,WARN:1,FLAVOR:2,EVENT:3},CLICK:10,REFRESH:20,GIVE:30,COLLECT:31,USE:32,RUNS_OUT:33,LOOSE:34,LOOSE_SOMEONE:36,UNLOCK:40,LOCK:50,BUILD:60,EVENT_START:70,EVENT_CANCEL:71,EVENT_END:72},h.prototype={toHTML:function(){var a=l("people");return a.appendChild(l("name",this.name)),this.lifeBar=l("bar life"),j(this.lifeBar,{name:"Health",desc:"The first thing you want is a good health."}),a.appendChild(this.lifeBar),this.energyBar=l("bar energy"),j(this.energyBar,{name:"Energy",desc:"Drained faster when busy or hungry."}),a.appendChild(this.energyBar),this.actionList=l("actionList"),a.appendChild(this.actionList),a},refresh:function(a,b,c){if(this.actions.forEach(function(b){b.refresh(a,c)}),c.settled){var d=1;this.busy&&(d=5,this.busy.relaxing&&(d*=1-this.busy.relaxing)),this.updateEnergy(-b*d-30*this.starving),this.thirsty?this.updateLife(-b*this.thirsty*30):this.energy>80&&!this.starving&&!this.thirsty&&this.updateLife(.5*b)}return this.starving=0,this.thirsty=0,this},getPronoun:function(){return"male"===this.gender?"he":"she"},setBusy:function(a){return this.busy=!!a&&a,this.html.classList.toggle("busy",!!a),this},updateEnergy:function(a){return this.energy+=a,this.energy>100?this.energy=100:this.energy<0&&(this.updateLife(this.energy),this.energy=0),this.energyBar.style.width=this.energy+"%",this.energy},isTired:function(){return this.energy<=0},updateLife:function(a){return this.life+=a,this.life>100?this.life=100:this.life<0&&this.die(),this.lifeBar.style.width=this.life+"%",this.lifeBar.classList[this.life<25?"add":"remove"]("warning"),this.life},planBuilding:function(a){return f.getInstance().notify(f.MSG_TYPES.LOGS.FLAVOR,"Reay to build "+B(a.name)),this.plan=a,this},addAction:function(b){if(z(b))for(var c=0,d=b.length;c<d;++c)this.addAction(b[c]);else if(this.actions.has(b.id))this.actions.get(b.id)._init(b);else{var e=new a(this,b);this.actions.push(b.id,e),this.actionList.appendChild(e.html)}return this},lockAction:function(a){if(z(a))for(var b=0,c=a.length;b<c;++b)this.lockAction(a[b]);else this.actions.pop(a.id).lock();return this},die:function(){return this.html.classList.contains("arrived")&&(f.getInstance().notify(f.MSG_TYPES.LOOSE_SOMEONE,this),this.html.classList.remove("arrived"),this.actions.forEach(function(a){a.cancel()}),H.timeout(function(){this.html.remove()}.bind(this),400)),this}},h.LST_ID="peopleList",h.randomName=function(a){return new Promise(function(b,c){var d="https://randomuser.me/api?inc=gender,name",e=["AU","BR","CA","CH","DE","DK","ES","FI","FR","GB","IE","NL","NZ","TR","US"];get(d+"&nat="+e.join(",")+"&noinfo&results="+a,b,c)})},i.prototype={_init:function(a){return this.data=w(this,a,["name","desc","consume"]),this.tooltip&&this.tooltip.remove(),this.tooltip=j(this.html,this.data),this},toHTML:function(a){var b=l("resource get-more");this.counter=l("counter",1),b.appendChild(this.counter);var c=l("icon icon-"+a.icon);return b.appendChild(c),b.style.order=a.order,b},refresh:function(a){return this.counter.textContent=floor(this.count),a&&z(this.data.consume)&&this.tooltip.refresh(a,this.data.consume),this},update:function(a){this.set(this.count+a);var b=!1;return a>0&&!this.html.classList.contains("more")?(this.html.classList.add("more"),b=function(){this.html.classList.remove("more")}.bind(this)):a<0&&!this.html.classList.contains("less")&&(this.html.classList.add("less"),b=function(){this.html.classList.remove("less")}.bind(this)),b&&H.timeout(b,700),this},get:function(){return 0|this.count},set:function(a){if(this.count=a,this.count<0)throw"Resources count can't be negative";return this.refresh()},has:function(a){return this.count>=a}},i.LST_ID="resourceList",function(){function a(a){return d+btoa(JSON.stringify(a))}function b(a){return JSON.parse(atob(a.slice(6)))}var c={knownVisitor:"k",gameData:"d",salt:"s"},d=localStorage.getItem(c.salt)||random().toString(36).slice(-6);window.saveManager={save:function(b){try{return localStorage.setItem(c.gameData,a(b))}catch(a){return!1}},load:function(){try{return b(localStorage.getItem(c.gameData))}catch(a){return!1}},erase:function(){localStorage.clear()}}}();var H=function(){function a(a,b){this.startTime=performance.now(),this.action=a,this.time=b,this.isRunning=!0,
this.timeout=this.setTimeout()}a.prototype={setTimeout:function(){return setTimeout(this.action,this.time)},getElapsed:function(){return performance.now()-this.startTime},getRemaining:function(){return this.time-this.getElapsed()},stop:function(){return!!this.isRunning&&(this.isRunning=!1,this.time=this.getRemaining(),clearTimeout(this.timeout),this.time)},restart:function(a){return!this.isRunning&&(this.isRunning=!0,this.startTime=a,this.timeout=this.setTimeout(),this.time)}};var b=new c;return{timeout:function(c,d){var e,f=function(){b.pop(e),c()};return e=b.push(new a(f,d))},stop:function(a){return b.get(a).stop()},stopAll:function(){return b.forEach(function(a){a.stop()}),this},restart:function(a){return b.get(a).restart(performance.now())},restartAll:function(){var a=performance.now();return b.forEach(function(b){b.restart(a)}),this},clear:function(a){return b.pop(a).stop()},clearAll:function(){return b.forEach(function(a){a.clear()}),this}}}(),I=(new Function,void 0);x.IDS=[],Array.prototype.last=function(){return this[this.length-1]},Object.prototype.values=function(){var a=[];for(var b in this)this.hasOwnProperty(b)&&a.push(this[b]);return a}}();