"use strict";function Action(owner,data){this.locked=!0,this.running=!1,this.owner=owner,this.data={},this.html=this.toHTML(),this._init(data)}function Building(data){this.number=0,this._init(data),this.add(1)}function Collection(){this.items={},this.length=0}function Event(data){this.data={},this.html=this.toHTML(),this._init(data)}function Game(holder,media){this.holder=holder,this.resources=new Collection,this.buildings=new Collection,this.events=new Collection,this.collects=[],this.people=[],this.initialActions=new Collection,this.flags={ready:!1,paused:!1,settled:!1,popup:!1,productivity:1},this.lastTick=performance.now(),this._init(),this.refresh()}function MessageBus(){if(MessageBus.instance)throw"An instance already exists.";this.observers=[]}function peopleFactory(amount){return new Promise(function(resolve,reject){Game.isDev?resolve(new Array(amount).fill(new People("John Doe"))):People.randomName(amount).then(function(data){try{var results=JSON.parse(data.target.response).results,people=[];results.forEach(function(res){people.push(new People(capitalize(res.name.first+" "+capitalize(res.name.last))))}),resolve(people)}catch(e){reject(e)}})})}function People(name){log(name+" join the community"),this.name=name,this.actions=new Collection,this.busy=!1,this.energy=100,this.starving=!1,this.life=100,this.thirsty=!1,this.plan=!1,this.html=this.toHTML()}function Resource(data,count){this.data={},this.html=this.toHTML(data.icon),this._init(data),this.count=0,count&&this.update(+count)}function tooltip(html,data){var box=wrap("tooltip");if(box.appendChild(wrap("title",data.name)),data.desc&&box.appendChild(wrap("description",data.desc)),data.time&&box.appendChild(wrap("time",formatTime(data.time))),data.consume){var item,resourcesContainer=wrap("consumption"),resourcesMapper={};data.consume.forEach(function(r){item=wrap("resource not-enough",r[0]+" "+r[1].name),resourcesMapper[r[1].id]=item,resourcesContainer.appendChild(item)}),box.appendChild(resourcesContainer)}return html.classList.add("tooltiped"),html.addEvent("mouseover",function(){document.body.appendChild(box)}),html.addEvent("mousemove",function(e){var left=e.clientX+10;left+255>document.body.offsetWidth&&(left=document.body.offsetWidth-255),box.style.left=left+"px",box.style.top=e.clientY+10+"px"}),html.addEvent("mouseout",function(){box.remove()}),{refresh:function(resources,consume){if(resourcesContainer){var id;consume.forEach(function(data){id=data[1].id,resources[id]&&resources[id].has(data[0])?resourcesMapper[id].classList.remove("not-enough"):resourcesMapper[id].classList.add("not-enough")})}},remove:function(){box.remove()}}}function popup(data,onYes,classes){if(!isFunction(onYes))throw"Popup need a confirm function";classes="popup"+(classes?" "+classes:"");var box=wrap(classes);box.appendChild(wrap("title",data.name)),box.appendChild(wrap("description",data.desc));var api={remove:function(){box.remove(),document.body.classList.remove("backdrop")}},yesButton=wrap("yes clickable",data.yes||"Ok");if(yesButton.addEvent("click",function(){onYes(),api.remove()}),box.appendChild(yesButton),data.no){var noButton=wrap("no clickable",data.no);noButton.addEvent("click",api.remove),box.appendChild(noButton)}return document.body.appendChild(box),document.body.classList.add("backdrop"),box.style.top=floor((document.body.offsetHeight-box.offsetHeight)/2)+"px",api}function wrap(classe,text){var html=document.createElement("div");return classe&&html.classList.add.apply(html.classList,classe.split(" ")),text&&(html.textContent=text),html}function formatTime(time){var units=["year","month","day","hour"],res=[],timeMatch=dataManager.getTime();return units.forEach(function(unit){if(time>=timeMatch[unit]){var y=floor(time/timeMatch[unit]);time%=timeMatch[unit],res.push(y+" "+pluralize(unit,y))}}),res.join(", ")}function pluralize(string,number){return string+(number>1?"s":"")}function capitalize(string){return string.split(" ").map(function(word){return word[0].toUpperCase()+word.slice(1)}).join(" ")}function randomize(list,amount){if(!list)throw"Can't pick from empty list";var all={},dropRateScale=[],dropRateSum=0;deepBrowse(list,function(item){item.dropRate&&(dropRateSum+=item.dropRate,dropRateScale.push(dropRateSum),all[dropRateSum]=item)});var pick=round(random(dropRateSum));dropRateScale.sort();for(var i=0,l=dropRateScale.length;i<l;++i)if(dropRateScale[i]>pick){pick=dropRateScale[i];break}return amount?[round(random.apply(null,amount.split("-"))),all[pick]]:all[pick]}function log(message){Game.isDev&&console.log(message)}function deepBrowse(tree,action){for(var item in tree)tree.hasOwnProperty(item)&&(tree[item].name?action(tree[item]):deepBrowse(tree[item],action));return tree}function clone(obj){return Object.assign({},obj)}function consolidateData(context,object,fields){if(isArray(fields)){var data=clone(object);return fields.forEach(function(field){data[field]&&isFunction(data[field])&&(data[field]=data[field](context))}),data}throw"Field is undefined or not an array"}function pickID(){var ID="------".replace(/-/g,function(){return round(random(36)).toString(36)});return pickID.IDS.indexOf(ID)<0?(pickID.IDS.push(ID),ID):pickID()}function isFunction(func){return func instanceof Function}function isArray(array){return array instanceof Array}function isUndefined(value){return value===undef}function sanitize(str){return str.toLowerCase().replace(/(\W)+/g,"_")}function an(word){var vowels="aeiou".split("");return(vowels.indexOf(word[0])<0?"a":"an")+" "+word}function compactResources(array){return array.reduce(function(reduced,item){var known=reduced.find(function(entry){return entry[1].id===item[1].id});return known?known[0]+=item[0]:reduced.push(item),reduced},[])}Action.prototype={_init:function(data){return this.data=consolidateData(this,data,["name","desc","time","consume"]),this.html.textContent=this.data.name,this.tooltip&&this.tooltip.remove(),this.tooltip=tooltip(this.html,this.data),this},toHTML:function(){var html=wrap("action clickable disabled animated");return html.addEvent("click",function(){this.locked||this.running||this.owner.busy||this.click.call(this)}.bind(this)),html},refresh:function(resources,flags){return this.locked=1!==this.data.relaxing&&this.owner.isTired()||this.data.isOut&&flags.cantGoOut,isArray(this.data.consume)&&(this.tooltip.refresh(resources,this.data.consume),this.locked||this.data.consume.forEach(function(r){var res=resources[r[1].id];res&&res.has(r[0])||(this.locked=!0)}.bind(this))),this.locked?this.html.classList.add("disabled"):this.html.classList.remove("disabled"),this},click:function(){if(this.owner.busy||this.owner.isTired()&&!(this.data.relaxing>0)||this.locked)return!1;isArray(this.data.consume)&&MessageBus.getInstance().notify(MessageBus.MSG_TYPES.USE,this.data.consume),this.owner.setBusy(this.data);var duration=(this.data.time||0)*Game.hourToMs;return this.html.style.animationDuration=duration+"ms",this.html.classList.add("cooldown"),this.timeout=TimerManager.timeout(function(){log(this.owner.name+" just finish to "+this.data.name),this.timeout=0,this.owner.setBusy(!1),this.html.classList.remove("cooldown"),isFunction(this.data.give)&&MessageBus.getInstance().notify(MessageBus.MSG_TYPES.GIVE,this.data.give(this)),isFunction(this.data.collect)&&MessageBus.getInstance().notify(MessageBus.MSG_TYPES.COLLECT,this.data.collect(this)),isFunction(this.data.unlock)&&this.owner.addAction(this.data.unlock(this)),isFunction(this.data.lock)&&this.owner.lockAction(this.data.lock(this)),isFunction(this.data.build)&&MessageBus.getInstance().notify(MessageBus.MSG_TYPES.BUILD,this.data.build(this))}.bind(this),duration),!0},lock:function(){return this.cancel(),this.html.remove(),this.tooltip.remove(),MessageBus.getInstance().notify(MessageBus.MSG_TYPES.LOCK,this),this},cancel:function(){return this.timeout&&(TimerManager.clear(this.timeout),this.owner.setBusy(!1),this.html.classList.remove("cooldown")),this}},Building.prototype={_init:function(data){return this.data=consolidateData(this,data,["name","desc","time","consume"]),this.html=this.toHTML(),this.tooltip&&this.tooltip.remove(),tooltip(this.html,this.data),this},toHTML:function(){this.counter=wrap("counter");var html=wrap("building",this.data.name);return html.appendChild(this.counter),html},add:function(number){return this.number+=number,this.counter.textContent=this.number,this}},Building.LST_ID="buildingsList",Collection.prototype={push:function(id,item){return++this.length,isUndefined(item)&&(item=id,id=item.id||this.length),this.items[id]=item,this.length},pop:function(id){var item=this.items[id];return delete this.items[id],--this.length,item},has:function(id){return!!this.items[id]},get:function(id){if(!this.has(id))throw"Unknown ID ("+id+") in Collection ("+this+")";return this.items[id]},set:function(id,value){if(!this.has(id))throw"Unknown ID ("+id+") in Collection ("+this+")";return this.items[id]=value},forEach:function(action){if(this.length>0)for(var id in this.items)this.items.hasOwnProperty(id)&&action(this.items[id],id,this.items);return this},filter:function(action){var kept=new Collection;return this.forEach(function(item,id){action(item,id)&&kept.push(id,item)}),kept},values:function(){return this.items.values()},clear:function(){return this.items={},this.length=0,this},toString:function(){return"["+Object.keys(this.items).join(", ")+"]"}},function(){var time={hour:1,day:24,week:168,month:720,year:8640},data={resources:{gatherable:{common:{water:{name:"Water",desc:"Water is definatly important to survive in this harsh environment.",icon:[0,0],dropRate:130},food:{name:"Food",desc:"Everyone need food to keep his strength.",icon:[1,0],dropRate:120},rock:{name:"Rock",desc:'"There\'s rocks everywhere ! Why would you bring this back ?"',icon:[2,0],dropRate:100},scrap:{name:"Scrap Metal",desc:"An old rusty piece of metal.",icon:[3,0],dropRate:80}},uncommon:{oil:{name:"Oil",desc:"About a liter of gas-oil",icon:[0,1],dropRate:30},plastic:{name:"Plastic",desc:"A sturdy piece of plastic",icon:[1,1],dropRate:50}},rare:{medication:{name:"Medication",desc:"An unmark medication, hope it'll help.",icon:[2,1],dropRate:10}}},ruins:{name:"Ruins",desc:"The location of an ancient building.",icon:[3,1]},craftable:{component:{name:"Component",desc:"A mechanical part for others craftables.",icon:[1,2],consume:function(){return[[2,this.data.resources.gatherable.common.scrap],[2,this.data.resources.gatherable.uncommon.plastic]]},dropRate:100},engine:{name:"Engine",desc:"Amazing what you manage to do with all those scraps !",icon:[2,2],consume:function(){return[[10,this.data.resources.gatherable.common.scrap],[20,this.data.resources.craftable.component],[5,this.data.resources.craftable.tool],[10,this.data.resources.gatherable.uncommon.oil]]},dropRate:70},tool:{name:"Tool",desc:"The base of any tinkerer.",icon:[3,2],consume:function(){return[[2,this.data.resources.gatherable.common.scrap],[2,this.data.resources.craftable.component],[1,this.data.resources.gatherable.common.rock]]},dropRate:90},stone:{name:"Smooth stone",desc:"A well polish stone.",icon:[0,3],consume:function(){return[[6,this.data.resources.gatherable.common.rock]]},dropRate:110},computer:{name:"Computer",desc:"Well, Internet is down since 2136 but it can be useful.",icon:[1,3],consume:function(){return[[5,this.data.resources.craftable.component],[3,this.data.resources.craftable.tool],[10,this.data.resources.gatherable.common.scrap],[2,this.data.resources.gatherable.uncommon.plastic]]},dropRate:15}},room:{name:"Room",desc:"A place for someone to join us.",icon:[0,2]}},people:{name:"People",desc:"The workforce and the bane of you camp.",need:function(){return[[1.5/time.day,this.data.resources.gatherable.common.food],[1/time.day,this.data.resources.gatherable.common.water]]},dropRate:.05},buildings:{small:{tent:{name:"Tent",desc:"Allow someone to rejoin your colony.",time:3,consume:function(){return[[3,this.data.resources.gatherable.common.rock],[5,this.data.resources.gatherable.common.scrap],[2,this.data.resources.craftable.component]]},give:function(){return[[1,this.data.resources.room]]},dropRate:100},well:{name:"Well",desc:"Just a large hole into the ground.",time:12,unlock:function(){return[this.data.actions.draw]},consume:function(){return[[8,this.data.resources.gatherable.common.rock],[4,this.data.resources.gatherable.common.scrap],[1,this.data.resources.gatherable.uncommon.plastic]]},give:function(){return[[8,this.data.resources.gatherable.common.water]]},dropRate:80},farm:{name:"Farm",desc:"A plotted land with some seeds has always provided food.",time:time.day,unlock:function(){return[this.data.actions.harvest]},consume:function(){return[[6,this.data.resources.gatherable.common.rock],[6,this.data.resources.gatherable.uncommon.plastic],[1,this.data.resources.craftable.tool]]}},dropRate:70},big:{pump:{name:"Water pump",desc:"A buried contraption that collect water from the earth moisture.",time:3*time.day,unlock:function(){return[this.data.actions.draw]},consume:function(){return[[100,this.data.resources.craftable.stone],[10,this.data.resources.gatherable.uncommon.plastic],[10,this.data.resources.craftable.component],[1,this.data.resources.craftable.engine],[3,this.data.resources.craftable.tool],[15,this.data.resources.gatherable.common.water]]},give:function(){return[[40,this.data.resources.gatherable.common.water]]},collect:function(){return[[2/time.day,this.data.resources.gatherable.common.water]]},dropRate:15},workshop:{name:"Workshop",desc:"Organizing your workforce make them more efficient at crafting.",time:3*time.day,unique:!0,consume:function(){return[[20,this.data.resources.craftable.stone],[20,this.data.resources.gatherable.common.scrap],[15,this.data.resources.craftable.component],[8,this.data.resources.craftable.tool]]},give:function(){return[]},dropRate:10},barrak:{name:"Barrack",desc:"Some place to sleep for a few people.",time:2*time.day+5*time.hour,consume:function(){return[[5,this.data.resources.craftable.tool],[10,this.data.resources.gatherable.common.scrap],[7,this.data.resources.gatherable.common.rock]]},give:function(){return[random(2,4),this.data.resources.room]},dropRate:10}},special:{forum:{name:"Forum",desc:"The center and start of our settlement.",unlock:function(){return[this.data.actions.sleep]},unique:!0}}},actions:{settle:{name:"Settle",desc:"Ok, let's settle right here !",time:1,unlock:function(){var unlocked=[this.data.actions.gather];return unlocked.forEach(function(action){this.initialActions.push(action)}.bind(this)),unlocked},lock:function(){var locked=[this.data.actions.settle];return locked.forEach(function(action){this.initialActions.pop(action.id)}.bind(this)),locked},build:function(){return this.data.buildings.special.forum},give:function(){return this.flags.settled=performance.now(),[[2,this.data.resources.room],[1,this.data.resources.gatherable.common.water],[1,this.data.resources.gatherable.common.food],[2,this.data.resources.craftable.tool]]}},gather:{name:"Gather resources",desc:"Go out to bring back resources, that's the best you can do.",time:3,isOut:1,unlock:function(){return[this.data.actions.roam]},give:function(){for(var res=[],i=0,l=round(random(1,3));i<l;++i)res.push(randomize(this.data.resources.gatherable,"1-"+5/l));return res}},roam:{name:"Roam",desc:"Explore the surroundings hoping to find something interesting.",time:7,isOut:1,consume:function(){return[[2,this.data.resources.gatherable.common.water]]},unlock:function(){return[this.data.actions.explore,this.data.actions.craft]},give:function(){return[randomize(this.data.resources.gatherable,"1-3"),[round(random(0,1)),this.data.resources.ruins]]}},explore:{name:"Explore a ruin",desc:"Remember that ruin you saw the other day ? Let's see what's inside.",time:time.day,isOut:1,relaxing:.15,consume:function(){return[[4,this.data.resources.gatherable.common.water],[1,this.data.resources.gatherable.common.food],[1,this.data.resources.ruins]]},give:function(){return[randomize(this.data.resources.gatherable,"1-3"),randomize(this.data.resources.craftable,"3-7")]}},craft:{name:"Craft something",desc:"Use some resources to tinker something useful.",time:6,unlock:function(){return[this.data.actions.plan]},consume:function(){return[]},give:function(){var pick=randomize(this.possibleCraftables());return pick?(isFunction(pick.consume)&&MessageBus.getInstance().notify(MessageBus.MSG_TYPES.USE,pick.consume(this)),[[1,pick]]):[]}},plan:{name:"Plan a building",desc:"Prepare blueprint and space for a new building.",time:8,relaxing:.5,unlock:function(){return[this.data.actions.build]},give:function(action){return action.owner.planBuilding(randomize(this.possibleBuildings())),[]},consume:function(){return[[1,this.data.resources.gatherable.common.water],[1,this.data.resources.gatherable.common.food],[1,this.data.resources.craftable.tool]]}},build:{name:function(action){return"Build "+an(action.owner.plan.name)},desc:function(action){return action.owner.plan.desc},time:function(action){return action.owner.plan.time},consume:function(action){var consume=[[2,this.data.resources.gatherable.common.water],[1,this.data.resources.gatherable.common.food]];return isFunction(action.owner.plan.consume)&&consume.push.apply(consume,action.owner.plan.consume(action)),consume},lock:function(action){var lock=[this.data.actions.build];return isFunction(action.owner.plan.lock)&&lock.push.apply(lock,action.owner.plan.lock(action)),lock},unlock:function(action){var unlock=[];return isFunction(action.owner.plan.unlock)&&unlock.push.apply(unlock,action.owner.plan.unlock(action)),unlock},build:function(action){return action.owner.plan},give:function(action){var give=[];return isFunction(action.owner.plan.give)&&give.push.apply(give,action.owner.plan.give(action)),give},collect:function(action){var collect=[];return isFunction(action.owner.plan.collect)&&collect.push.apply(collect,action.owner.plan.collect(action)),collect}},draw:{name:"Draw water",desc:"Get some water from our well.",time:5,give:function(){return[[round(random(1,3)),this.data.resources.gatherable.common.water]]}},harvest:{name:"Harvest crops",desc:"It's not the biggest vegetables, but it'll fill our stomachs.",time:4,consume:function(){return[[2,this.data.resources.gatherable.common.water]]},give:function(){return[[round(random(1,3)),this.data.resources.gatherable.common.food]]}},sleep:{name:"Sleep",desc:"Get some rest.",time:10,relaxing:1,give:function(action){return action.owner.updateEnergy(100),[]},unlock:function(){return[this.data.actions.heal]}},heal:{name:"Heal",desc:'"I really hope those pills are still good."',time:2,relaxing:.8,consume:function(){return[[2,this.data.resources.gatherable.rare.medication]]},give:function(action){return action.owner.updateLife(random()>.05?100:-10),[]}}},events:{dropRate:.3,easy:{sandstorm:{name:"Sand storm",desc:"The wind is blowing hard, impossible to go out for now.",time:function(){var delta=time.day/3;return time.day+random(-delta,delta)},effect:function(isOn){this.flags.cantGoOut=isOn},dropRate:100},crate:{name:"You find an old crate",desc:"Would you want to open it ?",yes:"Yes",no:"Leave it there",effect:function(isOn){isOn&&MessageBus.getInstance().notify(MessageBus.MSG_TYPES.GIVE,this.data.actions.gather.give())},dropRate:50}},medium:{death:{name:"The grim Reaper",desc:"Sometimes death strike unexpectedly.",condition:function(){return this.people.length>1},effect:function(isOn){isOn&&this.people.random().die()},dropRate:10},party:{name:"Throw a party",desc:"Someone propose to throw a party to change our mind.",time:time.day,yes:"Great idea !",no:"We can't afford it.",effect:function(isOn){this.flags.productivity*=isOn?2:.5,isOn&&MessageBus.getInstance().notify(MessageBus.MSG_TYPES.USE,[[1*this.people.length,this.data.resources.gatherable.common.water],[3*this.people.length,this.data.resources.gatherable.common.food]])},dropRate:25}},hard:{drought:{name:"Drought",desc:"The climate is so hot, we consume more water.",time:function(){var delta=time.day;return 3*time.day+random(-delta,delta)},effect:function(isOn){this.flags.drought=isOn},dropRate:6}}}};window.dataManager={getData:function(){return data},getTime:function(){return time}}}(),Event.prototype={_init:function(data){return this.data=consolidateData(this,data,["name","desc","time","consume"]),this.html.textContent=this.data.name,this.tooltip&&this.tooltip.remove(),this.tooltip=tooltip(this.html,this.data),this},toHTML:function(){return wrap("event, animated")},start:function(callback){return log("The "+this.data.name+" has started."),popup(this.data,function(){if(this.data.effect(!0),this.data.time){MessageBus.getInstance().notify(MessageBus.MSG_TYPES.EVENT_START,this);var duration=this.data.time*Game.hourToMs;this.html.style.animationDuration=duration+"ms",this.html.classList.add("ongoing"),TimerManager.timeout(function(){this.data.effect(!1),MessageBus.getInstance().notify(MessageBus.MSG_TYPES.EVENT_END,this),this.html.remove()}.bind(this),duration),callback(this)}}.bind(this),"event"),!!this.data.time}},Event.LST_ID="eventList",Game.version="0.1",Game.isDev=1,Game.hourToMs=2e3,Game.tickLength=Game.hourToMs,Game.prototype={_init:function(){log("Starting v"+Game.version),this.data=dataManager.getData(),this.time=dataManager.getTime();var game=this;deepBrowse(this.data,function(item){item.id=pickID();for(var attr in item)item.hasOwnProperty(attr)&&isFunction(item[attr])&&(item[attr]=item[attr].bind(game))}),this.initialActions.push(this.data.actions.settle),window.onkeypress=function(e){switch(e.keyCode){case 32:this.togglePause()}}.bind(this),this.resourcesList=wrap(),this.resourcesList.id=Resource.LST_ID,this.holder.appendChild(this.resourcesList),this.peopleList=wrap(),this.peopleList.id=People.LST_ID,this.holder.appendChild(this.peopleList),this.buildingsList=wrap(),this.buildingsList.id=Building.LST_ID,this.holder.appendChild(this.buildingsList),this.logsList=wrap(),this.logsList.id="logs",this.holder.appendChild(this.logsList),this.eventsList=wrap(),this.eventsList.id=Event.LST_ID,this.holder.appendChild(this.eventsList),TimerManager.timeout(this.welcome.bind(this),400*(Game.isDev?1:10)),MessageBus.getInstance().observe(MessageBus.MSG_TYPES.GIVE,function(given){isArray(given)&&compactResources(given).forEach(function(r){this.earn.apply(this,r)}.bind(this))}.bind(this)),MessageBus.getInstance().observe(MessageBus.MSG_TYPES.COLLECT,function(collected){isArray(collected)&&compactResources(this.collects.concat(collected))}.bind(this)),MessageBus.getInstance().observe(MessageBus.MSG_TYPES.USE,function(use){isArray(use)&&compactResources(use).forEach(function(r){this.consume.apply(this,r)}.bind(this))}.bind(this)),MessageBus.getInstance().observe(MessageBus.MSG_TYPES.BUILD,function(building){building&&this.build(building)}.bind(this)),MessageBus.getInstance().observe(MessageBus.MSG_TYPES.LOOSE_SOMEONE,function(person){log("We loose "+person.name),this.people.out(person),this.people.length<=0&&(log("We held up for "+this.getSurvivalDuration()),this.flags.paused=!0)}.bind(this)),MessageBus.getInstance().observe(MessageBus.MSG_TYPES.EVENT_START,function(event){this.events.push(event.data.id,event),this.flags.popup=!1}.bind(this)),MessageBus.getInstance().observe(MessageBus.MSG_TYPES.EVENT_END,function(event){this.events.pop(event.data.id)}.bind(this));var logTypes=[MessageBus.MSG_TYPES.INFO,MessageBus.MSG_TYPES.WARN,MessageBus.MSG_TYPES.FLAVOR];MessageBus.getInstance().observe(logTypes,function(message,type){this.log(message,type)}.bind(this)),this.flags.ready=1},addToInitialActions:function(actions){isArray(actions)||(actions=[actions]),actions.forEach(function(action){this.initialActions.push(action)}.bind(this)),this.people.forEach(function(people){people.addAction(actions)})},removeFromInitialActions:function(actions){isArray(actions)||(actions=[actions]),actions.forEach(function(action){this.initialActions.pop(action.id)}.bind(this)),this.people.forEach(function(people){people.lockAction(actions)})},getSettledTime:function(){return this.flags.settled?(performance.now()-this.flags.settled)/Game.hourToMs:0},getSurvivalDuration:function(){return formatTime(this.getSettledTime())},log:function(message,type){type=type||0;var types=["info","warning","flavor"];this.logsList.appendChild(wrap(types[type],message))},togglePause:function(){this.flags.paused=!this.flags.paused,this.holder.classList.toggle("paused",this.flags.paused),document.body.classList.toggle("backdrop",this.flags.paused),this.flags.paused?TimerManager.stopAll():TimerManager.restartAll()},refresh:function(){var now=performance.now(),elapse=floor((now-this.lastTick)/Game.tickLength);if(this.lastTick+=elapse*Game.tickLength,this.flags.paused&&(this.flags.settled&&(this.flags.settled+=elapse*Game.tickLength),elapse=0),raf(this.refresh.bind(this)),elapse>0){if(this.flags.settled){var needs=this.data.people.need();if(needs.forEach(function(need){var state=need[1].id===this.data.resources.gatherable.common.water.id?"thirsty":"starving";this.consume(need[0]*this.people.length,need[1],function(number){this.people.forEach(function(person,index,list){person[state]=number/list.length})})}.bind(this)),this.canSomeoneArrive()&&this.welcome(),!this.flags.popup&&random()<this.data.events.dropRate){var eventData=this.getRandomEvent();if(eventData){var event=new Event(eventData);event.start(function(event){this.eventsList.appendChild(event.html)}.bind(this)),this.flags.popup=!0}}}this.resources.forEach(function(resource,id,list){resource.refresh(list)}),this.people.forEach(function(people){people.refresh(this.resources.items,elapse,this.flags)}.bind(this))}},hasEnough:function(id,amount){return this.resources.get(id).has(amount)},consume:function(amount,resource,lack){if(amount){var instance=this.resources.get(resource.id);if(instance&&instance.has(amount))log("Use "+amount+" "+resource.name),instance.update(-amount);else if(isFunction(lack)){log("Ran out of "+amount+" "+resource.name);var diff=amount-instance.get();instance.set(0),lack.call(this,diff,resource)}}},earn:function(amount,resource){log("Acquire "+amount+" "+resource.name);var id=resource.id;if(this.resources.has(id))this.resources.get(id).update(amount);else if(amount>0){var res=new Resource(resource,amount);this.resources.push(id,res),this.resourcesList.appendChild(res.html)}},welcome:function(amount){peopleFactory(amount).then(function(persons){persons.forEach(function(person){person.addAction(this.initialActions.values()),this.people.push(person),this.peopleList.appendChild(person.html).offsetHeight,person.html.classList.add("arrived")}.bind(this))}.bind(this))},build:function(building){log("We add "+an(building.name)+" to the camp");var id=building.id;if(this.buildings.has(id))this.buildings.get(id).add(1);else{var bld=new Building(building);this.buildings.push(id,bld),this.buildingsList.appendChild(bld.html),isFunction(building.lock)&&this.removeFromInitialActions(building.lock(bld)),isFunction(building.unlock)&&this.addToInitialActions(building.unlock(bld))}},possibleCraftables:function(){var craftables=[],resources=this.resources.items;return deepBrowse(this.data.resources.craftable,function(craft){var ok=!0;craft.consume&&isFunction(craft.consume)&&craft.consume(craft).forEach(function(res){ok=ok&&resources[res[1].id]&&resources[res[1].id].has(res[0])}),ok&&craftables.push(craft)}),craftables},possibleBuildings:function(){var buildings=[],done=this.buildings;return deepBrowse(this.data.buildings,function(build){(!build.unique||build.unique&&!done.has(build.id))&&buildings.push(build)}),buildings},canSomeoneArrive:function(){return this.hasEnough(this.data.resources.room.id,this.people.length+1)&&random()<this.data.people.dropRate&&this.getSettledTime()/this.time.day>2},getRandomEvent:function(){var list=[],time=this.getSettledTime()/this.time.week;return time>0&&(list.push.apply(list,this.data.events.easy.values()),time>2&&(list.push.apply(list,this.data.events.medium.values()),time>5&&list.push.apply(list,this.data.events.hard.values()))),randomize(list.filter(function(event){return!this.events.has(event.id)&&(!event.condition||isFunction(event.condition)&&event.condition(event))}.bind(this)))}},MessageBus.prototype={observe:function(type,action){isArray(type)||(type=[type]);for(var i=0,l=type.length;i<l;++i)this.observers[type]||(this.observers[type]=[]),this.observers[type].push(action)},notify:function(type,message){if(this.observers[type])for(var i=0,l=this.observers[type].length;i<l;++i)this.observers[type][i](message,type)}},MessageBus.instance=!1,MessageBus.getInstance=function(){return MessageBus.instance||(MessageBus.instance=new MessageBus),MessageBus.instance},MessageBus.MSG_TYPES={INFO:0,WARN:1,FLAVOR:2,CLICK:10,REFRESH:20,GIVE:30,COLLECT:31,USE:32,RUNS_OUT:33,LOOSE:34,LOOSE_SOMEONE:36,UNLOCK:40,LOCK:50,BUILD:60,EVENT_START:70,EVENT_CANCEL:71,EVENT_END:72},People.prototype={toHTML:function(){var html=wrap("people");return html.appendChild(wrap("name",this.name)),this.lifeBar=wrap("bar life"),tooltip(this.lifeBar,{name:"Health",desc:"The first thing you want is a good health."}),html.appendChild(this.lifeBar),this.energyBar=wrap("bar energy"),tooltip(this.energyBar,{name:"Energy",desc:"Drained faster when busy or hungry."}),html.appendChild(this.energyBar),this.actionList=wrap("actionList"),html.appendChild(this.actionList),html},refresh:function(resources,elapse,flags){if(this.actions.forEach(function(action){action.refresh(resources,flags)}),flags.settled){var ratio=1;this.busy&&(ratio=5,this.busy.relaxing&&(ratio*=1-this.busy.relaxing)),this.updateEnergy(-elapse*ratio-30*this.starving),this.thirsty?this.updateLife(-elapse*this.thirsty*30):this.energy>80&&!this.starving&&!this.thirsty&&this.updateLife(.5*elapse)}return this.starving=0,this.thirsty=0,this},setBusy:function(action){return this.busy=!!action&&action,this.html.classList.toggle("busy",!!action),this},updateEnergy:function(amount){return this.energy+=amount,this.energy>100?this.energy=100:this.energy<0&&(this.updateLife(this.energy),this.energy=0),this.energyBar.style.width=this.energy+"%",this.energy},isTired:function(){return this.energy<=0},updateLife:function(amount){return this.life+=amount,this.life>100?this.life=100:this.life<0&&this.die(),this.lifeBar.style.width=this.life+"%",this.lifeBar.classList[this.life<25?"add":"remove"]("warning"),this.life},planBuilding:function(building){return log("\"We'll do "+an(building.name)+'"'),this.plan=building,this},addAction:function(actions){if(isArray(actions))for(var i=0,l=actions.length;i<l;++i)this.addAction(actions[i]);else if(this.actions.has(actions.id))this.actions.get(actions.id)._init(actions);else{var action=new Action(this,actions);this.actions.push(actions.id,action),this.actionList.appendChild(action.html)}return this},lockAction:function(actions){if(isArray(actions))for(var i=0,l=actions.length;i<l;++i)this.lockAction(actions[i]);else this.actions.pop(actions.id).lock();return this},die:function(){return this.html.classList.contains("arrived")&&(MessageBus.getInstance().notify(MessageBus.MSG_TYPES.LOOSE_SOMEONE,this),this.html.classList.remove("arrived"),this.actions.forEach(function(action){action.cancel()}),TimerManager.timeout(function(){this.html.remove()}.bind(this),400)),this}},People.LST_ID="peopleList",People.randomName=function(amount){return new Promise(function(resolve,reject){var baseUrl="https://randomuser.me/api?inc=gender,name",countries=["AU","BR","CA","CH","DE","DK","ES","FI","FR","GB","IE","NL","NZ","TR","US"];get(baseUrl+"&nat="+countries.join(",")+"&noinfo&results="+amount,resolve,reject)})},Resource.prototype={_init:function(data){return this.data=consolidateData(this,data,["name","desc","consume"]),this.tooltip&&this.tooltip.remove(),this.tooltip=tooltip(this.html,this.data),this},toHTML:function(iconPos){var html=wrap("resource get-more");this.counter=wrap("counter",1),html.appendChild(this.counter);var icon=wrap("icon"),pos="16px 16px";return isArray(iconPos)&&(pos=16*-iconPos[0]+"px "+16*-iconPos[1]+"px"),
icon.style.backgroundPosition=pos,html.appendChild(icon),html},refresh:function(resources){return this.counter.textContent=floor(this.count),resources&&isArray(this.data.consume)&&this.tooltip.refresh(resources,this.data.consume),this},update:function(amount){this.set(this.count+amount);var cb=!1;return amount>0&&!this.html.classList.contains("more")?(this.html.classList.add("more"),cb=function(){this.html.classList.remove("more")}.bind(this)):amount<0&&!this.html.classList.contains("less")&&(this.html.classList.add("less"),cb=function(){this.html.classList.remove("less")}.bind(this)),cb&&TimerManager.timeout(cb,700),this},get:function(){return 0|this.count},set:function(value){if(this.count=value,this.count<0)throw"Resources count can't be negative";return this.refresh()},has:function(amount){return this.count>=amount}},Resource.LST_ID="resourceList",function(){function hash(obj){return salt+btoa(JSON.stringify(obj))}function unhash(str){return JSON.parse(atob(str.slice(6)))}var keys={knownVisitor:"k",gameData:"d",salt:"s"},salt=localStorage.getItem(keys.salt)||Math.random().toString(36).slice(-6);window.saveManager={save:function(obj){try{return localStorage.setItem(keys.gameData,hash(obj))}catch(e){return!1}},load:function(){try{return unhash(localStorage.getItem(keys.gameData))}catch(e){return!1}},erase:function(){localStorage.clear()}}}(),function(){function Timer(action,time){this.startTime=performance.now(),this.action=action,this.time=time,this.isRunning=!0,this.timeout=this.setTimeout()}Timer.prototype={setTimeout:function(){return setTimeout(this._end.bind(this),this.time)},getElapsed:function(){return performance.now()-this.startTime},getRemaining:function(){return this.time-this.getElapsed()},stop:function(){return!!this.isRunning&&(this.isRunning=!1,this.time=this.getRemaining(),clearTimeout(this.timeout),this.time)},restart:function(now){return!this.isRunning&&(this.isRunning=!0,this.startTime=now,this.timeout=this.setTimeout(),this.time)},_end:function(){return this.action(),!0}};var timers=new Collection;window.TimerManager={timeout:function(action,time){var timerId,func=function(){timers.pop(timerId),action()};return timerId=timers.push(new Timer(func,time))},stop:function(timerId){return timers.get(timerId).stop()},stopAll:function(){return timers.forEach(function(timer){timer.stop()}),this},restart:function(timerId){return timers.get(timerId).restart(performance.now())},restartAll:function(){var now=performance.now();return timers.forEach(function(timer){timer.restart(now)}),this},clear:function(timerId){return timers.pop(timerId).stop()},clearAll:function(){return timers.forEach(function(timer){timer.clear()}),this}}}();var str="",noop=new Function,undef=void 0;pickID.IDS=[],Object.prototype.values=function(){var values=[];for(var key in this)this.hasOwnProperty(key)&&values.push(this[key]);return values};
//# sourceMappingURL=script.js.map